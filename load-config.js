// load-config.js ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∏ –Ω–∞–¥—ë–∂–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Supabase
// ‚ö†Ô∏è –§–∞–π–ª –¥–æ–ª–∂–µ–Ω –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è –ò–ú–ï–ù–ù–û load-config.js (–Ω–µ .html, –Ω–µ –æ–ø–µ—á–∞—Ç–∫–∏).
(function () {
  console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Edu Keys...');

  // ---- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—ç—à–∞ ----
  const CACHE_KEY_DATA = 'edu-keys-config';
  const CACHE_KEY_TIME = 'edu-keys-config-time';
  const CACHE_TTL_MS = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞
  const now = Date.now();

  // ---- –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Ä–µ–∑–µ—Ä–≤) ----
  const FALLBACK_CONFIG = {
    SUPABASE_URL: 'https://zjvedphdbpuzqzvznqex.supabase.co',
    SUPABASE_ANON_KEY:
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpqdmVkcGhkYnB1enF6dnpucWV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNDMxMDgsImV4cCI6MjA3NTkxOTEwOH0.rfIdcmTx9q-UZyQp0QKjBdGQGbDpMuy0R3_3P_DOV7I',
  };

  // ---- –£—Ç–∏–ª–∏—Ç—ã ----
  function saveToCache(config) {
    try {
      localStorage.setItem(CACHE_KEY_DATA, JSON.stringify(config));
      localStorage.setItem(CACHE_KEY_TIME, String(now));
      console.log('üíæ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –∫—ç—à');
    } catch (e) {
      console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫—ç—à:', e.message);
    }
  }

  function readFromCache() {
    try {
      const raw = localStorage.getItem(CACHE_KEY_DATA);
      const ts = Number(localStorage.getItem(CACHE_KEY_TIME) || '0');
      if (!raw || !ts) return null;
      if (now - ts > CACHE_TTL_MS) return null;
      return JSON.parse(raw);
    } catch {
      return null;
    }
  }

  function applyConfig(config, source) {
    window.SUPABASE_URL = config.SUPABASE_URL;
    window.SUPABASE_ANON_KEY = config.SUPABASE_ANON_KEY;
    window.__EDU_KEYS_CONFIG_SOURCE__ = source;
    console.log(`‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ (${source})`);
    dispatchReady();
  }

  function isValidConfig(cfg) {
    return !!(cfg && cfg.SUPABASE_URL && cfg.SUPABASE_ANON_KEY);
  }

  function dispatchReady() {
    // –°–æ–±—ã—Ç–∏–µ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å —É–∂–µ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–º –∫–æ–¥–æ–º
    window.dispatchEvent(
      new CustomEvent('configLoaded', {
        detail: {
          source: window.__EDU_KEYS_CONFIG_SOURCE__ || 'unknown',
          SUPABASE_URL: window.SUPABASE_URL,
        },
      })
    );
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ Promise –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
    if (!window.CONFIG_READY_RESOLVED) {
      window.CONFIG_READY_RESOLVED = true;
      if (typeof window.__CONFIG_READY_RESOLVE__ === 'function') {
        window.__CONFIG_READY_RESOLVE__();
      }
    }
  }

  // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
  window.checkConfig = function () {
    const ok = isValidConfig({
      SUPABASE_URL: window.SUPABASE_URL,
      SUPABASE_ANON_KEY: window.SUPABASE_ANON_KEY,
    });
    console.log('üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:', {
      SUPABASE_URL: window.SUPABASE_URL ? '‚úÖ' : '‚ùå',
      SUPABASE_ANON_KEY: window.SUPABASE_ANON_KEY ? '‚úÖ' : '‚ùå',
      valid: ok,
      source: window.__EDU_KEYS_CONFIG_SOURCE__ || '‚Äî',
    });
    return ok;
  };

  // Promise: window.CONFIG_READY
  if (!window.CONFIG_READY) {
    window.CONFIG_READY = new Promise((resolve) => {
      window.__CONFIG_READY_RESOLVE__ = resolve;
    });
  }

  // ---- 1) –ü—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –∏–∑ –∫—ç—à–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±—ã—Å—Ç—Ä–æ ----
  const cached = readFromCache();
  if (isValidConfig(cached)) {
    applyConfig(cached, 'cache');
  }

  // ---- 2) –†–µ–∑–µ—Ä–≤: –ø—Ä–∏–º–µ–Ω—è–µ–º FALLBACK –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, –µ—Å–ª–∏ –µ—â—ë –Ω–∏—á–µ–≥–æ –Ω–µ—Ç ----
  if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
    applyConfig(FALLBACK_CONFIG, 'fallback');
    // –°—Ä–∞–∑—É –∫–ª–∞–¥—ë–º –≤ –∫—ç—à, —á—Ç–æ–±—ã –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü —É–∂–µ —Ä–∞–±–æ—Ç–∞–ª–∞
    saveToCache(FALLBACK_CONFIG);
  }

  // ---- 3) –ü—Ä–æ–±—É–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π /config.js, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ----
  // –û–Ω –º–æ–∂–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è Vercel env)
  (function tryStaticConfig() {
    const script = document.createElement('script');
    script.src = '/config.js?' + Date.now(); // –∏–∑–±–µ–≥–∞–µ–º –∫—ç—à–∞
    script.async = true;
    script.onload = function () {
      if (isValidConfig({ SUPABASE_URL: window.SUPABASE_URL, SUPABASE_ANON_KEY: window.SUPABASE_ANON_KEY })) {
        saveToCache({
          SUPABASE_URL: window.SUPABASE_URL,
          SUPABASE_ANON_KEY: window.SUPABASE_ANON_KEY,
        });
        window.__EDU_KEYS_CONFIG_SOURCE__ = 'static';
        dispatchReady();
        console.log('üì¶ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π config.js –ø—Ä–∏–º–µ–Ω—ë–Ω');
      }
    };
    script.onerror = function () {
      console.log('‚ÑπÔ∏è –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π /config.js –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
    };
    document.head.appendChild(script);
  })();

  // ---- 4) –ü—Ä–æ–±—É–µ–º API /api/config (Node) ----
  // –ï—Å–ª–∏ –æ—Ç–¥–∞—ë—Ç –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ‚Äî –ø—Ä–∏–º–µ–Ω–∏–º –∏ —Ç–æ–∂–µ –∑–∞–∫—ç—à–∏—Ä—É–µ–º.
  fetch('/api/config', { cache: 'no-store' })
    .then((res) => {
      if (!res.ok) throw new Error('API config not available');
      return res.text();
    })
    .then((code) => {
      try {
        const before = { url: window.SUPABASE_URL, key: window.SUPABASE_ANON_KEY };
        // –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –≤—ã—Å—Ç–∞–≤–∏—Ç—å window.SUPABASE_URL –∏ window.SUPABASE_ANON_KEY
        // –í–Ω–∏–º–∞–Ω–∏–µ: —ç—Ç–æ—Ç –∫–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–º (–≤–∞—à API).
        // eslint-disable-next-line no-eval
        eval(code);
        const after = { url: window.SUPABASE_URL, key: window.SUPABASE_ANON_KEY };
        if (after.url !== before.url || after.key !== before.key) {
          if (isValidConfig(after)) {
            saveToCache({ SUPABASE_URL: after.url, SUPABASE_ANON_KEY: after.key });
            applyConfig({ SUPABASE_URL: after.url, SUPABASE_ANON_KEY: after.key }, 'api');
            console.log('üîÑ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑ API');
          }
        }
      } catch (e) {
        console.warn('API config evaluation failed:', e.message);
      }
    })
    .catch((e) => {
      console.log('‚ÑπÔ∏è /api/config –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', e.message);
    });

  // ---- 5) –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø—É—Å—Ç—è 100 –º—Å ----
  setTimeout(() => {
    if (!window.checkConfig()) {
      console.error('‚ùå –ö—Ä–∏—Ç–∏—á–Ω–æ: –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!');
    } else {
      console.log('‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑:', window.__EDU_KEYS_CONFIG_SOURCE__);
    }
  }, 100);
})();
