<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã ‚Äî Edu Keys</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .materials-container {
      width: 95%;
      max-width: 1200px;
      margin: 20px auto;
    }
    
    .materials-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
      flex-wrap: wrap;
    }
    
    .material-tab {
      padding: 12px 24px;
      background: none;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      transition: all 0.3s ease;
      color: #666;
    }
    
    .material-tab.active {
      background: var(--accent2);
      color: white;
    }
    
    .materials-section {
      display: none;
    }
    
    .materials-section.active {
      display: block;
    }
    
    .materials-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .material-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      border: 2px solid transparent;
      position: relative;
    }
    
    .material-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      border-color: var(--accent2);
    }
    
    .material-cover {
      width: 100%;
      height: 160px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 8px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 48px;
      font-weight: bold;
    }
    
    .material-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #333;
    }
    
    .material-description {
      color: #666;
      font-size: 14px;
      margin-bottom: 12px;
      line-height: 1.4;
    }
    
    .material-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #888;
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #f0f0f0;
      border-radius: 3px;
      margin: 8px 0;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--accent2);
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    
    .locked-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 16px;
    }
    
    .material-card.locked {
      cursor: not-allowed;
    }
    
    .material-card.locked:hover {
      transform: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-color: transparent;
    }

    .loading { 
      text-align: center; 
      padding: 40px; 
      display: none;
    }
    .spinner { 
      border: 4px solid #f3f3f3; 
      border-top: 4px solid var(--accent2); 
      border-radius: 50%; 
      width: 40px; 
      height: 40px; 
      animation: spin 2s linear infinite; 
      margin: 0 auto 20px; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    .error { 
      background: #ffebee; 
      color: #c62828; 
      padding: 20px; 
      border-radius: 8px; 
      margin: 20px; 
      text-align: center; 
      display: none; 
    }

    @media (max-width: 768px) {
      .materials-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .material-tab {
        padding: 10px 16px;
        font-size: 14px;
      }
      
      .materials-container {
        width: 100%;
        padding: 0 10px;
      }
    }
  </style>
  
  <script src="/load-config.js"></script>
</head>
<body>
  <div class="materials-container">
    <div class="header">
      <div class="logo">
        <div class="mark">EK</div>
        <div>
          <h3>–£—á–µ–±–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h3>
          <div class="small-muted">–í—ã–±–∏—Ä–∞–π—Ç–µ —É—á–µ–±–Ω–∏–∫–∏ –∏ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥—ã</div>
        </div>
      </div>
      <div class="nav">
        <button class="btn" onclick="location.href='/profile.html'">–ü—Ä–æ—Ñ–∏–ª—å</button>
        <button class="btn secondary" id="logoutBtn">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <div class="materials-tabs">
      <button class="material-tab active" data-tab="textbooks">üìö –£—á–µ–±–Ω–∏–∫–∏</button>
      <button class="material-tab" data-tab="crosswords">üß© –ö—Ä–æ—Å—Å–≤–æ—Ä–¥—ã</button>
    </div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã...</p>
    </div>
    
    <div id="errorMessage" class="error"></div>

    <div class="materials-section active" id="textbooks-section">
      <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ —É—á–µ–±–Ω–∏–∫–∏</h3>
      <p class="small-muted">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–±–Ω–∏–∫ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π</p>
      <div class="materials-grid" id="textbooksGrid"></div>
    </div>

    <div class="materials-section" id="crosswords-section">
      <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥—ã</h3>
      <p class="small-muted">–†–∞–∑–≥–∞–¥—ã–≤–∞–π—Ç–µ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥—ã –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è –∑–Ω–∞–Ω–∏–π</p>
      <div class="materials-grid" id="crosswordsGrid"></div>
    </div>
  </div>

  <script type="module">
    document.getElementById('loading').style.display = 'block';
    
    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorMessage').style.display = 'block';
      document.getElementById('loading').style.display = 'none';
    }
    
    function showContent() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
    }
    
    async function initApp() {
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
        showError('‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Supabase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.');
        return false;
      }
      
      try {
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
        const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          window.location.href = '/login.html';
          return;
        }

        let textbooks = [];
        let crosswords = [];
        let userProgress = [];
        let textbookAccess = [];
        let crosswordAccess = [];
        let assignments = [];

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        async function loadMaterials() {
          try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—á–µ–±–Ω–∏–∫–∏
            const { data: textbooksData, error: textbooksError } = await supabase
              .from('textbooks')
              .select('*')
              .eq('is_active', true)
              .order('order_index');

            if (textbooksError) throw textbooksError;
            textbooks = textbooksData || [];

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫—Ä–æ—Å—Å–≤–æ—Ä–¥—ã
            const { data: crosswordsData, error: crosswordsError } = await supabase
              .from('crosswords')
              .select('*')
              .eq('is_active', true)
              .order('order_index');

            if (crosswordsError) throw crosswordsError;
            crosswords = crosswordsData || [];

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è
            const { data: assignmentsData, error: assignmentsError } = await supabase
              .from('assignments')
              .select('*');

            if (assignmentsError) throw assignmentsError;
            assignments = assignmentsData || [];

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const { data: progressData, error: progressError } = await supabase
              .from('user_progress')
              .select('*')
              .eq('user_id', user.id);

            if (progressError) throw progressError;
            userProgress = progressData || [];

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ —É—á–µ–±–Ω–∏–∫–∞–º
            const { data: textbookAccessData, error: textbookAccessError } = await supabase
              .from('textbook_access')
              .select('*')
              .eq('user_id', user.id);

            if (textbookAccessError) throw textbookAccessError;
            textbookAccess = textbookAccessData || [];

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞–º
            const { data: crosswordAccessData, error: crosswordAccessError } = await supabase
              .from('crossword_access')
              .select('*')
              .eq('user_id', user.id);

            if (crosswordAccessError) throw crosswordAccessError;
            crosswordAccess = crosswordAccessData || [];

            renderTextbooks();
            renderCrosswords();
            showContent();

          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤:', error);
            showError('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: ' + error.message);
          }
        }

        function renderTextbooks() {
          const grid = document.getElementById('textbooksGrid');
          grid.innerHTML = '';

          // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –î–û–°–¢–£–ü–ê –ö –£–ß–ï–ë–ù–ò–ö–ê–ú
          const availableTextbooks = textbooks.filter(textbook => {
            // –£—á–µ–±–Ω–∏–∫ –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏:
            // 1. –û–Ω –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –¥–æ—Å—Ç—É–ø–Ω—ã–π –¥–ª—è –≤—Å–µ—Ö, –ò–õ–ò
            // 2. –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å —è–≤–Ω—ã–π –¥–æ—Å—Ç—É–ø
            return textbook.is_available || textbookAccess.some(access => access.textbook_id === textbook.id);
          });

          if (availableTextbooks.length === 0) {
            grid.innerHTML = `
              <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                <p>üìö –£—á–µ–±–Ω–∏–∫–∏ –ø–æ–∫–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã</p>
                <p class="small-muted">–û–∂–∏–¥–∞–π—Ç–µ, –∫–æ–≥–¥–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç –¥–æ—Å—Ç—É–ø</p>
              </div>
            `;
            return;
          }

          availableTextbooks.forEach(textbook => {
            // –°—á–∏—Ç–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è —É—á–µ–±–Ω–∏–∫–∞
            const textbookAssignments = assignments.filter(a => a.textbook_id === textbook.id);
            const completedAssignments = userProgress.filter(up => 
              up.is_completed && textbookAssignments.some(a => a.id === up.assignment_id)
            ).length;
            
            const totalCount = textbookAssignments.length;
            const progress = totalCount > 0 ? (completedAssignments / totalCount) * 100 : 0;

            const card = document.createElement('div');
            card.className = 'material-card';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤—Å–µ–≥–¥–∞ true –¥–ª—è availableTextbooks)
            const hasAccess = true;
            
            card.onclick = () => {
              if (hasAccess) {
                window.location.href = `/textbook.html?id=${textbook.id}`;
              }
            };

            card.innerHTML = `
              <div class="material-cover">
                ${textbook.cover_image_url ? 
                  `<img src="${textbook.cover_image_url}" alt="${textbook.title}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;" 
                       onerror="this.style.display='none'; this.parentElement.innerHTML='üìö';">` : 
                  'üìö'
                }
              </div>
              <div class="material-title">${textbook.title}</div>
              <div class="material-description">${textbook.description || '–£—á–µ–±–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ –∑–∞–¥–∞–Ω–∏—è'}</div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${progress}%"></div>
              </div>
              <div class="material-stats">
                <span>${completedAssignments}/${totalCount} –∑–∞–¥–∞–Ω–∏–π</span>
                <span>${Math.round(progress)}%</span>
              </div>
            `;

            grid.appendChild(card);
          });
        }

        function renderCrosswords() {
          const grid = document.getElementById('crosswordsGrid');
          grid.innerHTML = '';

          // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –î–û–°–¢–£–ü–ê –ö –ö–†–û–°–°–í–û–†–î–ê–ú
          const availableCrosswords = crosswords.filter(crossword => {
            // –ö—Ä–æ—Å—Å–≤–æ—Ä–¥ –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏:
            // 1. –û–Ω –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –¥–æ—Å—Ç—É–ø–Ω—ã–π –¥–ª—è –≤—Å–µ—Ö, –ò–õ–ò
            // 2. –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å —è–≤–Ω—ã–π –¥–æ—Å—Ç—É–ø
            return crossword.is_available || crosswordAccess.some(access => access.crossword_id === crossword.id);
          });

          if (availableCrosswords.length === 0) {
            grid.innerHTML = `
              <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                <p>üß© –ö—Ä–æ—Å—Å–≤–æ—Ä–¥—ã –ø–æ–∫–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã</p>
                <p class="small-muted">–û–∂–∏–¥–∞–π—Ç–µ, –∫–æ–≥–¥–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç –¥–æ—Å—Ç—É–ø</p>
              </div>
            `;
            return;
          }

          availableCrosswords.forEach(crossword => {
            // –°—á–∏—Ç–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞
            const crosswordAssignments = assignments.filter(a => a.crossword_id === crossword.id);
            const completedAssignments = userProgress.filter(up => 
              up.is_completed && crosswordAssignments.some(a => a.id === up.assignment_id)
            ).length;
            
            const totalCount = crosswordAssignments.length;
            const progress = totalCount > 0 ? (completedAssignments / totalCount) * 100 : 0;

            const card = document.createElement('div');
            card.className = 'material-card';
            const hasAccess = true; // –í—Å–µ–≥–¥–∞ true –¥–ª—è availableCrosswords
            
            card.onclick = () => {
              if (hasAccess) {
                window.location.href = `/crossword.html?id=${crossword.id}`;
              }
            };

            card.innerHTML = `
              <div class="material-cover">
                ${crossword.cover_image_url ? 
                  `<img src="${crossword.cover_image_url}" alt="${crossword.title}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;"
                       onerror="this.style.display='none'; this.parentElement.innerHTML='üß©';">` : 
                  'üß©'
                }
              </div>
              <div class="material-title">${crossword.title}</div>
              <div class="material-description">${crossword.description || '–†–∞–∑–≥–∞–¥–∞–π—Ç–µ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥'}</div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${progress}%"></div>
              </div>
              <div class="material-stats">
                <span>${completedAssignments}/${totalCount} —Å–ª–æ–≤</span>
                <span>${Math.round(progress)}%</span>
              </div>
            `;

            grid.appendChild(card);
          });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∫–ª–∞–¥–æ–∫
        document.querySelectorAll('.material-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.getAttribute('data-tab');
            
            document.querySelectorAll('.material-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.materials-section').forEach(s => s.classList.remove('active'));
            
            tab.classList.add('active');
            document.getElementById(`${tabName}-section`).classList.add('active');
          });
        });

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        document.getElementById('logoutBtn').addEventListener('click', async () => {
          if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
            await supabase.auth.signOut();
            window.location.href = '/login.html';
          }
        });

        await loadMaterials();
        return true;
        
      } catch (error) {
        showError('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message);
        return false;
      }
    }
    
    if (window.SUPABASE_URL) {
      initApp();
    } else {
      window.addEventListener('configLoaded', initApp);
    }
  </script>
</body>
</html>