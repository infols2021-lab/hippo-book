<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã ‚Äî Edu Keys</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .materials-container {
      width: 95%;
      max-width: 1200px;
      margin: 20px auto;
    }
    
    .materials-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
      flex-wrap: wrap;
    }
    
    .material-tab {
      padding: 12px 24px;
      background: none;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      transition: all 0.3s ease;
      color: #666;
    }
    
    .material-tab.active {
      background: var(--accent2);
      color: white;
    }
    
    .materials-section {
      display: none;
    }
    
    .materials-section.active {
      display: block;
    }
    
    .materials-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .material-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      border: 2px solid transparent;
      position: relative;
      display: flex;
      flex-direction: column;
      min-height: 280px;
    }
    
    .material-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      border-color: var(--accent2);
    }
    
    .material-cover {
      width: 100%;
      height: 160px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 8px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 48px;
      font-weight: bold;
      position: relative;
      overflow: hidden;
      user-select: none;
    }

    .material-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    
    .material-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #333;
    }
    
    .material-description {
      color: #666;
      font-size: 14px;
      margin-bottom: 12px;
      line-height: 1.4;
      min-height: 40px;
    }
    
    .material-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #888;
      margin-top: auto;
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #f0f0f0;
      border-radius: 3px;
      margin: 8px 0;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--accent2);
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    
    .locked-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.7);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 16px;
    }
    
    .material-card.locked {
      cursor: not-allowed;
    }
    
    .material-card.locked:hover {
      transform: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-color: transparent;
    }

    .loading { 
      text-align: center; 
      padding: 40px; 
      display: none;
    }
    .spinner { 
      border: 4px solid #f3f3f3; 
      border-top: 4px solid var(--accent2); 
      border-radius: 50%; 
      width: 40px; 
      height: 40px; 
      animation: spin 1.2s linear infinite; 
      margin: 0 auto 20px; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    .error { 
      background: #ffebee; 
      color: #c62828; 
      padding: 20px; 
      border-radius: 8px; 
      margin: 20px; 
      text-align: center; 
      display: none; 
    }

    @media (max-width: 768px) {
      .materials-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .material-tab {
        padding: 10px 16px;
        font-size: 14px;
      }
      
      .materials-container {
        width: 100%;
        padding: 0 10px;
      }
    }
  </style>
  
  <!-- –í–ê–ñ–ù–û: –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ -->
  <script src="/load-config.js"></script>
</head>
<body>
  <div class="materials-container">
    <div class="header">
      <div class="logo">
        <div class="mark">EK</div>
        <div>
          <h3>–£—á–µ–±–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h3>
          <div class="small-muted">–í—ã–±–∏—Ä–∞–π—Ç–µ —É—á–µ–±–Ω–∏–∫–∏ –∏ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥—ã</div>
        </div>
      </div>
      <div class="nav">
        <button class="btn" onclick="location.href='/profile.html'">–ü—Ä–æ—Ñ–∏–ª—å</button>
        <button class="btn secondary" id="logoutBtn">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <div class="materials-tabs">
      <button class="material-tab active" data-tab="textbooks">üìö –£—á–µ–±–Ω–∏–∫–∏</button>
      <button class="material-tab" data-tab="crosswords">üß© –ö—Ä–æ—Å—Å–≤–æ—Ä–¥—ã</button>
    </div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã...</p>
    </div>
    
    <div id="errorMessage" class="error"></div>

    <div class="materials-section active" id="textbooks-section">
      <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ —É—á–µ–±–Ω–∏–∫–∏</h3>
      <p class="small-muted">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–±–Ω–∏–∫ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π</p>
      <div class="materials-grid" id="textbooksGrid"></div>
    </div>

    <div class="materials-section" id="crosswords-section">
      <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥—ã</h3>
      <p class="small-muted">–†–∞–∑–≥–∞–¥—ã–≤–∞–π—Ç–µ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥—ã –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è –∑–Ω–∞–Ω–∏–π</p>
      <div class="materials-grid" id="crosswordsGrid"></div>
    </div>
  </div>

  <script type="module">
    // ===== –•–µ–ª–ø–µ—Ä—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∏–∑ Supabase Storage =====
    const isHttpUrl = (v) => typeof v === 'string' && /^https?:\/\//i.test(v);

    /**
     * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ä–µ–∑–æ–ª–≤–µ—Ä URL –æ–±–ª–æ–∂–∫–∏.
     * –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
     *  - –ü–æ–ª–Ω—ã–π URL (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å)
     *  - –ö–ª—é—á/–ø—É—Ç—å –≤ –±–∞–∫–µ—Ç–µ (—Å—Ç—Ä–æ–∏–º –ø—É–±–ª–∏—á–Ω—ã–π URL)
     *  - –ü—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–≤–æ–∑–≤—Ä–∞—â–∞–µ–º null)
     */
    function resolvePublicUrl(value, bucket) {
      if (!value) return null;
      if (isHttpUrl(value)) return value;

      // —á–∏—Å—Ç–∏–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–µ—Ñ–∏–∫—Å—ã –∏ –≤–µ–¥—É—â–∏–µ —Å–ª–µ—à–∏
      const key = String(value)
        .replace(/^\/+/, '')
        .replace(/^storage\/v1\/object\/public\/[^/]+\//,'');
      // cache-buster –¥–ª—è CDN
      const v = Date.now();
      return `${window.SUPABASE_URL}/storage/v1/object/public/${bucket}/${encodeURIComponent(key)}?v=${v}`;
    }

    // UI helpers
    function showError(message) {
      const el = document.getElementById('errorMessage');
      el.textContent = message;
      el.style.display = 'block';
      document.getElementById('loading').style.display = 'none';
    }
    
    function showContent() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
    }

    // –≤–∫–ª–∞–¥–∫–∏
    document.querySelectorAll('.material-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.getAttribute('data-tab');
        document.querySelectorAll('.material-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.materials-section').forEach(s => s.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`${tabName}-section`).classList.add('active');
      });
    });

    document.getElementById('loading').style.display = 'block';

    async function initApp() {
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
        showError('‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Supabase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.');
        return false;
      }
      
      try {
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
        const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          window.location.href = '/login.html';
          return;
        }

        // –≤—ã—Ö–æ–¥
        document.getElementById('logoutBtn').addEventListener('click', async () => {
          if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
            await supabase.auth.signOut();
            window.location.href = '/login.html';
          }
        });

        let textbooks = [];
        let crosswords = [];
        let userProgress = [];
        let textbookAccess = [];
        let crosswordAccess = [];
        let assignments = [];

        // ===== –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö =====
        async function loadAll() {
          // –º–∞—Ç–µ—Ä–∏–∞–ª—ã
          const [{ data: tb }, { data: cw }] = await Promise.all([
            supabase.from('textbooks')
              .select('id,title,description,cover_image_url,is_available,is_active,order_index')
              .eq('is_active', true)
              .order('order_index'),
            supabase.from('crosswords')
              .select('id,title,description,cover_image_url,is_available,is_active,order_index')
              .eq('is_active', true)
              .order('order_index')
          ]);
          textbooks = tb || [];
          crosswords = cw || [];

          // –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è (–¥–ª—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞)
          const { data: ass } = await supabase.from('assignments').select('id,textbook_id,crossword_id');
          assignments = ass || [];

          // –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          const { data: prog } = await supabase
            .from('user_progress')
            .select('assignment_id,is_completed')
            .eq('user_id', user.id);
          userProgress = prog || [];

          // –¥–æ—Å—Ç—É–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          const [{ data: tacc }, { data: cacc }] = await Promise.all([
            supabase.from('textbook_access').select('textbook_id').eq('user_id', user.id),
            supabase.from('crossword_access').select('crossword_id').eq('user_id', user.id)
          ]);
          textbookAccess = tacc || [];
          crosswordAccess = cacc || [];
        }

        function createCoverEl(raw, bucket, emoji) {
          const el = document.createElement('div');
          el.className = 'material-cover';
          el.textContent = emoji;

          const url = resolvePublicUrl(raw, bucket);
          if (!url) return el;

          const img = document.createElement('img');
          img.alt = '–û–±–ª–æ–∂–∫–∞';
          img.loading = 'lazy';
          img.decoding = 'async';
          img.src = url;

          let done = false;
          img.onload = () => {
            if (done) return;
            el.textContent = '';
            el.appendChild(img);
            done = true;
          };
          img.onerror = () => {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–ª–æ–∂–∫—É:', url);
          };

          return el;
        }

        function renderTextbooks() {
          const grid = document.getElementById('textbooksGrid');
          grid.innerHTML = '';

          const allowedIds = new Set(textbookAccess.map(a => a.textbook_id));
          const list = textbooks.filter(t => t.is_available || allowedIds.has(t.id));

          if (!list.length) {
            grid.innerHTML = `
              <div style="grid-column:1/-1;text-align:center;padding:40px;color:#666;">
                <p>üìö –£—á–µ–±–Ω–∏–∫–∏ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</p>
                <p class="small-muted">–û–∂–∏–¥–∞–π—Ç–µ, –∫–æ–≥–¥–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç –¥–æ—Å—Ç—É–ø</p>
              </div>`;
            return;
          }

          list.forEach(t => {
            const tAss = assignments.filter(a => a.textbook_id === t.id);
            const total = tAss.length;
            const completed = userProgress.filter(up => up.is_completed && tAss.some(a => a.id === up.assignment_id)).length;
            const progress = total ? Math.round(completed / total * 100) : 0;

            const card = document.createElement('div');
            card.className = 'material-card';
            card.onclick = () => location.href = `/textbook.html?id=${t.id}`;

            const cover = createCoverEl(t.cover_image_url, 'covers', 'üìö');

            const title = document.createElement('div');
            title.className = 'material-title';
            title.textContent = t.title;

            const desc = document.createElement('div');
            desc.className = 'material-description';
            desc.textContent = t.description || '–£—á–µ–±–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ –∑–∞–¥–∞–Ω–∏—è';

            const pbar = document.createElement('div');
            pbar.className = 'progress-bar';
            pbar.innerHTML = `<div class="progress-fill" style="width:${progress}%"></div>`;

            const stats = document.createElement('div');
            stats.className = 'material-stats';
            stats.innerHTML = `<span>${completed}/${total} –∑–∞–¥–∞–Ω–∏–π</span><span>${progress}%</span>`;

            card.appendChild(cover);
            card.appendChild(title);
            card.appendChild(desc);
            card.appendChild(pbar);
            card.appendChild(stats);

            grid.appendChild(card);
          });

          // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ (–¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ—ã)
          const locked = textbooks.filter(t => !t.is_available && !allowedIds.has(t.id));
          locked.forEach(t => {
            const card = document.createElement('div');
            card.className = 'material-card locked';

            const cover = createCoverEl(t.cover_image_url, 'covers', 'üìö');
            cover.style.filter = 'grayscale(100%)';
            cover.style.opacity = '0.6';

            const title = document.createElement('div');
            title.className = 'material-title';
            title.style.color = '#999';
            title.textContent = t.title;

            const desc = document.createElement('div');
            desc.className = 'material-description';
            desc.style.color = '#999';
            desc.textContent = t.description || '–£—á–µ–±–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ –∑–∞–¥–∞–Ω–∏—è';

            const overlay = document.createElement('div');
            overlay.className = 'locked-overlay';
            overlay.textContent = 'üîí –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω';

            card.appendChild(cover);
            card.appendChild(title);
            card.appendChild(desc);
            card.appendChild(overlay);

            grid.appendChild(card);
          });
        }

        function renderCrosswords() {
          const grid = document.getElementById('crosswordsGrid');
          grid.innerHTML = '';

          const allowedIds = new Set(crosswordAccess.map(a => a.crossword_id));
          const list = crosswords.filter(c => c.is_available || allowedIds.has(c.id));

          if (!list.length) {
            grid.innerHTML = `
              <div style="grid-column:1/-1;text-align:center;padding:40px;color:#666;">
                <p>üß© –ö—Ä–æ—Å—Å–≤–æ—Ä–¥—ã –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</p>
                <p class="small-muted">–û–∂–∏–¥–∞–π—Ç–µ, –∫–æ–≥–¥–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç –¥–æ—Å—Ç—É–ø</p>
              </div>`;
            return;
          }

          list.forEach(c => {
            const cAss = assignments.filter(a => a.crossword_id === c.id);
            const total = cAss.length;
            const completed = userProgress.filter(up => up.is_completed && cAss.some(a => a.id === up.assignment_id)).length;
            const progress = total ? Math.round(completed / total * 100) : 0;

            const card = document.createElement('div');
            card.className = 'material-card';
            card.onclick = () => location.href = `/crossword.html?id=${c.id}`;

            const cover = createCoverEl(c.cover_image_url, 'covers', 'üß©');

            const title = document.createElement('div');
            title.className = 'material-title';
            title.textContent = c.title;

            const desc = document.createElement('div');
            desc.className = 'material-description';
            desc.textContent = c.description || '–†–∞–∑–≥–∞–¥–∞–π—Ç–µ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥';

            const pbar = document.createElement('div');
            pbar.className = 'progress-bar';
            pbar.innerHTML = `<div class="progress-fill" style="width:${progress}%"></div>`;

            const stats = document.createElement('div');
            stats.className = 'material-stats';
            stats.innerHTML = `<span>${completed}/${total} —Å–ª–æ–≤</span><span>${progress}%</span>`;

            card.appendChild(cover);
            card.appendChild(title);
            card.appendChild(desc);
            card.appendChild(pbar);
            card.appendChild(stats);

            grid.appendChild(card);
          });

          // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
          const locked = crosswords.filter(c => !c.is_available && !allowedIds.has(c.id));
          locked.forEach(c => {
            const card = document.createElement('div');
            card.className = 'material-card locked';

            const cover = createCoverEl(c.cover_image_url, 'covers', 'üß©');
            cover.style.filter = 'grayscale(100%)';
            cover.style.opacity = '0.6';

            const title = document.createElement('div');
            title.className = 'material-title';
            title.style.color = '#999';
            title.textContent = c.title;

            const desc = document.createElement('div');
            desc.className = 'material-description';
            desc.style.color = '#999';
            desc.textContent = c.description || '–†–∞–∑–≥–∞–¥–∞–π—Ç–µ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥';

            const overlay = document.createElement('div');
            overlay.className = 'locked-overlay';
            overlay.textContent = 'üîí –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω';

            card.appendChild(cover);
            card.appendChild(title);
            card.appendChild(desc);
            card.appendChild(overlay);

            grid.appendChild(card);
          });
        }

        await loadAll();
        renderTextbooks();
        renderCrosswords();
        showContent();
        return true;
        
      } catch (error) {
        console.error(error);
        showError('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message);
        return false;
      }
    }
    
    if (window.SUPABASE_URL) {
      initApp();
    } else {
      window.addEventListener('configLoaded', initApp);
    }
  </script>
</body>
</html>
