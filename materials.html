<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã ‚Äî Edu Keys</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="css/style.css" />
  <style>
    :root{
      --card:white; --muted:#6b7280; --shadow:0 8px 26px rgba(0,0,0,.08);
      --accent:#667eea; --accent2:#4ecdc4; --ring:rgba(78,205,196,.2);
      --bg1:#f7f7fb;
    }
    body{background: #f5f7fb;}
    .materials-container{width:95%;max-width:1200px;margin:20px auto;}
    .header{
      display:flex;align-items:center;justify-content:space-between;
      background:var(--card);border-radius:16px;padding:14px 16px;box-shadow:var(--shadow);
      gap:10px;flex-wrap:wrap;
    }
    .header h1{margin:0;font-size:1.4rem}
    .header .actions{display:flex;gap:8px;flex-wrap:wrap}
    .grid{
      margin-top:16px;
      display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px;
    }
    .card{
      background:var(--card);border-radius:16px;overflow:hidden;box-shadow:var(--shadow);
      transition:transform .15s ease, box-shadow .15s ease; cursor:pointer; display:flex; flex-direction:column;
    }
    .card:hover{transform:translateY(-2px); box-shadow:0 12px 28px rgba(0,0,0,.12);}
    .cover{
      position:relative;background:#eef2ff;aspect-ratio:16/9;display:block;overflow:hidden;
    }
    .cover img{
      width:100%;height:100%;object-fit:cover;display:block;
      background:linear-gradient(135deg,#667eea22,#764ba222);
    }
    .cover .badge{
      position:absolute;left:10px;top:10px;background:#0009;color:#fff;
      padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px;backdrop-filter: blur(6px);
    }
    .content{padding:14px;display:flex;flex-direction:column;gap:6px}
    .title{font-weight:800;color:#111827}
    .desc{color:var(--muted);font-size:14px;height:40px;overflow:hidden}
    .meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:auto}
    .chip{background:var(--bg1);color:#374151;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700}
    .searchbar{display:flex;gap:8px;width:100%}
    .searchbar input{
      flex:1;padding:10px 12px;border-radius:12px;border:2px solid #eef;outline:none;
      font-size:14px;transition:border-color .2s;
    }
    .searchbar input:focus{border-color:var(--accent2); box-shadow:0 0 0 6px var(--ring)}
    .tabs{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap}
    .tab{padding:8px 12px;background:var(--card);border-radius:999px;box-shadow:var(--shadow);cursor:pointer;font-weight:700}
    .tab.active{background:var(--accent2);color:white}
    .section{display:none}
    .section.active{display:block}
    .loading{ text-align:center; padding:40px; }
    .spinner{ border:4px solid #f3f3f3;border-top:4px solid var(--accent2);border-radius:50%;width:40px;height:40px;animation:spin 1.2s linear infinite;margin:0 auto 12px;}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .error{ background:#ffebee;color:#c62828;padding:16px;border-radius:12px;margin-top:16px;display:none }
    .empty{padding:40px;text-align:center;color:#6b7280}
    .tiny{font-size:12px;color:#6b7280}
    .btn{padding:10px 12px;border-radius:12px;border:none;background:var(--accent2);color:#fff;font-weight:700;cursor:pointer}
    .btn.secondary{background:#e5e7eb;color:#111}
  </style>
  <script src="/load-config.js"></script>
</head>
<body>
  <div class="materials-container">
    <div class="header">
      <h1>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</h1>
      <div class="actions">
        <div class="searchbar">
          <input id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é‚Ä¶" />
        </div>
        <button class="btn secondary" id="toProfile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
        <button class="btn secondary" id="toAdmin" style="display:none">‚öôÔ∏è –ê–¥–º–∏–Ω</button>
        <button class="btn" id="logoutBtn">üö™ –í—ã–π—Ç–∏</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="textbooks">üìö –£—á–µ–±–Ω–∏–∫–∏</div>
      <div class="tab" data-tab="crosswords">üß© –ö—Ä–æ—Å—Å–≤–æ—Ä–¥—ã</div>
    </div>

    <div id="errorBox" class="error"></div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <div>–ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã‚Ä¶</div>
    </div>

    <div id="textbooksSection" class="section active">
      <div id="textbooksGrid" class="grid"></div>
      <div id="textbooksEmpty" class="empty" style="display:none">–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—á–µ–±–Ω–∏–∫–æ–≤</div>
    </div>

    <div id="crosswordsSection" class="section">
      <div id="crosswordsGrid" class="grid"></div>
      <div id="crosswordsEmpty" class="empty" style="display:none">–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–æ–≤</div>
    </div>

    <div class="tiny" style="margin-top:16px">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –µ—Å–ª–∏ –æ–±–ª–æ–∂–∫–∏ –Ω–µ –≤–∏–¥–Ω—ã ‚Äî –ø—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –≤ Storage –±–∞–∫–µ—Ç—ã <b>covers</b> (–∏–ª–∏ <b>backgrounds</b>) –ø—É–±–ª–∏—á–Ω—ã–µ.</div>
  </div>

  <script type="module">
    // UI helpers
    const E = (id)=>document.getElementById(id);
    const errorBox = E('errorBox');
    const showError = (msg)=>{ errorBox.textContent = msg; errorBox.style.display='block'; };
    const clearError=()=>{ errorBox.style.display='none'; errorBox.textContent=''; };

    // Tabs
    document.querySelectorAll('.tab').forEach(t=>{
      t.addEventListener('click',()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const tab = t.dataset.tab;
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        (tab==='textbooks'?E('textbooksSection'):E('crosswordsSection')).classList.add('active');
      });
    });

    // Navigation
    E('toProfile').onclick=()=>location.href='/profile.html';
    E('toAdmin').onclick=()=>location.href='/admin.html';

    // Start
    E('loading').style.display='block';

    async function initApp() {
      if(!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY){
        showError('‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Supabase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.');
        E('loading').style.display='none';
        return;
      }
      try{
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
        const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

        // Auth
        const { data: { user } } = await supabase.auth.getUser();
        if(!user){ location.href='/login.html'; return; }

        // Show admin button if user is admin
        const { data: profile } = await supabase
          .from('profiles').select('is_admin').eq('id', user.id).single();
        if(profile?.is_admin) E('toAdmin').style.display='inline-block';

        // Load both lists with access rules
        await Promise.all([
          loadTextbooks(supabase, user),
          loadCrosswords(supabase, user)
        ]);

        // Search
        E('searchInput').addEventListener('input', ()=>{
          filterCards(E('searchInput').value.trim().toLowerCase());
        });

        // Logout
        E('logoutBtn').onclick= async ()=>{
          await supabase.auth.signOut();
          location.href='/login.html';
        };

      }catch(err){
        console.error(err);
        showError('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + err.message);
      }finally{
        E('loading').style.display='none';
      }
    }

    function filterCards(query){
      const cards = document.querySelectorAll('.card[data-search]');
      cards.forEach(c=>{
        const match = c.dataset.search.includes(query);
        c.style.display = match ? '' : 'none';
      });
    }

    function cardHTML({id,title,description,cover,items,isAvailable,type}){
      const safeDesc = (description||'').trim();
      const searchData = [title||'', safeDesc].join(' ').toLowerCase();
      const href = type==='textbook'
        ? `/textbook.html?id=${id}`
        : `/crossword.html?id=${id}`;
      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É, –µ—Å–ª–∏ –Ω–µ—Ç cover
      const coverTag = cover
        ? `<img src="${cover}" alt="">`
        : `<img alt="" src="data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 450'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='%23667eea22'/><stop offset='1' stop-color='%23764ba222'/></linearGradient></defs><rect width='800' height='450' fill='url(%23g)'/><g fill='%23667eea' opacity='.6'><circle cx='120' cy='120' r='40'/><circle cx='720' cy='340' r='60'/></g></svg>`)}">`;

      return `
        <a class="card" href="${href}" data-search="${searchData}">
          <div class="cover">
            ${coverTag}
            <span class="badge">${isAvailable ? 'üåç –î–ª—è –≤—Å–µ—Ö' : 'üîí –ü–æ –¥–æ—Å—Ç—É–ø—É'}</span>
          </div>
          <div class="content">
            <div class="title">${title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
            <div class="desc">${safeDesc || '‚Äî'}</div>
            <div class="meta">
              <div class="chip">üìù ${items ?? 0} –∑–∞–¥–∞–Ω–∏–π</div>
              ${type==='textbook' ? '<div class="chip">üìö –£—á–µ–±–Ω–∏–∫</div>' : '<div class="chip">üß© –ö—Ä–æ—Å—Å–≤–æ—Ä–¥</div>'}
            </div>
          </div>
        </a>
      `;
    }

    async function loadTextbooks(supabase, user){
      clearError();
      const grid = E('textbooksGrid');
      grid.innerHTML = '';
      E('textbooksEmpty').style.display='none';

      // –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤—Å–µ–º –ò–õ–ò –≤—ã–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      const [{ data: allTextbooks, error: tErr }, { data: tAccess }] = await Promise.all([
        supabase.from('textbooks').select('id,title,description,cover_image_url,is_available').eq('is_active', true).order('order_index'),
        supabase.from('textbook_access').select('textbook_id').eq('user_id', user.id)
      ]);
      if(tErr){ showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–µ–±–Ω–∏–∫–æ–≤: '+tErr.message); return; }

      const allowedIds = new Set([...(tAccess?.map(a=>a.textbook_id)||[])]);
      const list = (allTextbooks||[]).filter(t => t.is_available || allowedIds.has(t.id));

      // –ø–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞–Ω–∏–π
      const ids = list.map(x=>x.id);
      let countBy = {};
      if(ids.length){
        const { data: ass } = await supabase
          .from('assignments').select('id,textbook_id').in('textbook_id', ids);
        (ass||[]).forEach(a=>{
          countBy[a.textbook_id] = (countBy[a.textbook_id]||0)+1;
        });
      }

      if(!list.length){ E('textbooksEmpty').style.display='block'; return; }

      grid.innerHTML = list.map(t => cardHTML({
        id: t.id,
        title: t.title,
        description: t.description,
        cover: t.cover_image_url || null,   // –≤–∞–∂–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º cover_image_url –∫–∞–∫ –µ—Å—Ç—å (–ø—É–±–ª–∏—á–Ω—ã–π)
        items: countBy[t.id]||0,
        isAvailable: t.is_available,
        type: 'textbook'
      })).join('');
    }

    async function loadCrosswords(supabase, user){
      clearError();
      const grid = E('crosswordsGrid');
      grid.innerHTML = '';
      E('crosswordsEmpty').style.display='none';

      const [{ data: allCross, error: cErr }, { data: cAccess }] = await Promise.all([
        supabase.from('crosswords').select('id,title,description,cover_image_url,is_available').eq('is_active', true).order('order_index'),
        supabase.from('crossword_access').select('crossword_id').eq('user_id', user.id)
      ]);
      if(cErr){ showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–æ–≤: '+cErr.message); return; }

      const allowedIds = new Set([...(cAccess?.map(a=>a.crossword_id)||[])]);
      const list = (allCross||[]).filter(x => x.is_available || allowedIds.has(x.id));

      // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞–Ω–∏–π
      const ids = list.map(x=>x.id);
      let countBy = {};
      if(ids.length){
        const { data: ass } = await supabase
          .from('assignments').select('id,crossword_id').in('crossword_id', ids);
        (ass||[]).forEach(a=>{
          countBy[a.crossword_id] = (countBy[a.crossword_id]||0)+1;
        });
      }

      if(!list.length){ E('crosswordsEmpty').style.display='block'; return; }

      grid.innerHTML = list.map(x => cardHTML({
        id: x.id,
        title: x.title,
        description: x.description,
        cover: x.cover_image_url || null,  // –≤–∞–∂–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        items: countBy[x.id]||0,
        isAvailable: x.is_available,
        type: 'crossword'
      })).join('');
    }

    if(window.SUPABASE_URL){ initApp(); }
    else{
      window.addEventListener('configLoaded', initApp);
    }
  </script>
</body>
</html>
