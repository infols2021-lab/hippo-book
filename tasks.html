<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–ó–∞–¥–∞–Ω–∏—è ‚Äî Edu Platform</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .tasks-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tasks-tab {
      padding: 12px 20px;
      background: var(--card);
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .tasks-tab.active {
      background: var(--accent2);
      color: white;
      border-color: var(--accent2);
    }
    .tasks-section {
      display: none;
    }
    .tasks-section.active {
      display: block;
    }

    /* –≠–ª–µ–º–µ–Ω—Ç—ã —É—á–µ–±–Ω–∏–∫–æ–≤ –∏ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–æ–≤ */
    .textbook-item, .crossword-item {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }
    .textbook-item:hover, .crossword-item:hover {
      border-color: var(--accent2);
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    .textbook-header, .crossword-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .tasks-list {
      margin-top: 15px;
    }
    .task-card {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }
    .task-card:hover {
      background: #e9ecef;
      transform: translateY(-2px);
    }
    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .task-actions {
      display: flex;
      gap: 8px;
    }
    .task-stats {
      display: flex;
      gap: 10px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .stat-badge {
      background: var(--bg1);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }

    /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –±–ª–æ–∫–∏ */
    .info-card {
      background: #e7f3ff;
      border: 1px solid #b3d9ff;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .warning-card {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ */
    .progress-indicator {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }
    .progress-completed {
      background: #d4edda;
      color: #155724;
    }
    .progress-available {
      background: #d1ecf1;
      color: #0c5460;
    }
    .progress-locked {
      background: #f8d7da;
      color: #721c24;
    }

    .loading { 
      text-align: center; 
      padding: 40px; 
      display: none;
    }
    .spinner { 
      border: 4px solid #f3f3f3; 
      border-top: 4px solid var(--accent2); 
      border-radius: 50%; 
      width: 40px; 
      height: 40px; 
      animation: spin 2s linear infinite; 
      margin: 0 auto 20px; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    .error { 
      background: #ffebee; 
      color: #c62828; 
      padding: 20px; 
      border-radius: 8px; 
      margin: 20px; 
      text-align: center; 
      display: none; 
    }

    /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
    @media (max-width: 768px) {
      .tasks-tabs {
        flex-direction: column;
        gap: 5px;
      }
      
      .tasks-tab {
        text-align: center;
        padding: 15px;
      }
      
      .textbook-header, .crossword-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }
      
      .task-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }
      
      .task-actions {
        width: 100%;
        justify-content: flex-start;
      }
      
      .task-stats {
        justify-content: flex-start;
      }
    }

    @media (max-width: 480px) {
      .textbook-item, .crossword-item {
        padding: 15px;
      }
      
      .task-card {
        padding: 12px;
      }
      
      .stat-badge {
        font-size: 11px;
        padding: 3px 6px;
      }
    }
  </style>
  
  <script src="/load-config.js"></script>
</head>
<body>
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞–Ω–∏—è...</p>
  </div>
  
  <div id="errorMessage" class="error"></div>
  
  <div id="mainContent" style="display: none;">
    <div class="container">
      <div class="header">
        <div class="logo">
          <div class="mark">EP</div>
          <div>
            <h3>–ó–∞–¥–∞–Ω–∏—è</h3>
            <div class="small-muted">–í—ã–±–∏—Ä–∞–π –∏ –ø—Ä–æ—Ö–æ–¥–∏</div>
          </div>
        </div>
        <div class="nav">
          <button class="btn" onclick="location.href='/profile.html'">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
          <button class="btn secondary" id="logoutBtn">üö™ –í—ã–π—Ç–∏</button>
        </div>
      </div>

      <div class="info-card">
        <strong>üí° –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞–Ω–∏—è—Ö:</strong>
        <p style="margin: 8px 0 0 0; font-size: 14px;">
          ‚Ä¢ <strong>–£—á–µ–±–Ω–∏–∫–∏</strong> - —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è –∏ —Ç–µ—Å—Ç—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞<br>
          ‚Ä¢ <strong>–ö—Ä–æ—Å—Å–≤–æ—Ä–¥—ã</strong> - –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è –∑–Ω–∞–Ω–∏–π<br>
          ‚Ä¢ –ü—Ä–æ–≥—Ä–µ—Å—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏–π
        </p>
      </div>

      <div class="warning-card">
        <strong>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!</strong>
        <p style="margin: 8px 0 0 0; font-size: 14px;">
          –ó–∞–¥–∞–Ω–∏–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ". 
          –£ –≤–∞—Å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è.
        </p>
      </div>

      <div class="card">
        <div class="tasks-tabs">
          <div class="tasks-tab active" data-tab="textbooks">üìö –£—á–µ–±–Ω–∏–∫–∏</div>
          <div class="tasks-tab" data-tab="crosswords">üß© –ö—Ä–æ—Å—Å–≤–æ—Ä–¥—ã</div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è —É—á–µ–±–Ω–∏–∫–æ–≤ -->
        <div class="tasks-section active" id="textbooks-section">
          <div id="textbooksList">
            <div class="loading" style="padding: 40px;">
              <div class="spinner"></div>
              <p>–ó–∞–≥—Ä—É–∂–∞–µ–º —É—á–µ–±–Ω–∏–∫–∏...</p>
            </div>
          </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–æ–≤ -->
        <div class="tasks-section" id="crosswords-section">
          <div id="crosswordsList">
            <div class="loading" style="padding: 40px;">
              <div class="spinner"></div>
              <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –∫—Ä–æ—Å—Å–≤–æ—Ä–¥—ã...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    document.getElementById('loading').style.display = 'block';
    
    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorMessage').style.display = 'block';
      document.getElementById('loading').style.display = 'none';
    }
    
    function showContent() {
      document.getElementById('mainContent').style.display = 'block';
      document.getElementById('loading').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
    }
    
    async function initApp() {
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
        showError('‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Supabase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.');
        return false;
      }
      
      try {
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
        const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ localStorage
        const userStr = localStorage.getItem('currentUser');
        if (!userStr) {
          location.href = '/login.html';
          return;
        }
        
        const user = JSON.parse(userStr);

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
        function initTasksTabs() {
          const tabs = document.querySelectorAll('.tasks-tab');
          
          tabs.forEach(tab => {
            tab.addEventListener('click', () => {
              const tabName = tab.getAttribute('data-tab');
              
              // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
              tabs.forEach(t => t.classList.remove('active'));
              document.querySelectorAll('.tasks-section').forEach(s => s.classList.remove('active'));
              
              // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
              tab.classList.add('active');
              document.getElementById(`${tabName}-section`).classList.add('active');
              
              // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
              if (tabName === 'textbooks') {
                loadTextbooks();
              } else if (tabName === 'crosswords') {
                loadCrosswords();
              }
            });
          });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–µ–±–Ω–∏–∫–æ–≤ –∏ –∑–∞–¥–∞–Ω–∏–π
        async function loadTextbooks() {
          const container = document.getElementById('textbooksList');
          
          try {
            container.innerHTML = '<div class="loading" style="padding: 40px;"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∂–∞–µ–º —É—á–µ–±–Ω–∏–∫–∏...</p></div>';
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —É—á–µ–±–Ω–∏–∫–∏ —Å –∏—Ö –∑–∞–¥–∞–Ω–∏—è–º–∏
            const { data: textbooks, error: textbooksError } = await supabase
              .from('textbooks')
              .select(`
                *,
                tasks (
                  id,
                  title,
                  type,
                  time_limit,
                  passing_score,
                  order_index,
                  is_active
                )
              `)
              .eq('is_active', true)
              .order('order_index', { ascending: true });
            
            if (textbooksError) throw textbooksError;
            
            if (!textbooks || textbooks.length === 0) {
              container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">üìö –£—á–µ–±–Ω–∏–∫–∏ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>';
              return;
            }
            
            let html = '';
            
            // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–µ–±–Ω–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –µ–≥–æ –∑–∞–¥–∞–Ω–∏—è
            for (const textbook of textbooks) {
              const activeTasks = textbook.tasks?.filter(task => task.is_active) || [];
              
              if (activeTasks.length === 0) continue;
              
              html += `
                <div class="textbook-item">
                  <div class="textbook-header">
                    <div>
                      <h3 style="margin: 0; color: #333;">${textbook.title}</h3>
                      <p class="small-muted" style="margin: 5px 0 0 0;">${textbook.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                      <p class="small-muted">–ó–∞–¥–∞–Ω–∏–π: ${activeTasks.length}</p>
                    </div>
                  </div>
                  <div class="tasks-list">
              `;
              
              // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–¥–∞–Ω–∏—è –ø–æ order_index
              activeTasks.sort((a, b) => a.order_index - b.order_index);
              
              // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
              for (const task of activeTasks) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –ª–∏ –∑–∞–¥–∞–Ω–∏–µ
                const { data: progress, error: progressError } = await supabase
                  .from('user_progress')
                  .select('is_completed, score')
                  .eq('user_id', user.id)
                  .eq('task_id', task.id)
                  .single();
                
                const isCompleted = progress?.is_completed || false;
                const score = progress?.score || 0;
                
                const taskTypeIcon = task.type === 'test' ? 'üìù' : 
                                   task.type === 'fill' ? '‚úçÔ∏è' : 'üß©';
                
                const progressIndicator = isCompleted ? 
                  `<span class="progress-indicator progress-completed">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ (${score}%)</span>` :
                  `<span class="progress-indicator progress-available">üìù –î–æ—Å—Ç—É–ø–Ω–æ</span>`;
                
                html += `
                  <div class="task-card">
                    <div class="task-header">
                      <div>
                        <strong>${taskTypeIcon} ${task.title}</strong>
                        ${progressIndicator}
                      </div>
                      <div class="task-actions">
                        <button class="btn btn-small start-task-btn" 
                                data-task-id="${task.id}" 
                                data-task-title="${task.title}">
                          ${isCompleted ? 'üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å' : 'üöÄ –ù–∞—á–∞—Ç—å'}
                        </button>
                      </div>
                    </div>
                    <div class="task-stats">
                      <span class="stat-badge">‚è±Ô∏è ${task.time_limit || 60} –º–∏–Ω</span>
                      <span class="stat-badge">üéØ ${task.passing_score || 80}% –¥–ª—è –∑–∞—á–µ—Ç–∞</span>
                      <span class="stat-badge">${taskTypeIcon} ${task.type === 'test' ? '–¢–µ—Å—Ç' : task.type === 'fill' ? '–ü—Ä–æ–ø—É—Å–∫–∏' : '–ö—Ä–æ—Å—Å–≤–æ—Ä–¥'}</span>
                    </div>
                  </div>
                `;
              }
              
              html += `
                  </div>
                </div>
              `;
            }
            
            container.innerHTML = html;
            
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞–Ω–∏–π
            document.querySelectorAll('.start-task-btn').forEach(btn => {
              btn.addEventListener('click', (e) => {
                const taskId = btn.getAttribute('data-task-id');
                const taskTitle = btn.getAttribute('data-task-title');
                
                if (confirm(`–ù–∞—á–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ "${taskTitle}"?\n\n–£ –≤–∞—Å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫. –ó–∞–¥–∞–Ω–∏–µ –±—É–¥–µ—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ".`)) {
                  window.location.href = `/task.html?id=${taskId}`;
                }
              });
            });
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–µ–±–Ω–∏–∫–æ–≤:', error);
            container.innerHTML = '<p style="text-align: center; padding: 20px; color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–µ–±–Ω–∏–∫–æ–≤</p>';
          }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–æ–≤ –∏ –∑–∞–¥–∞–Ω–∏–π
        async function loadCrosswords() {
          const container = document.getElementById('crosswordsList');
          
          try {
            container.innerHTML = '<div class="loading" style="padding: 40px;"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∂–∞–µ–º –∫—Ä–æ—Å—Å–≤–æ—Ä–¥—ã...</p></div>';
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥—ã —Å –∏—Ö –∑–∞–¥–∞–Ω–∏—è–º–∏
            const { data: crosswords, error: crosswordsError } = await supabase
              .from('crosswords')
              .select(`
                *,
                tasks (
                  id,
                  title,
                  type,
                  time_limit,
                  passing_score,
                  order_index,
                  is_active
                )
              `)
              .eq('is_active', true)
              .order('order_index', { ascending: true });
            
            if (crosswordsError) throw crosswordsError;
            
            if (!crosswords || crosswords.length === 0) {
              container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">üß© –ö—Ä–æ—Å—Å–≤–æ—Ä–¥—ã –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>';
              return;
            }
            
            let html = '';
            
            // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –µ–≥–æ –∑–∞–¥–∞–Ω–∏—è
            for (const crossword of crosswords) {
              const activeTasks = crossword.tasks?.filter(task => task.is_active) || [];
              
              if (activeTasks.length === 0) continue;
              
              html += `
                <div class="crossword-item">
                  <div class="crossword-header">
                    <div>
                      <h3 style="margin: 0; color: #333;">${crossword.title}</h3>
                      <p class="small-muted" style="margin: 5px 0 0 0;">${crossword.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                      <p class="small-muted">–ó–∞–¥–∞–Ω–∏–π: ${activeTasks.length}</p>
                    </div>
                  </div>
                  <div class="tasks-list">
              `;
              
              // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–¥–∞–Ω–∏—è –ø–æ order_index
              activeTasks.sort((a, b) => a.order_index - b.order_index);
              
              // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
              for (const task of activeTasks) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –ª–∏ –∑–∞–¥–∞–Ω–∏–µ
                const { data: progress, error: progressError } = await supabase
                  .from('user_progress')
                  .select('is_completed, score')
                  .eq('user_id', user.id)
                  .eq('task_id', task.id)
                  .single();
                
                const isCompleted = progress?.is_completed || false;
                const score = progress?.score || 0;
                
                const taskTypeIcon = task.type === 'test' ? 'üìù' : 
                                   task.type === 'fill' ? '‚úçÔ∏è' : 'üß©';
                
                const progressIndicator = isCompleted ? 
                  `<span class="progress-indicator progress-completed">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ (${score}%)</span>` :
                  `<span class="progress-indicator progress-available">üìù –î–æ—Å—Ç—É–ø–Ω–æ</span>`;
                
                html += `
                  <div class="task-card">
                    <div class="task-header">
                      <div>
                        <strong>${taskTypeIcon} ${task.title}</strong>
                        ${progressIndicator}
                      </div>
                      <div class="task-actions">
                        <button class="btn btn-small start-task-btn" 
                                data-task-id="${task.id}" 
                                data-task-title="${task.title}">
                          ${isCompleted ? 'üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å' : 'üöÄ –ù–∞—á–∞—Ç—å'}
                        </button>
                      </div>
                    </div>
                    <div class="task-stats">
                      <span class="stat-badge">‚è±Ô∏è ${task.time_limit || 60} –º–∏–Ω</span>
                      <span class="stat-badge">üéØ ${task.passing_score || 80}% –¥–ª—è –∑–∞—á–µ—Ç–∞</span>
                      <span class="stat-badge">${taskTypeIcon} ${task.type === 'test' ? '–¢–µ—Å—Ç' : task.type === 'fill' ? '–ü—Ä–æ–ø—É—Å–∫–∏' : '–ö—Ä–æ—Å—Å–≤–æ—Ä–¥'}</span>
                    </div>
                  </div>
                `;
              }
              
              html += `
                  </div>
                </div>
              `;
            }
            
            container.innerHTML = html;
            
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞–Ω–∏–π
            document.querySelectorAll('.start-task-btn').forEach(btn => {
              btn.addEventListener('click', (e) => {
                const taskId = btn.getAttribute('data-task-id');
                const taskTitle = btn.getAttribute('data-task-title');
                
                if (confirm(`–ù–∞—á–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ "${taskTitle}"?\n\n–£ –≤–∞—Å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫. –ó–∞–¥–∞–Ω–∏–µ –±—É–¥–µ—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ".`)) {
                  window.location.href = `/task.html?id=${taskId}`;
                }
              });
            });
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–æ–≤:', error);
            container.innerHTML = '<p style="text-align: center; padding: 20px; color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–æ–≤</p>';
          }
        }

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        document.getElementById('logoutBtn').addEventListener('click', async () => {
          if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
            localStorage.removeItem('currentUser');
            location.href = '/login.html';
          }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∫–ª–∞–¥–∫–∏
        initTasksTabs();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—á–µ–±–Ω–∏–∫–∏ (–∞–∫—Ç–∏–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        await loadTextbooks();
        
        showContent();
        return true;
        
      } catch (error) {
        showError('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π: ' + error.message);
        return false;
      }
    }
    
    if (window.SUPABASE_URL) {
      initApp();
    } else {
      const timeout = setTimeout(() => {
        showError('‚ùå –¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏');
      }, 1000);
      
      window.addEventListener('configLoaded', () => {
        clearTimeout(timeout);
        initApp();
      });
    }
  </script>
</body>
</html>