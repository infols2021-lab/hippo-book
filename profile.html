<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–ü—Ä–æ—Ñ–∏–ª—å ‚Äî Edu Platform</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* –°–ò–°–¢–ï–ú–ê –§–û–ù–ê */
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      font-family: 'Poppins', "Comic Sans MS", sans-serif;
      color: #1f2937;
    }

    .container {
      width: 95%;
      max-width: 1100px;
      margin: 20px auto;
      position: relative;
      z-index: 2;
    }

    /* –í–∫–ª–∞–¥–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ */
    .progress-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .progress-tab {
      padding: 12px 20px;
      background: var(--card);
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .progress-tab.active {
      background: var(--accent2);
      color: white;
      border-color: var(--accent2);
    }
    .progress-section {
      display: none;
    }
    .progress-section.active {
      display: block;
    }

    /* –≠–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ */
    .progress-item {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }
    .progress-item:hover {
      border-color: var(--accent2);
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .progress-stats {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    .progress-badge {
      background: var(--bg1);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }
    .progress-bar-container {
      width: 100%;
      height: 8px;
      background: #f0f0f0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(135deg, var(--accent2), #6dd3c0);
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    .progress-percentage {
      font-size: 14px;
      color: var(--muted);
      margin-top: 5px;
      text-align: right;
    }

    /* –ê–≤–∞—Ç–∞—Ä –±–µ–∑ –∫–ª—é—á–µ–π */
    .profile-avatar {
      border: 4px solid #ffa726;
      box-shadow: 
        0 12px 32px rgba(255, 152, 0, 0.2),
        inset 0 0 20px rgba(255, 193, 7, 0.1);
      transition: all 0.5s ease;
    }
    .profile-avatar:hover {
      transform: scale(1.02);
      box-shadow: 
        0 16px 40px rgba(255, 152, 0, 0.3),
        inset 0 0 30px rgba(255, 193, 7, 0.2);
    }

    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    #mainContent {
      animation: fadeInUp 0.8s ease-out;
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ */
    .loading { 
      text-align: center; 
      padding: 40px; 
      display: none;
      background: white;
      border-radius: 16px;
      margin: 20px;
    }
    .spinner { 
      border: 4px solid #f3f3f3; 
      border-top: 4px solid var(--accent2); 
      border-radius: 50%; 
      width: 40px; 
      height: 40px; 
      animation: spin 2s linear infinite; 
      margin: 0 auto 20px; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    .error { 
      background: #ffebee; 
      color: #c62828; 
      padding: 20px; 
      border-radius: 8px; 
      margin: 20px; 
      text-align: center; 
      display: none; 
    }

    /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
    @media (max-width: 768px) {
      .container {
        width: 100%;
        margin: 0;
        padding: 10px;
      }
      
      .progress-tabs {
        flex-direction: column;
        gap: 5px;
      }
      
      .progress-tab {
        text-align: center;
        padding: 15px;
      }
      
      .progress-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }
      
      .progress-stats {
        width: 100%;
        justify-content: space-between;
      }
      
      .profile-avatar {
        width: 180px;
        height: 180px;
      }
    }

    @media (max-width: 480px) {
      .profile-avatar {
        width: 150px;
        height: 150px;
      }
      
      .progress-badge {
        font-size: 12px;
        padding: 4px 8px;
      }
      
      .progress-item {
        padding: 15px;
      }
    }
  </style>
  
  <script src="/load-config.js"></script>
</head>
<body id="profileBody">
  <div class="container">
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å...</p>
    </div>
    
    <div id="errorMessage" class="error"></div>
    
    <div id="mainContent" style="display: none;">
      <div class="header">
        <div class="logo">
          <div class="mark" style="background: linear-gradient(135deg, #ff9800, #f57c00);">EP</div>
          <div>
            <h3 style="background: linear-gradient(135deg, #ff9800, #e65100); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0;">Edu Platform</h3>
            <div class="small-muted">üìä –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è</div>
          </div>
        </div>
        <div class="nav">
          <button class="btn" onclick="location.href='/tasks.html'" style="background: linear-gradient(135deg, #ff9800, #f57c00);">üìö –ö –∑–∞–¥–∞–Ω–∏—è–º</button>
          <button class="btn secondary" id="logoutBtn" style="background: linear-gradient(135deg, #795548, #5d4037);">üö™ –í—ã–π—Ç–∏</button>
        </div>
      </div>

      <div class="grid-2">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ø—Ä–æ—Ñ–∏–ª—å -->
        <div class="card profile-card">
          <div class="profile-avatar" role="img" aria-label="–ü—Ä–æ—Ñ–∏–ª—å —É—á–µ–Ω–∏–∫–∞">
            <svg viewBox="0 0 200 200" preserveAspectRatio="none" style="width:100%;height:100%;border-radius:12px">
              <defs>
                <linearGradient id="avatarGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#fff8e6;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#ffecb3;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="faceGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#ffd166;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#ffb74d;stop-opacity:1" />
                </linearGradient>
              </defs>
              <rect width="100%" height="100%" fill="url(#avatarGradient)"/>
              <circle cx="100" cy="80" r="28" fill="url(#faceGradient)"/>
              <g transform="translate(22,120)">
                <ellipse cx="30" cy="10" rx="30" ry="12" fill="#ffcc80"/>
                <ellipse cx="70" cy="10" rx="30" ry="12" fill="#ffcc80"/>
              </g>
            </svg>
          </div>

          <div class="profile-info">
            <h3 id="fullname" style="color: #5d4037; margin-bottom: 8px;">–£—á–µ–Ω–∏–∫</h3>
            <div class="small-muted" id="emailText" style="color: #8d6e63;">‚Äî</div>
            <div style="margin-top:16px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
              <span class="badge" id="totalProgress" style="background: linear-gradient(135deg, #ffa726, #fb8c00); padding: 8px 16px;">üìä –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å: 0%</span>
              <span class="badge" id="completedTasks" style="background: linear-gradient(135deg, #795548, #5d4037); padding: 8px 16px;">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: 0 –∑–∞–¥–∞–Ω–∏–π</span>
            </div>
          </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ø—Ä–æ–≥—Ä–µ—Å—Å -->
        <div>
          <div class="card">
            <h3 style="color: #e65100; margin-bottom: 16px;">üìä –ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è</h3>
            
            <div class="progress-tabs">
              <div class="progress-tab active" data-tab="textbooks">üìö –£—á–µ–±–Ω–∏–∫–∏</div>
              <div class="progress-tab" data-tab="crosswords">üß© –ö—Ä–æ—Å—Å–≤–æ—Ä–¥—ã</div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è —É—á–µ–±–Ω–∏–∫–æ–≤ -->
            <div class="progress-section active" id="textbooks-section">
              <div id="textbooksProgress">
                <div class="loading" style="padding: 20px;">
                  <div class="spinner" style="width: 24px; height: 24px;"></div>
                  <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —É—á–µ–±–Ω–∏–∫–∞–º...</p>
                </div>
              </div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–æ–≤ -->
            <div class="progress-section" id="crosswords-section">
              <div id="crosswordsProgress">
                <div class="loading" style="padding: 20px;">
                  <div class="spinner" style="width: 24px; height: 24px;"></div>
                  <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞–º...</p>
                </div>
              </div>
            </div>
          </div>

          <div style="height:18px"></div>

          <div class="card">
            <h3 style="color: #e65100; margin-bottom: 16px;">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <p class="small-muted" style="color: #5d4037; line-height: 1.5;">üéØ –ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π –≤ –∫–∞–∂–¥–æ–º —É—á–µ–±–Ω–∏–∫–µ –∏ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–µ.</p>
            <p class="small-muted" style="color: #5d4037; line-height: 1.5;">üìö –£—á–µ–±–Ω–∏–∫–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è –∏ —Ç–µ—Å—Ç—ã.</p>
            <p class="small-muted" style="color: #5d4037; line-height: 1.5;">üß© –ö—Ä–æ—Å—Å–≤–æ—Ä–¥—ã - —ç—Ç–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞.</p>
            <p class="small-muted" style="color: #5d4037; line-height: 1.5;"><strong>üí° –°–æ–≤–µ—Ç:</strong> –í—ã–ø–æ–ª–Ω—è–π—Ç–µ –∑–∞–¥–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ª—É—á—à–µ–≥–æ —É—Å–≤–æ–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    document.getElementById('loading').style.display = 'block';
    
    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorMessage').style.display = 'block';
      document.getElementById('loading').style.display = 'none';
    }
    
    function showContent() {
      document.getElementById('mainContent').style.display = 'block';
      document.getElementById('loading').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
    }
    
    async function initApp() {
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
        showError('‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Supabase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.');
        return false;
      }
      
      try {
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
        const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ localStorage
        const userStr = localStorage.getItem('currentUser');
        if (!userStr) {
          location.href = '/login.html';
          return;
        }
        
        const user = JSON.parse(userStr);

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ–Ω–∞
        async function loadProfileBackground() {
          try {
            const { data: background, error } = await supabase
              .from('backgrounds')
              .select('image_url')
              .eq('is_active', true)
              .order('created_at', { ascending: false })
              .limit(1)
              .single();

            if (!error && background && background.image_url) {
              document.getElementById('profileBody').style.backgroundImage = `url('${background.image_url}')`;
            }
          } catch (error) {
            console.log('–§–æ–Ω –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω:', error.message);
          }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
        function initProgressTabs() {
          const tabs = document.querySelectorAll('.progress-tab');
          
          tabs.forEach(tab => {
            tab.addEventListener('click', () => {
              const tabName = tab.getAttribute('data-tab');
              
              // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
              tabs.forEach(t => t.classList.remove('active'));
              document.querySelectorAll('.progress-section').forEach(s => s.classList.remove('active'));
              
              // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
              tab.classList.add('active');
              document.getElementById(`${tabName}-section`).classList.add('active');
              
              // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
              if (tabName === 'textbooks') {
                loadTextbooksProgress();
              } else if (tabName === 'crosswords') {
                loadCrosswordsProgress();
              }
            });
          });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ —É—á–µ–±–Ω–∏–∫–∞–º
        async function loadTextbooksProgress() {
          const container = document.getElementById('textbooksProgress');
          
          try {
            container.innerHTML = '<div class="loading" style="padding: 20px;"><div class="spinner" style="width: 24px; height: 24px;"></div><p>–ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —É—á–µ–±–Ω–∏–∫–∞–º...</p></div>';
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —É—á–µ–±–Ω–∏–∫–∏
            const { data: textbooks, error: textbooksError } = await supabase
              .from('textbooks')
              .select('*')
              .eq('is_active', true)
              .order('order_index', { ascending: true });
            
            if (textbooksError) throw textbooksError;
            
            if (!textbooks || textbooks.length === 0) {
              container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">üìö –£—á–µ–±–Ω–∏–∫–∏ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>';
              return;
            }
            
            let html = '';
            let totalCompleted = 0;
            let totalTasks = 0;
            
            // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–µ–±–Ω–∏–∫–∞ –ø–æ–ª—É—á–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            for (const textbook of textbooks) {
              // –ü–æ–ª—É—á–∞–µ–º –∑–∞–¥–∞–Ω–∏—è —É—á–µ–±–Ω–∏–∫–∞
              const { data: tasks, error: tasksError } = await supabase
                .from('tasks')
                .select('id')
                .eq('textbook_id', textbook.id)
                .eq('is_active', true);
              
              if (tasksError) throw tasksError;
              
              const totalTextbookTasks = tasks?.length || 0;
              totalTasks += totalTextbookTasks;
              
              // –ü–æ–ª—É—á–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è
              const { data: completedTasks, error: progressError } = await supabase
                .from('user_progress')
                .select('task_id')
                .eq('user_id', user.id)
                .eq('is_completed', true)
                .in('task_id', tasks?.map(t => t.id) || []);
              
              if (progressError) throw progressError;
              
              const completedTextbookTasks = completedTasks?.length || 0;
              totalCompleted += completedTextbookTasks;
              
              const percentage = totalTextbookTasks > 0 ? Math.round((completedTextbookTasks / totalTextbookTasks) * 100) : 0;
              
              html += `
                <div class="progress-item">
                  <div class="progress-header">
                    <div>
                      <h4 style="margin: 0; color: #333;">${textbook.title}</h4>
                      <p class="small-muted" style="margin: 5px 0 0 0;">${textbook.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                    </div>
                    <div class="progress-stats">
                      <span class="progress-badge" style="background: ${percentage === 100 ? '#e8f5e8' : '#e3f2fd'}; color: ${percentage === 100 ? '#2e7d32' : '#1976d2'};">${completedTextbookTasks}/${totalTextbookTasks}</span>
                      <span class="progress-badge" style="background: #fff3cd; color: #856404;">${percentage}%</span>
                    </div>
                  </div>
                  <div class="progress-bar-container">
                    <div class="progress-bar" style="width: ${percentage}%; background: ${percentage === 100 ? 'linear-gradient(135deg, #4caf50, #66bb6a)' : 'linear-gradient(135deg, var(--accent2), #6dd3c0)'};"></div>
                  </div>
                  <div class="progress-percentage">
                    ${percentage === 100 ? '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ' : `–í—ã–ø–æ–ª–Ω–µ–Ω–æ ${percentage}%`}
                  </div>
                </div>
              `;
            }
            
            container.innerHTML = html;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const totalPercentage = totalTasks > 0 ? Math.round((totalCompleted / totalTasks) * 100) : 0;
            document.getElementById('totalProgress').textContent = `üìä –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å: ${totalPercentage}%`;
            document.getElementById('completedTasks').textContent = `‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${totalCompleted} –∑–∞–¥–∞–Ω–∏–π`;
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —É—á–µ–±–Ω–∏–∫–æ–≤:', error);
            container.innerHTML = '<p style="text-align: center; padding: 20px; color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</p>';
          }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞–º
        async function loadCrosswordsProgress() {
          const container = document.getElementById('crosswordsProgress');
          
          try {
            container.innerHTML = '<div class="loading" style="padding: 20px;"><div class="spinner" style="width: 24px; height: 24px;"></div><p>–ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞–º...</p></div>';
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥—ã
            const { data: crosswords, error: crosswordsError } = await supabase
              .from('crosswords')
              .select('*')
              .eq('is_active', true)
              .order('order_index', { ascending: true });
            
            if (crosswordsError) throw crosswordsError;
            
            if (!crosswords || crosswords.length === 0) {
              container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">üß© –ö—Ä–æ—Å—Å–≤–æ—Ä–¥—ã –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>';
              return;
            }
            
            let html = '';
            let totalCompleted = 0;
            let totalTasks = 0;
            
            // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞ –ø–æ–ª—É—á–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            for (const crossword of crosswords) {
              // –ü–æ–ª—É—á–∞–µ–º –∑–∞–¥–∞–Ω–∏—è –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞
              const { data: tasks, error: tasksError } = await supabase
                .from('tasks')
                .select('id')
                .eq('crossword_id', crossword.id)
                .eq('is_active', true);
              
              if (tasksError) throw tasksError;
              
              const totalCrosswordTasks = tasks?.length || 0;
              totalTasks += totalCrosswordTasks;
              
              // –ü–æ–ª—É—á–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è
              const { data: completedTasks, error: progressError } = await supabase
                .from('user_progress')
                .select('task_id')
                .eq('user_id', user.id)
                .eq('is_completed', true)
                .in('task_id', tasks?.map(t => t.id) || []);
              
              if (progressError) throw progressError;
              
              const completedCrosswordTasks = completedTasks?.length || 0;
              totalCompleted += completedCrosswordTasks;
              
              const percentage = totalCrosswordTasks > 0 ? Math.round((completedCrosswordTasks / totalCrosswordTasks) * 100) : 0;
              
              html += `
                <div class="progress-item">
                  <div class="progress-header">
                    <div>
                      <h4 style="margin: 0; color: #333;">${crossword.title}</h4>
                      <p class="small-muted" style="margin: 5px 0 0 0;">${crossword.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                    </div>
                    <div class="progress-stats">
                      <span class="progress-badge" style="background: ${percentage === 100 ? '#e8f5e8' : '#f3e5f5'}; color: ${percentage === 100 ? '#2e7d32' : '#7b1fa2'};">${completedCrosswordTasks}/${totalCrosswordTasks}</span>
                      <span class="progress-badge" style="background: #fff3cd; color: #856404;">${percentage}%</span>
                    </div>
                  </div>
                  <div class="progress-bar-container">
                    <div class="progress-bar" style="width: ${percentage}%; background: ${percentage === 100 ? 'linear-gradient(135deg, #4caf50, #66bb6a)' : 'linear-gradient(135deg, #7b1fa2, #9c27b0)'};"></div>
                  </div>
                  <div class="progress-percentage">
                    ${percentage === 100 ? '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ' : `–í—ã–ø–æ–ª–Ω–µ–Ω–æ ${percentage}%`}
                  </div>
                </div>
              `;
            }
            
            container.innerHTML = html;
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–æ–≤:', error);
            container.innerHTML = '<p style="text-align: center; padding: 20px; color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</p>';
          }
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
        async function loadProfile() {
          document.getElementById('fullname').textContent = user.full_name || '–£—á–µ–Ω–∏–∫';
          document.getElementById('emailText').textContent = user.email;

          // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ–Ω –ø—Ä–æ—Ñ–∏–ª—è
          await loadProfileBackground();
          
          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∫–ª–∞–¥–∫–∏
          initProgressTabs();
          
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —É—á–µ–±–Ω–∏–∫–∞–º (–∞–∫—Ç–∏–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
          await loadTextbooksProgress();
        }

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        document.getElementById('logoutBtn').addEventListener('click', async () => {
          if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
            localStorage.removeItem('currentUser');
            location.href = '/login.html';
          }
        });

        await loadProfile();
        showContent();
        return true;
        
      } catch (error) {
        showError('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message);
        return false;
      }
    }
    
    if (window.SUPABASE_URL) {
      initApp();
    } else {
      const timeout = setTimeout(() => {
        showError('‚ùå –¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏');
      }, 1000);
      
      window.addEventListener('configLoaded', () => {
        clearTimeout(timeout);
        initApp();
      });
    }
  </script>
</body>
</html>