<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏ ‚Äî –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="css/style.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      font-family: 'Poppins', "Comic Sans MS", sans-serif;
      color: #1f2937;
    }

    .container {
      width: 95%;
      max-width: 1400px;
      margin: 20px auto;
      position: relative;
      z-index: 2;
    }

    .loading { 
      text-align: center; 
      padding: 40px; 
      display: none;
    }
    .spinner { 
      border: 4px solid #f3f3f3; 
      border-top: 4px solid var(--accent2); 
      border-radius: 50%; 
      width: 40px; 
      height: 40px; 
      animation: spin 2s linear infinite; 
      margin: 0 auto 20px; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    .error { 
      background: #ffebee; 
      color: #c62828; 
      padding: 20px; 
      border-radius: 8px; 
      margin: 20px; 
      text-align: center; 
      display: none; 
    }

    .requests-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .requests-table th, .requests-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }

    .requests-table th {
      background-color: var(--bg1);
      font-weight: 700;
    }

    .requests-table tr:last-child td {
      border-bottom: none;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 14px;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-processed {
      background: #d4edda;
      color: #155724;
    }

    .search-container {
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: end;
    }

    .search-container .form-group {
      margin-bottom: 0;
      flex: 1;
      min-width: 250px;
    }

    .search-container input {
      width: 100%;
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }

    .stats-bar {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .stat-card {
      background: white;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      flex: 1;
      min-width: 150px;
      text-align: center;
      border-left: 4px solid var(--accent2);
    }

    .stat-number {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--accent2);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      color: #666;
      font-weight: 600;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state p {
      margin: 10px 0;
    }

    @media (max-width: 768px) {
      .container {
        width: 100%;
        margin: 0;
        padding: 10px;
      }
      
      .requests-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      
      .search-container {
        flex-direction: column;
      }
      
      .search-container .form-group {
        width: 100%;
      }
      
      .stats-bar {
        flex-direction: column;
      }
    }

    @media (max-width: 480px) {
      .requests-table th, .requests-table td {
        padding: 8px 10px;
        font-size: 14px;
      }
      
      .btn-small {
        padding: 4px 8px;
        font-size: 12px;
      }
      
      .stat-card {
        padding: 12px 15px;
      }
      
      .stat-number {
        font-size: 1.5rem;
      }
    }
  </style>
  
  <script src="/load-config.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <div class="mark" style="background: linear-gradient(135deg, var(--accent2), #6dd3c0);">EK</div>
        <div>
          <h3 style="background: linear-gradient(135deg, var(--accent2), #6dd3c0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0;">Edu Keys</h3>
          <div class="small-muted">üéì –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∞–º–∏</div>
        </div>
      </div>
      <div class="nav">
        <button class="btn secondary" onclick="location.href='/admin.html'">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω–∫—É</button>
        <button class="btn secondary" id="logoutBtn">üö™ –í—ã–π—Ç–∏</button>
      </div>
    </div>

    <div class="card">
      <h2 style="color: var(--accent2); margin-bottom: 20px;">üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏ –Ω–∞ —É—á–µ–±–Ω–∏–∫–∏</h2>

      <div class="stats-bar">
        <div class="stat-card">
          <div class="stat-number" id="totalRequests">0</div>
          <div class="stat-label">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="pendingRequests">0</div>
          <div class="stat-label">–û–∂–∏–¥–∞—é—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="processedRequests">0</div>
          <div class="stat-label">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
        </div>
      </div>

      <div class="search-container">
        <div class="form-group">
          <label>–ü–æ–∏—Å–∫ –ø–æ –§–ò–û:</label>
          <input type="text" id="searchName" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û —É—á–µ–Ω–∏–∫–∞..." class="input">
        </div>
        <div class="form-group">
          <label>–ü–æ–∏—Å–∫ –ø–æ email:</label>
          <input type="text" id="searchEmail" placeholder="–í–≤–µ–¥–∏—Ç–µ email..." class="input">
        </div>
        <div class="form-group">
          <button class="btn" id="clearSearchBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫</button>
        </div>
      </div>

      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞—è–≤–∫–∏...</p>
      </div>
      
      <div id="errorMessage" class="error"></div>

      <div id="requestsContent" style="display: none;">
        <div style="overflow-x: auto;">
          <table class="requests-table" id="requestsTable">
            <thead>
              <tr>
                <th>‚Ññ</th>
                <th>–ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏</th>
                <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è</th>
                <th>–ö–ª–∞—Å—Å</th>
                <th>–¢–∏–ø—ã –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</th>
                <th>Email</th>
                <th>–§–ò–û —É—á–µ–Ω–∏–∫–∞</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody id="requestsTableBody">
              <!-- –ó–∞—è–≤–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å—é–¥–∞ -->
            </tbody>
          </table>
        </div>
        
        <div id="emptyState" class="empty-state" style="display: none;">
          <h3>üì≠ –ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</h3>
          <p>–ó–∞—è–≤–∫–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å</p>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    document.getElementById('loading').style.display = 'block';
    
    let currentUser = null;
    let supabaseClient = null;
    let allRequests = [];
    let searchTimeout = null;

    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorMessage').style.display = 'block';
      document.getElementById('loading').style.display = 'none';
    }
    
    function showContent() {
      document.getElementById('requestsContent').style.display = 'block';
      document.getElementById('loading').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
    }

    function showEmptyState() {
      document.getElementById('emptyState').style.display = 'block';
      document.getElementById('requestsTable').style.display = 'none';
      showContent();
    }

    function showTable() {
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('requestsTable').style.display = 'table';
      showContent();
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–ª–∞—Å—Å–∞
    function formatClassLevel(classLevel) {
      const classMap = {
        '1-2': '1-2 –∫–ª–∞—Å—Å',
        '3-4': '3-4 –∫–ª–∞—Å—Å',
        '5-6': '5-6 –∫–ª–∞—Å—Å',
        '7': '7 –∫–ª–∞—Å—Å',
        '8-9': '8-9 –∫–ª–∞—Å—Å',
        '10-11': '10-11 –∫–ª–∞—Å—Å (–¢–µ—Ö–Ω–∏–∫—É–º, –∫–æ–ª–ª–µ–¥–∂ - 1–π –∫—É—Ä—Å)',
        '12': '12 –∫–ª–∞—Å—Å (–¢–µ—Ö–Ω–∏–∫—É–º, –∫–æ–ª–ª–µ–¥–∂)'
      };
      return classMap[classLevel] || classLevel;
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ —É—á–µ–±–Ω–∏–∫–æ–≤
    function formatTextbookTypes(types) {
      if (!types || !Array.isArray(types)) return '';
      
      const typeMap = {
        '—É—á–µ–±–Ω–∏–∫': 'üìö –£—á–µ–±–Ω–∏–∫',
        '–∫—Ä–æ—Å—Å–≤–æ—Ä–¥': 'üß© –ö—Ä–æ—Å—Å–≤–æ—Ä–¥'
      };
      
      return types.map(type => typeMap[type] || type).join(', ');
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
    function formatDateTime(dateString) {
      return new Date(dateString).toLocaleString('ru-RU', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function updateStats() {
      const total = allRequests.length;
      const pending = allRequests.filter(req => !req.is_processed).length;
      const processed = allRequests.filter(req => req.is_processed).length;

      document.getElementById('totalRequests').textContent = total;
      document.getElementById('pendingRequests').textContent = pending;
      document.getElementById('processedRequests').textContent = processed;

      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤ –∞–¥–º–∏–Ω–∫–µ (–µ—Å–ª–∏ –º—ã –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ, —Ç–æ –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º localStorage)
      localStorage.setItem('pendingRequestsCount', pending);
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞—è–≤–æ–∫
    function filterRequests() {
      const nameFilter = document.getElementById('searchName').value.toLowerCase();
      const emailFilter = document.getElementById('searchEmail').value.toLowerCase();

      const filtered = allRequests.filter(request => {
        const matchesName = !nameFilter || 
          (request.full_name && request.full_name.toLowerCase().includes(nameFilter));
        const matchesEmail = !emailFilter || 
          (request.email && request.email.toLowerCase().includes(emailFilter));
        
        return matchesName && matchesEmail;
      });

      renderRequests(filtered);
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–∞—è–≤–æ–∫
    function renderRequests(requests) {
      const tbody = document.getElementById('requestsTableBody');
      tbody.innerHTML = '';

      if (!requests || requests.length === 0) {
        showEmptyState();
        return;
      }

      requests.forEach((request, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${index + 1}</strong></td>
          <td><strong>${request.request_number}</strong></td>
          <td>${formatDateTime(request.created_at)}</td>
          <td>${formatClassLevel(request.class_level)}</td>
          <td>${formatTextbookTypes(request.textbook_types)}</td>
          <td>${request.email}</td>
          <td>${request.full_name}</td>
          <td>
            <span class="status-badge ${request.is_processed ? 'status-processed' : 'status-pending'}">
              ${request.is_processed ? '‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–∞' : '‚è≥ –û–∂–∏–¥–∞–µ—Ç'}
            </span>
          </td>
          <td>
            ${!request.is_processed ? 
              `<button class="btn btn-small" data-process="${request.id}">‚úÖ –û–±—Ä–∞–±–æ—Ç–∞—Ç—å</button>` : 
              `<button class="btn btn-small btn-warning" data-unprocess="${request.id}">‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å –≤ –æ–∂–∏–¥–∞–Ω–∏–µ</button>`
            }
          </td>
        `;
        tbody.appendChild(row);
      });

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫
      tbody.querySelectorAll('[data-process]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const requestId = btn.getAttribute('data-process');
          await processRequest(requestId, true);
        });
      });

      tbody.querySelectorAll('[data-unprocess]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const requestId = btn.getAttribute('data-unprocess');
          await processRequest(requestId, false);
        });
      });

      showTable();
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞—è–≤–∫–∏
    async function processRequest(requestId, isProcessed) {
      try {
        const { error } = await supabaseClient
          .from('purchase_requests')
          .update({ 
            is_processed: isProcessed,
            processed_at: isProcessed ? new Date().toISOString() : null
          })
          .eq('id', requestId);

        if (error) throw error;

        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        const requestIndex = allRequests.findIndex(req => req.id === requestId);
        if (requestIndex !== -1) {
          allRequests[requestIndex].is_processed = isProcessed;
          allRequests[requestIndex].processed_at = isProcessed ? new Date().toISOString() : null;
        }

        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
        filterRequests();
        updateStats();

        showNotification(isProcessed ? '‚úÖ –ó–∞—è–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞' : '‚Ü©Ô∏è –ó–∞—è–≤–∫–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞ –≤ –æ–∂–∏–¥–∞–Ω–∏–µ');
      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏: ' + error.message);
      }
    }

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--accent2);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 10000;
        font-weight: 600;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∑–∞—è–≤–æ–∫
    async function loadAllRequests() {
      try {
        const { data: requests, error } = await supabaseClient
          .from('purchase_requests')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        allRequests = requests || [];
        filterRequests();
        updateStats();
      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫: ' + error.message);
      }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    async function checkAdmin(supabase) {
      try {
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        if (authError) throw authError;
        
        if (!user) {
          window.location.href = '/login.html';
          return false;
        }

        const { data: profile, error: profileError } = await supabase
          .from('profiles')
          .select('is_admin')
          .eq('id', user.id)
          .single();

        if (profileError) throw profileError;

        if (!profile?.is_admin) {
          showModal('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω', '–ù—É–∂–Ω—ã –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
          setTimeout(() => { window.location.href = '/profile.html'; }, 2000);
          return false;
        }

        return user;
      } catch (e) {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤: ' + (e?.message || e));
        setTimeout(() => { window.location.href = '/login.html'; }, 2000);
        return false;
      }
    }

    async function initApp() {
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
        showError('‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Supabase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.');
        return false;
      }
      
      try {
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
        supabaseClient = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        
        const user = await checkAdmin(supabaseClient);
        if (!user) return false;

        currentUser = user;

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('logoutBtn').addEventListener('click', async () => {
          if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
            await supabaseClient.auth.signOut();
            location.href = '/login.html';
          }
        });

        document.getElementById('clearSearchBtn').addEventListener('click', () => {
          document.getElementById('searchName').value = '';
          document.getElementById('searchEmail').value = '';
          filterRequests();
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–∏—Å–∫–∞
        document.getElementById('searchName').addEventListener('input', () => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(filterRequests, 350);
        });

        document.getElementById('searchEmail').addEventListener('input', () => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(filterRequests, 350);
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞—è–≤–∫–∏
        await loadAllRequests();
        return true;
        
      } catch (error) {
        showError('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message);
        return false;
      }
    }
    
    if (window.SUPABASE_URL) {
      initApp();
    } else {
      const timeout = setTimeout(() => {
        showError('‚ùå –¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏');
      }, 1000);
      
      window.addEventListener('configLoaded', () => {
        clearTimeout(timeout);
        initApp();
      });
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function showModal(title, text) {
      alert(`${title}\n\n${text}`);
    }
  </script>
</body>
</html>