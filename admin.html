<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Админ — Edu Keys</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .admin-container { width:95%; max-width:1200px; margin:20px auto; }
    .admin-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding:15px; background:var(--card); border-radius:16px; box-shadow:0 8px 26px rgba(0,0,0,0.08); }
    .admin-tabs { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
    .admin-tab { padding:12px 20px; background:var(--card); border-radius:12px; cursor:pointer; font-weight:700; box-shadow:0 4px 12px rgba(0,0,0,0.1); transition:all 0.2s; }
    .admin-tab.active { background:var(--accent2); color:white; }
    .admin-section { display:none; }
    .admin-section.active { display:block; }
    .admin-table { width:100%; border-collapse:collapse; margin-top:15px; background:var(--card); border-radius:12px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    .admin-table th, .admin-table td { padding:12px 15px; text-align:left; border-bottom:1px solid rgba(0,0,0,0.06); }
    .admin-table th { background-color:var(--bg1); font-weight:700; }
    .admin-table tr:last-child td { border-bottom:none; }
    .form-group { margin-bottom:15px; }
    .form-group label { display:block; margin-bottom:5px; font-weight:600; }
    .subtask-item { background:var(--bg1); padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid rgba(0,0,0,0.1); }
    .btn-danger { background:#e74c3c; }
    .btn-warning { background:#f39c12; }
    .btn-small { padding:6px 12px; font-size:14px; }
    .user-stats { display:flex; gap:10px; margin-top:5px; flex-wrap:wrap; }
    .stat-badge { background:var(--bg1); padding:4px 8px; border-radius:6px; font-size:12px; }
    .user-actions { display:flex; flex-direction:column; gap:5px; }
    .search-container { margin-bottom:15px; }
    .search-container input { width:100%; }
    .image-preview { max-width:200px; max-height:150px; border-radius:8px; margin:10px 0; display:none; }
    .upload-area { border:2px dashed #ccc; border-radius:8px; padding:20px; text-align:center; cursor:pointer; transition:border-color 0.3s; margin:10px 0; }
    .upload-area:hover { border-color:var(--accent2); }
    .upload-area.dragover { border-color:var(--accent2); background-color:rgba(78,205,196,0.1); }
    .upload-progress { width:100%; height:4px; background:#f0f0f0; border-radius:2px; margin:10px 0; display:none; }
    .upload-progress-bar { height:100%; background:var(--accent2); border-radius:2px; width:0%; transition:width 0.3s; }
    .time-limit-info { background:#e7f3ff; border:1px solid #b3d9ff; border-radius:8px; padding:10px; margin-top:5px; font-size:14px; }
    .question-type-selector { display:flex; gap:10px; margin-bottom:15px; }
    .type-btn { padding:10px 15px; border:2px solid #ddd; border-radius:8px; cursor:pointer; background:white; transition:all 0.3s; }
    .type-btn.active { border-color:var(--accent2); background:var(--accent2); color:white; }
    .fill-answer { padding:8px 12px; border:2px solid rgba(0,0,0,0.1); border-radius:8px; font-size:16px; width:100%; margin-top:5px; }
    .task-stats { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; }
    .task-type-indicator { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 5px; }
    .mcq-type { background: #e3f2fd; color: #1976d2; }
    .fill-type { background: #f3e5f5; color: #7b1fa2; }
    .mixed-type { background: #e8f5e8; color: #2e7d32; }
    .demo-type { background: #fff3cd; color: #856404; }
    .loading { 
      text-align: center; 
      padding: 40px; 
      display: none;
    }
    .spinner { 
      border: 4px solid #f3f3f3; 
      border-top: 4px solid var(--accent2); 
      border-radius: 50%; 
      width: 40px; 
      height: 40px; 
      animation: spin 2s linear infinite; 
      margin: 0 auto 20px; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    .error { 
      background: #ffebee; 
      color: #c62828; 
      padding: 20px; 
      border-radius: 8px; 
      margin: 20px; 
      text-align: center; 
      display: none; 
    }
    .config-loading { 
      text-align: center; 
      padding: 40px; 
    }

    /* Стили для управления фонами */
    .background-preview {
      max-width: 300px;
      max-height: 200px;
      border-radius: 12px;
      margin: 15px 0;
      border: 3px solid #f0f0f0;
    }
    .background-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 12px;
      margin-bottom: 12px;
      background: rgba(255,255,255,0.9);
      transition: all 0.3s ease;
    }
    .background-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .background-item img {
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
    }
    .background-info {
      flex: 1;
    }
    .background-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 120px;
    }
    .active-badge {
      background: #4caf50;
      color: white;
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }

    /* Новые стили для полей ввода в fill-вопросах */
    .fill-inputs-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 10px 0;
    }
    .fill-input-item {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .fill-input-item input {
      flex: 1;
      padding: 8px 12px;
      border: 2px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      font-size: 14px;
    }
    .remove-input-btn {
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .add-input-btn {
      background: var(--accent2);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 5px;
    }
    .input-count {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    /* Демо задания */
    .demo-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
    }
    .demo-checkbox input {
      width: auto;
    }
    .demo-info {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
      font-size: 14px;
    }

    /* Адаптивность для админ-панели */
    @media (max-width: 1024px) {
      .admin-container {
        width: 98%;
        margin: 15px auto;
      }
      
      .admin-table {
        font-size: 14px;
      }
      
      .admin-table th, 
      .admin-table td {
        padding: 8px 10px;
      }
      
      .admin-tabs {
        gap: 5px;
      }
      
      .admin-tab {
        padding: 10px 15px;
        font-size: 14px;
      }

      .background-item {
        flex-direction: column;
        text-align: center;
      }
      
      .background-actions {
        flex-direction: row;
        justify-content: center;
        min-width: auto;
      }

      .fill-input-item {
        flex-direction: column;
        gap: 5px;
      }
    }

    @media (max-width: 768px) {
      .admin-container {
        width: 100%;
        margin: 10px auto;
        padding: 0 10px;
      }
      
      .admin-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
        padding: 15px;
      }
      
      .admin-header h1 {
        font-size: 1.5rem;
      }
      
      .admin-tabs {
        flex-direction: column;
        gap: 5px;
      }
      
      .admin-tab {
        text-align: center;
        padding: 12px;
      }
      
      .admin-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
        font-size: 13px;
      }
      
      .admin-table th,
      .admin-table td {
        padding: 6px 8px;
        min-width: 120px;
      }
      
      .task-stats {
        padding: 10px;
      }
      
      .task-stats > div {
        flex-direction: column;
        gap: 10px;
      }
      
      .modal-body {
        width: 95%;
        margin: 10px;
        padding: 15px;
      }
      
      .form-group {
        margin-bottom: 12px;
      }
      
      .question-type-selector {
        flex-direction: column;
        gap: 8px;
      }
      
      .type-btn {
        padding: 12px;
        text-align: center;
      }
      
      .subtask-item {
        padding: 12px;
      }
      
      .user-actions {
        flex-direction: row;
        gap: 5px;
      }
      
      .user-actions .btn-small {
        padding: 4px 8px;
        font-size: 12px;
      }

      .user-stats {
        flex-direction: column;
        gap: 5px;
      }

      .background-preview {
        max-width: 100%;
      }
    }

    @media (max-width: 480px) {
      .admin-header h1 {
        font-size: 1.3rem;
      }
      
      .admin-table {
        font-size: 12px;
      }
      
      .admin-table th,
      .admin-table td {
        padding: 4px 6px;
        min-width: 100px;
      }
      
      .task-stats {
        font-size: 14px;
      }
      
      .admin-controls {
        flex-direction: column;
      }
      
      .admin-controls .btn {
        width: 100%;
      }
      
      .search-container input {
        font-size: 16px;
      }
      
      .subtask-item .form-group label {
        font-size: 14px;
      }
      
      .subtask-item input,
      .subtask-item textarea,
      .subtask-item select {
        font-size: 16px;
        padding: 10px 12px;
      }
      
      .upload-area {
        padding: 15px;
      }
      
      .upload-area p {
        font-size: 14px;
      }

      .modal-body {
        margin: 5px;
        padding: 10px;
      }
    }

    @media (max-height: 500px) and (orientation: landscape) {
      .admin-container {
        margin: 5px auto;
      }
      
      .admin-header {
        padding: 10px;
        margin-bottom: 10px;
      }
      
      .card {
        padding: 12px;
      }
    }

    @media (max-width: 360px) {
      .admin-container {
        padding: 0 5px;
      }
      
      .admin-header {
        padding: 10px;
      }
      
      .admin-tab {
        padding: 10px;
        font-size: 13px;
      }
      
      .btn {
        padding: 8px 12px;
        font-size: 14px;
      }
      
      .task-stats {
        font-size: 12px;
      }
    }
  </style>
  
  <script src="/load-config.js"></script>
</head>
<body>
  <div id="configLoading" class="config-loading">
    <div class="spinner"></div>
    <p>🔄 Загружаем конфигурацию админ-панели...</p>
  </div>
  
  <div id="errorMessage" class="error"></div>
  
  <div id="mainContent" style="display: none;">
    <div class="admin-container">
      <div class="admin-header">
        <h1>⚙️ Панель администратора</h1>
        <div>
          <button class="btn" onclick="location.href='/profile.html'">👤 Мой профиль</button>
          <button class="btn secondary" id="logoutBtn">🚪 Выйти</button>
        </div>
      </div>

      <div class="task-stats">
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
          <div>
            <strong>📊 Статистика:</strong>
            <span id="totalTasks">Заданий: 0</span> | 
            <span id="totalUsers">Пользователей: 0</span> |
            <span id="totalBackgrounds">Фонов: 0</span>
          </div>
          <div>
            <strong>🎯 Типы вопросов:</strong>
            <span class="task-type-indicator mcq-type">📝 Тест</span>
            <span class="task-type-indicator fill-type">✍️ Письменный</span>
            <span class="task-type-indicator mixed-type">📝+✍️ Смешанный</span>
            <span class="task-type-indicator demo-type">📚 Демо</span>
          </div>
        </div>
      </div>

      <div class="admin-tabs">
        <div class="admin-tab active" data-tab="users">👥 Пользователи</div>
        <div class="admin-tab" data-tab="tasks">📚 Задания</div>
        <div class="admin-tab" data-tab="background">🎨 Фон профиля</div>
      </div>

      <div class="admin-section active" id="users-section">
        <div class="card">
          <h2>Список пользователей</h2>
          <div class="search-container">
            <input type="text" id="userSearch" placeholder="Поиск по имени или email..." class="input">
          </div>
          <div style="overflow-x: auto;">
            <table class="admin-table" id="usersTable">
              <thead>
                <tr>
                  <th>ФИО</th>
                  <th>Email</th>
                  <th>Прогресс</th>
                  <th>Статус</th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="admin-section" id="tasks-section">
        <div class="card">
          <h2>Управление заданиями</h2>
          <div class="admin-controls">
            <button class="btn" id="createTaskBtn">➕ Создать задание</button>
            <button class="btn" id="createDemoTaskBtn">📚 Создать демо-задание</button>
          </div>
          <div style="overflow-x: auto;">
            <table class="admin-table" id="tasksTable">
              <thead>
                <tr>
                  <th>Название</th>
                  <th>Месяц</th>
                  <th>Тип</th>
                  <th>Демо</th>
                  <th>Лимит времени</th>
                  <th>Проходной балл</th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card" id="taskFormCard" style="display:none;">
          <h2 id="formTitle">Создать задание</h2>
          
          <div class="form-group">
            <label>Название задания:</label>
            <input type="text" id="taskTitle" class="input" placeholder="Введите название">
          </div>
          
          <div class="demo-checkbox">
            <input type="checkbox" id="taskIsDemo">
            <label for="taskIsDemo"><strong>📚 Это демо-задание</strong></label>
          </div>
          <div class="demo-info" id="demoInfo" style="display: none;">
            💡 <strong>Демо-задание</strong> - это пример задания с уже вписанными ответами. 
            Ученики могут просматривать его для обучения, но баллы за него не начисляются.
          </div>
          
          <div class="form-group">
            <label>Месяц:</label>
            <select id="taskMonth" class="input">
              <option value="1">Сентябрь</option>
              <option value="2">Октябрь</option>
              <option value="3">Ноябрь</option>
              <option value="4">Декабрь</option>
              <option value="5">Январь</option>
              <option value="6">Февраль</option>
              <option value="7">Март</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Лимит времени (минуты):</label>
            <input type="number" id="taskTimeLimit" class="input" value="60" min="1" max="240">
            <div class="time-limit-info">⏰ Ученик должен успеть выполнить задание за указанное время</div>
          </div>
          
          <div class="form-group">
            <label>Проходной балл (%):</label>
            <input type="number" id="taskPassingScore" class="input" value="80" min="0" max="100">
          </div>
          
          <div id="taskContent">
            <h3>Вопросы задания</h3>
            <div class="question-type-selector">
              <div class="type-btn active" data-type="mcq">📝 Тестовый вопрос</div>
              <div class="type-btn" data-type="fill">✍️ Вписать ответ</div>
              <div class="type-btn" data-type="demo">📚 Демо-вопрос</div>
            </div>
            <div id="questionsContainer">
              <!-- Вопросы будут добавляться сюда динамически -->
            </div>
            <button class="btn" id="addQuestionBtn">➕ Добавить вопрос</button>
          </div>
          
          <div style="margin-top:20px; display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn" id="saveTaskBtn">💾 Сохранить задание</button>
            <button class="btn secondary" id="cancelTaskBtn">❌ Отмена</button>
          </div>
        </div>
      </div>

      <!-- Новая секция для управления фонами -->
      <div class="admin-section" id="background-section">
        <div class="card">
          <h2>🎨 Управление фоном профиля</h2>
          
          <!-- Текущий активный фон -->
          <div class="form-group">
            <label>Текущий активный фон:</label>
            <div id="currentBackgroundPreview" style="text-align: center; margin: 15px 0;">
              <p class="small-muted" id="noBackgroundMessage">Фон не установлен</p>
              <img id="currentBackgroundImage" class="background-preview" style="display: none;">
              <div id="currentBackgroundInfo" style="margin-top: 10px;"></div>
            </div>
          </div>

          <!-- Форма загрузки нового фона -->
          <div class="form-group">
            <label>Загрузить новый фон:</label>
            <div class="upload-area" id="backgroundUploadArea">
              <p>📁 Нажмите для загрузки фона или перетащите файл сюда</p>
              <p class="small-muted">Поддерживаемые форматы: JPG, PNG, GIF, WebP (макс. 10MB)</p>
              <input type="file" id="backgroundInput" style="display:none" accept="image/*, .gif">
            </div>
            <div class="upload-progress" id="backgroundProgress" style="display: none;">
              <div class="upload-progress-bar" id="backgroundProgressBar"></div>
            </div>
            <button class="btn" id="uploadBackgroundBtn" style="display: none; margin-top: 10px;">📤 Загрузить фон</button>
          </div>

          <!-- Список загруженных фонов -->
          <div class="form-group">
            <label>Загруженные фоны:</label>
            <div id="backgroundsList" style="margin-top: 15px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="modal" style="display: none;">
    <div class="modal-body card">
      <h3 id="modalTitle"></h3>
      <p id="modalText" style="white-space: pre-line;"></p>
      <div style="margin-top: 12px; text-align: center;">
        <button class="btn" id="modalOk">ОК</button>
      </div>
    </div>
  </div>

  <script type="module">
    document.getElementById('configLoading').style.display = 'block';
    
    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorMessage').style.display = 'block';
      document.getElementById('configLoading').style.display = 'none';
    }
    
    function showContent() {
      document.getElementById('mainContent').style.display = 'block';
      document.getElementById('configLoading').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
    }
    
    function showModal(title, text) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalText').textContent = text;
      document.getElementById('modal').style.display = 'flex';
    }

    // Функция проверки прав администратора
    async function checkAdmin(supabase) {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            window.location.href = '/login.html';
            return false;
        }
        
        const { data: profile } = await supabase
            .from('profiles')
            .select('is_admin')
            .eq('id', user.id)
            .single();
            
        if (!profile || !profile.is_admin) {
            showModal('Доступ запрещен', 'Требуются права администратора.');
            setTimeout(() => {
                window.location.href = '/profile.html';
            }, 2000);
            return false;
        }
        
        return { user, profile };
    }

    // Функция для экранирования HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Генератор уникальных ID для вопросов
    function generateQuestionId() {
      return 'q_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    async function initApp() {
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
        showError('❌ Ошибка конфигурации. Переменные Supabase не загружены.');
        return false;
      }
      
      try {
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
        const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        
        // ПРОВЕРЯЕМ АДМИНА ПЕРВЫМ ДЕЛОМ
        const adminCheck = await checkAdmin(supabase);
        if (!adminCheck) return false;
        
        const currentUser = adminCheck.user;
        let editingTaskId = null;
        let currentQuestionType = 'mcq';
        let searchTimeout = null;

        // ===== ОБРАБОТЧИКИ СОБЫТИЙ =====
        
        // Модальное окно
        document.getElementById('modalOk').addEventListener('click', () => {
          document.getElementById('modal').style.display = 'none';
        });

        // Выход из системы
        document.getElementById('logoutBtn').addEventListener('click', async () => {
          if (confirm('Вы уверены, что хотите выйти?')) {
            await supabase.auth.signOut();
            window.location.href = '/login.html';
          }
        });

        // Поиск пользователей с задержкой
        document.getElementById('userSearch').addEventListener('input', function(e) {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            loadUsers();
          }, 500);
        });

        // Управление заданиями
        document.getElementById('createTaskBtn').addEventListener('click', () => showTaskForm(false));
        document.getElementById('createDemoTaskBtn').addEventListener('click', () => showTaskForm(true));
        document.getElementById('cancelTaskBtn').addEventListener('click', hideTaskForm);
        document.getElementById('saveTaskBtn').addEventListener('click', saveTask);
        
        document.getElementById('addQuestionBtn').addEventListener('click', function() {
          addQuestion(currentQuestionType);
        });

        // Демо-чекбокс
        document.getElementById('taskIsDemo').addEventListener('change', function() {
          document.getElementById('demoInfo').style.display = this.checked ? 'block' : 'none';
        });

        // Типы вопросов
        document.querySelectorAll('.type-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentQuestionType = this.getAttribute('data-type');
          });
        });

        // Вкладки
        document.querySelectorAll('.admin-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.getAttribute('data-tab');
            
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            
            tab.classList.add('active');
            document.getElementById(`${tabName}-section`).classList.add('active');
            
            if (tabName === 'background') {
              loadCurrentBackground();
              loadBackgroundsList();
            }
          });
        });
        
        // Функция загрузки изображения в Supabase Storage
        async function uploadQuestionImage(file, questionId) {
          try {
            const fileExt = file.name.split('.').pop();
            const fileName = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
            const filePath = `questions/${fileName}`;
            
            const { data, error } = await supabase.storage
              .from('task-images')
              .upload(filePath, file);
            
            if (error) throw error;
            
            const { data: { publicUrl } } = supabase.storage
              .from('task-images')
              .getPublicUrl(filePath);
            
            return publicUrl;
          } catch (error) {
            console.error('Ошибка загрузки изображения:', error);
            throw new Error('Не удалось загрузить изображение: ' + error.message);
          }
        }
        
        // Функция удаления изображения из Supabase Storage
        async function deleteQuestionImage(imageUrl) {
          try {
            if (!imageUrl) return;
            
            // Извлекаем имя файла из URL
            const fileName = imageUrl.split('/').pop();
            if (!fileName) return;
            
            const { error } = await supabase.storage
              .from('task-images')
              .remove([`questions/${fileName}`]);
            
            if (error) {
              console.warn('Не удалось удалить изображение из Storage:', error);
            } else {
              console.log('✅ Изображение удалено из Storage:', fileName);
            }
          } catch (error) {
            console.error('Ошибка удаления изображения:', error);
          }
        }
        
        // Функция для загрузки статистики
        async function loadStats() {
          try {
            const { data: tasks, error: tasksError } = await supabase
              .from('tasks')
              .select('id, content, is_demo');
            
            const { data: users, error: usersError } = await supabase
              .from('profiles')
              .select('id');

            const { data: backgrounds, error: backgroundsError } = await supabase
              .from('backgrounds')
              .select('id');

            if (!tasksError && !usersError && !backgroundsError) {
              const regularTasks = tasks.filter(t => !t.is_demo).length;
              const demoTasks = tasks.filter(t => t.is_demo).length;
              
              document.getElementById('totalTasks').textContent = `Заданий: ${regularTasks} + ${demoTasks} демо`;
              document.getElementById('totalUsers').textContent = `Пользователей: ${users.length}`;
              document.getElementById('totalBackgrounds').textContent = `Фонов: ${backgrounds?.length || 0}`;
            }
          } catch (error) {
            console.error('Ошибка загрузки статистики:', error);
          }
        }

        // ===== УПРАВЛЕНИЕ ФОНАМИ =====

        async function loadCurrentBackground() {
          const { data: activeBackground, error } = await supabase
            .from('backgrounds')
            .select('*')
            .eq('is_active', true)
            .order('created_at', { ascending: false })
            .limit(1)
            .single();

          if (error && error.code !== 'PGRST116') {
            console.error('Ошибка загрузки фона:', error);
            return;
          }

          const preview = document.getElementById('currentBackgroundPreview');
          const image = document.getElementById('currentBackgroundImage');
          const noBgMessage = document.getElementById('noBackgroundMessage');
          const infoDiv = document.getElementById('currentBackgroundInfo');

          infoDiv.innerHTML = '';

          if (activeBackground) {
            image.src = activeBackground.image_url;
            image.style.display = 'block';
            noBgMessage.style.display = 'none';
            
            const info = document.createElement('div');
            info.className = 'small-muted';
            info.innerHTML = `
              <strong>Файл:</strong> ${activeBackground.file_name} 
              (${Math.round(activeBackground.file_size / 1024)} KB) 
              • <strong>Тип:</strong> ${activeBackground.mime_type || 'image'}
              <br><strong>Загружен:</strong> ${new Date(activeBackground.created_at).toLocaleDateString('ru-RU')}
            `;
            infoDiv.appendChild(info);
          } else {
            image.style.display = 'none';
            noBgMessage.style.display = 'block';
          }
        }

        async function loadBackgroundsList() {
          const { data: backgrounds, error } = await supabase
            .from('backgrounds')
            .select('*')
            .order('created_at', { ascending: false });

          if (error) {
            console.error('Ошибка загрузки списка фонов:', error);
            return;
          }

          const container = document.getElementById('backgroundsList');
          container.innerHTML = '';

          if (!backgrounds || backgrounds.length === 0) {
            container.innerHTML = '<p class="small-muted" style="text-align: center; padding: 20px;">Нет загруженных фонов</p>';
            return;
          }

          backgrounds.forEach(bg => {
            const bgCard = document.createElement('div');
            bgCard.className = 'background-item';
            
            bgCard.innerHTML = `
              <img src="${bg.image_url}" style="width: 120px; height: 80px; object-fit: cover;">
              <div class="background-info">
                <div><strong>${bg.file_name}</strong></div>
                <div class="small-muted">
                  ${Math.round(bg.file_size / 1024)} KB • 
                  ${bg.mime_type || 'image'} •
                  ${new Date(bg.created_at).toLocaleDateString('ru-RU')}
                </div>
                <div style="margin-top: 8px;">
                  ${bg.is_active ? 
                    '<span class="active-badge">✅ Активный фон</span>' : 
                    ''
                  }
                </div>
              </div>
              <div class="background-actions">
                ${!bg.is_active ? 
                  `<button class="btn btn-small set-active-bg" data-bg-id="${bg.id}">🎯 Сделать активным</button>` : 
                  ''
                }
                <button class="btn btn-small btn-danger delete-bg" data-bg-id="${bg.id}">🗑️ Удалить</button>
              </div>
            `;
            
            container.appendChild(bgCard);
          });

          document.querySelectorAll('.set-active-bg').forEach(btn => {
            btn.addEventListener('click', async () => {
              const bgId = btn.getAttribute('data-bg-id');
              await setActiveBackground(bgId);
            });
          });

          document.querySelectorAll('.delete-bg').forEach(btn => {
            btn.addEventListener('click', async () => {
              const bgId = btn.getAttribute('data-bg-id');
              await deleteBackground(bgId);
            });
          });
        }

        async function setActiveBackground(bgId) {
          try {
            const { error: updateError } = await supabase
              .from('backgrounds')
              .update({ is_active: false })
              .eq('is_active', true);

            if (updateError) throw updateError;

            const { error: setError } = await supabase
              .from('backgrounds')
              .update({ is_active: true })
              .eq('id', bgId);

            if (setError) throw setError;

            showModal('Успех', '✅ Фон успешно установлен как активный!\n\nТеперь все пользователи увидят этот фон в своих профилях.');
            loadCurrentBackground();
            loadBackgroundsList();
          } catch (error) {
            console.error('Ошибка установки фона:', error);
            showModal('Ошибка', 'Не удалось установить фон: ' + error.message);
          }
        }

        async function deleteBackground(bgId) {
          if (!confirm('Вы уверены, что хотите удалить этот фон?\n\nЭто действие нельзя отменить.')) {
            return;
          }

          try {
            const { data: background, error: fetchError } = await supabase
              .from('backgrounds')
              .select('*')
              .eq('id', bgId)
              .single();

            if (fetchError) throw fetchError;

            const filePath = background.image_url.split('/').pop();
            const { error: storageError } = await supabase.storage
              .from('backgrounds')
              .remove([filePath]);

            if (storageError) {
              console.warn('Не удалось удалить файл из Storage:', storageError);
            }

            const { error: deleteError } = await supabase
              .from('backgrounds')
              .delete()
              .eq('id', bgId);

            if (deleteError) throw deleteError;

            showModal('Успех', '✅ Фон успешно удалён!');
            loadCurrentBackground();
            loadBackgroundsList();
            loadStats();
          } catch (error) {
            console.error('Ошибка удаления фона:', error);
            showModal('Ошибка', 'Не удалось удалить фон: ' + error.message);
          }
        }

        async function uploadBackground(file) {
          const progressBar = document.getElementById('backgroundProgressBar');
          const progress = document.getElementById('backgroundProgress');
          const uploadBtn = document.getElementById('uploadBackgroundBtn');

          try {
            progress.style.display = 'block';
            progressBar.style.width = '0%';
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Загружаем...';

            if (file.size > 10 * 1024 * 1024) {
              throw new Error('Файл слишком большой! Максимальный размер: 10MB');
            }

            if (!file.type.match('image.*')) {
              throw new Error('Пожалуйста, выберите файл изображения!');
            }

            progressBar.style.width = '25%';

            const fileExt = file.name.split('.').pop();
            const fileName = `background-${Date.now()}-${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
            const filePath = `backgrounds/${fileName}`;

            const { data: uploadData, error: uploadError } = await supabase.storage
              .from('backgrounds')
              .upload(filePath, file, {
                cacheControl: '3600',
                upsert: false
              });

            if (uploadError) throw uploadError;

            progressBar.style.width = '50%';

            const { data: { publicUrl } } = supabase.storage
              .from('backgrounds')
              .getPublicUrl(filePath);

            progressBar.style.width = '75%';

            const { error: dbError } = await supabase
              .from('backgrounds')
              .insert([{
                image_url: publicUrl,
                file_name: file.name,
                file_size: file.size,
                mime_type: file.type,
                created_by: currentUser.id,
                is_active: false
              }]);

            if (dbError) throw dbError;

            progressBar.style.width = '100%';

            setTimeout(() => {
              progress.style.display = 'none';
              uploadBtn.disabled = false;
              uploadBtn.textContent = '📤 Загрузить фон';
              uploadBtn.style.display = 'none';
              
              document.getElementById('backgroundInput').value = '';
              
              showModal('Успех', '✅ Фон успешно загружен!\n\nТеперь вы можете сделать его активным в списке ниже.');
              loadCurrentBackground();
              loadBackgroundsList();
              loadStats();
            }, 1000);

          } catch (error) {
            console.error('Ошибка загрузки фона:', error);
            progress.style.display = 'none';
            uploadBtn.disabled = false;
            uploadBtn.textContent = '📤 Загрузить фон';
            showModal('Ошибка', 'Не удалось загрузить фон: ' + error.message);
          }
        }

        function initBackgrounds() {
          const backgroundInput = document.getElementById('backgroundInput');
          const backgroundUploadArea = document.getElementById('backgroundUploadArea');
          const uploadBtn = document.getElementById('uploadBackgroundBtn');

          backgroundUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            backgroundUploadArea.classList.add('dragover');
          });

          backgroundUploadArea.addEventListener('dragleave', () => {
            backgroundUploadArea.classList.remove('dragover');
          });

          backgroundUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            backgroundUploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
              backgroundInput.files = files;
              handleBackgroundSelection();
            }
          });

          backgroundUploadArea.addEventListener('click', () => {
            backgroundInput.click();
          });

          backgroundInput.addEventListener('change', handleBackgroundSelection);

          uploadBtn.addEventListener('click', () => {
            if (backgroundInput.files && backgroundInput.files[0]) {
              uploadBackground(backgroundInput.files[0]);
            }
          });

          loadCurrentBackground();
          loadBackgroundsList();
        }

        function handleBackgroundSelection() {
          const file = document.getElementById('backgroundInput').files[0];
          const uploadBtn = document.getElementById('uploadBackgroundBtn');
          
          if (file) {
            uploadBtn.style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = function(e) {
              const preview = document.getElementById('currentBackgroundPreview');
              const tempImg = document.createElement('img');
              tempImg.src = e.target.result;
              tempImg.className = 'background-preview';
              tempImg.style.display = 'block';
              
              const currentImg = document.getElementById('currentBackgroundImage');
              const noBg = document.getElementById('noBackgroundMessage');
              currentImg.style.display = 'none';
              noBg.style.display = 'none';
              
              preview.insertBefore(tempImg, preview.firstChild);
            };
            reader.readAsDataURL(file);
          } else {
            uploadBtn.style.display = 'none';
          }
        }

        // ===== РАБОТА С ПОЛЬЗОВАТЕЛЯМИ =====
        async function loadUsers() {
          const searchTerm = document.getElementById('userSearch').value.trim();
          
          let query = supabase
            .from('profiles')
            .select(`
              *,
              attempts:attempts(count),
              keys:keys(count)
            `)
            .order('created_at', { ascending: false });
          
          if (searchTerm) {
            query = query.or(`full_name.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%`);
          }
          
          const { data, error } = await query;
          
          if (error) {
            console.error('Ошибка загрузки пользователей:', error);
            showModal('Ошибка', 'Ошибка загрузки пользователей: ' + error.message);
            return;
          }
          
          const tbody = document.querySelector('#usersTable tbody');
          tbody.innerHTML = '';
          
          if (data.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="5" style="text-align:center;padding:20px;">Пользователи не найдены</td>`;
            tbody.appendChild(tr);
            return;
          }
          
          data.forEach(user => {
            const attemptsCount = user.attempts?.[0]?.count || 0;
            const keysCount = user.keys?.[0]?.count || 0;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>
                <div><strong>${user.full_name || 'Не указано'}</strong></div>
                <div class="user-stats">
                  <span class="stat-badge">👤 ID: ${user.id.substring(0, 8)}...</span>
                </div>
              </td>
              <td>${user.email || 'Не указано'}</td>
              <td>
                <div class="user-stats">
                  <span class="stat-badge">🗝️ ${keysCount} ключей</span>
                  <span class="stat-badge">📊 ${attemptsCount} попыток</span>
                </div>
              </td>
              <td>${user.is_admin ? '👑 Админ' : '👤 Пользователь'}</td>
              <td>
                <div class="user-actions">
                  <button class="btn btn-small ${user.is_admin ? 'secondary' : ''}" data-user-id="${user.id}" data-make-admin="${!user.is_admin}">
                    ${user.is_admin ? '❌ Убрать админку' : '👑 Сделать админом'}
                  </button>
                  <button class="btn btn-small btn-warning" data-user-id="${user.id}" data-user-email="${user.email}">🔄 Сбросить прогресс</button>
                </div>
              </td>
            `;
            tbody.appendChild(tr);
          });

          document.querySelectorAll('[data-user-id]').forEach(btn => {
            if (btn.textContent.includes('админ')) {
              btn.addEventListener('click', () => {
                const userId = btn.getAttribute('data-user-id');
                const makeAdmin = btn.getAttribute('data-make-admin') === 'true';
                toggleAdmin(userId, makeAdmin);
              });
            } else {
              btn.addEventListener('click', () => {
                const userId = btn.getAttribute('data-user-id');
                const userEmail = btn.getAttribute('data-user-email');
                resetProgress(userId, userEmail);
              });
            }
          });
        }
        
        async function toggleAdmin(userId, makeAdmin) {
          if (!confirm(`Вы уверены, что хотите ${makeAdmin ? 'назначить' : 'снять'} права администратора?`)) return;
          
          const { error } = await supabase
            .from('profiles')
            .update({ is_admin: makeAdmin })
            .eq('id', userId);
            
          if (error) {
            showModal('Ошибка', 'Ошибка при изменении прав: ' + error.message);
          } else {
            loadUsers();
          }
        }
        
        async function resetProgress(userId, userEmail) {
          if (!confirm(`ВЫ УВЕРЕНЫ, что хотите ПОЛНОСТЬЮ сбросить прогресс пользователя ${userEmail}?\n\nЭто действие:\n• Удалит ВСЕ ключи пользователя\n• Удалит ВСЕ попытки пользователя\n• Сбросит счетчики в профиле\n• НЕЛЬЗЯ отменить!`)) return;
          
          try {
            const { data, error } = await supabase.rpc('reset_user_progress', {
              _user_id: userId
            });
            
            if (error) {
              console.error('RPC Error:', error);
              showModal('Ошибка', 'Ошибка при сбросе прогресса: ' + error.message);
              return;
            }
            
            if (data.error) {
              showModal('Ошибка', 'Ошибка при сбросе прогресса: ' + data.message);
            } else {
              showModal('Успех', '✅ Прогресс пользователя полностью сброшен!\n\nУдалены все ключи и попытки.');
              loadUsers();
            }
          } catch (error) {
            console.error('Ошибка при сбросе прогресса:', error);
            showModal('Ошибка', 'Ошибка при сбросе прогресса: ' + error.message);
          }
        }

        // ===== РАБОТА С ЗАДАНИЯМИ =====
        async function loadTasks() {
          const { data, error } = await supabase
            .from('tasks')
            .select('*')
            .order('month_index', { ascending: true });
          
          if (error) {
            console.error('Ошибка загрузки заданий:', error);
            showModal('Ошибка', 'Ошибка загрузки заданий: ' + error.message);
            return;
          }
          
          const tbody = document.querySelector('#tasksTable tbody');
          tbody.innerHTML = '';
          
          if (!data || data.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="7" style="text-align:center;padding:20px;">Задания не найдены</td>`;
            tbody.appendChild(tr);
            return;
          }
          
          const months = ["Сентябрь", "Октябрь", "Ноябрь", "Декабрь", "Январь", "Февраль", "Март"];
          
          data.forEach(task => {
            const questionTypes = task.content?.questions?.map(q => q.type) || [];
            const hasMcq = questionTypes.includes('mcq');
            const hasFill = questionTypes.includes('fill');
            const hasDemo = questionTypes.includes('demo') || task.is_demo;
            
            let typeText = '';
            let typeClass = '';
            if (hasDemo) {
              typeText = '📚';
              typeClass = 'demo-type';
            } else if (hasMcq && hasFill) {
              typeText = '📝+✍️';
              typeClass = 'mixed-type';
            } else if (hasMcq) {
              typeText = '📝';
              typeClass = 'mcq-type';
            } else if (hasFill) {
              typeText = '✍️';
              typeClass = 'fill-type';
            } else {
              typeText = '📝';
              typeClass = 'mcq-type';
            }
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${task.title}</td>
              <td>${months[task.month_index - 1] || task.month_index}</td>
              <td>
                <span class="task-type-indicator ${typeClass}">${typeText}</span>
              </td>
              <td>${task.is_demo ? '✅' : '❌'}</td>
              <td>${task.time_limit || 60} мин</td>
              <td>${task.passing_score}%</td>
              <td>
                <button class="btn btn-small edit-task" data-task-id="${task.id}">✏️ Редактировать</button>
                <button class="btn btn-small btn-danger delete-task" data-task-id="${task.id}" data-task-title="${task.title}">🗑️ Удалить</button>
              </td>
            `;
            tbody.appendChild(tr);
          });

          document.querySelectorAll('.edit-task').forEach(btn => {
            btn.addEventListener('click', () => {
              const taskId = btn.getAttribute('data-task-id');
              editTask(taskId);
            });
          });

          document.querySelectorAll('.delete-task').forEach(btn => {
            btn.addEventListener('click', () => {
              const taskId = btn.getAttribute('data-task-id');
              const taskTitle = btn.getAttribute('data-task-title');
              deleteTask(taskId, taskTitle);
            });
          });
        }
        
        function showTaskForm(isDemo = false) {
          document.getElementById('taskFormCard').style.display = 'block';
          document.getElementById('formTitle').textContent = isDemo ? 'Создать демо-задание' : 'Создать задание';
          document.getElementById('taskTitle').value = '';
          document.getElementById('taskMonth').value = '1';
          document.getElementById('taskTimeLimit').value = '60';
          document.getElementById('taskPassingScore').value = '80';
          document.getElementById('taskIsDemo').checked = isDemo;
          document.getElementById('demoInfo').style.display = isDemo ? 'block' : 'none';
          editingTaskId = null;
          
          currentQuestionType = 'mcq';
          document.querySelectorAll('.type-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-type') === 'mcq') {
              btn.classList.add('active');
            }
          });
          
          const questionsContainer = document.getElementById('questionsContainer');
          questionsContainer.innerHTML = '';
          
          addQuestion('mcq');
        }
        
        function hideTaskForm() {
          document.getElementById('taskFormCard').style.display = 'none';
        }
        
        function setupUploadArea(questionId) {
          const uploadArea = document.getElementById(`uploadArea${questionId}`);
          if (!uploadArea) return;
          
          const imageInput = document.getElementById(`imageInput${questionId}`);
          
          uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
          });
          
          uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
          });
          
          uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
              imageInput.files = files;
              handleImageUpload(imageInput, questionId);
            }
          });
        }
        
        function handleImageUpload(input, questionId) {
          const file = input.files[0];
          if (!file) return;
          
          if (file.size > 5 * 1024 * 1024) {
            alert('Файл слишком большой! Максимальный размер: 5MB');
            return;
          }
          
          if (!file.type.match('image.*')) {
            alert('Пожалуйста, выберите файл изображения!');
            return;
          }
          
          const progress = document.getElementById(`progress${questionId}`);
          const progressBar = document.getElementById(`progressBar${questionId}`);
          const preview = document.getElementById(`imagePreview${questionId}`);
          const removeBtn = document.getElementById(`removeBtn${questionId}`);
          const uploadArea = document.getElementById(`uploadArea${questionId}`);
          
          progress.style.display = 'block';
          progressBar.style.width = '0%';
          
          uploadQuestionImage(file, questionId)
            .then(imageUrl => {
              document.getElementById(`imageUrl${questionId}`).value = imageUrl;
              
              preview.src = imageUrl;
              preview.style.display = 'block';
              removeBtn.style.display = 'block';
              uploadArea.style.display = 'none';
              progressBar.style.width = '100%';
              
              setTimeout(() => {
                progress.style.display = 'none';
              }, 1000);
            })
            .catch(error => {
              alert('Ошибка загрузки изображения: ' + error.message);
              progress.style.display = 'none';
            });
        }
        
        function removeImage(questionId) {
          const preview = document.getElementById(`imagePreview${questionId}`);
          const removeBtn = document.getElementById(`removeBtn${questionId}`);
          const uploadArea = document.getElementById(`uploadArea${questionId}`);
          const imageUrlInput = document.getElementById(`imageUrl${questionId}`);
          const imageInput = document.getElementById(`imageInput${questionId}`);
          
          // Удаляем изображение из Storage
          const imageUrl = imageUrlInput.value;
          if (imageUrl) {
            deleteQuestionImage(imageUrl);
          }
          
          preview.style.display = 'none';
          removeBtn.style.display = 'none';
          uploadArea.style.display = 'block';
          imageUrlInput.value = '';
          imageInput.value = '';
          
          // Сбрасываем input file
          imageInput.type = 'file';
        }
        
        // Функция для добавления нового поля ввода в fill-вопросе
        function addFillInputField(container) {
          const inputCount = container.querySelectorAll('.fill-input-item').length;
          const inputItem = document.createElement('div');
          inputItem.className = 'fill-input-item';
          inputItem.innerHTML = `
            <input type="text" class="input" placeholder="Правильный ответ для поля ${inputCount + 1}">
            <button type="button" class="remove-input-btn">🗑️</button>
          `;
          
          container.appendChild(inputItem);
          
          const removeBtn = inputItem.querySelector('.remove-input-btn');
          removeBtn.addEventListener('click', function() {
            if (container.querySelectorAll('.fill-input-item').length > 1) {
              inputItem.remove();
              updateInputCount(container);
            } else {
              alert('Должен остаться хотя бы один вариант ответа');
            }
          });
          
          updateInputCount(container);
        }
        
        function updateInputCount(container) {
          const count = container.querySelectorAll('.fill-input-item').length;
          const countElement = container.parentElement.querySelector('.input-count');
          if (countElement) {
            countElement.textContent = `Количество полей: ${count}`;
          }
        }
        
        function addQuestion(type = null) {
          const questionsContainer = document.getElementById('questionsContainer');
          const questionType = type || currentQuestionType;
          const questionId = generateQuestionId();
          
          const newQuestion = document.createElement('div');
          newQuestion.className = 'subtask-item';
          newQuestion.setAttribute('data-type', questionType);
          newQuestion.setAttribute('data-id', questionId);
          
          if (questionType === 'mcq') {
            newQuestion.innerHTML = `
              <div class="form-group">
                <label>Текст вопроса:</label>
                <input type="text" class="input question-text" placeholder="Введите вопрос">
              </div>
              <div class="form-group">
                <label>Изображение для вопроса (опционально):</label>
                <div class="upload-area" id="uploadArea${questionId}">
                  <p>📁 Нажмите для загрузки изображения или перетащите файл сюда</p>
                  <p class="small-muted">Поддерживаемые форматы: JPG, PNG, GIF (макс. 5MB)</p>
                  <input type="file" id="imageInput${questionId}" style="display:none" accept="image/*">
                </div>
                <div class="upload-progress" id="progress${questionId}">
                  <div class="upload-progress-bar" id="progressBar${questionId}"></div>
                </div>
                <input type="hidden" class="input question-image" id="imageUrl${questionId}">
                <img class="image-preview" id="imagePreview${questionId}" alt="Предпросмотр изображения">
                <button type="button" class="btn btn-small btn-danger" id="removeBtn${questionId}" style="display:none; margin-top:5px;">🗑️ Удалить изображение</button>
              </div>
              <div class="form-group">
                <label>Варианты ответов (каждый с новой строки):</label>
                <textarea class="input mcq-options" placeholder="Вариант 1\nВариант 2\nВариант 3" rows="3"></textarea>
              </div>
              <div class="form-group">
                <label>Правильный ответ (номер варианта, начиная с 1):</label>
                <input type="number" class="input mcq-correct" min="1" value="1">
              </div>
              <button class="btn btn-small btn-danger remove-question">🗑️ Удалить вопрос</button>
            `;
          } else if (questionType === 'fill') {
            newQuestion.innerHTML = `
              <div class="form-group">
                <label>Текст вопроса:</label>
                <input type="text" class="input question-text" placeholder="Введите вопрос">
              </div>
              <div class="form-group">
                <label>Изображение для вопроса (опционально):</label>
                <div class="upload-area" id="uploadArea${questionId}">
                  <p>📁 Нажмите для загрузки изображения или перетащите файл сюда</p>
                  <p class="small-muted">Поддерживаемые форматы: JPG, PNG, GIF (макс. 5MB)</p>
                  <input type="file" id="imageInput${questionId}" style="display:none" accept="image/*">
                </div>
                <div class="upload-progress" id="progress${questionId}">
                  <div class="upload-progress-bar" id="progressBar${questionId}"></div>
                </div>
                <input type="hidden" class="input question-image" id="imageUrl${questionId}">
                <img class="image-preview" id="imagePreview${questionId}" alt="Предпросмотр изображения">
                <button type="button" class="btn btn-small btn-danger" id="removeBtn${questionId}" style="display:none; margin-top:5px;">🗑️ Удалить изображение</button>
              </div>
              <div class="form-group">
                <label>Поля для ввода ответов (каждое поле — отдельный правильный ответ):</label>
                <div class="fill-inputs-container">
                  <div class="fill-input-item">
                    <input type="text" class="input" placeholder="Правильный ответ для поля 1">
                    <button type="button" class="remove-input-btn">🗑️</button>
                  </div>
                </div>
                <div class="input-count">Количество полей: 1</div>
                <button type="button" class="btn btn-small add-fill-input">+ Добавить поле</button>
              </div>
              <button class="btn btn-small btn-danger remove-question">🗑️ Удалить вопрос</button>
            `;
          } else if (questionType === 'demo') {
            newQuestion.innerHTML = `
              <div class="form-group">
                <label>Текст демо-вопроса:</label>
                <input type="text" class="input question-text" placeholder="Введите вопрос для примера">
              </div>
              <div class="form-group">
                <label>Изображение для демо-вопроса (опционально):</label>
                <div class="upload-area" id="uploadArea${questionId}">
                  <p>📁 Нажмите для загрузки изображения или перетащите файл сюда</p>
                  <p class="small-muted">Поддерживаемые форматы: JPG, PNG, GIF (макс. 5MB)</p>
                  <input type="file" id="imageInput${questionId}" style="display:none" accept="image/*">
                </div>
                <div class="upload-progress" id="progress${questionId}">
                  <div class="upload-progress-bar" id="progressBar${questionId}"></div>
                </div>
                <input type="hidden" class="input question-image" id="imageUrl${questionId}">
                <img class="image-preview" id="imagePreview${questionId}" alt="Предпросмотр изображения">
                <button type="button" class="btn btn-small btn-danger" id="removeBtn${questionId}" style="display:none; margin-top:5px;">🗑️ Удалить изображение</button>
              </div>
              <div class="form-group">
                <label>Поля для правильных ответов (каждое поле — отдельный правильный ответ):</label>
                <div class="fill-inputs-container">
                  <div class="fill-input-item">
                    <input type="text" class="input" placeholder="Правильный ответ для поля 1">
                    <button type="button" class="remove-input-btn">🗑️</button>
                  </div>
                </div>
                <div class="input-count">Количество полей: 1</div>
                <button type="button" class="btn btn-small add-fill-input">+ Добавить поле</button>
              </div>
              <div class="form-group">
                <label>Объяснение ответа (опционально):</label>
                <textarea class="input demo-explanation" placeholder="Объясните, почему это правильный ответ" rows="3"></textarea>
              </div>
              <button class="btn btn-small btn-danger remove-question">🗑️ Удалить вопрос</button>
            `;
          }
          
          questionsContainer.appendChild(newQuestion);
          
          const uploadArea = document.getElementById(`uploadArea${questionId}`);
          const imageInput = document.getElementById(`imageInput${questionId}`);
          const removeBtn = document.getElementById(`removeBtn${questionId}`);
          const removeQuestionBtn = newQuestion.querySelector('.remove-question');
          
          if (uploadArea) {
            uploadArea.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', () => handleImageUpload(imageInput, questionId));
          }
          if (removeBtn) {
            removeBtn.addEventListener('click', () => removeImage(questionId));
          }
          removeQuestionBtn.addEventListener('click', function() {
            if (document.querySelectorAll('.subtask-item').length > 1) {
              // Удаляем изображение из Storage при удалении вопроса
              const imageUrlInput = document.getElementById(`imageUrl${questionId}`);
              if (imageUrlInput && imageUrlInput.value) {
                deleteQuestionImage(imageUrlInput.value);
              }
              newQuestion.remove();
            } else {
              alert('Должен остаться хотя бы один вопрос');
            }
          });
          
          const addFillInputBtn = newQuestion.querySelector('.add-fill-input');
          if (addFillInputBtn) {
            addFillInputBtn.addEventListener('click', function() {
              const container = newQuestion.querySelector('.fill-inputs-container');
              addFillInputField(container);
            });
          }
          
          const existingRemoveBtns = newQuestion.querySelectorAll('.remove-input-btn');
          existingRemoveBtns.forEach(btn => {
            btn.addEventListener('click', function() {
              const container = newQuestion.querySelector('.fill-inputs-container');
              if (container.querySelectorAll('.fill-input-item').length > 1) {
                btn.closest('.fill-input-item').remove();
                updateInputCount(container);
              } else {
                alert('Должен остаться хотя бы один вариант ответа');
              }
            });
          });
          
          setupUploadArea(questionId);
        }
        
        async function editTask(taskId) {
          const { data: task, error } = await supabase
            .from('tasks')
            .select('*')
            .eq('id', taskId)
            .single();
            
          if (error) {
            alert('Ошибка загрузки задания: ' + error.message);
            return;
          }
          
          document.getElementById('taskFormCard').style.display = 'block';
          document.getElementById('formTitle').textContent = 'Редактировать задание';
          document.getElementById('taskTitle').value = task.title;
          document.getElementById('taskMonth').value = task.month_index;
          document.getElementById('taskTimeLimit').value = task.time_limit || 60;
          document.getElementById('taskPassingScore').value = task.passing_score;
          document.getElementById('taskIsDemo').checked = task.is_demo || false;
          document.getElementById('demoInfo').style.display = task.is_demo ? 'block' : 'none';
          editingTaskId = taskId;
          
          const questionsContainer = document.getElementById('questionsContainer');
          questionsContainer.innerHTML = '';
          
          const questions = task.content?.questions || [];
          questions.forEach((q, i) => {
            const questionId = generateQuestionId();
            const questionDiv = document.createElement('div');
            questionDiv.className = 'subtask-item';
            questionDiv.setAttribute('data-type', q.type || 'mcq');
            questionDiv.setAttribute('data-id', questionId);
            
            if (q.type === 'fill') {
              const answers = Array.isArray(q.answers) ? q.answers : [q.answer || ''];
              const inputsHTML = answers.map((answer, index) => `
                <div class="fill-input-item">
                  <input type="text" class="input" value="${escapeHtml(answer)}" placeholder="Правильный ответ для поля ${index + 1}">
                  <button type="button" class="remove-input-btn">🗑️</button>
                </div>
              `).join('');
              
              questionDiv.innerHTML = `
                <div class="form-group">
                  <label>Текст вопроса:</label>
                  <input type="text" class="input question-text" value="${q.q || ''}" placeholder="Введите вопрос">
                </div>
                <div class="form-group">
                  <label>Изображение для вопроса (опционально):</label>
                  <div class="upload-area" id="uploadArea${questionId}" style="${q.image ? 'display:none' : ''}">
                    <p>📁 Нажмите для загрузки изображения или перетащите файл сюда</p>
                    <p class="small-muted">Поддерживаемые форматы: JPG, PNG, GIF (макс. 5MB)</p>
                    <input type="file" id="imageInput${questionId}" style="display:none" accept="image/*">
                  </div>
                  <div class="upload-progress" id="progress${questionId}">
                    <div class="upload-progress-bar" id="progressBar${questionId}"></div>
                  </div>
                  <input type="hidden" class="input question-image" id="imageUrl${questionId}" value="${q.image || ''}">
                  <img class="image-preview" id="imagePreview${questionId}" alt="Предпросмотр изображения" style="display:${q.image ? 'block' : 'none'}" src="${q.image || ''}">
                  <button type="button" class="btn btn-small btn-danger" id="removeBtn${questionId}" style="display:${q.image ? 'block' : 'none'}; margin-top:5px;">🗑️ Удалить изображение</button>
                </div>
                <div class="form-group">
                  <label>Поля для ввода ответов (каждое поле — отдельный правильный ответ):</label>
                  <div class="fill-inputs-container">
                    ${inputsHTML}
                  </div>
                  <div class="input-count">Количество полей: ${answers.length}</div>
                  <button type="button" class="btn btn-small add-fill-input">+ Добавить поле</button>
                </div>
                <button class="btn btn-small btn-danger remove-question">🗑️ Удалить вопрос</button>
              `;
            } else if (q.type === 'demo') {
              // Поддержка старого формата с demoAnswer и нового с answers
              const answers = q.answers || [q.demoAnswer || ''];
              const inputsHTML = answers.map((answer, index) => `
                <div class="fill-input-item">
                  <input type="text" class="input" value="${escapeHtml(answer)}" placeholder="Правильный ответ для поля ${index + 1}">
                  <button type="button" class="remove-input-btn">🗑️</button>
                </div>
              `).join('');
              
              questionDiv.innerHTML = `
                <div class="form-group">
                  <label>Текст демо-вопроса:</label>
                  <input type="text" class="input question-text" value="${q.q || ''}" placeholder="Введите вопрос для примера">
                </div>
                <div class="form-group">
                  <label>Изображение для демо-вопроса (опционально):</label>
                  <div class="upload-area" id="uploadArea${questionId}" style="${q.image ? 'display:none' : ''}">
                    <p>📁 Нажмите для загрузки изображения или перетащите файл сюда</p>
                    <p class="small-muted">Поддерживаемые форматы: JPG, PNG, GIF (макс. 5MB)</p>
                    <input type="file" id="imageInput${questionId}" style="display:none" accept="image/*">
                  </div>
                  <div class="upload-progress" id="progress${questionId}">
                    <div class="upload-progress-bar" id="progressBar${questionId}"></div>
                  </div>
                  <input type="hidden" class="input question-image" id="imageUrl${questionId}" value="${q.image || ''}">
                  <img class="image-preview" id="imagePreview${questionId}" alt="Предпросмотр изображения" style="display:${q.image ? 'block' : 'none'}" src="${q.image || ''}">
                  <button type="button" class="btn btn-small btn-danger" id="removeBtn${questionId}" style="display:${q.image ? 'block' : 'none'}; margin-top:5px;">🗑️ Удалить изображение</button>
                </div>
                <div class="form-group">
                  <label>Поля для правильных ответов (каждое поле — отдельный правильный ответ):</label>
                  <div class="fill-inputs-container">
                    ${inputsHTML}
                  </div>
                  <div class="input-count">Количество полей: ${answers.length}</div>
                  <button type="button" class="btn btn-small add-fill-input">+ Добавить поле</button>
                </div>
                <div class="form-group">
                  <label>Объяснение ответа (опционально):</label>
                  <textarea class="input demo-explanation" placeholder="Объясните, почему это правильный ответ" rows="3">${q.explanation || ''}</textarea>
                </div>
                <button class="btn btn-small btn-danger remove-question">🗑️ Удалить вопрос</button>
              `;
            } else {
              questionDiv.innerHTML = `
                <div class="form-group">
                  <label>Текст вопроса:</label>
                  <input type="text" class="input question-text" value="${q.q || ''}" placeholder="Введите вопрос">
                </div>
                <div class="form-group">
                  <label>Изображение для вопроса (опционально):</label>
                  <div class="upload-area" id="uploadArea${questionId}" style="${q.image ? 'display:none' : ''}">
                    <p>📁 Нажмите для загрузки изображения или перетащите файл сюда</p>
                    <p class="small-muted">Поддерживаемые форматы: JPG, PNG, GIF (макс. 5MB)</p>
                    <input type="file" id="imageInput${questionId}" style="display:none" accept="image/*">
                  </div>
                  <div class="upload-progress" id="progress${questionId}">
                    <div class="upload-progress-bar" id="progressBar${questionId}"></div>
                  </div>
                  <input type="hidden" class="input question-image" id="imageUrl${questionId}" value="${q.image || ''}">
                  <img class="image-preview" id="imagePreview${questionId}" alt="Предпросмотр изображения" style="display:${q.image ? 'block' : 'none'}" src="${q.image || ''}">
                  <button type="button" class="btn btn-small btn-danger" id="removeBtn${questionId}" style="display:${q.image ? 'block' : 'none'}; margin-top:5px;">🗑️ Удалить изображение</button>
                </div>
                <div class="form-group">
                  <label>Варианты ответов (каждый с новой строки):</label>
                  <textarea class="input mcq-options" placeholder="Вариант 1\nВариант 2\nВариант 3" rows="3">${(q.options || []).join('\n')}</textarea>
                </div>
                <div class="form-group">
                  <label>Правильный ответ (номер варианта, начиная с 1):</label>
                  <input type="number" class="input mcq-correct" min="1" value="${(q.correct || 0) + 1}">
                </div>
                <button class="btn btn-small btn-danger remove-question">🗑️ Удалить вопрос</button>
              `;
            }
            
            questionsContainer.appendChild(questionDiv);
            
            const uploadArea = document.getElementById(`uploadArea${questionId}`);
            const imageInput = document.getElementById(`imageInput${questionId}`);
            const removeBtn = document.getElementById(`removeBtn${questionId}`);
            const removeQuestionBtn = questionDiv.querySelector('.remove-question');
            
            if (uploadArea) {
              uploadArea.addEventListener('click', () => imageInput.click());
              imageInput.addEventListener('change', () => handleImageUpload(imageInput, questionId));
            }
            if (removeBtn) {
              removeBtn.addEventListener('click', () => removeImage(questionId));
            }
            removeQuestionBtn.addEventListener('click', function() {
              if (document.querySelectorAll('.subtask-item').length > 1) {
                // Удаляем изображение из Storage при удалении вопроса
                const imageUrlInput = document.getElementById(`imageUrl${questionId}`);
                if (imageUrlInput && imageUrlInput.value) {
                  deleteQuestionImage(imageUrlInput.value);
                }
                questionDiv.remove();
              } else {
                alert('Должен остаться хотя бы один вопрос');
              }
            });
            
            const addFillInputBtn = questionDiv.querySelector('.add-fill-input');
            if (addFillInputBtn) {
              addFillInputBtn.addEventListener('click', function() {
                const container = questionDiv.querySelector('.fill-inputs-container');
                addFillInputField(container);
              });
            }
            
            const removeInputBtns = questionDiv.querySelectorAll('.remove-input-btn');
            removeInputBtns.forEach(btn => {
              btn.addEventListener('click', function() {
                const container = questionDiv.querySelector('.fill-inputs-container');
                if (container.querySelectorAll('.fill-input-item').length > 1) {
                  btn.closest('.fill-input-item').remove();
                  updateInputCount(container);
                } else {
                  alert('Должен остаться хотя бы один вариант ответа');
                }
              });
            });
            
            setupUploadArea(questionId);
          });
        }
        
        async function saveTask() {
          const title = document.getElementById('taskTitle').value;
          const monthIndex = parseInt(document.getElementById('taskMonth').value);
          const timeLimit = parseInt(document.getElementById('taskTimeLimit').value);
          const passingScore = parseInt(document.getElementById('taskPassingScore').value);
          const isDemo = document.getElementById('taskIsDemo').checked;
          
          if (!title) {
            alert('Введите название задания');
            return;
          }
          
          const questions = [];
          const questionElements = document.querySelectorAll('.subtask-item');
          
          if (questionElements.length === 0) {
            alert('Добавьте хотя бы один вопрос');
            return;
          }
          
          for (let i = 0; i < questionElements.length; i++) {
            const item = questionElements[i];
            const questionType = item.getAttribute('data-type') || 'mcq';
            const question = item.querySelector('.question-text').value;
            const questionId = item.getAttribute('data-id');
            const imageUrl = document.getElementById(`imageUrl${questionId}`)?.value || '';
            
            if (!question) {
              alert('Заполните текст вопроса');
              return;
            }
            
            if (questionType === 'mcq') {
              const optionsText = item.querySelector('.mcq-options').value;
              const correct = parseInt(item.querySelector('.mcq-correct').value) - 1;
              
              const options = optionsText.split('\n').filter(opt => opt.trim() !== '');
              
              if (correct < 0 || correct >= options.length) {
                alert('Номер правильного ответа должен соответствовать одному из вариантов');
                return;
              }
              
              questions.push({
                type: 'mcq',
                q: question,
                image: imageUrl || null,
                options: options,
                correct: correct
              });
            } else if (questionType === 'fill') {
              const inputItems = item.querySelectorAll('.fill-input-item input');
              const answers = Array.from(inputItems).map(input => input.value.trim()).filter(val => val !== '');
              
              if (answers.length === 0) {
                alert('Введите хотя бы один правильный ответ для вопроса с вводом текста');
                return;
              }
              
              questions.push({
                type: 'fill',
                q: question,
                image: imageUrl || null,
                answers: answers
              });
            } else if (questionType === 'demo') {
              const inputItems = item.querySelectorAll('.fill-input-item input');
              const answers = Array.from(inputItems).map(input => input.value.trim()).filter(val => val !== '');
              const explanation = item.querySelector('.demo-explanation').value;
              
              if (answers.length === 0) {
                alert('Введите хотя бы один правильный ответ для демо-вопроса');
                return;
              }
              
              questions.push({
                type: 'demo',
                q: question,
                image: imageUrl || null,
                answers: answers,
                explanation: explanation
              });
            }
          }
          
          const content = { questions };
          
          const hasMcq = questions.some(q => q.type === 'mcq');
          const hasFill = questions.some(q => q.type === 'fill');
          const hasDemo = questions.some(q => q.type === 'demo') || isDemo;
          
          let taskType = 'mcq';
          if (hasDemo) {
            taskType = 'demo';
          } else if (hasMcq && hasFill) {
            taskType = 'mixed';
          } else if (hasFill) {
            taskType = 'fill';
          }
          
          try {
            if (editingTaskId) {
              const { error } = await supabase
                .from('tasks')
                .update({ 
                  title, 
                  month_index: monthIndex, 
                  time_limit: timeLimit, 
                  type: taskType,
                  passing_score: passingScore, 
                  content,
                  is_demo: isDemo
                })
                .eq('id', editingTaskId);
                
              if (error) {
                alert('Ошибка при обновлении задания: ' + error.message);
              } else {
                alert('Задание обновлено');
                hideTaskForm();
                loadTasks();
              }
            } else {
              const { error } = await supabase
                .from('tasks')
                .insert([{ 
                  title, 
                  month_index: monthIndex, 
                  time_limit: timeLimit, 
                  type: taskType,
                  passing_score: passingScore, 
                  content,
                  is_demo: isDemo
                }]);
                
              if (error) {
                alert('Ошибка при создании задания: ' + error.message);
              } else {
                alert('Задание создано');
                hideTaskForm();
                loadTasks();
              }
            }
          } catch (error) {
            console.error('Ошибка при сохранении задания:', error);
            alert('Ошибка при сохранении задания: ' + error.message);
          }
        }
        
        async function deleteTask(taskId, taskTitle) {
          if (!confirm(`Вы уверены, что хотите удалить задание "${taskTitle}"?\n\nВсе связанные попытки также будут удалены.`)) return;
          
          try {
            // Сначала получаем задание, чтобы удалить связанные изображения
            const { data: task, error: fetchError } = await supabase
              .from('tasks')
              .select('content')
              .eq('id', taskId)
              .single();
              
            if (!fetchError && task && task.content && task.content.questions) {
              // Удаляем все изображения из Storage
              for (const question of task.content.questions) {
                if (question.image) {
                  await deleteQuestionImage(question.image);
                }
              }
            }
            
            const { error } = await supabase
              .from('tasks')
              .delete()
              .eq('id', taskId);
              
            if (error) {
              alert('Ошибка при удалении задания: ' + error.message);
            } else {
              alert('Задание удалено');
              loadTasks();
            }
          } catch (error) {
            console.error('Ошибка при удалении задания:', error);
            alert('Ошибка при удалении задания');
          }
        }

        async function initAdmin() {
          loadUsers();
          loadTasks();
          loadStats();
          initBackgrounds();
          
          addQuestion('mcq');
        }

        await initAdmin();
        showContent();
        return true;
        
      } catch (error) {
        showError('❌ Ошибка инициализации админ-панели: ' + error.message);
        return false;
      }
    }
    
    if (window.SUPABASE_URL) {
      initApp();
    } else {
      const timeout = setTimeout(() => {
        showError('❌ Таймаут загрузки конфигурации');
      }, 1000);
      
      window.addEventListener('configLoaded', () => {
        clearTimeout(timeout);
        initApp();
      });
    }
  </script>
</body>
</html>