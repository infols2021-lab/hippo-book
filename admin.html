<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê–¥–º–∏–Ω ‚Äî Edu Keys</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .admin-container { width:95%; max-width:1400px; margin:20px auto; }
    .admin-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding:15px; background:var(--card); border-radius:16px; box-shadow:0 8px 26px rgba(0,0,0,0.08); }
    .admin-tabs { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
    .admin-tab { padding:12px 20px; background:var(--card); border-radius:12px; cursor:pointer; font-weight:700; box-shadow:0 4px 12px rgba(0,0,0,0.1); transition:all 0.2s; }
    .admin-tab.active { background:var(--accent2); color:white; }
    .admin-section { display:none; }
    .admin-section.active { display:block; }
    .admin-table { width:100%; border-collapse:collapse; margin-top:15px; background:var(--card); border-radius:12px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    .admin-table th, .admin-table td { padding:12px 15px; text-align:left; border-bottom:1px solid rgba(0,0,0,0.06); }
    .admin-table th { background-color:var(--bg1); font-weight:700; }
    .admin-table tr:last-child td { border-bottom:none; }
    .form-group { margin-bottom:15px; }
    .form-group label { display:block; margin-bottom:5px; font-weight:600; }
    .subtask-item { background:var(--bg1); padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid rgba(0,0,0,0.1); }
    .btn-danger { background:#e74c3c; }
    .btn-warning { background:#f39c12; }
    .btn-small { padding:6px 12px; font-size:14px; }
    .user-stats { display:flex; gap:10px; margin-top:5px; flex-wrap:wrap; }
    .stat-badge { background:var(--bg1); padding:4px 8px; border-radius:6px; font-size:12px; }
    .user-actions { display:flex; flex-direction:column; gap:5px; }
    .search-container { margin-bottom:15px; }
    .search-container input { width:100%; }
    .image-preview { max-width:200px; max-height:150px; border-radius:8px; margin:10px 0; display:none; }
    .upload-area { border:2px dashed #ccc; border-radius:8px; padding:20px; text-align:center; cursor:pointer; transition:border-color 0.3s; margin:10px 0; }
    .upload-area:hover { border-color:var(--accent2); }
    .upload-area.dragover { border-color:var(--accent2); background-color:rgba(78,205,196,0.1); }
    .upload-progress { width:100%; height:4px; background:#f0f0f0; border-radius:2px; margin:10px 0; display:none; }
    .upload-progress-bar { height:100%; background:var(--accent2); border-radius:2px; width:0%; transition:width 0.3s; }
    
    .material-form { display: none; margin-top: 20px; }
    .material-form.active { display: block; }
    .assignment-form { display: none; margin-top: 20px; }
    .assignment-form.active { display: block; }
    .access-management { display: none; margin-top: 20px; }
    .access-management.active { display: block; }
    
    .question-type-selector { display:flex; gap:10px; margin-bottom:15px; }
    .type-btn { padding:10px 15px; border:2px solid #ddd; border-radius:8px; cursor:pointer; background:white; transition:all 0.3s; }
    .type-btn.active { border-color:var(--accent2); background:var(--accent2); color:white; }
    
    .fill-inputs-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 10px 0;
    }
    .fill-input-item {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .fill-input-item input {
      flex: 1;
      padding: 8px 12px;
      border: 2px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      font-size: 14px;
    }
    .remove-input-btn {
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .add-input-btn {
      background: var(--accent2);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 5px;
    }
    .input-count {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    
    .sentence-builder {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
    }
    .sentence-preview {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 10px;
      font-size: 16px;
      line-height: 1.5;
    }
    .sentence-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .add-gap-btn {
      background: #17a2b8;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .loading { 
      text-align: center; 
      padding: 40px; 
      display: none;
    }
    .spinner { 
      border: 4px solid #f3f3f3; 
      border-top: 4px solid var(--accent2); 
      border-radius: 50%; 
      width: 40px; 
      height: 40px; 
      animation: spin 2s linear infinite; 
      margin: 0 auto 20px; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    .error { 
      background: #ffebee; 
      color: #c62828; 
      padding: 20px; 
      border-radius: 8px; 
      margin: 20px; 
      text-align: center; 
      display: none; 
    }
    .config-loading { 
      text-align: center; 
      padding: 40px; 
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
      border-left: 4px solid var(--accent2);
    }
    
    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent2);
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 14px;
      color: #666;
      font-weight: 600;
    }

    @media (max-width: 1024px) {
      .admin-container {
        width: 98%;
        margin: 15px auto;
      }
      
      .admin-table {
        font-size: 14px;
      }
      
      .admin-table th, 
      .admin-table td {
        padding: 8px 10px;
      }
      
      .admin-tabs {
        gap: 5px;
      }
      
      .admin-tab {
        padding: 10px 15px;
        font-size: 14px;
      }
    }

    @media (max-width: 768px) {
      .admin-container {
        width: 100%;
        margin: 10px auto;
        padding: 0 10px;
      }
      
      .admin-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
        padding: 15px;
      }
      
      .admin-header h1 {
        font-size: 1.5rem;
      }
      
      .admin-tabs {
        flex-direction: column;
        gap: 5px;
      }
      
      .admin-tab {
        text-align: center;
        padding: 12px;
      }
      
      .admin-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
        font-size: 13px;
      }
      
      .admin-table th,
      .admin-table td {
        padding: 6px 8px;
        min-width: 120px;
      }
      
      .question-type-selector {
        flex-direction: column;
        gap: 8px;
      }
      
      .type-btn {
        padding: 12px;
        text-align: center;
      }
      
      .user-actions {
        flex-direction: row;
        gap: 5px;
      }
      
      .user-actions .btn-small {
        padding: 4px 8px;
        font-size: 12px;
      }
    }
  </style>
  
  <script src="/load-config.js"></script>
</head>
<body>
  <div id="configLoading" class="config-loading">
    <div class="spinner"></div>
    <p>üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏...</p>
  </div>
  
  <div id="errorMessage" class="error"></div>
  
  <div id="mainContent" style="display: none;">
    <div class="admin-container">
      <div class="admin-header">
        <h1>‚öôÔ∏è –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
        <div>
          <button class="btn" onclick="location.href='/profile.html'">üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</button>
          <button class="btn secondary" id="logoutBtn">üö™ –í—ã–π—Ç–∏</button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalTextbooks">0</div>
          <div class="stat-label">–£—á–µ–±–Ω–∏–∫–æ–≤</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalCrosswords">0</div>
          <div class="stat-label">–ö—Ä–æ—Å—Å–≤–æ—Ä–¥–æ–≤</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalAssignments">0</div>
          <div class="stat-label">–ó–∞–¥–∞–Ω–∏–π</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalUsers">0</div>
          <div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
        </div>
      </div>

      <div class="admin-tabs">
        <div class="admin-tab active" data-tab="textbooks">üìö –£—á–µ–±–Ω–∏–∫–∏</div>
        <div class="admin-tab" data-tab="crosswords">üß© –ö—Ä–æ—Å—Å–≤–æ—Ä–¥—ã</div>
        <div class="admin-tab" data-tab="assignments">üìù –ó–∞–¥–∞–Ω–∏—è</div>
        <div class="admin-tab" data-tab="users">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
        <div class="admin-tab" data-tab="access">üîê –î–æ—Å—Ç—É–ø—ã</div>
      </div>

      <!-- –°–µ–∫—Ü–∏—è —É—á–µ–±–Ω–∏–∫–æ–≤ -->
      <div class="admin-section active" id="textbooks-section">
        <div class="card">
          <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–µ–±–Ω–∏–∫–∞–º–∏</h2>
          <div class="admin-controls">
            <button class="btn" id="createTextbookBtn">‚ûï –°–æ–∑–¥–∞—Ç—å —É—á–µ–±–Ω–∏–∫</button>
          </div>
          
          <div class="material-form" id="textbookForm">
            <h3 id="textbookFormTitle">–°–æ–∑–¥–∞—Ç—å —É—á–µ–±–Ω–∏–∫</h3>
            
            <div class="form-group">
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ —É—á–µ–±–Ω–∏–∫–∞:</label>
              <input type="text" id="textbookTitle" class="input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—á–µ–±–Ω–∏–∫–∞">
            </div>
            
            <div class="form-group">
              <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
              <textarea id="textbookDescription" class="input" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—á–µ–±–Ω–∏–∫–∞" rows="3"></textarea>
            </div>
            
            <div class="form-group">
              <label>–û–±–ª–æ–∂–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
              <div class="upload-area" id="textbookUploadArea">
                <p>üìÅ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–ª–æ–∂–∫–∏ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</p>
                <p class="small-muted">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF, WebP (–º–∞–∫—Å. 5MB)</p>
                <input type="file" id="textbookCoverInput" style="display:none" accept="image/*">
              </div>
              <div class="upload-progress" id="textbookCoverProgress">
                <div class="upload-progress-bar" id="textbookCoverProgressBar"></div>
              </div>
              <input type="hidden" id="textbookCoverUrl">
              <img class="image-preview" id="textbookCoverPreview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±–ª–æ–∂–∫–∏">
            </div>
            
            <div class="form-group">
              <label>–ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:</label>
              <input type="number" id="textbookOrder" class="input" value="0" min="0">
            </div>
            
            <div style="margin-top:20px; display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="btn" id="saveTextbookBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É—á–µ–±–Ω–∏–∫</button>
              <button class="btn secondary" id="cancelTextbookBtn">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>
          </div>
          
          <div style="overflow-x: auto; margin-top: 20px;">
            <table class="admin-table" id="textbooksTable">
              <thead>
                <tr>
                  <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                  <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                  <th>–ó–∞–¥–∞–Ω–∏–π</th>
                  <th>–°—Ç–∞—Ç—É—Å</th>
                  <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- –°–µ–∫—Ü–∏—è –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–æ–≤ -->
      <div class="admin-section" id="crosswords-section">
        <div class="card">
          <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞–º–∏</h2>
          <div class="admin-controls">
            <button class="btn" id="createCrosswordBtn">‚ûï –°–æ–∑–¥–∞—Ç—å –∫—Ä–æ—Å—Å–≤–æ—Ä–¥</button>
          </div>
          
          <div class="material-form" id="crosswordForm">
            <h3 id="crosswordFormTitle">–°–æ–∑–¥–∞—Ç—å –∫—Ä–æ—Å—Å–≤–æ—Ä–¥</h3>
            
            <div class="form-group">
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞:</label>
              <input type="text" id="crosswordTitle" class="input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞">
            </div>
            
            <div class="form-group">
              <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
              <textarea id="crosswordDescription" class="input" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞" rows="3"></textarea>
            </div>
            
            <div class="form-group">
              <label>–û–±–ª–æ–∂–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
              <div class="upload-area" id="crosswordUploadArea">
                <p>üìÅ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–ª–æ–∂–∫–∏ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</p>
                <p class="small-muted">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF, WebP (–º–∞–∫—Å. 5MB)</p>
                <input type="file" id="crosswordCoverInput" style="display:none" accept="image/*">
              </div>
              <div class="upload-progress" id="crosswordCoverProgress">
                <div class="upload-progress-bar" id="crosswordCoverProgressBar"></div>
              </div>
              <input type="hidden" id="crosswordCoverUrl">
              <img class="image-preview" id="crosswordCoverPreview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±–ª–æ–∂–∫–∏">
            </div>
            
            <div class="form-group">
              <label>–ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:</label>
              <input type="number" id="crosswordOrder" class="input" value="0" min="0">
            </div>
            
            <div class="form-group">
              <label>
                <input type="checkbox" id="crosswordIsAvailable">
                –î–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
              </label>
            </div>
            
            <div style="margin-top:20px; display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="btn" id="saveCrosswordBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫—Ä–æ—Å—Å–≤–æ—Ä–¥</button>
              <button class="btn secondary" id="cancelCrosswordBtn">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>
          </div>
          
          <div style="overflow-x: auto; margin-top: 20px;">
            <table class="admin-table" id="crosswordsTable">
              <thead>
                <tr>
                  <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                  <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                  <th>–ó–∞–¥–∞–Ω–∏–π</th>
                  <th>–î–æ—Å—Ç—É–ø</th>
                  <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- –°–µ–∫—Ü–∏—è –∑–∞–¥–∞–Ω–∏–π -->
      <div class="admin-section" id="assignments-section">
        <div class="card">
          <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è–º–∏</h2>
          
          <div class="form-group">
            <label>–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª:</label>
            <select id="materialSelect" class="input">
              <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–±–Ω–∏–∫ –∏–ª–∏ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥ --</option>
            </select>
          </div>
          
          <div class="admin-controls">
            <button class="btn" id="createAssignmentBtn" disabled>‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
          </div>
          
          <div class="assignment-form" id="assignmentForm">
            <h3 id="assignmentFormTitle">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</h3>
            
            <div class="form-group">
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è:</label>
              <input type="text" id="assignmentTitle" class="input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è">
            </div>
            
            <div class="form-group">
              <label>–ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:</label>
              <input type="number" id="assignmentOrder" class="input" value="0" min="0">
            </div>
            
            <div id="assignmentContent">
              <h3>–í–æ–ø—Ä–æ—Å—ã –∑–∞–¥–∞–Ω–∏—è</h3>
              <div class="question-type-selector">
                <div class="type-btn active" data-type="test">üìù –¢–µ—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å</div>
                <div class="type-btn" data-type="fill">‚úçÔ∏è –í–ø–∏—Å–∞—Ç—å –æ—Ç–≤–µ—Ç</div>
                <div class="type-btn" data-type="sentence">üìù –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</div>
              </div>
              <div id="questionsContainer">
                <!-- –í–æ–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
              </div>
              <button class="btn" id="addQuestionBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
            </div>
            
            <div style="margin-top:20px; display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="btn" id="saveAssignmentBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
              <button class="btn secondary" id="cancelAssignmentBtn">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>
          </div>
          
          <div style="overflow-x: auto; margin-top: 20px;">
            <table class="admin-table" id="assignmentsTable">
              <thead>
                <tr>
                  <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                  <th>–ú–∞—Ç–µ—Ä–∏–∞–ª</th>
                  <th>–¢–∏–ø</th>
                  <th>–í–æ–ø—Ä–æ—Å–æ–≤</th>
                  <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- –°–µ–∫—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
      <div class="admin-section" id="users-section">
        <div class="card">
          <h2>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
          <div class="search-container">
            <input type="text" id="userSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email..." class="input">
          </div>
          <div style="overflow-x: auto;">
            <table class="admin-table" id="usersTable">
              <thead>
                <tr>
                  <th>–§–ò–û</th>
                  <th>Email</th>
                  <th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th>
                  <th>–°—Ç–∞—Ç—É—Å</th>
                  <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- –°–µ–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–æ–≤ -->
      <div class="admin-section" id="access-section">
        <div class="card">
          <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞–º–∏ –∫ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞–º</h2>
          
          <div class="form-group">
            <label>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
            <select id="userSelect" class="input">
              <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è --</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>–í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥:</label>
            <select id="crosswordAccessSelect" class="input">
              <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥ --</option>
            </select>
          </div>
          
          <div class="admin-controls">
            <button class="btn" id="grantAccessBtn" disabled>üîê –í—ã–¥–∞—Ç—å –¥–æ—Å—Ç—É–ø</button>
          </div>
          
          <div class="access-management" id="accessManagement">
            <h3>–¢–µ–∫—É—â–∏–µ –¥–æ—Å—Ç—É–ø—ã</h3>
            <div style="overflow-x: auto; margin-top: 20px;">
              <table class="admin-table" id="accessTable">
                <thead>
                  <tr>
                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                    <th>–ö—Ä–æ—Å—Å–≤–æ—Ä–¥</th>
                    <th>–í—ã–¥–∞–Ω</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="modal" style="display: none;">
    <div class="modal-body card">
      <h3 id="modalTitle"></h3>
      <p id="modalText" style="white-space: pre-line;"></p>
      <div style="margin-top: 12px; text-align: center;">
        <button class="btn" id="modalOk">–û–ö</button>
      </div>
    </div>
  </div>

  <script type="module">
    document.getElementById('configLoading').style.display = 'block';
    
    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorMessage').style.display = 'block';
      document.getElementById('configLoading').style.display = 'none';
    }
    
    function showContent() {
      document.getElementById('mainContent').style.display = 'block';
      document.getElementById('configLoading').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
    }
    
    function showModal(title, text) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalText').textContent = text;
      document.getElementById('modal').style.display = 'flex';
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    async function checkAdmin(supabase) {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            window.location.href = '/login.html';
            return false;
        }
        
        const { data: profile } = await supabase
            .from('profiles')
            .select('is_admin')
            .eq('id', user.id)
            .single();
            
        if (!profile || !profile.is_admin) {
            showModal('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω', '–¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
            setTimeout(() => {
                window.location.href = '/profile.html';
            }, 2000);
            return false;
        }
        
        return { user, profile };
    }

    // –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö ID –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤
    function generateQuestionId() {
      return 'q_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    async function initApp() {
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
        showError('‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Supabase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.');
        return false;
      }
      
      try {
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
        const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        
        // –ü–†–û–í–ï–†–Ø–ï–ú –ê–î–ú–ò–ù–ê –ü–ï–†–í–´–ú –î–ï–õ–û–ú
        const adminCheck = await checkAdmin(supabase);
        if (!adminCheck) return false;
        
        const currentUser = adminCheck.user;
        let currentQuestionType = 'test';
        let searchTimeout = null;
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        let editingTextbookId = null;
        let editingCrosswordId = null;
        let editingAssignmentId = null;
        let selectedMaterialId = null;

        // ===== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô =====
        
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        document.getElementById('modalOk').addEventListener('click', () => {
          document.getElementById('modal').style.display = 'none';
        });

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        document.getElementById('logoutBtn').addEventListener('click', async () => {
          if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
            await supabase.auth.signOut();
            window.location.href = '/login.html';
          }
        });

        // –í–∫–ª–∞–¥–∫–∏
        document.querySelectorAll('.admin-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.getAttribute('data-tab');
            
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            
            tab.classList.add('active');
            document.getElementById(`${tabName}-section`).classList.add('active');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
            if (tabName === 'textbooks') {
              loadTextbooks();
            } else if (tabName === 'crosswords') {
              loadCrosswords();
            } else if (tabName === 'assignments') {
              loadMaterialsForAssignments();
              loadAssignments();
            } else if (tabName === 'users') {
              loadUsers();
            } else if (tabName === 'access') {
              loadUsersForAccess();
              loadCrosswordsForAccess();
              loadAccessList();
            }
          });
        });

        // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –£–ß–ï–ë–ù–ò–ö–ê–ú–ò =====
        
        document.getElementById('createTextbookBtn').addEventListener('click', () => showTextbookForm());
        document.getElementById('cancelTextbookBtn').addEventListener('click', () => hideTextbookForm());
        document.getElementById('saveTextbookBtn').addEventListener('click', () => saveTextbook());

        // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–†–û–°–°–í–û–†–î–ê–ú–ò =====
        
        document.getElementById('createCrosswordBtn').addEventListener('click', () => showCrosswordForm());
        document.getElementById('cancelCrosswordBtn').addEventListener('click', () => hideCrosswordForm());
        document.getElementById('saveCrosswordBtn').addEventListener('click', () => saveCrossword());

        // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–î–ê–ù–ò–Ø–ú–ò =====
        
        document.getElementById('materialSelect').addEventListener('change', function() {
          selectedMaterialId = this.value;
          document.getElementById('createAssignmentBtn').disabled = !selectedMaterialId;
          loadAssignments();
        });
        
        document.getElementById('createAssignmentBtn').addEventListener('click', () => showAssignmentForm());
        document.getElementById('cancelAssignmentBtn').addEventListener('click', () => hideAssignmentForm());
        document.getElementById('saveAssignmentBtn').addEventListener('click', () => saveAssignment());
        document.getElementById('addQuestionBtn').addEventListener('click', () => addQuestion());

        // –¢–∏–ø—ã –≤–æ–ø—Ä–æ—Å–æ–≤
        document.querySelectorAll('.type-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentQuestionType = this.getAttribute('data-type');
          });
        });

        // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–û–°–¢–£–ü–ê–ú–ò =====
        
        document.getElementById('userSelect').addEventListener('change', updateAccessButton);
        document.getElementById('crosswordAccessSelect').addEventListener('change', updateAccessButton);
        document.getElementById('grantAccessBtn').addEventListener('click', grantAccess);

        // ===== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø–ú–ò =====
        
        async function uploadImage(file, path) {
          try {
            const fileExt = file.name.split('.').pop();
            const fileName = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
            const filePath = `${path}/${fileName}`;
            
            const { data, error } = await supabase.storage
              .from('materials')
              .upload(filePath, file);
            
            if (error) throw error;
            
            const { data: { publicUrl } } = supabase.storage
              .from('materials')
              .getPublicUrl(filePath);
            
            return publicUrl;
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ' + error.message);
          }
        }
        
        // ===== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ò =====
        
        async function loadStats() {
          try {
            const { data: textbooks, error: textbooksError } = await supabase
              .from('textbooks')
              .select('id');
            
            const { data: crosswords, error: crosswordsError } = await supabase
              .from('crosswords')
              .select('id');

            const { data: assignments, error: assignmentsError } = await supabase
              .from('assignments')
              .select('id');

            const { data: users, error: usersError } = await supabase
              .from('profiles')
              .select('id');

            if (!textbooksError && !crosswordsError && !assignmentsError && !usersError) {
              document.getElementById('totalTextbooks').textContent = textbooks.length;
              document.getElementById('totalCrosswords').textContent = crosswords.length;
              document.getElementById('totalAssignments').textContent = assignments.length;
              document.getElementById('totalUsers').textContent = users.length;
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
          }
        }

        // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –£–ß–ï–ë–ù–ò–ö–ê–ú–ò =====
        
        function showTextbookForm() {
          document.getElementById('textbookForm').classList.add('active');
          document.getElementById('textbookFormTitle').textContent = '–°–æ–∑–¥–∞—Ç—å —É—á–µ–±–Ω–∏–∫';
          document.getElementById('textbookTitle').value = '';
          document.getElementById('textbookDescription').value = '';
          document.getElementById('textbookOrder').value = '0';
          document.getElementById('textbookCoverUrl').value = '';
          document.getElementById('textbookCoverPreview').style.display = 'none';
          editingTextbookId = null;
        }
        
        function hideTextbookForm() {
          document.getElementById('textbookForm').classList.remove('active');
        }
        
        async function saveTextbook() {
          const title = document.getElementById('textbookTitle').value.trim();
          const description = document.getElementById('textbookDescription').value.trim();
          const orderIndex = parseInt(document.getElementById('textbookOrder').value);
          const coverUrl = document.getElementById('textbookCoverUrl').value;
          
          if (!title) {
            showModal('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—á–µ–±–Ω–∏–∫–∞');
            return;
          }
          
          try {
            const textbookData = {
              title,
              description,
              order_index: orderIndex,
              is_active: true,
              created_by: currentUser.id
            };
            
            if (coverUrl) {
              textbookData.cover_image_url = coverUrl;
            }
            
            let result;
            if (editingTextbookId) {
              result = await supabase
                .from('textbooks')
                .update(textbookData)
                .eq('id', editingTextbookId);
            } else {
              result = await supabase
                .from('textbooks')
                .insert([textbookData]);
            }
            
            const { error } = result;
            
            if (error) {
              console.error('Supabase error:', error);
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—à–∏–±–∫–∞ RLS –æ—à–∏–±–∫–æ–π
              if (error.code === '42501' || error.message.includes('row-level security')) {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.');
              }
              throw error;
            }
            
            showModal('–£—Å–ø–µ—Ö', editingTextbookId ? '–£—á–µ–±–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω' : '–£—á–µ–±–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω');
            hideTextbookForm();
            loadTextbooks();
            loadStats();
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É—á–µ–±–Ω–∏–∫–∞:', error);
            showModal('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —É—á–µ–±–Ω–∏–∫: ' + error.message);
          }
        }
        
        async function loadTextbooks() {
          try {
            const { data: textbooks, error } = await supabase
              .from('textbooks')
              .select('*')
              .order('order_index');
              
            if (error) throw error;
            
            const { data: assignments } = await supabase
              .from('assignments')
              .select('id, textbook_id');
              
            const assignmentsCount = assignments?.reduce((acc, assignment) => {
              if (assignment.textbook_id) {
                acc[assignment.textbook_id] = (acc[assignment.textbook_id] || 0) + 1;
              }
              return acc;
            }, {}) || {};
            
            const tbody = document.querySelector('#textbooksTable tbody');
            tbody.innerHTML = '';
            
            if (!textbooks || textbooks.length === 0) {
              tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:20px;">–£—á–µ–±–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>`;
              return;
            }
            
            textbooks.forEach(textbook => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${textbook.title}</td>
                <td>${textbook.description || '‚Äî'}</td>
                <td>${assignmentsCount[textbook.id] || 0}</td>
                <td>${textbook.is_active ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ùå –ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}</td>
                <td>
                  <button class="btn btn-small edit-textbook" data-id="${textbook.id}">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                  <button class="btn btn-small btn-danger delete-textbook" data-id="${textbook.id}" data-title="${textbook.title}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </td>
              `;
              tbody.appendChild(tr);
            });
            
            document.querySelectorAll('.edit-textbook').forEach(btn => {
              btn.addEventListener('click', async () => {
                const textbookId = btn.getAttribute('data-id');
                await editTextbook(textbookId);
              });
            });
            
            document.querySelectorAll('.delete-textbook').forEach(btn => {
              btn.addEventListener('click', async () => {
                const textbookId = btn.getAttribute('data-id');
                const textbookTitle = btn.getAttribute('data-title');
                await deleteTextbook(textbookId, textbookTitle);
              });
            });
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–µ–±–Ω–∏–∫–æ–≤:', error);
            showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–µ–±–Ω–∏–∫–æ–≤: ' + error.message);
          }
        }
        
        async function editTextbook(textbookId) {
          try {
            const { data: textbook, error } = await supabase
              .from('textbooks')
              .select('*')
              .eq('id', textbookId)
              .single();
              
            if (error) throw error;
            
            document.getElementById('textbookForm').classList.add('active');
            document.getElementById('textbookFormTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É—á–µ–±–Ω–∏–∫';
            document.getElementById('textbookTitle').value = textbook.title;
            document.getElementById('textbookDescription').value = textbook.description || '';
            document.getElementById('textbookOrder').value = textbook.order_index || 0;
            document.getElementById('textbookCoverUrl').value = textbook.cover_image_url || '';
            
            if (textbook.cover_image_url) {
              document.getElementById('textbookCoverPreview').src = textbook.cover_image_url;
              document.getElementById('textbookCoverPreview').style.display = 'block';
            } else {
              document.getElementById('textbookCoverPreview').style.display = 'none';
            }
            
            editingTextbookId = textbookId;
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–µ–±–Ω–∏–∫–∞:', error);
            showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–µ–±–Ω–∏–∫–∞: ' + error.message);
          }
        }
        
        async function deleteTextbook(textbookId, textbookTitle) {
          if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —É—á–µ–±–Ω–∏–∫ "${textbookTitle}"?\n\n–í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.`)) return;
          
          try {
            const { error } = await supabase
              .from('textbooks')
              .delete()
              .eq('id', textbookId);
              
            if (error) throw error;
            
            showModal('–£—Å–ø–µ—Ö', '–£—á–µ–±–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω');
            loadTextbooks();
            loadStats();
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —É—á–µ–±–Ω–∏–∫–∞:', error);
            showModal('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —É—á–µ–±–Ω–∏–∫: ' + error.message);
          }
        }

        // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–†–û–°–°–í–û–†–î–ê–ú–ò =====
        
        function showCrosswordForm() {
          document.getElementById('crosswordForm').classList.add('active');
          document.getElementById('crosswordFormTitle').textContent = '–°–æ–∑–¥–∞—Ç—å –∫—Ä–æ—Å—Å–≤–æ—Ä–¥';
          document.getElementById('crosswordTitle').value = '';
          document.getElementById('crosswordDescription').value = '';
          document.getElementById('crosswordOrder').value = '0';
          document.getElementById('crosswordIsAvailable').checked = false;
          document.getElementById('crosswordCoverUrl').value = '';
          document.getElementById('crosswordCoverPreview').style.display = 'none';
          editingCrosswordId = null;
        }
        
        function hideCrosswordForm() {
          document.getElementById('crosswordForm').classList.remove('active');
        }
        
        async function saveCrossword() {
          const title = document.getElementById('crosswordTitle').value.trim();
          const description = document.getElementById('crosswordDescription').value.trim();
          const orderIndex = parseInt(document.getElementById('crosswordOrder').value);
          const isAvailable = document.getElementById('crosswordIsAvailable').checked;
          const coverUrl = document.getElementById('crosswordCoverUrl').value;
          
          if (!title) {
            showModal('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞');
            return;
          }
          
          try {
            const crosswordData = {
              title,
              description,
              order_index: orderIndex,
              is_available: isAvailable,
              is_active: true,
              created_by: currentUser.id
            };
            
            if (coverUrl) {
              crosswordData.cover_image_url = coverUrl;
            }
            
            let result;
            if (editingCrosswordId) {
              result = await supabase
                .from('crosswords')
                .update(crosswordData)
                .eq('id', editingCrosswordId);
            } else {
              result = await supabase
                .from('crosswords')
                .insert([crosswordData]);
            }
            
            const { error } = result;
            
            if (error) {
              console.error('Supabase error:', error);
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—à–∏–±–∫–∞ RLS –æ—à–∏–±–∫–æ–π
              if (error.code === '42501' || error.message.includes('row-level security')) {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.');
              }
              throw error;
            }
            
            showModal('–£—Å–ø–µ—Ö', editingCrosswordId ? '–ö—Ä–æ—Å—Å–≤–æ—Ä–¥ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω' : '–ö—Ä–æ—Å—Å–≤–æ—Ä–¥ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω');
            hideCrosswordForm();
            loadCrosswords();
            loadStats();
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞:', error);
            showModal('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫—Ä–æ—Å—Å–≤–æ—Ä–¥: ' + error.message);
          }
        }
        
        async function loadCrosswords() {
          try {
            const { data: crosswords, error } = await supabase
              .from('crosswords')
              .select('*')
              .order('order_index');
              
            if (error) throw error;
            
            const { data: assignments } = await supabase
              .from('assignments')
              .select('id, crossword_id');
              
            const assignmentsCount = assignments?.reduce((acc, assignment) => {
              if (assignment.crossword_id) {
                acc[assignment.crossword_id] = (acc[assignment.crossword_id] || 0) + 1;
              }
              return acc;
            }, {}) || {};
            
            const tbody = document.querySelector('#crosswordsTable tbody');
            tbody.innerHTML = '';
            
            if (!crosswords || crosswords.length === 0) {
              tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:20px;">–ö—Ä–æ—Å—Å–≤–æ—Ä–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>`;
              return;
            }
            
            crosswords.forEach(crossword => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${crossword.title}</td>
                <td>${crossword.description || '‚Äî'}</td>
                <td>${assignmentsCount[crossword.id] || 0}</td>
                <td>${crossword.is_available ? 'üåç –î–ª—è –≤—Å–µ—Ö' : 'üîí –ü–æ –¥–æ—Å—Ç—É–ø—É'}</td>
                <td>
                  <button class="btn btn-small edit-crossword" data-id="${crossword.id}">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                  <button class="btn btn-small btn-danger delete-crossword" data-id="${crossword.id}" data-title="${crossword.title}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </td>
              `;
              tbody.appendChild(tr);
            });
            
            document.querySelectorAll('.edit-crossword').forEach(btn => {
              btn.addEventListener('click', async () => {
                const crosswordId = btn.getAttribute('data-id');
                await editCrossword(crosswordId);
              });
            });
            
            document.querySelectorAll('.delete-crossword').forEach(btn => {
              btn.addEventListener('click', async () => {
                const crosswordId = btn.getAttribute('data-id');
                const crosswordTitle = btn.getAttribute('data-title');
                await deleteCrossword(crosswordId, crosswordTitle);
              });
            });
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–æ–≤:', error);
            showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–æ–≤: ' + error.message);
          }
        }
        
        async function editCrossword(crosswordId) {
          try {
            const { data: crossword, error } = await supabase
              .from('crosswords')
              .select('*')
              .eq('id', crosswordId)
              .single();
              
            if (error) throw error;
            
            document.getElementById('crosswordForm').classList.add('active');
            document.getElementById('crosswordFormTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–æ—Å—Å–≤–æ—Ä–¥';
            document.getElementById('crosswordTitle').value = crossword.title;
            document.getElementById('crosswordDescription').value = crossword.description || '';
            document.getElementById('crosswordOrder').value = crossword.order_index || 0;
            document.getElementById('crosswordIsAvailable').checked = crossword.is_available;
            document.getElementById('crosswordCoverUrl').value = crossword.cover_image_url || '';
            
            if (crossword.cover_image_url) {
              document.getElementById('crosswordCoverPreview').src = crossword.cover_image_url;
              document.getElementById('crosswordCoverPreview').style.display = 'block';
            } else {
              document.getElementById('crosswordCoverPreview').style.display = 'none';
            }
            
            editingCrosswordId = crosswordId;
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞:', error);
            showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞: ' + error.message);
          }
        }
        
        async function deleteCrossword(crosswordId, crosswordTitle) {
          if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫—Ä–æ—Å—Å–≤–æ—Ä–¥ "${crosswordTitle}"?\n\n–í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.`)) return;
          
          try {
            const { error } = await supabase
              .from('crosswords')
              .delete()
              .eq('id', crosswordId);
              
            if (error) throw error;
            
            showModal('–£—Å–ø–µ—Ö', '–ö—Ä–æ—Å—Å–≤–æ—Ä–¥ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω');
            loadCrosswords();
            loadStats();
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞:', error);
            showModal('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫—Ä–æ—Å—Å–≤–æ—Ä–¥: ' + error.message);
          }
        }

        // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–î–ê–ù–ò–Ø–ú–ò =====
        
        async function loadMaterialsForAssignments() {
          try {
            const { data: textbooks, error: textbooksError } = await supabase
              .from('textbooks')
              .select('id, title')
              .eq('is_active', true)
              .order('order_index');
              
            const { data: crosswords, error: crosswordsError } = await supabase
              .from('crosswords')
              .select('id, title')
              .eq('is_active', true)
              .order('order_index');
              
            if (textbooksError) throw textbooksError;
            if (crosswordsError) throw crosswordsError;
            
            const select = document.getElementById('materialSelect');
            select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–±–Ω–∏–∫ –∏–ª–∏ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥ --</option>';
            
            if (textbooks && textbooks.length > 0) {
              const optgroup = document.createElement('optgroup');
              optgroup.label = 'üìö –£—á–µ–±–Ω–∏–∫–∏';
              textbooks.forEach(textbook => {
                const option = document.createElement('option');
                option.value = `textbook_${textbook.id}`;
                option.textContent = textbook.title;
                optgroup.appendChild(option);
              });
              select.appendChild(optgroup);
            }
            
            if (crosswords && crosswords.length > 0) {
              const optgroup = document.createElement('optgroup');
              optgroup.label = 'üß© –ö—Ä–æ—Å—Å–≤–æ—Ä–¥—ã';
              crosswords.forEach(crossword => {
                const option = document.createElement('option');
                option.value = `crossword_${crossword.id}`;
                option.textContent = crossword.title;
                optgroup.appendChild(option);
              });
              select.appendChild(optgroup);
            }
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤:', error);
          }
        }
        
        function showAssignmentForm() {
          document.getElementById('assignmentForm').classList.add('active');
          document.getElementById('assignmentFormTitle').textContent = '–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ';
          document.getElementById('assignmentTitle').value = '';
          document.getElementById('assignmentOrder').value = '0';
          
          currentQuestionType = 'test';
          document.querySelectorAll('.type-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-type') === 'test') {
              btn.classList.add('active');
            }
          });
          
          const questionsContainer = document.getElementById('questionsContainer');
          questionsContainer.innerHTML = '';
          
          addQuestion();
          editingAssignmentId = null;
        }
        
        function hideAssignmentForm() {
          document.getElementById('assignmentForm').classList.remove('active');
        }
        
        function addQuestion() {
          const questionsContainer = document.getElementById('questionsContainer');
          const questionId = generateQuestionId();
          
          const newQuestion = document.createElement('div');
          newQuestion.className = 'subtask-item';
          newQuestion.setAttribute('data-type', currentQuestionType);
          newQuestion.setAttribute('data-id', questionId);
          
          if (currentQuestionType === 'test') {
            newQuestion.innerHTML = `
              <div class="form-group">
                <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
                <input type="text" class="input question-text" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å">
              </div>
              <div class="form-group">
                <label>–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):</label>
                <textarea class="input test-options" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1\n–í–∞—Ä–∏–∞–Ω—Ç 2\n–í–∞—Ä–∏–∞–Ω—Ç 3\n–í–∞—Ä–∏–∞–Ω—Ç 4" rows="4"></textarea>
              </div>
              <div class="form-group">
                <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (–Ω–æ–º–µ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–∞, –Ω–∞—á–∏–Ω–∞—è —Å 1):</label>
                <input type="number" class="input test-correct" min="1" value="1">
              </div>
              <button class="btn btn-small btn-danger remove-question">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
            `;
          } else if (currentQuestionType === 'fill') {
            newQuestion.innerHTML = `
              <div class="form-group">
                <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
                <input type="text" class="input question-text" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å">
              </div>
              <div class="form-group">
                <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):</label>
                <textarea class="input fill-answers" placeholder="–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç 1\n–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç 2\n–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç 3" rows="3"></textarea>
                <div class="small-muted">–£—á–µ–Ω–∏–∫ –ø–æ–ª—É—á–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç, –µ—Å–ª–∏ –≤–≤–µ–¥–µ—Ç –ª—é–±–æ–π –∏–∑ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</div>
              </div>
              <button class="btn btn-small btn-danger remove-question">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
            `;
          } else if (currentQuestionType === 'sentence') {
            newQuestion.innerHTML = `
              <div class="form-group">
                <label>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å –ø—Ä–æ–ø—É—Å–∫–∞–º–∏:</label>
                <div class="sentence-builder">
                  <div class="sentence-preview" id="sentencePreview${questionId}">–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–∏–∂–µ</div>
                  <textarea class="sentence-input" id="sentenceInput${questionId}" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É—è ___ –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–æ–≤. –ù–∞–ø—Ä–∏–º–µ—Ä: –Ø ___ —è–±–ª–æ–∫–æ." rows="2"></textarea>
                  <button class="btn btn-small add-gap-btn" onclick="updateSentencePreview('${questionId}')">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
                </div>
              </div>
              <div class="form-group">
                <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–æ–≤ (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏, –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤):</label>
                <textarea class="input sentence-answers" placeholder="–µ–º\n–∫—Ä–∞—Å–Ω–æ–µ" rows="3"></textarea>
                <div class="small-muted">–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–ø—É—Å–∫–∞ –≤ –ø–æ—Ä—è–¥–∫–µ –∏—Ö –ø–æ—è–≤–ª–µ–Ω–∏—è</div>
              </div>
              <button class="btn btn-small btn-danger remove-question">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
            `;
          }
          
          questionsContainer.appendChild(newQuestion);
          
          const removeQuestionBtn = newQuestion.querySelector('.remove-question');
          removeQuestionBtn.addEventListener('click', function() {
            if (document.querySelectorAll('.subtask-item').length > 1) {
              newQuestion.remove();
            } else {
              alert('–î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å');
            }
          });
          
          // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
          if (currentQuestionType === 'sentence') {
            const sentenceInput = document.getElementById(`sentenceInput${questionId}`);
            sentenceInput.addEventListener('input', () => {
              updateSentencePreview(questionId);
            });
          }
        }
        
        function updateSentencePreview(questionId) {
          const sentenceInput = document.getElementById(`sentenceInput${questionId}`);
          const preview = document.getElementById(`sentencePreview${questionId}`);
          
          if (sentenceInput.value) {
            // –ó–∞–º–µ–Ω—è–µ–º ___ –Ω–∞ –∏–Ω–ø—É—Ç—ã –≤ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ
            let previewHTML = sentenceInput.value;
            let gapCount = 0;
            
            previewHTML = previewHTML.replace(/___/g, () => {
              gapCount++;
              return `<span style="border-bottom: 2px dashed #666; padding: 0 10px; margin: 0 2px;">[${gapCount}]</span>`;
            });
            
            preview.innerHTML = previewHTML;
          } else {
            preview.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–∏–∂–µ';
          }
        }
        
        async function saveAssignment() {
          const title = document.getElementById('assignmentTitle').value.trim();
          const orderIndex = parseInt(document.getElementById('assignmentOrder').value);
          
          if (!title) {
            showModal('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è');
            return;
          }
          
          if (!selectedMaterialId) {
            showModal('–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–±–Ω–∏–∫ –∏–ª–∏ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥');
            return;
          }
          
          const questions = [];
          const questionElements = document.querySelectorAll('.subtask-item');
          
          if (questionElements.length === 0) {
            showModal('–û—à–∏–±–∫–∞', '–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å');
            return;
          }
          
          for (let i = 0; i < questionElements.length; i++) {
            const item = questionElements[i];
            const questionType = item.getAttribute('data-type') || 'test';
            const question = item.querySelector('.question-text').value;
            
            if (!question) {
              showModal('–û—à–∏–±–∫–∞', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞');
              return;
            }
            
            if (questionType === 'test') {
              const optionsText = item.querySelector('.test-options').value;
              const correct = parseInt(item.querySelector('.test-correct').value) - 1;
              
              const options = optionsText.split('\n').filter(opt => opt.trim() !== '');
              
              if (correct < 0 || correct >= options.length) {
                showModal('–û—à–∏–±–∫–∞', '–ù–æ–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –æ–¥–Ω–æ–º—É –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤');
                return;
              }
              
              questions.push({
                type: 'test',
                q: question,
                options: options,
                correct: correct
              });
            } else if (questionType === 'fill') {
              const answersText = item.querySelector('.fill-answers').value;
              const answers = answersText.split('\n').filter(ans => ans.trim() !== '');
              
              if (answers.length === 0) {
                showModal('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç');
                return;
              }
              
              questions.push({
                type: 'fill',
                q: question,
                answers: answers
              });
            } else if (questionType === 'sentence') {
              const sentence = item.querySelector('.sentence-input').value;
              const answersText = item.querySelector('.sentence-answers').value;
              const answers = answersText.split('\n').filter(ans => ans.trim() !== '');
              
              if (!sentence) {
                showModal('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å –ø—Ä–æ–ø—É—Å–∫–∞–º–∏');
                return;
              }
              
              if (answers.length === 0) {
                showModal('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–æ–≤');
                return;
              }
              
              // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏
              const gapCount = (sentence.match(/___/g) || []).length;
              
              if (gapCount !== answers.length) {
                showModal('–û—à–∏–±–∫–∞', `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏ (${gapCount}) –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –æ—Ç–≤–µ—Ç–æ–≤ (${answers.length})`);
                return;
              }
              
              questions.push({
                type: 'sentence',
                q: question,
                sentence: sentence,
                answers: answers
              });
            }
          }
          
          const content = { questions };
          
          const [materialType, materialId] = selectedMaterialId.split('_');
          
          try {
            const assignmentData = {
              title,
              order_index: orderIndex,
              content,
              created_by: currentUser.id
            };
            
            if (materialType === 'textbook') {
              assignmentData.textbook_id = materialId;
            } else if (materialType === 'crossword') {
              assignmentData.crossword_id = materialId;
            }
            
            let result;
            if (editingAssignmentId) {
              result = await supabase
                .from('assignments')
                .update(assignmentData)
                .eq('id', editingAssignmentId);
            } else {
              result = await supabase
                .from('assignments')
                .insert([assignmentData]);
            }
            
            const { error } = result;
            
            if (error) {
              console.error('Supabase error:', error);
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—à–∏–±–∫–∞ RLS –æ—à–∏–±–∫–æ–π
              if (error.code === '42501' || error.message.includes('row-level security')) {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.');
              }
              throw error;
            }
            
            showModal('–£—Å–ø–µ—Ö', editingAssignmentId ? '–ó–∞–¥–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ' : '–ó–∞–¥–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ');
            hideAssignmentForm();
            loadAssignments();
            loadStats();
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è:', error);
            showModal('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ: ' + error.message);
          }
        }
        
        async function loadAssignments() {
          if (!selectedMaterialId) return;
          
          try {
            const [materialType, materialId] = selectedMaterialId.split('_');
            let query = supabase
              .from('assignments')
              .select('*');
              
            if (materialType === 'textbook') {
              query = query.eq('textbook_id', materialId);
            } else if (materialType === 'crossword') {
              query = query.eq('crossword_id', materialId);
            }
            
            const { data: assignments, error } = await query.order('order_index');
            
            if (error) throw error;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const materialNames = {};
            
            if (materialType === 'textbook') {
              const { data: textbook } = await supabase
                .from('textbooks')
                .select('title')
                .eq('id', materialId)
                .single();
              materialNames[materialId] = textbook?.title || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            } else if (materialType === 'crossword') {
              const { data: crossword } = await supabase
                .from('crosswords')
                .select('title')
                .eq('id', materialId)
                .single();
              materialNames[materialId] = crossword?.title || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            }
            
            const tbody = document.querySelector('#assignmentsTable tbody');
            tbody.innerHTML = '';
            
            if (!assignments || assignments.length === 0) {
              tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:20px;">–ó–∞–¥–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>`;
              return;
            }
            
            assignments.forEach(assignment => {
              const questions = assignment.content?.questions || [];
              const questionTypes = questions.map(q => q.type);
              
              let typeText = 'üìù –¢–µ—Å—Ç';
              if (questionTypes.includes('sentence')) {
                typeText = 'üìù –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ';
              } else if (questionTypes.includes('fill')) {
                typeText = '‚úçÔ∏è –í–≤–æ–¥';
              } else if (questionTypes.includes('test')) {
                typeText = 'üìù –¢–µ—Å—Ç';
              }
              
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${assignment.title}</td>
                <td>${materialNames[materialId]}</td>
                <td>${typeText}</td>
                <td>${questions.length}</td>
                <td>
                  <button class="btn btn-small edit-assignment" data-id="${assignment.id}">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                  <button class="btn btn-small btn-danger delete-assignment" data-id="${assignment.id}" data-title="${assignment.title}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </td>
              `;
              tbody.appendChild(tr);
            });
            
            document.querySelectorAll('.edit-assignment').forEach(btn => {
              btn.addEventListener('click', async () => {
                const assignmentId = btn.getAttribute('data-id');
                await editAssignment(assignmentId);
              });
            });
            
            document.querySelectorAll('.delete-assignment').forEach(btn => {
              btn.addEventListener('click', async () => {
                const assignmentId = btn.getAttribute('data-id');
                const assignmentTitle = btn.getAttribute('data-title');
                await deleteAssignment(assignmentId, assignmentTitle);
              });
            });
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π:', error);
            showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π: ' + error.message);
          }
        }
        
        async function editAssignment(assignmentId) {
          try {
            const { data: assignment, error } = await supabase
              .from('assignments')
              .select('*')
              .eq('id', assignmentId)
              .single();
              
            if (error) throw error;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è –≤—ã–±–æ—Ä–∞
            let materialValue = '';
            if (assignment.textbook_id) {
              materialValue = `textbook_${assignment.textbook_id}`;
            } else if (assignment.crossword_id) {
              materialValue = `crossword_${assignment.crossword_id}`;
            }
            
            document.getElementById('materialSelect').value = materialValue;
            selectedMaterialId = materialValue;
            document.getElementById('createAssignmentBtn').disabled = false;
            
            document.getElementById('assignmentForm').classList.add('active');
            document.getElementById('assignmentFormTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ';
            document.getElementById('assignmentTitle').value = assignment.title;
            document.getElementById('assignmentOrder').value = assignment.order_index || 0;
            
            const questionsContainer = document.getElementById('questionsContainer');
            questionsContainer.innerHTML = '';
            
            const questions = assignment.content?.questions || [];
            
            questions.forEach((question, index) => {
              const questionId = generateQuestionId();
              const questionDiv = document.createElement('div');
              questionDiv.className = 'subtask-item';
              questionDiv.setAttribute('data-type', question.type || 'test');
              questionDiv.setAttribute('data-id', questionId);
              
              if (question.type === 'test') {
                questionDiv.innerHTML = `
                  <div class="form-group">
                    <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
                    <input type="text" class="input question-text" value="${question.q}" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å">
                  </div>
                  <div class="form-group">
                    <label>–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):</label>
                    <textarea class="input test-options" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1\n–í–∞—Ä–∏–∞–Ω—Ç 2\n–í–∞—Ä–∏–∞–Ω—Ç 3\n–í–∞—Ä–∏–∞–Ω—Ç 4" rows="4">${(question.options || []).join('\n')}</textarea>
                  </div>
                  <div class="form-group">
                    <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (–Ω–æ–º–µ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–∞, –Ω–∞—á–∏–Ω–∞—è —Å 1):</label>
                    <input type="number" class="input test-correct" min="1" value="${(question.correct || 0) + 1}">
                  </div>
                  <button class="btn btn-small btn-danger remove-question">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
                `;
              } else if (question.type === 'fill') {
                questionDiv.innerHTML = `
                  <div class="form-group">
                    <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
                    <input type="text" class="input question-text" value="${question.q}" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å">
                  </div>
                  <div class="form-group">
                    <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):</label>
                    <textarea class="input fill-answers" placeholder="–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç 1\n–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç 2\n–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç 3" rows="3">${(question.answers || []).join('\n')}</textarea>
                    <div class="small-muted">–£—á–µ–Ω–∏–∫ –ø–æ–ª—É—á–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç, –µ—Å–ª–∏ –≤–≤–µ–¥–µ—Ç –ª—é–±–æ–π –∏–∑ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</div>
                  </div>
                  <button class="btn btn-small btn-danger remove-question">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
                `;
              } else if (question.type === 'sentence') {
                questionDiv.innerHTML = `
                  <div class="form-group">
                    <label>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å –ø—Ä–æ–ø—É—Å–∫–∞–º–∏:</label>
                    <div class="sentence-builder">
                      <div class="sentence-preview" id="sentencePreview${questionId}">${question.sentence.replace(/___/g, '<span style="border-bottom: 2px dashed #666; padding: 0 10px; margin: 0 2px;">[?]</span>')}</div>
                      <textarea class="sentence-input" id="sentenceInput${questionId}" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É—è ___ –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–æ–≤. –ù–∞–ø—Ä–∏–º–µ—Ä: –Ø ___ —è–±–ª–æ–∫–æ." rows="2">${question.sentence}</textarea>
                      <button class="btn btn-small add-gap-btn" onclick="updateSentencePreview('${questionId}')">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
                    </div>
                  </div>
                  <div class="form-group">
                    <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–æ–≤ (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏, –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤):</label>
                    <textarea class="input sentence-answers" placeholder="–µ–º\n–∫—Ä–∞—Å–Ω–æ–µ" rows="3">${(question.answers || []).join('\n')}</textarea>
                    <div class="small-muted">–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–ø—É—Å–∫–∞ –≤ –ø–æ—Ä—è–¥–∫–µ –∏—Ö –ø–æ—è–≤–ª–µ–Ω–∏—è</div>
                  </div>
                  <button class="btn btn-small btn-danger remove-question">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
                `;
              }
              
              questionsContainer.appendChild(questionDiv);
              
              const removeQuestionBtn = questionDiv.querySelector('.remove-question');
              removeQuestionBtn.addEventListener('click', function() {
                if (document.querySelectorAll('.subtask-item').length > 1) {
                  questionDiv.remove();
                } else {
                  alert('–î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å');
                }
              });
            });
            
            editingAssignmentId = assignmentId;
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏—è:', error);
            showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏—è: ' + error.message);
          }
        }
        
        async function deleteAssignment(assignmentId, assignmentTitle) {
          if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ "${assignmentTitle}"?`)) return;
          
          try {
            const { error } = await supabase
              .from('assignments')
              .delete()
              .eq('id', assignmentId);
              
            if (error) throw error;
            
            showModal('–£—Å–ø–µ—Ö', '–ó–∞–¥–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ');
            loadAssignments();
            loadStats();
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è:', error);
            showModal('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ: ' + error.message);
          }
        }

        // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò =====
        
        async function loadUsers() {
          const searchTerm = document.getElementById('userSearch').value.trim();
          
          let query = supabase
            .from('profiles')
            .select(`
              *,
              user_progress(count),
              user_progress_completed:user_progress!inner(count)
            `)
            .neq('id', currentUser.id)
            .order('created_at', { ascending: false });
          
          if (searchTerm) {
            query = query.or(`full_name.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%`);
          }
          
          const { data, error } = await query;
          
          if (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
            showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + error.message);
            return;
          }
          
          const tbody = document.querySelector('#usersTable tbody');
          tbody.innerHTML = '';
          
          if (data.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="5" style="text-align:center;padding:20px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td>`;
            tbody.appendChild(tr);
            return;
          }
          
          data.forEach(user => {
            const totalAssignments = user.user_progress?.[0]?.count || 0;
            const completedAssignments = user.user_progress_completed?.[0]?.count || 0;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>
                <div><strong>${user.full_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</strong></div>
                <div class="user-stats">
                  <span class="stat-badge">üë§ ID: ${user.id.substring(0, 8)}...</span>
                </div>
              </td>
              <td>${user.email || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
              <td>
                <div class="user-stats">
                  <span class="stat-badge">üìä ${completedAssignments}/${totalAssignments} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                </div>
              </td>
              <td>${user.is_admin ? 'üëë –ê–¥–º–∏–Ω' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</td>
              <td>
                <div class="user-actions">
                  <button class="btn btn-small ${user.is_admin ? 'secondary' : ''}" data-user-id="${user.id}" data-make-admin="${!user.is_admin}">
                    ${user.is_admin ? '‚ùå –£–±—Ä–∞—Ç—å –∞–¥–º–∏–Ω–∫—É' : 'üëë –°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º'}
                  </button>
                </div>
              </td>
            `;
            tbody.appendChild(tr);
          });

          document.querySelectorAll('[data-user-id]').forEach(btn => {
            if (btn.textContent.includes('–∞–¥–º–∏–Ω')) {
              btn.addEventListener('click', () => {
                const userId = btn.getAttribute('data-user-id');
                const makeAdmin = btn.getAttribute('data-make-admin') === 'true';
                toggleAdmin(userId, makeAdmin);
              });
            }
          });
        }
        
        async function toggleAdmin(userId, makeAdmin) {
          if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${makeAdmin ? '–Ω–∞–∑–Ω–∞—á–∏—Ç—å' : '—Å–Ω—è—Ç—å'} –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞?`)) return;
          
          const { error } = await supabase
            .from('profiles')
            .update({ is_admin: makeAdmin })
            .eq('id', userId);
            
          if (error) {
            showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–∞–≤: ' + error.message);
          } else {
            loadUsers();
          }
        }

        // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–û–°–¢–£–ü–ê–ú–ò =====
        
        async function loadUsersForAccess() {
          try {
            const { data: users, error } = await supabase
              .from('profiles')
              .select('id, full_name, email')
              .neq('id', currentUser.id)
              .order('full_name');
              
            if (error) throw error;
            
            const select = document.getElementById('userSelect');
            select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è --</option>';
            
            users.forEach(user => {
              const option = document.createElement('option');
              option.value = user.id;
              option.textContent = `${user.full_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'} (${user.email})`;
              select.appendChild(option);
            });
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
          }
        }
        
        async function loadCrosswordsForAccess() {
          try {
            const { data: crosswords, error } = await supabase
              .from('crosswords')
              .select('id, title')
              .eq('is_active', true)
              .eq('is_available', false) // –¢–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
              .order('title');
              
            if (error) throw error;
            
            const select = document.getElementById('crosswordAccessSelect');
            select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥ --</option>';
            
            crosswords.forEach(crossword => {
              const option = document.createElement('option');
              option.value = crossword.id;
              option.textContent = crossword.title;
              select.appendChild(option);
            });
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–æ–≤:', error);
          }
        }
        
        function updateAccessButton() {
          const userId = document.getElementById('userSelect').value;
          const crosswordId = document.getElementById('crosswordAccessSelect').value;
          document.getElementById('grantAccessBtn').disabled = !userId || !crosswordId;
        }
        
        async function grantAccess() {
          const userId = document.getElementById('userSelect').value;
          const crosswordId = document.getElementById('crosswordAccessSelect').value;
          
          try {
            const { error } = await supabase
              .from('crossword_access')
              .insert([{
                user_id: userId,
                crossword_id: crosswordId,
                granted_by: currentUser.id
              }]);
              
            if (error) throw error;
            
            showModal('–£—Å–ø–µ—Ö', '–î–æ—Å—Ç—É–ø —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω');
            loadAccessList();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('userSelect').value = '';
            document.getElementById('crosswordAccessSelect').value = '';
            updateAccessButton();
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –≤—ã–¥–∞—á–∏ –¥–æ—Å—Ç—É–ø–∞:', error);
            showModal('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–¥–∞—Ç—å –¥–æ—Å—Ç—É–ø: ' + error.message);
          }
        }
        
        async function loadAccessList() {
          try {
            const { data: accessList, error } = await supabase
              .from('crossword_access')
              .select(`
                *,
                profiles:user_id(full_name, email),
                crosswords:crossword_id(title),
                granted_by_profiles:granted_by(full_name)
              `)
              .order('granted_at', { ascending: false });
              
            if (error) throw error;
            
            const tbody = document.querySelector('#accessTable tbody');
            tbody.innerHTML = '';
            
            if (!accessList || accessList.length === 0) {
              tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:20px;">–î–æ—Å—Ç—É–ø—ã –Ω–µ –≤—ã–¥–∞–Ω—ã</td></tr>`;
              return;
            }
            
            accessList.forEach(access => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${access.profiles?.full_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'} (${access.profiles?.email})</td>
                <td>${access.crosswords?.title || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                <td>${new Date(access.granted_at).toLocaleDateString('ru-RU')} (${access.granted_by_profiles?.full_name || '–ê–¥–º–∏–Ω'})</td>
                <td>
                  <button class="btn btn-small btn-danger revoke-access" data-id="${access.id}" data-user="${access.profiles?.full_name}" data-crossword="${access.crosswords?.title}">üóëÔ∏è –û—Ç–æ–∑–≤–∞—Ç—å</button>
                </td>
              `;
              tbody.appendChild(tr);
            });
            
            document.querySelectorAll('.revoke-access').forEach(btn => {
              btn.addEventListener('click', async () => {
                const accessId = btn.getAttribute('data-id');
                const userName = btn.getAttribute('data-user');
                const crosswordName = btn.getAttribute('data-crossword');
                await revokeAccess(accessId, userName, crosswordName);
              });
            });
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–æ–≤:', error);
          }
        }
        
        async function revokeAccess(accessId, userName, crosswordName) {
          if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–æ–∑–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –∫ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥—É "${crosswordName}"?`)) return;
          
          try {
            const { error } = await supabase
              .from('crossword_access')
              .delete()
              .eq('id', accessId);
              
            if (error) throw error;
            
            showModal('–£—Å–ø–µ—Ö', '–î–æ—Å—Ç—É–ø —É—Å–ø–µ—à–Ω–æ –æ—Ç–æ–∑–≤–∞–Ω');
            loadAccessList();
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–∑—ã–≤–∞ –¥–æ—Å—Ç—É–ø–∞:', error);
            showModal('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–∑–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø: ' + error.message);
          }
        }

        // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
        
        async function initAdmin() {
          await loadStats();
          await loadTextbooks();
          await loadCrosswords();
          await loadMaterialsForAssignments();
          await loadUsers();
          await loadUsersForAccess();
          await loadCrosswordsForAccess();
          await loadAccessList();
        }

        // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        document.getElementById('userSearch').addEventListener('input', function(e) {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            loadUsers();
          }, 500);
        });

        await initAdmin();
        showContent();
        return true;
        
      } catch (error) {
        showError('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏: ' + error.message);
        return false;
      }
    }
    
    if (window.SUPABASE_URL) {
      initApp();
    } else {
      const timeout = setTimeout(() => {
        showError('‚ùå –¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏');
      }, 1000);
      
      window.addEventListener('configLoaded', () => {
        clearTimeout(timeout);
        initApp();
      });
    }
  </script>
</body>
</html>