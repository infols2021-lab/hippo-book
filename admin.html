<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Админ — Edu Platform</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .admin-container { width:95%; max-width:1400px; margin:20px auto; }
    .admin-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding:15px; background:var(--card); border-radius:16px; box-shadow:0 8px 26px rgba(0,0,0,0.08); }
    .admin-tabs { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
    .admin-tab { padding:12px 20px; background:var(--card); border-radius:12px; cursor:pointer; font-weight:700; box-shadow:0 4px 12px rgba(0,0,0,0.1); transition:all 0.2s; }
    .admin-tab.active { background:var(--accent2); color:white; }
    .admin-section { display:none; }
    .admin-section.active { display:block; }
    .admin-table { width:100%; border-collapse:collapse; margin-top:15px; background:var(--card); border-radius:12px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    .admin-table th, .admin-table td { padding:12px 15px; text-align:left; border-bottom:1px solid rgba(0,0,0,0.06); }
    .admin-table th { background-color:var(--bg1); font-weight:700; }
    .admin-table tr:last-child td { border-bottom:none; }
    .form-group { margin-bottom:15px; }
    .form-group label { display:block; margin-bottom:5px; font-weight:600; }
    .subtask-item { background:var(--bg1); padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid rgba(0,0,0,0.1); }
    .btn-danger { background:#e74c3c; }
    .btn-warning { background:#f39c12; }
    .btn-small { padding:6px 12px; font-size:14px; }
    .user-stats { display:flex; gap:10px; margin-top:5px; flex-wrap:wrap; }
    .stat-badge { background:var(--bg1); padding:4px 8px; border-radius:6px; font-size:12px; }
    .user-actions { display:flex; flex-direction:column; gap:5px; }
    .search-container { margin-bottom:15px; }
    .search-container input { width:100%; }
    .image-preview { max-width:200px; max-height:150px; border-radius:8px; margin:10px 0; display:none; }
    .upload-area { border:2px dashed #ccc; border-radius:8px; padding:20px; text-align:center; cursor:pointer; transition:border-color 0.3s; margin:10px 0; }
    .upload-area:hover { border-color:var(--accent2); }
    .upload-area.dragover { border-color:var(--accent2); background-color:rgba(78,205,196,0.1); }
    .upload-progress { width:100%; height:4px; background:#f0f0f0; border-radius:2px; margin:10px 0; display:none; }
    .upload-progress-bar { height:100%; background:var(--accent2); border-radius:2px; width:0%; transition:width 0.3s; }
    .time-limit-info { background:#e7f3ff; border:1px solid #b3d9ff; border-radius:8px; padding:10px; margin-top:5px; font-size:14px; }
    .question-type-selector { display:flex; gap:10px; margin-bottom:15px; }
    .type-btn { padding:10px 15px; border:2px solid #ddd; border-radius:8px; cursor:pointer; background:white; transition:all 0.3s; }
    .type-btn.active { border-color:var(--accent2); background:var(--accent2); color:white; }
    .fill-answer { padding:8px 12px; border:2px solid rgba(0,0,0,0.1); border-radius:8px; font-size:16px; width:100%; margin-top:5px; }
    .task-stats { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; }
    .task-type-indicator { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 5px; }
    .mcq-type { background: #e3f2fd; color: #1976d2; }
    .fill-type { background: #f3e5f5; color: #7b1fa2; }
    .mixed-type { background: #e8f5e8; color: #2e7d32; }
    .demo-type { background: #fff3cd; color: #856404; }
    .loading { 
      text-align: center; 
      padding: 40px; 
      display: none;
    }
    .spinner { 
      border: 4px solid #f3f3f3; 
      border-top: 4px solid var(--accent2); 
      border-radius: 50%; 
      width: 40px; 
      height: 40px; 
      animation: spin 2s linear infinite; 
      margin: 0 auto 20px; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    .error { 
      background: #ffebee; 
      color: #c62828; 
      padding: 20px; 
      border-radius: 8px; 
      margin: 20px; 
      text-align: center; 
      display: none; 
    }
    .config-loading { 
      text-align: center; 
      padding: 40px; 
    }

    /* Стили для управления фонами */
    .background-preview {
      max-width: 300px;
      max-height: 200px;
      border-radius: 12px;
      margin: 15px 0;
      border: 3px solid #f0f0f0;
    }
    .background-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 12px;
      margin-bottom: 12px;
      background: rgba(255,255,255,0.9);
      transition: all 0.3s ease;
    }
    .background-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .background-item img {
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
    }
    .background-info {
      flex: 1;
    }
    .background-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 120px;
    }
    .active-badge {
      background: #4caf50;
      color: white;
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }

    /* Новые стили для полей ввода в fill-вопросах */
    .fill-inputs-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 10px 0;
    }
    .fill-input-item {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .fill-input-item input {
      flex: 1;
      padding: 8px 12px;
      border: 2px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      font-size: 14px;
    }
    .remove-input-btn {
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .add-input-btn {
      background: var(--accent2);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 5px;
    }
    .input-count {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    /* Демо задания */
    .demo-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
    }
    .demo-checkbox input {
      width: auto;
    }
    .demo-info {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
      font-size: 14px;
    }

    /* Стили для учебников и кроссвордов */
    .textbook-item, .crossword-item {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }
    .textbook-item:hover, .crossword-item:hover {
      border-color: var(--accent2);
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    .textbook-header, .crossword-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .tasks-list {
      margin-top: 15px;
    }
    .task-item {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .task-actions {
      display: flex;
      gap: 8px;
    }

    /* Форма создания пользователя */
    .create-user-form {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .create-user-form h3 {
      margin-top: 0;
      color: #333;
    }

    /* Адаптивность для админ-панели */
    @media (max-width: 1024px) {
      .admin-container {
        width: 98%;
        margin: 15px auto;
      }
      
      .admin-table {
        font-size: 14px;
      }
      
      .admin-table th, 
      .admin-table td {
        padding: 8px 10px;
      }
      
      .admin-tabs {
        gap: 5px;
      }
      
      .admin-tab {
        padding: 10px 15px;
        font-size: 14px;
      }

      .background-item {
        flex-direction: column;
        text-align: center;
      }
      
      .background-actions {
        flex-direction: row;
        justify-content: center;
        min-width: auto;
      }

      .fill-input-item {
        flex-direction: column;
        gap: 5px;
      }

      .textbook-header, .crossword-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .task-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .task-actions {
        width: 100%;
        justify-content: flex-start;
      }
    }

    @media (max-width: 768px) {
      .admin-container {
        width: 100%;
        margin: 10px auto;
        padding: 0 10px;
      }
      
      .admin-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
        padding: 15px;
      }
      
      .admin-header h1 {
        font-size: 1.5rem;
      }
      
      .admin-tabs {
        flex-direction: column;
        gap: 5px;
      }
      
      .admin-tab {
        text-align: center;
        padding: 12px;
      }
      
      .admin-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
        font-size: 13px;
      }
      
      .admin-table th,
      .admin-table td {
        padding: 6px 8px;
        min-width: 120px;
      }
      
      .task-stats {
        padding: 10px;
      }
      
      .task-stats > div {
        flex-direction: column;
        gap: 10px;
      }
      
      .modal-body {
        width: 95%;
        margin: 10px;
        padding: 15px;
      }
      
      .form-group {
        margin-bottom: 12px;
      }
      
      .question-type-selector {
        flex-direction: column;
        gap: 8px;
      }
      
      .type-btn {
        padding: 12px;
        text-align: center;
      }
      
      .subtask-item {
        padding: 12px;
      }
      
      .user-actions {
        flex-direction: row;
        gap: 5px;
      }
      
      .user-actions .btn-small {
        padding: 4px 8px;
        font-size: 12px;
      }

      .user-stats {
        flex-direction: column;
        gap: 5px;
      }

      .background-preview {
        max-width: 100%;
      }
    }

    @media (max-width: 480px) {
      .admin-header h1 {
        font-size: 1.3rem;
      }
      
      .admin-table {
        font-size: 12px;
      }
      
      .admin-table th,
      .admin-table td {
        padding: 4px 6px;
        min-width: 100px;
      }
      
      .task-stats {
        font-size: 14px;
      }
      
      .admin-controls {
        flex-direction: column;
      }
      
      .admin-controls .btn {
        width: 100%;
      }
      
      .search-container input {
        font-size: 16px;
      }
      
      .subtask-item .form-group label {
        font-size: 14px;
      }
      
      .subtask-item input,
      .subtask-item textarea,
      .subtask-item select {
        font-size: 16px;
        padding: 10px 12px;
      }
      
      .upload-area {
        padding: 15px;
      }
      
      .upload-area p {
        font-size: 14px;
      }

      .modal-body {
        margin: 5px;
        padding: 10px;
      }
    }

    @media (max-height: 500px) and (orientation: landscape) {
      .admin-container {
        margin: 5px auto;
      }
      
      .admin-header {
        padding: 10px;
        margin-bottom: 10px;
      }
      
      .card {
        padding: 12px;
      }
    }

    @media (max-width: 360px) {
      .admin-container {
        padding: 0 5px;
      }
      
      .admin-header {
        padding: 10px;
      }
      
      .admin-tab {
        padding: 10px;
        font-size: 13px;
      }
      
      .btn {
        padding: 8px 12px;
        font-size: 14px;
      }
      
      .task-stats {
        font-size: 12px;
      }
    }
  </style>
  
  <script src="/load-config.js"></script>
</head>
<body>
  <div id="configLoading" class="config-loading">
    <div class="spinner"></div>
    <p>🔄 Загружаем конфигурацию админ-панели...</p>
  </div>
  
  <div id="errorMessage" class="error"></div>
  
  <div id="mainContent" style="display: none;">
    <div class="admin-container">
      <div class="admin-header">
        <h1>⚙️ Панель администратора</h1>
        <div>
          <button class="btn" onclick="location.href='/profile.html'">👤 Мой профиль</button>
          <button class="btn secondary" id="logoutBtn">🚪 Выйти</button>
        </div>
      </div>

      <div class="task-stats">
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
          <div>
            <strong>📊 Статистика:</strong>
            <span id="totalUsers">Пользователей: 0</span> | 
            <span id="totalTextbooks">Учебников: 0</span> |
            <span id="totalCrosswords">Кроссвордов: 0</span> |
            <span id="totalBackgrounds">Фонов: 0</span>
          </div>
        </div>
      </div>

      <div class="admin-tabs">
        <div class="admin-tab active" data-tab="users">👥 Пользователи</div>
        <div class="admin-tab" data-tab="textbooks">📚 Учебники</div>
        <div class="admin-tab" data-tab="crosswords">🧩 Кроссворды</div>
        <div class="admin-tab" data-tab="background">🎨 Фон профиля</div>
      </div>

      <!-- Секция пользователей -->
      <div class="admin-section active" id="users-section">
        <div class="card">
          <h2>Управление пользователями</h2>
          
          <!-- Форма создания пользователя -->
          <div class="create-user-form">
            <h3>➕ Добавить нового пользователя</h3>
            <div class="form-group">
              <label>ФИО:</label>
              <input type="text" id="newUserFullName" class="input" placeholder="Иванов Иван Иванович">
            </div>
            <div class="form-group">
              <label>Email:</label>
              <input type="email" id="newUserEmail" class="input" placeholder="ivanov@school.edu">
            </div>
            <div class="form-group">
              <label>Телефон:</label>
              <input type="tel" id="newUserPhone" class="input" placeholder="+7 (999) 123-45-67">
            </div>
            <div class="form-group">
              <label>Пароль:</label>
              <input type="text" id="newUserPassword" class="input" placeholder="Придумайте пароль">
            </div>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="newUserIsAdmin">
                Администратор
              </label>
            </div>
            <button class="btn" id="createUserBtn">Создать пользователя</button>
          </div>

          <!-- Список пользователей -->
          <div class="search-container">
            <input type="text" id="userSearch" placeholder="Поиск по имени или email..." class="input">
          </div>
          <div style="overflow-x: auto;">
            <table class="admin-table" id="usersTable">
              <thead>
                <tr>
                  <th>ФИО</th>
                  <th>Email</th>
                  <th>Телефон</th>
                  <th>Прогресс</th>
                  <th>Статус</th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Секция учебников -->
      <div class="admin-section" id="textbooks-section">
        <div class="card">
          <h2>Управление учебниками</h2>
          <div class="admin-controls">
            <button class="btn" id="createTextbookBtn">➕ Создать учебник</button>
          </div>
          
          <!-- Список учебников -->
          <div id="textbooksList"></div>

          <!-- Форма создания/редактирования учебника -->
          <div class="card" id="textbookFormCard" style="display:none;">
            <h2 id="textbookFormTitle">Создать учебник</h2>
            
            <div class="form-group">
              <label>Название учебника:</label>
              <input type="text" id="textbookTitle" class="input" placeholder="Введите название учебника">
            </div>
            
            <div class="form-group">
              <label>Описание:</label>
              <textarea id="textbookDescription" class="input" placeholder="Описание учебника" rows="3"></textarea>
            </div>
            
            <div class="form-group">
              <label>Порядковый номер:</label>
              <input type="number" id="textbookOrder" class="input" value="1" min="1">
            </div>
            
            <div style="margin-top:20px; display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="btn" id="saveTextbookBtn">💾 Сохранить учебник</button>
              <button class="btn secondary" id="cancelTextbookBtn">❌ Отмена</button>
            </div>
          </div>

          <!-- Форма создания задания в учебнике -->
          <div class="card" id="textbookTaskFormCard" style="display:none;">
            <h2 id="textbookTaskFormTitle">Создать задание в учебнике</h2>
            
            <div class="form-group">
              <label>Название задания:</label>
              <input type="text" id="textbookTaskTitle" class="input" placeholder="Введите название задания">
            </div>
            
            <div class="form-group">
              <label>Тип задания:</label>
              <select id="textbookTaskType" class="input">
                <option value="test">📝 Тестовое задание</option>
                <option value="fill">✍️ Задание с пропусками</option>
                <option value="crossword">🧩 Кроссворд</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>Лимит времени (минуты):</label>
              <input type="number" id="textbookTaskTimeLimit" class="input" value="60" min="1" max="240">
            </div>
            
            <div class="form-group">
              <label>Проходной балл (%):</label>
              <input type="number" id="textbookTaskPassingScore" class="input" value="80" min="0" max="100">
            </div>
            
            <div id="textbookTaskContent">
              <!-- Контент задания будет добавляться динамически -->
            </div>
            
            <div style="margin-top:20px; display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="btn" id="saveTextbookTaskBtn">💾 Сохранить задание</button>
              <button class="btn secondary" id="cancelTextbookTaskBtn">❌ Отмена</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Секция кроссвордов -->
      <div class="admin-section" id="crosswords-section">
        <div class="card">
          <h2>Управление кроссвордами</h2>
          <div class="admin-controls">
            <button class="btn" id="createCrosswordBtn">➕ Создать кроссворд</button>
          </div>
          
          <!-- Список кроссвордов -->
          <div id="crosswordsList"></div>

          <!-- Форма создания/редактирования кроссворда -->
          <div class="card" id="crosswordFormCard" style="display:none;">
            <h2 id="crosswordFormTitle">Создать кроссворд</h2>
            
            <div class="form-group">
              <label>Название кроссворда:</label>
              <input type="text" id="crosswordTitle" class="input" placeholder="Введите название кроссворда">
            </div>
            
            <div class="form-group">
              <label>Описание:</label>
              <textarea id="crosswordDescription" class="input" placeholder="Описание кроссворда" rows="3"></textarea>
            </div>
            
            <div class="form-group">
              <label>Порядковый номер:</label>
              <input type="number" id="crosswordOrder" class="input" value="1" min="1">
            </div>
            
            <div style="margin-top:20px; display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="btn" id="saveCrosswordBtn">💾 Сохранить кроссворд</button>
              <button class="btn secondary" id="cancelCrosswordBtn">❌ Отмена</button>
            </div>
          </div>

          <!-- Форма создания задания в кроссворде -->
          <div class="card" id="crosswordTaskFormCard" style="display:none;">
            <h2 id="crosswordTaskFormTitle">Создать задание в кроссворде</h2>
            
            <div class="form-group">
              <label>Название задания:</label>
              <input type="text" id="crosswordTaskTitle" class="input" placeholder="Введите название задания">
            </div>
            
            <div class="form-group">
              <label>Тип задания:</label>
              <select id="crosswordTaskType" class="input">
                <option value="test">📝 Тестовое задание</option>
                <option value="fill">✍️ Задание с пропусками</option>
                <option value="crossword">🧩 Кроссворд</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>Лимит времени (минуты):</label>
              <input type="number" id="crosswordTaskTimeLimit" class="input" value="60" min="1" max="240">
            </div>
            
            <div class="form-group">
              <label>Проходной балл (%):</label>
              <input type="number" id="crosswordTaskPassingScore" class="input" value="80" min="0" max="100">
            </div>
            
            <div id="crosswordTaskContent">
              <!-- Контент задания будет добавляться динамически -->
            </div>
            
            <div style="margin-top:20px; display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="btn" id="saveCrosswordTaskBtn">💾 Сохранить задание</button>
              <button class="btn secondary" id="cancelCrosswordTaskBtn">❌ Отмена</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Секция фонов -->
      <div class="admin-section" id="background-section">
        <div class="card">
          <h2>🎨 Управление фоном профиля</h2>
          
          <!-- Текущий активный фон -->
          <div class="form-group">
            <label>Текущий активный фон:</label>
            <div id="currentBackgroundPreview" style="text-align: center; margin: 15px 0;">
              <p class="small-muted" id="noBackgroundMessage">Фон не установлен</p>
              <img id="currentBackgroundImage" class="background-preview" style="display: none;">
              <div id="currentBackgroundInfo" style="margin-top: 10px;"></div>
            </div>
          </div>

          <!-- Форма загрузки нового фона -->
          <div class="form-group">
            <label>Загрузить новый фон:</label>
            <div class="upload-area" id="backgroundUploadArea">
              <p>📁 Нажмите для загрузки фона или перетащите файл сюда</p>
              <p class="small-muted">Поддерживаемые форматы: JPG, PNG, GIF, WebP (макс. 10MB)</p>
              <input type="file" id="backgroundInput" style="display:none" accept="image/*, .gif">
            </div>
            <div class="upload-progress" id="backgroundProgress" style="display: none;">
              <div class="upload-progress-bar" id="backgroundProgressBar"></div>
            </div>
            <button class="btn" id="uploadBackgroundBtn" style="display: none; margin-top: 10px;">📤 Загрузить фон</button>
          </div>

          <!-- Список загруженных фонов -->
          <div class="form-group">
            <label>Загруженные фоны:</label>
            <div id="backgroundsList" style="margin-top: 15px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="modal" style="display: none;">
    <div class="modal-body card">
      <h3 id="modalTitle"></h3>
      <p id="modalText" style="white-space: pre-line;"></p>
      <div style="margin-top: 12px; text-align: center;">
        <button class="btn" id="modalOk">ОК</button>
      </div>
    </div>
  </div>

  <script type="module">
    document.getElementById('configLoading').style.display = 'block';
    
    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorMessage').style.display = 'block';
      document.getElementById('configLoading').style.display = 'none';
    }
    
    function showContent() {
      document.getElementById('mainContent').style.display = 'block';
      document.getElementById('configLoading').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
    }
    
    function showModal(title, text) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalText').textContent = text;
      document.getElementById('modal').style.display = 'flex';
    }

    // Функция проверки прав администратора
    async function checkAdmin(supabase) {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            window.location.href = '/login.html';
            return false;
        }
        
        const { data: userData } = await supabase
            .from('users')
            .select('is_admin')
            .eq('id', user.id)
            .single();
            
        if (!userData || !userData.is_admin) {
            showModal('Доступ запрещен', 'Требуются права администратора.');
            setTimeout(() => {
                window.location.href = '/profile.html';
            }, 2000);
            return false;
        }
        
        return { user, userData };
    }

    // Функция для экранирования HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Генератор уникальных ID для вопросов
    function generateQuestionId() {
      return 'q_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    async function initApp() {
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
        showError('❌ Ошибка конфигурации. Переменные Supabase не загружены.');
        return false;
      }
      
      try {
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
        const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        
        // ПРОВЕРЯЕМ АДМИНА ПЕРВЫМ ДЕЛОМ
        const adminCheck = await checkAdmin(supabase);
        if (!adminCheck) return false;
        
        const currentUser = adminCheck.user;
        let editingUserId = null;
        let editingTextbookId = null;
        let editingCrosswordId = null;
        let editingTaskId = null;
        let currentTaskType = 'textbook'; // 'textbook' или 'crossword'
        let searchTimeout = null;

        // ===== ОБРАБОТЧИКИ СОБЫТИЙ =====
        
        // Модальное окно
        document.getElementById('modalOk').addEventListener('click', () => {
          document.getElementById('modal').style.display = 'none';
        });

        // Выход из системы
        document.getElementById('logoutBtn').addEventListener('click', async () => {
          if (confirm('Вы уверены, что хотите выйти?')) {
            await supabase.auth.signOut();
            window.location.href = '/login.html';
          }
        });

        // Вкладки
        document.querySelectorAll('.admin-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.getAttribute('data-tab');
            
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            
            tab.classList.add('active');
            document.getElementById(`${tabName}-section`).classList.add('active');
            
            if (tabName === 'users') {
              loadUsers();
            } else if (tabName === 'textbooks') {
              loadTextbooks();
            } else if (tabName === 'crosswords') {
              loadCrosswords();
            } else if (tabName === 'background') {
              loadCurrentBackground();
              loadBackgroundsList();
            }
          });
        });

        // ===== УПРАВЛЕНИЕ ПОЛЬЗОВАТЕЛЯМИ =====

        // Создание пользователя
        document.getElementById('createUserBtn').addEventListener('click', createUser);

        // Поиск пользователей
        document.getElementById('userSearch').addEventListener('input', function(e) {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            loadUsers();
          }, 500);
        });

        // ===== УПРАВЛЕНИЕ УЧЕБНИКАМИ =====

        document.getElementById('createTextbookBtn').addEventListener('click', () => showTextbookForm());
        document.getElementById('saveTextbookBtn').addEventListener('click', saveTextbook);
        document.getElementById('cancelTextbookBtn').addEventListener('click', hideTextbookForm);

        // ===== УПРАВЛЕНИЕ КРОССВОРДАМИ =====

        document.getElementById('createCrosswordBtn').addEventListener('click', () => showCrosswordForm());
        document.getElementById('saveCrosswordBtn').addEventListener('click', saveCrossword);
        document.getElementById('cancelCrosswordBtn').addEventListener('click', hideCrosswordForm);

        // ===== ФУНКЦИИ ДЛЯ ЗАГРУЗКИ ДАННЫХ =====

        async function loadStats() {
          try {
            const { data: users, error: usersError } = await supabase
              .from('users')
              .select('id');

            const { data: textbooks, error: textbooksError } = await supabase
              .from('textbooks')
              .select('id');

            const { data: crosswords, error: crosswordsError } = await supabase
              .from('crosswords')
              .select('id');

            const { data: backgrounds, error: backgroundsError } = await supabase
              .from('backgrounds')
              .select('id');

            if (!usersError && !textbooksError && !crosswordsError && !backgroundsError) {
              document.getElementById('totalUsers').textContent = `Пользователей: ${users.length}`;
              document.getElementById('totalTextbooks').textContent = `Учебников: ${textbooks.length}`;
              document.getElementById('totalCrosswords').textContent = `Кроссвордов: ${crosswords.length}`;
              document.getElementById('totalBackgrounds').textContent = `Фонов: ${backgrounds?.length || 0}`;
            }
          } catch (error) {
            console.error('Ошибка загрузки статистики:', error);
          }
        }

        // ===== УПРАВЛЕНИЕ ПОЛЬЗОВАТЕЛЯМИ =====

        async function loadUsers() {
          const searchTerm = document.getElementById('userSearch').value.trim();
          
          let query = supabase
            .from('users')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (searchTerm) {
            query = query.or(`full_name.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%`);
          }
          
          const { data, error } = await query;
          
          if (error) {
            console.error('Ошибка загрузки пользователей:', error);
            showModal('Ошибка', 'Ошибка загрузки пользователей: ' + error.message);
            return;
          }
          
          const tbody = document.querySelector('#usersTable tbody');
          tbody.innerHTML = '';
          
          if (data.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="6" style="text-align:center;padding:20px;">Пользователи не найдены</td>`;
            tbody.appendChild(tr);
            return;
          }
          
          // Загружаем прогресс для каждого пользователя
          for (let user of data) {
            const progress = await getUserProgress(user.id);
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>
                <div><strong>${user.full_name || 'Не указано'}</strong></div>
                <div class="user-stats">
                  <span class="stat-badge">👤 ID: ${user.id.substring(0, 8)}...</span>
                </div>
              </td>
              <td>${user.email || 'Не указано'}</td>
              <td>${user.phone || 'Не указано'}</td>
              <td>
                <div class="user-stats">
                  <span class="stat-badge">📚 ${progress.textbooks.completed}/${progress.textbooks.total}</span>
                  <span class="stat-badge">🧩 ${progress.crosswords.completed}/${progress.crosswords.total}</span>
                </div>
              </td>
              <td>${user.is_admin ? '👑 Админ' : '👤 Ученик'}</td>
              <td>
                <div class="user-actions">
                  <button class="btn btn-small ${user.is_admin ? 'secondary' : ''}" data-user-id="${user.id}" data-make-admin="${!user.is_admin}">
                    ${user.is_admin ? '❌ Убрать админку' : '👑 Сделать админом'}
                  </button>
                  <button class="btn btn-small btn-warning" data-user-id="${user.id}" data-user-email="${user.email}">🔄 Сбросить прогресс</button>
                  <button class="btn btn-small btn-danger" data-user-id="${user.id}" data-user-name="${user.full_name}">🗑️ Удалить</button>
                </div>
              </td>
            `;
            tbody.appendChild(tr);
          }

          // Назначаем обработчики событий
          document.querySelectorAll('[data-user-id]').forEach(btn => {
            if (btn.textContent.includes('админ')) {
              btn.addEventListener('click', () => {
                const userId = btn.getAttribute('data-user-id');
                const makeAdmin = btn.getAttribute('data-make-admin') === 'true';
                toggleAdmin(userId, makeAdmin);
              });
            } else if (btn.textContent.includes('прогресс')) {
              btn.addEventListener('click', () => {
                const userId = btn.getAttribute('data-user-id');
                const userEmail = btn.getAttribute('data-user-email');
                resetProgress(userId, userEmail);
              });
            } else if (btn.textContent.includes('Удалить')) {
              btn.addEventListener('click', () => {
                const userId = btn.getAttribute('data-user-id');
                const userName = btn.getAttribute('data-user-name');
                deleteUser(userId, userName);
              });
            }
          });
        }

        async function getUserProgress(userId) {
          // Получаем прогресс по учебникам
          const { data: textbookProgress, error: textbookError } = await supabase
            .from('user_progress')
            .select('task_id, tasks!inner(textbook_id)')
            .eq('user_id', userId)
            .eq('is_completed', true);

          // Получаем прогресс по кроссвордам
          const { data: crosswordProgress, error: crosswordError } = await supabase
            .from('user_progress')
            .select('task_id, tasks!inner(crossword_id)')
            .eq('user_id', userId)
            .eq('is_completed', true);

          // Получаем общее количество заданий
          const { data: textbookTasks, error: textbookTasksError } = await supabase
            .from('tasks')
            .select('id', { count: 'exact' })
            .not('textbook_id', 'is', null);

          const { data: crosswordTasks, error: crosswordTasksError } = await supabase
            .from('tasks')
            .select('id', { count: 'exact' })
            .not('crossword_id', 'is', null);

          return {
            textbooks: {
              completed: textbookProgress?.length || 0,
              total: textbookTasks?.length || 0
            },
            crosswords: {
              completed: crosswordProgress?.length || 0,
              total: crosswordTasks?.length || 0
            }
          };
        }

        async function createUser() {
          const fullName = document.getElementById('newUserFullName').value.trim();
          const email = document.getElementById('newUserEmail').value.trim();
          const phone = document.getElementById('newUserPhone').value.trim();
          const password = document.getElementById('newUserPassword').value;
          const isAdmin = document.getElementById('newUserIsAdmin').checked;

          if (!fullName || !email || !password) {
            showModal('Ошибка', 'Заполните обязательные поля: ФИО, email и пароль');
            return;
          }

          try {
            // В реальной системе здесь должно быть хеширование пароля!
            const { data, error } = await supabase
              .from('users')
              .insert([{
                full_name: fullName,
                email: email,
                phone: phone,
                password_hash: password, // В реальной системе: await hashPassword(password)
                is_admin: isAdmin
              }])
              .select();

            if (error) throw error;

            showModal('Успех', '✅ Пользователь успешно создан!\n\nДанные для входа:\nEmail: ' + email + '\nПароль: ' + password);
            
            // Очищаем форму
            document.getElementById('newUserFullName').value = '';
            document.getElementById('newUserEmail').value = '';
            document.getElementById('newUserPhone').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('newUserIsAdmin').checked = false;

            // Обновляем список
            loadUsers();
            loadStats();
          } catch (error) {
            console.error('Ошибка создания пользователя:', error);
            if (error.code === '23505') {
              showModal('Ошибка', '❌ Пользователь с таким email уже существует');
            } else {
              showModal('Ошибка', '❌ Ошибка создания пользователя: ' + error.message);
            }
          }
        }

        async function toggleAdmin(userId, makeAdmin) {
          if (!confirm(`Вы уверены, что хотите ${makeAdmin ? 'назначить' : 'снять'} права администратора?`)) return;
          
          const { error } = await supabase
            .from('users')
            .update({ is_admin: makeAdmin })
            .eq('id', userId);
            
          if (error) {
            showModal('Ошибка', 'Ошибка при изменении прав: ' + error.message);
          } else {
            loadUsers();
          }
        }

        async function resetProgress(userId, userEmail) {
          if (!confirm(`ВЫ УВЕРЕНЫ, что хотите ПОЛНОСТЬЮ сбросить прогресс пользователя ${userEmail}?\n\nЭто действие удалит ВСЕ результаты выполнения заданий!`)) return;
          
          try {
            const { error } = await supabase
              .from('user_progress')
              .delete()
              .eq('user_id', userId);
              
            if (error) throw error;
            
            showModal('Успех', '✅ Прогресс пользователя полностью сброшен!');
            loadUsers();
          } catch (error) {
            console.error('Ошибка при сбросе прогресса:', error);
            showModal('Ошибка', 'Ошибка при сбросе прогресса: ' + error.message);
          }
        }

        async function deleteUser(userId, userName) {
          if (!confirm(`ВЫ УВЕРЕНЫ, что хотите УДАЛИТЬ пользователя "${userName}"?\n\nЭто действие нельзя отменить!`)) return;
          
          try {
            // Сначала удаляем прогресс пользователя
            const { error: progressError } = await supabase
              .from('user_progress')
              .delete()
              .eq('user_id', userId);
            
            if (progressError) throw progressError;
            
            // Затем удаляем самого пользователя
            const { error } = await supabase
              .from('users')
              .delete()
              .eq('id', userId);
              
            if (error) throw error;
            
            showModal('Успех', '✅ Пользователь успешно удалён!');
            loadUsers();
            loadStats();
          } catch (error) {
            console.error('Ошибка удаления пользователя:', error);
            showModal('Ошибка', 'Ошибка удаления пользователя: ' + error.message);
          }
        }

        // ===== УПРАВЛЕНИЕ УЧЕБНИКАМИ =====

        async function loadTextbooks() {
          const { data: textbooks, error } = await supabase
            .from('textbooks')
            .select(`
              *,
              tasks (
                id,
                title,
                type,
                order_index,
                is_active
              )
            `)
            .order('order_index', { ascending: true });
          
          if (error) {
            console.error('Ошибка загрузки учебников:', error);
            showModal('Ошибка', 'Ошибка загрузки учебников: ' + error.message);
            return;
          }
          
          const container = document.getElementById('textbooksList');
          container.innerHTML = '';
          
          if (!textbooks || textbooks.length === 0) {
            container.innerHTML = '<p style="text-align:center;padding:20px;color:#666;">Учебники не найдены</p>';
            return;
          }
          
          textbooks.forEach(textbook => {
            const textbookEl = document.createElement('div');
            textbookEl.className = 'textbook-item';
            textbookEl.innerHTML = `
              <div class="textbook-header">
                <div>
                  <h3 style="margin:0;">${textbook.title}</h3>
                  <p class="small-muted" style="margin:5px 0 0 0;">${textbook.description || 'Без описания'}</p>
                  <p class="small-muted">Порядок: ${textbook.order_index} • Заданий: ${textbook.tasks?.length || 0}</p>
                </div>
                <div class="task-actions">
                  <button class="btn btn-small add-task-btn" data-textbook-id="${textbook.id}">➕ Добавить задание</button>
                  <button class="btn btn-small edit-textbook-btn" data-textbook-id="${textbook.id}">✏️ Редактировать</button>
                  <button class="btn btn-small btn-danger delete-textbook-btn" data-textbook-id="${textbook.id}" data-textbook-title="${textbook.title}">🗑️ Удалить</button>
                </div>
              </div>
              <div class="tasks-list">
                ${textbook.tasks && textbook.tasks.length > 0 ? 
                  textbook.tasks.map(task => `
                    <div class="task-item">
                      <div class="task-header">
                        <div>
                          <strong>${task.title}</strong>
                          <span class="task-type-indicator ${task.type === 'test' ? 'mcq-type' : task.type === 'fill' ? 'fill-type' : 'demo-type'}">
                            ${task.type === 'test' ? '📝 Тест' : task.type === 'fill' ? '✍️ Пропуски' : '🧩 Кроссворд'}
                          </span>
                        </div>
                        <div class="task-actions">
                          <button class="btn btn-small edit-task-btn" data-task-id="${task.id}" data-textbook-id="${textbook.id}">✏️ Редактировать</button>
                          <button class="btn btn-small btn-danger delete-task-btn" data-task-id="${task.id}" data-task-title="${task.title}">🗑️ Удалить</button>
                        </div>
                      </div>
                    </div>
                  `).join('') : 
                  '<p style="text-align:center;color:#666;padding:10px;">Задания отсутствуют</p>'
                }
              </div>
            `;
            container.appendChild(textbookEl);
          });

          // Назначаем обработчики
          document.querySelectorAll('.add-task-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const textbookId = btn.getAttribute('data-textbook-id');
              showTextbookTaskForm(textbookId);
            });
          });

          document.querySelectorAll('.edit-textbook-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const textbookId = btn.getAttribute('data-textbook-id');
              editTextbook(textbookId);
            });
          });

          document.querySelectorAll('.delete-textbook-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const textbookId = btn.getAttribute('data-textbook-id');
              const textbookTitle = btn.getAttribute('data-textbook-title');
              deleteTextbook(textbookId, textbookTitle);
            });
          });

          document.querySelectorAll('.edit-task-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const taskId = btn.getAttribute('data-task-id');
              const textbookId = btn.getAttribute('data-textbook-id');
              editTask(taskId, 'textbook', textbookId);
            });
          });

          document.querySelectorAll('.delete-task-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const taskId = btn.getAttribute('data-task-id');
              const taskTitle = btn.getAttribute('data-task-title');
              deleteTask(taskId, taskTitle);
            });
          });
        }

        function showTextbookForm() {
          document.getElementById('textbookFormCard').style.display = 'block';
          document.getElementById('textbookFormTitle').textContent = 'Создать учебник';
          document.getElementById('textbookTitle').value = '';
          document.getElementById('textbookDescription').value = '';
          document.getElementById('textbookOrder').value = '1';
          editingTextbookId = null;
        }

        function hideTextbookForm() {
          document.getElementById('textbookFormCard').style.display = 'none';
        }

        async function saveTextbook() {
          const title = document.getElementById('textbookTitle').value;
          const description = document.getElementById('textbookDescription').value;
          const orderIndex = parseInt(document.getElementById('textbookOrder').value);

          if (!title) {
            showModal('Ошибка', 'Введите название учебника');
            return;
          }

          try {
            if (editingTextbookId) {
              const { error } = await supabase
                .from('textbooks')
                .update({ 
                  title, 
                  description,
                  order_index: orderIndex
                })
                .eq('id', editingTextbookId);
                
              if (error) {
                showModal('Ошибка', 'Ошибка при обновлении учебника: ' + error.message);
              } else {
                showModal('Успех', 'Учебник обновлен');
                hideTextbookForm();
                loadTextbooks();
                loadStats();
              }
            } else {
              const { error } = await supabase
                .from('textbooks')
                .insert([{ 
                  title, 
                  description,
                  order_index: orderIndex
                }]);
                
              if (error) {
                showModal('Ошибка', 'Ошибка при создании учебника: ' + error.message);
              } else {
                showModal('Успех', 'Учебник создан');
                hideTextbookForm();
                loadTextbooks();
                loadStats();
              }
            }
          } catch (error) {
            console.error('Ошибка при сохранении учебника:', error);
            showModal('Ошибка', 'Ошибка при сохранении учебника: ' + error.message);
          }
        }

        async function editTextbook(textbookId) {
          const { data: textbook, error } = await supabase
            .from('textbooks')
            .select('*')
            .eq('id', textbookId)
            .single();
            
          if (error) {
            showModal('Ошибка', 'Ошибка загрузки учебника: ' + error.message);
            return;
          }
          
          document.getElementById('textbookFormCard').style.display = 'block';
          document.getElementById('textbookFormTitle').textContent = 'Редактировать учебник';
          document.getElementById('textbookTitle').value = textbook.title;
          document.getElementById('textbookDescription').value = textbook.description || '';
          document.getElementById('textbookOrder').value = textbook.order_index;
          editingTextbookId = textbookId;
        }

        async function deleteTextbook(textbookId, textbookTitle) {
          if (!confirm(`Вы уверены, что хотите удалить учебник "${textbookTitle}"?\n\nВсе задания в этом учебнике также будут удалены.`)) return;
          
          try {
            const { error } = await supabase
              .from('textbooks')
              .delete()
              .eq('id', textbookId);
              
            if (error) {
              showModal('Ошибка', 'Ошибка при удалении учебника: ' + error.message);
            } else {
              showModal('Успех', 'Учебник удален');
              loadTextbooks();
              loadStats();
            }
          } catch (error) {
            console.error('Ошибка при удалении учебника:', error);
            showModal('Ошибка', 'Ошибка при удалении учебника');
          }
        }

        // ===== УПРАВЛЕНИЕ КРОССВОРДАМИ =====

        async function loadCrosswords() {
          const { data: crosswords, error } = await supabase
            .from('crosswords')
            .select(`
              *,
              tasks (
                id,
                title,
                type,
                order_index,
                is_active
              )
            `)
            .order('order_index', { ascending: true });
          
          if (error) {
            console.error('Ошибка загрузки кроссвордов:', error);
            showModal('Ошибка', 'Ошибка загрузки кроссвордов: ' + error.message);
            return;
          }
          
          const container = document.getElementById('crosswordsList');
          container.innerHTML = '';
          
          if (!crosswords || crosswords.length === 0) {
            container.innerHTML = '<p style="text-align:center;padding:20px;color:#666;">Кроссворды не найдены</p>';
            return;
          }
          
          crosswords.forEach(crossword => {
            const crosswordEl = document.createElement('div');
            crosswordEl.className = 'crossword-item';
            crosswordEl.innerHTML = `
              <div class="crossword-header">
                <div>
                  <h3 style="margin:0;">${crossword.title}</h3>
                  <p class="small-muted" style="margin:5px 0 0 0;">${crossword.description || 'Без описания'}</p>
                  <p class="small-muted">Порядок: ${crossword.order_index} • Заданий: ${crossword.tasks?.length || 0}</p>
                </div>
                <div class="task-actions">
                  <button class="btn btn-small add-crossword-task-btn" data-crossword-id="${crossword.id}">➕ Добавить задание</button>
                  <button class="btn btn-small edit-crossword-btn" data-crossword-id="${crossword.id}">✏️ Редактировать</button>
                  <button class="btn btn-small btn-danger delete-crossword-btn" data-crossword-id="${crossword.id}" data-crossword-title="${crossword.title}">🗑️ Удалить</button>
                </div>
              </div>
              <div class="tasks-list">
                ${crossword.tasks && crossword.tasks.length > 0 ? 
                  crossword.tasks.map(task => `
                    <div class="task-item">
                      <div class="task-header">
                        <div>
                          <strong>${task.title}</strong>
                          <span class="task-type-indicator ${task.type === 'test' ? 'mcq-type' : task.type === 'fill' ? 'fill-type' : 'demo-type'}">
                            ${task.type === 'test' ? '📝 Тест' : task.type === 'fill' ? '✍️ Пропуски' : '🧩 Кроссворд'}
                          </span>
                        </div>
                        <div class="task-actions">
                          <button class="btn btn-small edit-crossword-task-btn" data-task-id="${task.id}" data-crossword-id="${crossword.id}">✏️ Редактировать</button>
                          <button class="btn btn-small btn-danger delete-crossword-task-btn" data-task-id="${task.id}" data-task-title="${task.title}">🗑️ Удалить</button>
                        </div>
                      </div>
                    </div>
                  `).join('') : 
                  '<p style="text-align:center;color:#666;padding:10px;">Задания отсутствуют</p>'
                }
              </div>
            `;
            container.appendChild(crosswordEl);
          });

          // Назначаем обработчики
          document.querySelectorAll('.add-crossword-task-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const crosswordId = btn.getAttribute('data-crossword-id');
              showCrosswordTaskForm(crosswordId);
            });
          });

          document.querySelectorAll('.edit-crossword-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const crosswordId = btn.getAttribute('data-crossword-id');
              editCrossword(crosswordId);
            });
          });

          document.querySelectorAll('.delete-crossword-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const crosswordId = btn.getAttribute('data-crossword-id');
              const crosswordTitle = btn.getAttribute('data-crossword-title');
              deleteCrossword(crosswordId, crosswordTitle);
            });
          });

          document.querySelectorAll('.edit-crossword-task-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const taskId = btn.getAttribute('data-task-id');
              const crosswordId = btn.getAttribute('data-crossword-id');
              editTask(taskId, 'crossword', crosswordId);
            });
          });

          document.querySelectorAll('.delete-crossword-task-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const taskId = btn.getAttribute('data-task-id');
              const taskTitle = btn.getAttribute('data-task-title');
              deleteTask(taskId, taskTitle);
            });
          });
        }

        function showCrosswordForm() {
          document.getElementById('crosswordFormCard').style.display = 'block';
          document.getElementById('crosswordFormTitle').textContent = 'Создать кроссворд';
          document.getElementById('crosswordTitle').value = '';
          document.getElementById('crosswordDescription').value = '';
          document.getElementById('crosswordOrder').value = '1';
          editingCrosswordId = null;
        }

        function hideCrosswordForm() {
          document.getElementById('crosswordFormCard').style.display = 'none';
        }

        async function saveCrossword() {
          const title = document.getElementById('crosswordTitle').value;
          const description = document.getElementById('crosswordDescription').value;
          const orderIndex = parseInt(document.getElementById('crosswordOrder').value);

          if (!title) {
            showModal('Ошибка', 'Введите название кроссворда');
            return;
          }

          try {
            if (editingCrosswordId) {
              const { error } = await supabase
                .from('crosswords')
                .update({ 
                  title, 
                  description,
                  order_index: orderIndex
                })
                .eq('id', editingCrosswordId);
                
              if (error) {
                showModal('Ошибка', 'Ошибка при обновлении кроссворда: ' + error.message);
              } else {
                showModal('Успех', 'Кроссворд обновлен');
                hideCrosswordForm();
                loadCrosswords();
                loadStats();
              }
            } else {
              const { error } = await supabase
                .from('crosswords')
                .insert([{ 
                  title, 
                  description,
                  order_index: orderIndex
                }]);
                
              if (error) {
                showModal('Ошибка', 'Ошибка при создании кроссворда: ' + error.message);
              } else {
                showModal('Успех', 'Кроссворд создан');
                hideCrosswordForm();
                loadCrosswords();
                loadStats();
              }
            }
          } catch (error) {
            console.error('Ошибка при сохранении кроссворда:', error);
            showModal('Ошибка', 'Ошибка при сохранении кроссворда: ' + error.message);
          }
        }

        async function editCrossword(crosswordId) {
          const { data: crossword, error } = await supabase
            .from('crosswords')
            .select('*')
            .eq('id', crosswordId)
            .single();
            
          if (error) {
            showModal('Ошибка', 'Ошибка загрузки кроссворда: ' + error.message);
            return;
          }
          
          document.getElementById('crosswordFormCard').style.display = 'block';
          document.getElementById('crosswordFormTitle').textContent = 'Редактировать кроссворд';
          document.getElementById('crosswordTitle').value = crossword.title;
          document.getElementById('crosswordDescription').value = crossword.description || '';
          document.getElementById('crosswordOrder').value = crossword.order_index;
          editingCrosswordId = crosswordId;
        }

        async function deleteCrossword(crosswordId, crosswordTitle) {
          if (!confirm(`Вы уверены, что хотите удалить кроссворд "${crosswordTitle}"?\n\nВсе задания в этом кроссворде также будут удалены.`)) return;
          
          try {
            const { error } = await supabase
              .from('crosswords')
              .delete()
              .eq('id', crosswordId);
              
            if (error) {
              showModal('Ошибка', 'Ошибка при удалении кроссворда: ' + error.message);
            } else {
              showModal('Успех', 'Кроссворд удален');
              loadCrosswords();
              loadStats();
            }
          } catch (error) {
            console.error('Ошибка при удалении кроссворда:', error);
            showModal('Ошибка', 'Ошибка при удалении кроссворда');
          }
        }

        // ===== ФУНКЦИИ ДЛЯ ЗАДАНИЙ =====

        function showTextbookTaskForm(textbookId) {
          currentTaskType = 'textbook';
          editingTextbookId = textbookId;
          document.getElementById('textbookTaskFormCard').style.display = 'block';
          document.getElementById('textbookTaskFormTitle').textContent = 'Создать задание в учебнике';
          document.getElementById('textbookTaskTitle').value = '';
          document.getElementById('textbookTaskType').value = 'test';
          document.getElementById('textbookTaskTimeLimit').value = '60';
          document.getElementById('textbookTaskPassingScore').value = '80';
          document.getElementById('textbookTaskContent').innerHTML = '';
          editingTaskId = null;
          
          // Здесь можно добавить логику для создания формы задания в зависимости от типа
          // Пока оставим простую форму
        }

        function showCrosswordTaskForm(crosswordId) {
          currentTaskType = 'crossword';
          editingCrosswordId = crosswordId;
          document.getElementById('crosswordTaskFormCard').style.display = 'block';
          document.getElementById('crosswordTaskFormTitle').textContent = 'Создать задание в кроссворде';
          document.getElementById('crosswordTaskTitle').value = '';
          document.getElementById('crosswordTaskType').value = 'test';
          document.getElementById('crosswordTaskTimeLimit').value = '60';
          document.getElementById('crosswordTaskPassingScore').value = '80';
          document.getElementById('crosswordTaskContent').innerHTML = '';
          editingTaskId = null;
          
          // Здесь можно добавить логику для создания формы задания в зависимости от типа
          // Пока оставим простую форму
        }

        async function saveTextbookTask() {
          const title = document.getElementById('textbookTaskTitle').value;
          const type = document.getElementById('textbookTaskType').value;
          const timeLimit = parseInt(document.getElementById('textbookTaskTimeLimit').value);
          const passingScore = parseInt(document.getElementById('textbookTaskPassingScore').value);

          if (!title) {
            showModal('Ошибка', 'Введите название задания');
            return;
          }

          // Здесь должна быть логика для создания контента задания
          // Пока создаем простой контент
          const content = {
            questions: [
              {
                type: type,
                q: "Пример вопроса",
                options: type === 'test' ? ["Вариант 1", "Вариант 2", "Вариант 3"] : undefined,
                correct: type === 'test' ? 0 : undefined,
                answers: type === 'fill' ? ["правильный ответ"] : undefined
              }
            ]
          };

          try {
            if (editingTaskId) {
              const { error } = await supabase
                .from('tasks')
                .update({ 
                  title, 
                  type,
                  time_limit: timeLimit,
                  passing_score: passingScore,
                  content
                })
                .eq('id', editingTaskId);
                
              if (error) {
                showModal('Ошибка', 'Ошибка при обновлении задания: ' + error.message);
              } else {
                showModal('Успех', 'Задание обновлено');
                document.getElementById('textbookTaskFormCard').style.display = 'none';
                loadTextbooks();
              }
            } else {
              const { error } = await supabase
                .from('tasks')
                .insert([{ 
                  title, 
                  textbook_id: editingTextbookId,
                  type,
                  time_limit: timeLimit,
                  passing_score: passingScore,
                  content
                }]);
                
              if (error) {
                showModal('Ошибка', 'Ошибка при создании задания: ' + error.message);
              } else {
                showModal('Успех', 'Задание создано');
                document.getElementById('textbookTaskFormCard').style.display = 'none';
                loadTextbooks();
              }
            }
          } catch (error) {
            console.error('Ошибка при сохранении задания:', error);
            showModal('Ошибка', 'Ошибка при сохранении задания: ' + error.message);
          }
        }

        async function saveCrosswordTask() {
          const title = document.getElementById('crosswordTaskTitle').value;
          const type = document.getElementById('crosswordTaskType').value;
          const timeLimit = parseInt(document.getElementById('crosswordTaskTimeLimit').value);
          const passingScore = parseInt(document.getElementById('crosswordTaskPassingScore').value);

          if (!title) {
            showModal('Ошибка', 'Введите название задания');
            return;
          }

          // Здесь должна быть логика для создания контента задания
          // Пока создаем простой контент
          const content = {
            questions: [
              {
                type: type,
                q: "Пример вопроса",
                options: type === 'test' ? ["Вариант 1", "Вариант 2", "Вариант 3"] : undefined,
                correct: type === 'test' ? 0 : undefined,
                answers: type === 'fill' ? ["правильный ответ"] : undefined
              }
            ]
          };

          try {
            if (editingTaskId) {
              const { error } = await supabase
                .from('tasks')
                .update({ 
                  title, 
                  type,
                  time_limit: timeLimit,
                  passing_score: passingScore,
                  content
                })
                .eq('id', editingTaskId);
                
              if (error) {
                showModal('Ошибка', 'Ошибка при обновлении задания: ' + error.message);
              } else {
                showModal('Успех', 'Задание обновлено');
                document.getElementById('crosswordTaskFormCard').style.display = 'none';
                loadCrosswords();
              }
            } else {
              const { error } = await supabase
                .from('tasks')
                .insert([{ 
                  title, 
                  crossword_id: editingCrosswordId,
                  type,
                  time_limit: timeLimit,
                  passing_score: passingScore,
                  content
                }]);
                
              if (error) {
                showModal('Ошибка', 'Ошибка при создании задания: ' + error.message);
              } else {
                showModal('Успех', 'Задание создано');
                document.getElementById('crosswordTaskFormCard').style.display = 'none';
                loadCrosswords();
              }
            }
          } catch (error) {
            console.error('Ошибка при сохранении задания:', error);
            showModal('Ошибка', 'Ошибка при сохранении задания: ' + error.message);
          }
        }

        async function editTask(taskId, type, parentId) {
          const { data: task, error } = await supabase
            .from('tasks')
            .select('*')
            .eq('id', taskId)
            .single();
            
          if (error) {
            showModal('Ошибка', 'Ошибка загрузки задания: ' + error.message);
            return;
          }
          
          if (type === 'textbook') {
            document.getElementById('textbookTaskFormCard').style.display = 'block';
            document.getElementById('textbookTaskFormTitle').textContent = 'Редактировать задание';
            document.getElementById('textbookTaskTitle').value = task.title;
            document.getElementById('textbookTaskType').value = task.type;
            document.getElementById('textbookTaskTimeLimit').value = task.time_limit;
            document.getElementById('textbookTaskPassingScore').value = task.passing_score;
            editingTextbookId = parentId;
          } else {
            document.getElementById('crosswordTaskFormCard').style.display = 'block';
            document.getElementById('crosswordTaskFormTitle').textContent = 'Редактировать задание';
            document.getElementById('crosswordTaskTitle').value = task.title;
            document.getElementById('crosswordTaskType').value = task.type;
            document.getElementById('crosswordTaskTimeLimit').value = task.time_limit;
            document.getElementById('crosswordTaskPassingScore').value = task.passing_score;
            editingCrosswordId = parentId;
          }
          
          editingTaskId = taskId;
          currentTaskType = type;
          
          // Здесь должна быть логика для загрузки контента задания в форму
          // Пока оставим простую форму
        }

        async function deleteTask(taskId, taskTitle) {
          if (!confirm(`Вы уверены, что хотите удалить задание "${taskTitle}"?`)) return;
          
          try {
            const { error } = await supabase
              .from('tasks')
              .delete()
              .eq('id', taskId);
              
            if (error) {
              showModal('Ошибка', 'Ошибка при удалении задания: ' + error.message);
            } else {
              showModal('Успех', 'Задание удалено');
              if (currentTaskType === 'textbook') {
                loadTextbooks();
              } else {
                loadCrosswords();
              }
            }
          } catch (error) {
            console.error('Ошибка при удалении задания:', error);
            showModal('Ошибка', 'Ошибка при удалении задания');
          }
        }

        // Назначаем обработчики для форм заданий
        document.getElementById('saveTextbookTaskBtn').addEventListener('click', saveTextbookTask);
        document.getElementById('cancelTextbookTaskBtn').addEventListener('click', () => {
          document.getElementById('textbookTaskFormCard').style.display = 'none';
        });

        document.getElementById('saveCrosswordTaskBtn').addEventListener('click', saveCrosswordTask);
        document.getElementById('cancelCrosswordTaskBtn').addEventListener('click', () => {
          document.getElementById('crosswordTaskFormCard').style.display = 'none';
        });

        // ===== УПРАВЛЕНИЕ ФОНАМИ (оставляем из предыдущей версии) =====

        async function loadCurrentBackground() {
          const { data: activeBackground, error } = await supabase
            .from('backgrounds')
            .select('*')
            .eq('is_active', true)
            .order('created_at', { ascending: false })
            .limit(1)
            .single();

          if (error && error.code !== 'PGRST116') {
            console.error('Ошибка загрузки фона:', error);
            return;
          }

          const preview = document.getElementById('currentBackgroundPreview');
          const image = document.getElementById('currentBackgroundImage');
          const noBgMessage = document.getElementById('noBackgroundMessage');
          const infoDiv = document.getElementById('currentBackgroundInfo');

          infoDiv.innerHTML = '';

          if (activeBackground) {
            image.src = activeBackground.image_url;
            image.style.display = 'block';
            noBgMessage.style.display = 'none';
            
            const info = document.createElement('div');
            info.className = 'small-muted';
            info.innerHTML = `
              <strong>Файл:</strong> ${activeBackground.file_name} 
              (${Math.round(activeBackground.file_size / 1024)} KB) 
              • <strong>Тип:</strong> ${activeBackground.mime_type || 'image'}
              <br><strong>Загружен:</strong> ${new Date(activeBackground.created_at).toLocaleDateString('ru-RU')}
            `;
            infoDiv.appendChild(info);
          } else {
            image.style.display = 'none';
            noBgMessage.style.display = 'block';
          }
        }

        async function loadBackgroundsList() {
          const { data: backgrounds, error } = await supabase
            .from('backgrounds')
            .select('*')
            .order('created_at', { ascending: false });

          if (error) {
            console.error('Ошибка загрузки списка фонов:', error);
            return;
          }

          const container = document.getElementById('backgroundsList');
          container.innerHTML = '';

          if (!backgrounds || backgrounds.length === 0) {
            container.innerHTML = '<p class="small-muted" style="text-align: center; padding: 20px;">Нет загруженных фонов</p>';
            return;
          }

          backgrounds.forEach(bg => {
            const bgCard = document.createElement('div');
            bgCard.className = 'background-item';
            
            bgCard.innerHTML = `
              <img src="${bg.image_url}" style="width: 120px; height: 80px; object-fit: cover;">
              <div class="background-info">
                <div><strong>${bg.file_name}</strong></div>
                <div class="small-muted">
                  ${Math.round(bg.file_size / 1024)} KB • 
                  ${bg.mime_type || 'image'} •
                  ${new Date(bg.created_at).toLocaleDateString('ru-RU')}
                </div>
                <div style="margin-top: 8px;">
                  ${bg.is_active ? 
                    '<span class="active-badge">✅ Активный фон</span>' : 
                    ''
                  }
                </div>
              </div>
              <div class="background-actions">
                ${!bg.is_active ? 
                  `<button class="btn btn-small set-active-bg" data-bg-id="${bg.id}">🎯 Сделать активным</button>` : 
                  ''
                }
                <button class="btn btn-small btn-danger delete-bg" data-bg-id="${bg.id}">🗑️ Удалить</button>
              </div>
            `;
            
            container.appendChild(bgCard);
          });

          document.querySelectorAll('.set-active-bg').forEach(btn => {
            btn.addEventListener('click', async () => {
              const bgId = btn.getAttribute('data-bg-id');
              await setActiveBackground(bgId);
            });
          });

          document.querySelectorAll('.delete-bg').forEach(btn => {
            btn.addEventListener('click', async () => {
              const bgId = btn.getAttribute('data-bg-id');
              await deleteBackground(bgId);
            });
          });
        }

        async function setActiveBackground(bgId) {
          try {
            const { error: updateError } = await supabase
              .from('backgrounds')
              .update({ is_active: false })
              .eq('is_active', true);

            if (updateError) throw updateError;

            const { error: setError } = await supabase
              .from('backgrounds')
              .update({ is_active: true })
              .eq('id', bgId);

            if (setError) throw setError;

            showModal('Успех', '✅ Фон успешно установлен как активный!\n\nТеперь все пользователи увидят этот фон в своих профилях.');
            loadCurrentBackground();
            loadBackgroundsList();
          } catch (error) {
            console.error('Ошибка установки фона:', error);
            showModal('Ошибка', 'Не удалось установить фон: ' + error.message);
          }
        }

        async function deleteBackground(bgId) {
          if (!confirm('Вы уверены, что хотите удалить этот фон?\n\nЭто действие нельзя отменить.')) {
            return;
          }

          try {
            const { data: background, error: fetchError } = await supabase
              .from('backgrounds')
              .select('*')
              .eq('id', bgId)
              .single();

            if (fetchError) throw fetchError;

            const filePath = background.image_url.split('/').pop();
            const { error: storageError } = await supabase.storage
              .from('backgrounds')
              .remove([filePath]);

            if (storageError) {
              console.warn('Не удалось удалить файл из Storage:', storageError);
            }

            const { error: deleteError } = await supabase
              .from('backgrounds')
              .delete()
              .eq('id', bgId);

            if (deleteError) throw deleteError;

            showModal('Успех', '✅ Фон успешно удалён!');
            loadCurrentBackground();
            loadBackgroundsList();
            loadStats();
          } catch (error) {
            console.error('Ошибка удаления фона:', error);
            showModal('Ошибка', 'Не удалось удалить фон: ' + error.message);
          }
        }

        function initBackgrounds() {
          const backgroundInput = document.getElementById('backgroundInput');
          const backgroundUploadArea = document.getElementById('backgroundUploadArea');
          const uploadBtn = document.getElementById('uploadBackgroundBtn');

          backgroundUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            backgroundUploadArea.classList.add('dragover');
          });

          backgroundUploadArea.addEventListener('dragleave', () => {
            backgroundUploadArea.classList.remove('dragover');
          });

          backgroundUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            backgroundUploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
              backgroundInput.files = files;
              handleBackgroundSelection();
            }
          });

          backgroundUploadArea.addEventListener('click', () => {
            backgroundInput.click();
          });

          backgroundInput.addEventListener('change', handleBackgroundSelection);

          uploadBtn.addEventListener('click', () => {
            if (backgroundInput.files && backgroundInput.files[0]) {
              uploadBackground(backgroundInput.files[0]);
            }
          });

          loadCurrentBackground();
          loadBackgroundsList();
        }

        function handleBackgroundSelection() {
          const file = document.getElementById('backgroundInput').files[0];
          const uploadBtn = document.getElementById('uploadBackgroundBtn');
          
          if (file) {
            uploadBtn.style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = function(e) {
              const preview = document.getElementById('currentBackgroundPreview');
              const tempImg = document.createElement('img');
              tempImg.src = e.target.result;
              tempImg.className = 'background-preview';
              tempImg.style.display = 'block';
              
              const currentImg = document.getElementById('currentBackgroundImage');
              const noBg = document.getElementById('noBackgroundMessage');
              currentImg.style.display = 'none';
              noBg.style.display = 'none';
              
              preview.insertBefore(tempImg, preview.firstChild);
            };
            reader.readAsDataURL(file);
          } else {
            uploadBtn.style.display = 'none';
          }
        }

        async function uploadBackground(file) {
          const progressBar = document.getElementById('backgroundProgressBar');
          const progress = document.getElementById('backgroundProgress');
          const uploadBtn = document.getElementById('uploadBackgroundBtn');

          try {
            progress.style.display = 'block';
            progressBar.style.width = '0%';
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Загружаем...';

            if (file.size > 10 * 1024 * 1024) {
              throw new Error('Файл слишком большой! Максимальный размер: 10MB');
            }

            if (!file.type.match('image.*')) {
              throw new Error('Пожалуйста, выберите файл изображения!');
            }

            progressBar.style.width = '25%';

            const fileExt = file.name.split('.').pop();
            const fileName = `background-${Date.now()}-${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
            const filePath = `backgrounds/${fileName}`;

            const { data: uploadData, error: uploadError } = await supabase.storage
              .from('backgrounds')
              .upload(filePath, file, {
                cacheControl: '3600',
                upsert: false
              });

            if (uploadError) throw uploadError;

            progressBar.style.width = '50%';

            const { data: { publicUrl } } = supabase.storage
              .from('backgrounds')
              .getPublicUrl(filePath);

            progressBar.style.width = '75%';

            const { error: dbError } = await supabase
              .from('backgrounds')
              .insert([{
                image_url: publicUrl,
                file_name: file.name,
                file_size: file.size,
                mime_type: file.type,
                created_by: currentUser.id,
                is_active: false
              }]);

            if (dbError) throw dbError;

            progressBar.style.width = '100%';

            setTimeout(() => {
              progress.style.display = 'none';
              uploadBtn.disabled = false;
              uploadBtn.textContent = '📤 Загрузить фон';
              uploadBtn.style.display = 'none';
              
              document.getElementById('backgroundInput').value = '';
              
              showModal('Успех', '✅ Фон успешно загружен!\n\nТеперь вы можете сделать его активным в списке ниже.');
              loadCurrentBackground();
              loadBackgroundsList();
              loadStats();
            }, 1000);

          } catch (error) {
            console.error('Ошибка загрузки фона:', error);
            progress.style.display = 'none';
            uploadBtn.disabled = false;
            uploadBtn.textContent = '📤 Загрузить фон';
            showModal('Ошибка', 'Не удалось загрузить фон: ' + error.message);
          }
        }

        // ===== ИНИЦИАЛИЗАЦИЯ =====

        async function initAdmin() {
          await loadUsers();
          await loadTextbooks();
          await loadCrosswords();
          await loadStats();
          initBackgrounds();
        }

        await initAdmin();
        showContent();
        return true;
        
      } catch (error) {
        showError('❌ Ошибка инициализации админ-панели: ' + error.message);
        return false;
      }
    }
    
    if (window.SUPABASE_URL) {
      initApp();
    } else {
      const timeout = setTimeout(() => {
        showError('❌ Таймаут загрузки конфигурации');
      }, 1000);
      
      window.addEventListener('configLoaded', () => {
        clearTimeout(timeout);
        initApp();
      });
    }
  </script>
</body>
</html>