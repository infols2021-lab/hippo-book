<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Админ — Edu Keys</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .admin-container { width:95%; max-width:1400px; margin:20px auto; }
    .admin-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding:15px; background:var(--card); border-radius:16px; box-shadow:0 8px 26px rgba(0,0,0,0.08); }
    .admin-tabs { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
    .admin-tab { padding:12px 20px; background:var(--card); border-radius:12px; cursor:pointer; font-weight:700; box-shadow:0 4px 12px rgba(0,0,0,0.1); transition:all 0.2s; }
    .admin-tab.active { background:var(--accent2); color:white; }
    .admin-section { display:none; }
    .admin-section.active { display:block; }
    .admin-table { width:100%; border-collapse:collapse; margin-top:15px; background:var(--card); border-radius:12px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    .admin-table th, .admin-table td { padding:12px 15px; text-align:left; border-bottom:1px solid rgba(0,0,0,0.06); }
    .admin-table th { background-color:var(--bg1); font-weight:700; }
    .admin-table tr:last-child td { border-bottom:none; }
    .form-group { margin-bottom:15px; }
    .form-group label { display:block; margin-bottom:5px; font-weight:600; }
    .subtask-item { background:var(--bg1); padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid rgba(0,0,0,0.1); }
    .btn-danger { background:#e74c3c; }
    .btn-warning { background:#f39c12; }
    .btn-small { padding:6px 12px; font-size:14px; }
    .user-stats { display:flex; gap:10px; margin-top:5px; flex-wrap:wrap; }
    .stat-badge { background:var(--bg1); padding:4px 8px; border-radius:6px; font-size:12px; }
    .user-actions { display:flex; flex-direction:column; gap:5px; }
    .search-container { margin-bottom:15px; }
    .search-container input { width:100%; }
    .image-preview { max-width:200px; max-height:150px; border-radius:8px; margin:10px 0; display:none; }
    .upload-area { border:2px dashed #ccc; border-radius:8px; padding:20px; text-align:center; cursor:pointer; transition:border-color 0.3s; margin:10px 0; }
    .upload-area:hover { border-color:var(--accent2); }
    .upload-area.dragover { border-color:var(--accent2); background-color:rgba(78,205,196,0.1); }
    .upload-progress { width:100%; height:4px; background:#f0f0f0; border-radius:2px; margin:10px 0; display:none; }
    .upload-progress-bar { height:100%; background:var(--accent2); border-radius:2px; width:0%; transition:width 0.3s; }
    .material-form { display: none; margin-top: 20px; }
    .material-form.active { display: block; }
    .assignment-form { display: none; margin-top: 20px; }
    .assignment-form.active { display: block; }
    .access-management { display: none; margin-top: 20px; }
    .access-management.active { display: block; }
    .question-type-selector { display:flex; gap:10px; margin-bottom:15px; }
    .type-btn { padding:10px 15px; border:2px solid #ddd; border-radius:8px; cursor:pointer; background:white; transition:all 0.3s; }
    .type-btn.active { border-color:var(--accent2); background:var(--accent2); color:white; }
    .fill-inputs-container { display: flex; flex-direction: column; gap: 10px; margin: 10px 0; }
    .fill-input-item { display: flex; gap: 10px; align-items: center; }
    .fill-input-item input { flex: 1; padding: 8px 12px; border: 2px solid rgba(0,0,0,0.1); border-radius: 8px; font-size: 14px; }
    .remove-input-btn { background: #e74c3c; color: white; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-size: 12px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }
    .add-input-btn { background: var(--accent2); color: white; border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; font-size: 14px; margin-top: 5px; }
    .input-count { font-size: 12px; color: #666; margin-top: 5px; }
    .sentence-builder { background: #f8f9fa; border-radius: 8px; padding: 15px; margin: 10px 0; }
    .sentence-preview { background: white; border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin-bottom: 10px; font-size: 16px; line-height: 1.5; }
    .sentence-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; margin-bottom: 10px; }
    .add-gap-btn { background: #17a2b8; color: white; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-size: 14px; }
    .loading { text-align: center; padding: 40px; display: none; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent2); border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .error { background: #ffebee; color: #c62828; padding: 20px; border-radius: 8px; margin: 20px; text-align: center; display: none; }
    .config-loading { text-align: center; padding: 40px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
    .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; border-left: 4px solid var(--accent2); }
    .stat-number { font-size: 2rem; font-weight: 700; color: var(--accent2); margin-bottom: 5px; }
    .stat-label { font-size: 14px; color: #666; font-weight: 600; }

    /* Изображения в вопросах */
    .question-image-upload { margin: 10px 0; }
    .question-image-preview { max-width: 200px; max-height: 150px; border-radius: 8px; margin-top: 10px; display: none; }

    /* Модалка доступа пользователей */
    .user-access-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 10000; }
    .user-access-content { background: white; border-radius: 12px; padding: 20px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; }
    .access-category { margin: 15px 0; }
    .access-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px; margin: 10px 0; }
    .access-item { display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }

    /* НОВЫЕ СТИЛИ ДЛЯ ПРОСТОГО КРОССВОРДА */
    .crossword-simple-builder {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        margin: 15px 0;
        border: 2px solid #e9ecef;
    }

    .crossword-simple-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: end;
    }

    .crossword-simple-controls .form-group {
        margin-bottom: 0;
        flex: 1;
        min-width: 150px;
    }

    .crossword-simple-grid {
        display: inline-block;
        border: 3px solid #333;
        background: white;
        margin: 10px 0;
    }

    .crossword-row {
        display: flex;
    }

    .crossword-cell {
        width: 40px;
        height: 40px;
        border: 1px solid #999;
        position: relative;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
    }

    .crossword-cell.blocked {
        background: #333;
        border-color: #333;
    }

    .crossword-cell input {
        width: 100%;
        height: 100%;
        border: none;
        text-align: center;
        font-size: 18px;
        font-weight: bold;
        text-transform: uppercase;
        background: transparent;
        outline: none;
        font-family: inherit;
        color: #2c3e50;
    }

    .crossword-cell input:focus {
        background: #e3f2fd;
    }

    .crossword-cell.blocked input {
        display: none;
    }

    .crossword-simple-actions {
        display: flex;
        gap: 10px;
        margin: 15px 0;
        flex-wrap: wrap;
    }

    .crossword-simple-help {
        background: #e8f5e8;
        border: 1px solid #c8e6c9;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        font-size: 14px;
        line-height: 1.5;
    }

    .crossword-simple-help h4 {
        margin: 0 0 10px 0;
        color: #2e7d32;
    }

    .crossword-simple-help ul {
        margin: 0;
        padding-left: 20px;
    }

    .crossword-simple-help li {
        margin-bottom: 5px;
    }

    .crossword-stats {
        background: white;
        padding: 12px;
        border-radius: 8px;
        margin: 10px 0;
        border: 1px solid #e0e0e0;
        font-size: 14px;
    }

    .crossword-stat-item {
        display: flex;
        justify-content: space-between;
        margin: 5px 0;
    }

    .validation-message {
        padding: 12px;
        border-radius: 8px;
        margin: 10px 0;
        font-size: 14px;
    }

    .validation-message.success {
        background: #e8f5e8;
        color: #2e7d32;
        border: 1px solid #c8e6c9;
    }

    .validation-message.error {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ffcdd2;
    }

    .validation-message.warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    @media (max-width: 1024px) {
      .admin-container { width: 98%; margin: 15px auto; }
      .admin-table { font-size: 14px; }
      .admin-table th, .admin-table td { padding: 8px 10px; }
      .admin-tabs { gap: 5px; }
      .admin-tab { padding: 10px 15px; font-size: 14px; }
      .crossword-cell { width: 35px; height: 35px; font-size: 14px; }
    }

    @media (max-width: 768px) {
      .admin-container { width: 100%; margin: 10px auto; padding: 0 10px; }
      .admin-header { flex-direction: column; gap: 15px; text-align: center; padding: 15px; }
      .admin-header h1 { font-size: 1.5rem; }
      .admin-tabs { flex-direction: column; gap: 5px; }
      .admin-tab { text-align: center; padding: 12px; }
      .admin-table { display: block; overflow-x: auto; white-space: nowrap; font-size: 13px; }
      .admin-table th, .admin-table td { padding: 6px 8px; min-width: 120px; }
      .question-type-selector { flex-direction: column; gap: 8px; }
      .type-btn { padding: 12px; text-align: center; }
      .user-actions { flex-direction: row; gap: 5px; }
      .user-actions .btn-small { padding: 4px 8px; font-size: 12px; }
      .crossword-cell { width: 30px; height: 30px; font-size: 12px; }
      .crossword-simple-controls { flex-direction: column; }
      .crossword-simple-controls .form-group { width: 100%; }
    }

    @media (max-width: 480px) {
      .crossword-cell { width: 25px; height: 25px; font-size: 10px; }
    }
  </style>

  <script src="/load-config.js"></script>
</head>
<body>
  <div id="configLoading" class="config-loading">
    <div class="spinner"></div>
    <p>🔄 Загружаем конфигурацию админ-панели...</p>
  </div>
  <div id="errorMessage" class="error"></div>

  <div id="mainContent" style="display: none;">
    <!-- Модальное окно управления доступом пользователя -->
    <div class="user-access-modal" id="userAccessModal">
      <div class="user-access-content card">
        <h3>🔐 Управление доступом пользователя</h3>
        <div id="userAccessInfo"></div>

        <div class="access-category">
          <h4>📚 Доступ к учебникам</h4>
          <div class="access-list" id="textbookAccessList"></div>
        </div>

        <div class="access-category">
          <h4>🧩 Доступ к кроссвордам</h4>
          <div class="access-list" id="crosswordAccessList"></div>
        </div>

        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
          <button class="btn" id="saveUserAccessBtn">💾 Сохранить доступы</button>
          <button class="btn secondary" id="closeUserAccessModal">❌ Закрыть</button>
        </div>
      </div>
    </div>

    <div class="admin-container">
      <div class="admin-header">
        <h1>⚙️ Панель администратора</h1>
        <div>
          <button class="btn" onclick="location.href='/profile.html'">👤 Мой профиль</button>
          <button class="btn secondary" id="logoutBtn">🚪 Выйти</button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalTextbooks">0</div>
          <div class="stat-label">Учебников</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalCrosswords">0</div>
          <div class="stat-label">Кроссвордов</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalAssignments">0</div>
          <div class="stat-label">Заданий</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalUsers">0</div>
          <div class="stat-label">Пользователей</div>
        </div>
      </div>

      <div class="admin-tabs">
        <div class="admin-tab active" data-tab="textbooks">📚 Учебники</div>
        <div class="admin-tab" data-tab="crosswords">🧩 Кроссворды</div>
        <div class="admin-tab" data-tab="assignments">📝 Задания</div>
        <div class="admin-tab" data-tab="users">👥 Пользователи</div>
      </div>

      <!-- Секция учебников -->
      <div class="admin-section active" id="textbooks-section">
        <div class="card">
          <h2>Управление учебниками</h2>
          <div class="admin-controls">
            <button class="btn" id="createTextbookBtn">➕ Создать учебник</button>
          </div>

          <div class="material-form" id="textbookForm">
            <h3 id="textbookFormTitle">Создать учебник</h3>

            <div class="form-group">
              <label>Название учебника:</label>
              <input type="text" id="textbookTitle" class="input" placeholder="Введите название учебника">
            </div>

            <div class="form-group">
              <label>Описание:</label>
              <textarea id="textbookDescription" class="input" placeholder="Введите описание учебника" rows="3"></textarea>
            </div>

            <div class="form-group">
              <label>Обложка (опционально):</label>
              <div class="upload-area" id="textbookUploadArea">
                <p>📁 Нажмите для загрузки обложки или перетащите файл сюда</p>
                <p class="small-muted">Поддерживаемые форматы: JPG, PNG, GIF, WebP (макс. 5MB)</p>
                <input type="file" id="textbookCoverInput" style="display:none" accept="image/*">
              </div>
              <div class="upload-progress" id="textbookCoverProgress">
                <div class="upload-progress-bar" id="textbookCoverProgressBar"></div>
              </div>
              <input type="hidden" id="textbookCoverUrl">
              <img class="image-preview" id="textbookCoverPreview" alt="Предпросмотр обложки">
            </div>

            <div class="form-group">
              <label>Порядок отображения:</label>
              <input type="number" id="textbookOrder" class="input" value="0" min="0">
            </div>

            <div class="form-group">
              <label><input type="checkbox" id="textbookIsAvailable"> Доступен для всех пользователей</label>
            </div>

            <div style="margin-top:20px; display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="btn" id="saveTextbookBtn">💾 Сохранить учебник</button>
              <button class="btn secondary" id="cancelTextbookBtn">❌ Отмена</button>
            </div>
          </div>

          <div style="overflow-x: auto; margin-top: 20px;">
            <table class="admin-table" id="textbooksTable">
              <thead>
                <tr>
                  <th>Название</th>
                  <th>Описание</th>
                  <th>Заданий</th>
                  <th>Доступ</th>
                  <th>Статус</th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Секция кроссвордов -->
      <div class="admin-section" id="crosswords-section">
        <div class="card">
          <h2>Управление кроссвордами</h2>
          <div class="admin-controls">
            <button class="btn" id="createCrosswordBtn">➕ Создать кроссворд</button>
          </div>

          <div class="material-form" id="crosswordForm">
            <h3 id="crosswordFormTitle">Создать кроссворд</h3>

            <div class="form-group">
              <label>Название кроссворда:</label>
              <input type="text" id="crosswordTitle" class="input" placeholder="Введите название кроссворда">
            </div>

            <div class="form-group">
              <label>Описание:</label>
              <textarea id="crosswordDescription" class="input" placeholder="Введите описание кроссворда" rows="3"></textarea>
            </div>

            <div class="form-group">
              <label>Обложка (опционально):</label>
              <div class="upload-area" id="crosswordUploadArea">
                <p>📁 Нажмите для загрузки обложки или перетащите файл сюда</p>
                <p class="small-muted">Поддерживаемые форматы: JPG, PNG, GIF, WebP (макс. 5MB)</p>
                <input type="file" id="crosswordCoverInput" style="display:none" accept="image/*">
              </div>
              <div class="upload-progress" id="crosswordCoverProgress">
                <div class="upload-progress-bar" id="crosswordCoverProgressBar"></div>
              </div>
              <input type="hidden" id="crosswordCoverUrl">
              <img class="image-preview" id="crosswordCoverPreview" alt="Предпросмотр обложки">
            </div>

            <div class="form-group">
              <label>Порядок отображения:</label>
              <input type="number" id="crosswordOrder" class="input" value="0" min="0">
            </div>

            <div class="form-group">
              <label><input type="checkbox" id="crosswordIsAvailable"> Доступен для всех пользователей</label>
            </div>

            <div style="margin-top:20px; display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="btn" id="saveCrosswordBtn">💾 Сохранить кроссворд</button>
              <button class="btn secondary" id="cancelCrosswordBtn">❌ Отмена</button>
            </div>
          </div>

          <div style="overflow-x: auto; margin-top: 20px;">
            <table class="admin-table" id="crosswordsTable">
              <thead>
                <tr>
                  <th>Название</th>
                  <th>Описание</th>
                  <th>Заданий</th>
                  <th>Доступ</th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Секция заданий -->
      <div class="admin-section" id="assignments-section">
        <div class="card">
          <h2>Управление заданиями</h2>

          <div class="form-group">
            <label>Выберите материал:</label>
            <select id="materialSelect" class="input">
              <option value="">-- Выберите учебник или кроссворд --</option>
            </select>
          </div>

          <div class="admin-controls">
            <button class="btn" id="createAssignmentBtn" disabled>➕ Создать задание</button>
          </div>

          <div class="assignment-form" id="assignmentForm">
            <h3 id="assignmentFormTitle">Создать задание</h3>

            <div class="form-group">
              <label>Название задания:</label>
              <input type="text" id="assignmentTitle" class="input" placeholder="Введите название задания">
            </div>

            <div class="form-group">
              <label>Порядок отображения:</label>
              <input type="number" id="assignmentOrder" class="input" value="0" min="0">
            </div>

            <div id="assignmentContent">
              <h3>Вопросы задания</h3>

              <div class="question-type-selector">
                <div class="type-btn active" data-type="test">📝 Тестовый вопрос</div>
                <div class="type-btn" data-type="fill">✍️ Вписать ответ</div>
                <div class="type-btn" data-type="sentence">📝 Заполнить предложение</div>
                <div class="type-btn" data-type="crossword">🧩 Кроссворд</div>
              </div>

              <div id="questionsContainer"><!-- динамика --></div>
              <button class="btn" id="addQuestionBtn">➕ Добавить вопрос</button>
            </div>

            <div style="margin-top:20px; display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="btn" id="saveAssignmentBtn">💾 Сохранить задание</button>
              <button class="btn secondary" id="cancelAssignmentBtn">❌ Отмена</button>
            </div>
          </div>

          <div style="overflow-x: auto; margin-top: 20px;">
            <table class="admin-table" id="assignmentsTable">
              <thead>
                <tr>
                  <th>Название</th>
                  <th>Материал</th>
                  <th>Тип</th>
                  <th>Вопросов</th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Секция пользователей -->
      <div class="admin-section" id="users-section">
        <div class="card">
          <h2>Список пользователей</h2>
          <div class="search-container">
            <input type="text" id="userSearch" placeholder="Поиск по имени или email..." class="input">
          </div>
          <div style="overflow-x: auto;">
            <table class="admin-table" id="usersTable">
              <thead>
                <tr>
                  <th>ФИО</th>
                  <th>Email</th>
                  <th>Прогресс</th>
                  <th>Статус</th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="modal-backdrop" id="modal" style="display: none;">
    <div class="modal-body card">
      <h3 id="modalTitle"></h3>
      <p id="modalText" style="white-space: pre-line;"></p>
      <div style="margin-top: 12px; text-align: center;">
        <button class="btn" id="modalOk">ОК</button>
      </div>
    </div>
  </div>
  <script type="module">
    // ============ БАЗОВЫЕ UI ХЕЛПЕРЫ ============
    document.getElementById('configLoading').style.display = 'block';

    function showError(message) {
      const el = document.getElementById('errorMessage');
      el.textContent = message;
      el.style.display = 'block';
      document.getElementById('configLoading').style.display = 'none';
    }

    function showContent() {
      document.getElementById('mainContent').style.display = 'block';
      document.getElementById('configLoading').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
    }

    function showModal(title, text) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalText').textContent = text;
      document.getElementById('modal').style.display = 'flex';
    }

    // ============ УЛУЧШЕННАЯ ПРОВЕРКА АДМИНА ============
    async function checkAdmin(supabase) {
      try {
        console.log('🔄 Начинаем проверку прав администратора...');
        
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        if (authError) {
          console.error('Ошибка аутентификации:', authError);
          throw authError;
        }
        
        if (!user) {
          console.log('❌ Пользователь не авторизован');
          window.location.href = '/login.html';
          return false;
        }

        console.log('✅ Пользователь авторизован:', user.email);

        // Пробуем получить профиль пользователя
        const { data: profile, error: profileError } = await supabase
          .from('profiles')
          .select('is_admin, full_name, email')
          .eq('id', user.id)
          .single();

        if (profileError) {
          console.error('❌ Ошибка загрузки профиля:', profileError);
          
          // Если профиль не найден - создаем его
          if (profileError.code === 'PGRST116') {
            console.log('📝 Профиль не найден, создаем новый...');
            
            const { error: insertError } = await supabase
              .from('profiles')
              .insert({
                id: user.id,
                email: user.email,
                full_name: user.user_metadata?.full_name || '',
                is_admin: false,
                created_at: new Date().toISOString()
              });

            if (insertError) {
              console.error('❌ Ошибка создания профиля:', insertError);
              throw new Error('Не удалось создать профиль: ' + insertError.message);
            }

            showModal('Доступ запрещен', 'Профиль создан, но прав администратора нет. Обратитесь к администратору.');
            setTimeout(() => { window.location.href = '/profile.html'; }, 2500);
            return false;
          }
          
          throw new Error('Ошибка загрузки профиля: ' + profileError.message);
        }

        console.log('📊 Профиль загружен:', profile);

        if (!profile?.is_admin) {
          console.log('❌ У пользователя нет прав администратора');
          showModal('Доступ запрещен', 'Нужны права администратора.');
          setTimeout(() => { window.location.href = '/profile.html'; }, 2000);
          return false;
        }

        console.log('✅ Права администратора подтверждены');
        return user;
      } catch (e) {
        console.error('❌ Ошибка проверки прав:', e);
        showModal('Ошибка доступа', 'Не удалось проверить права: ' + (e?.message || e) + '\n\nКод ошибки: ' + (e?.code || 'неизвестно'));
        setTimeout(() => { window.location.href = '/login.html'; }, 2000);
        return false;
      }
    }

    // ============ УТИЛИТЫ ============
    function generateQuestionId() {
      return 'q_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9);
    }
    function safeName(name) {
      return name.replace(/[^a-zA-Z0-9._-]/g, '_');
    }

    // ВАЖНО: КЛЮЧ ХРАНИМ ПЛОСКО В КОРНЕ БАКЕТА (без /userId/дата)
    // и сразу получаем public URL (бакет должен быть публичным)
    async function uploadImageToSupabase({ supabase, file, bucket }) {
      const ext = (file.name.split('.').pop() || 'bin').toLowerCase();
      const allowed = ['jpg','jpeg','png','gif','webp','avif'];
      if (!allowed.includes(ext)) throw new Error('Поддерживаются только JPG, PNG, GIF, WebP, AVIF');
      if (file.size > 5 * 1024 * 1024) throw new Error('Размер > 5MB');

      const filename = `${Date.now()}_${Math.random().toString(36).slice(2,8)}.${ext}`;
      const path = safeName(filename); // <— плоско: covers/<path> или question-images/<path>

      const { error } = await supabase.storage.from(bucket).upload(path, file, {
        cacheControl: '3600',
        upsert: false,
        contentType: file.type || 'application/octet-stream'
      });

      if (error) {
        const msg = (error.message || '').toLowerCase();
        if (msg.includes('not found') || msg.includes('bucket')) {
          throw new Error(`Бакет "${bucket}" не найден. Создайте его в Supabase Storage и сделайте публичным.`);
        }
        throw error;
      }

      // Публичный URL (ключ плоский)
      const { data: pub } = supabase.storage.from(bucket).getPublicUrl(path);
      return pub.publicUrl;
    }

    function initImageUpload({ uploadAreaId, fileInputId, progressId, progressBarId, previewId, urlInputId, bucket, supabase }) {
      const area = document.getElementById(uploadAreaId);
      const input = document.getElementById(fileInputId);
      const barWrap = document.getElementById(progressId);
      const bar = document.getElementById(progressBarId);
      const preview = document.getElementById(previewId);
      const urlInput = document.getElementById(urlInputId);

      function resetProgress() {
        barWrap.style.display = 'none';
        bar.style.width = '0%';
      }

      async function handle(file) {
        try {
          barWrap.style.display = 'block';
          bar.style.width = '20%';
          const objectUrl = URL.createObjectURL(file);
          preview.src = objectUrl;
          preview.style.display = 'block';

          bar.style.width = '65%';
          const publicUrl = await uploadImageToSupabase({ supabase, file, bucket });
          bar.style.width = '100%';
          urlInput.value = publicUrl;
          setTimeout(resetProgress, 400);
        } catch (e) {
          resetProgress();
          preview.style.display = 'none';
          showModal('Ошибка загрузки', e?.message || e);
        }
      }

      area.addEventListener('click', () => input.click());
      input.addEventListener('change', e => {
        if (e.target.files?.length) handle(e.target.files[0]);
      });

      area.addEventListener('dragover', e => { e.preventDefault(); area.classList.add('dragover'); });
      area.addEventListener('dragleave', e => { e.preventDefault(); area.classList.remove('dragover'); });
      area.addEventListener('drop', e => {
        e.preventDefault(); area.classList.remove('dragover');
        if (e.dataTransfer.files?.length) handle(e.dataTransfer.files[0]);
      });
    }

    // Инициализация загрузки картинок в вопросах (bucket: question-images)
    function initQuestionImageUpload(questionId, supabase) {
      initImageUpload({
        uploadAreaId: `questionUploadArea_${questionId}`,
        fileInputId: `questionImageInput_${questionId}`,
        progressId: `questionImageProgress_${questionId}`,
        progressBarId: `questionImageProgressBar_${questionId}`,
        previewId: `questionImagePreview_${questionId}`,
        urlInputId: `questionImageUrl_${questionId}`,
        bucket: 'question-images',
        supabase
      });
    }

    // Обновление предпросмотра предложения (глобально)
    window.updateSentencePreview = function(qid) {
      const input = document.getElementById(`sentenceInput_${qid}`);
      const preview = document.getElementById(`sentencePreview_${qid}`);
      if (!input || !preview) return;
      const raw = input.value || '';
      if (!raw.trim()) {
        preview.textContent = 'Введите предложение ниже';
        return;
      }
      let i = 0;
      preview.innerHTML = raw.replace(/___/g, () => {
        i++;
        return `<span style="border-bottom:2px dashed #666; padding:0 10px; margin:0 2px;">[${i}]</span>`;
      });
    };

    // ============ ПРОСТОЙ КОНСТРУКТОР КРОССВОРДОВ ============
    // Объект для хранения данных кроссворда по questionId
    const crosswordData = {};

    function initSimpleCrosswordBuilder(qid) {
      const builder = document.getElementById(`crosswordSimpleBuilder_${qid}`);
      if (!builder) return;

      // Инициализация данных кроссворда, если их нет
      if (!crosswordData[qid]) {
        crosswordData[qid] = {
          grid: [],
          rows: 15,
          cols: 15
        };
      }

      // Обработчики для создания сетки
      const createGridBtn = document.getElementById(`createSimpleGridBtn_${qid}`);
      const clearGridBtn = document.getElementById(`clearSimpleGridBtn_${qid}`);
      const blockAllBtn = document.getElementById(`blockAllSimpleGridBtn_${qid}`);
      const unblockAllBtn = document.getElementById(`unblockAllSimpleGridBtn_${qid}`);
      
      if (createGridBtn) {
        createGridBtn.addEventListener('click', () => createSimpleGrid(qid));
      }
      
      if (clearGridBtn) {
        clearGridBtn.addEventListener('click', () => clearSimpleGrid(qid));
      }

      if (blockAllBtn) {
        blockAllBtn.addEventListener('click', () => blockAllCells(qid));
      }

      if (unblockAllBtn) {
        unblockAllBtn.addEventListener('click', () => unblockAllCells(qid));
      }

      // Инициализация загрузки изображения для кроссворда
      initImageUpload({
        uploadAreaId: `crosswordSimpleUploadArea_${qid}`,
        fileInputId: `crosswordSimpleImageInput_${qid}`,
        progressId: `crosswordSimpleImageProgress_${qid}`,
        progressBarId: `crosswordSimpleImageProgressBar_${qid}`,
        previewId: `crosswordSimpleImagePreview_${qid}`,
        urlInputId: `crosswordSimpleImageUrl_${qid}`,
        bucket: 'question-images',
        supabase: window.supabase
      });

      // Если есть предзаполненные данные, восстанавливаем сетку
      const questionText = document.getElementById(`questionText_${qid}`);
      if (questionText && questionText.value.includes('[CROSSWORD]')) {
        try {
          const match = questionText.value.match(/\[CROSSWORD\](.*?)\[\/CROSSWORD\]/);
          if (match) {
            const savedData = JSON.parse(match[1]);
            crosswordData[qid] = savedData;
            renderSimpleGrid(qid);
            updateSimpleCrosswordStats(qid);
          }
        } catch (e) {
          console.warn('Не удалось восстановить кроссворд:', e);
        }
      } else if (crosswordData[qid].grid && crosswordData[qid].grid.length > 0) {
        // Если данные уже есть в crosswordData, просто рендерим
        renderSimpleGrid(qid);
        updateSimpleCrosswordStats(qid);
      }
    }

    function createSimpleGrid(qid) {
      const rows = parseInt(document.getElementById(`crosswordSimpleRows_${qid}`).value) || 15;
      const cols = parseInt(document.getElementById(`crosswordSimpleCols_${qid}`).value) || 15;
      
      if (rows < 5 || cols < 5) {
        showModal('❌ Ошибка', 'Минимальный размер сетки: 5×5');
        return;
      }
      
      if (rows > 30 || cols > 30) {
        showModal('❌ Ошибка', 'Максимальный размер сетки: 30×30');
        return;
      }
      
      crosswordData[qid] = {
        grid: Array(rows).fill().map(() => Array(cols).fill('')),
        rows: rows,
        cols: cols
      };
      
      renderSimpleGrid(qid);
      updateSimpleCrosswordStats(qid);
      
      showModal('✅ Готово', `Сетка ${rows}×${cols} создана! Теперь заполните слова.`);
    }

    function clearSimpleGrid(qid) {
      if (confirm('Очистить всю сетку? Все введенные данные будут удалены.')) {
        const data = crosswordData[qid];
        if (data && data.grid) {
          data.grid = Array(data.rows).fill().map(() => Array(data.cols).fill(''));
          renderSimpleGrid(qid);
          updateSimpleCrosswordStats(qid);
          showModal('✅ Готово', 'Сетка очищена');
        }
      }
    }

    function blockAllCells(qid) {
      const data = crosswordData[qid];
      if (data && data.grid) {
        data.grid = Array(data.rows).fill().map(() => Array(data.cols).fill(null));
        renderSimpleGrid(qid);
        updateSimpleCrosswordStats(qid);
        showModal('✅ Готово', 'Все клетки заблокированы');
      }
    }

    function unblockAllCells(qid) {
      const data = crosswordData[qid];
      if (data && data.grid) {
        data.grid = Array(data.rows).fill().map(() => Array(data.cols).fill(''));
        renderSimpleGrid(qid);
        updateSimpleCrosswordStats(qid);
        showModal('✅ Готово', 'Все клетки разблокированы');
      }
    }

    function renderSimpleGrid(qid) {
      const container = document.getElementById(`crosswordSimpleGridContainer_${qid}`);
      if (!container) return;
      
      const data = crosswordData[qid];
      if (!data || !data.grid) return;
      
      container.innerHTML = '';
      
      const gridElement = document.createElement('div');
      gridElement.className = 'crossword-simple-grid';
      
      for (let i = 0; i < data.rows; i++) {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'crossword-row';
        
        for (let j = 0; j < data.cols; j++) {
          const cell = document.createElement('div');
          cell.className = 'crossword-cell';
          cell.dataset.row = i;
          cell.dataset.col = j;
          
          // Если клетка заблокирована
          if (data.grid[i][j] === null) {
            cell.classList.add('blocked');
          } else {
            const input = document.createElement('input');
            input.type = 'text';
            input.maxLength = 1;
            input.value = data.grid[i][j] || '';
            input.placeholder = '';
            input.addEventListener('input', (e) => {
              data.grid[i][j] = e.target.value.toUpperCase();
              // Автопереход к следующей клетке
              if (e.target.value && j < data.cols - 1) {
                const nextCell = gridElement.querySelector(`[data-row="${i}"][data-col="${j + 1}"] input`);
                if (nextCell) nextCell.focus();
              }
              updateSimpleCrosswordStats(qid);
            });
            
            input.addEventListener('keydown', (e) => {
              // Навигация стрелками
              switch(e.key) {
                case 'ArrowLeft':
                  e.preventDefault();
                  if (j > 0) {
                    const prevCell = gridElement.querySelector(`[data-row="${i}"][data-col="${j - 1}"] input`);
                    if (prevCell) prevCell.focus();
                  }
                  break;
                case 'ArrowRight':
                  e.preventDefault();
                  if (j < data.cols - 1) {
                    const nextCell = gridElement.querySelector(`[data-row="${i}"][data-col="${j + 1}"] input`);
                    if (nextCell) nextCell.focus();
                  }
                  break;
                case 'ArrowUp':
                  e.preventDefault();
                  if (i > 0) {
                    const upCell = gridElement.querySelector(`[data-row="${i - 1}"][data-col="${j}"] input`);
                    if (upCell) upCell.focus();
                  }
                  break;
                case 'ArrowDown':
                  e.preventDefault();
                  if (i < data.rows - 1) {
                    const downCell = gridElement.querySelector(`[data-row="${i + 1}"][data-col="${j}"] input`);
                    if (downCell) downCell.focus();
                  }
                  break;
              }
            });
            
            input.addEventListener('focus', () => {
              cell.style.backgroundColor = '#e3f2fd';
            });
            
            input.addEventListener('blur', () => {
              cell.style.backgroundColor = '';
            });
            
            cell.appendChild(input);
          }
          
          // Двойной клик для блокировки/разблокировки клетки
          cell.addEventListener('dblclick', () => {
            if (data.grid[i][j] === null) {
              data.grid[i][j] = '';
              cell.classList.remove('blocked');
              const input = document.createElement('input');
              input.type = 'text';
              input.maxLength = 1;
              cell.appendChild(input);
              input.focus();
            } else {
              data.grid[i][j] = null;
              cell.classList.add('blocked');
              cell.innerHTML = '';
            }
            updateSimpleCrosswordStats(qid);
          });
          
          rowDiv.appendChild(cell);
        }
        gridElement.appendChild(rowDiv);
      }
      
      container.appendChild(gridElement);
      updateSimpleCrosswordStats(qid);
    }

    function updateSimpleCrosswordStats(qid) {
      const statsContainer = document.getElementById(`crosswordSimpleStats_${qid}`) || 
        createSimpleStatsContainer(qid);
      
      const data = crosswordData[qid];
      if (!data || !data.grid) return;
      
      const totalCells = data.rows * data.cols;
      let blockedCells = 0;
      let filledCells = 0;
      let emptyCells = 0;
      
      for (let i = 0; i < data.rows; i++) {
        for (let j = 0; j < data.cols; j++) {
          if (data.grid[i][j] === null) {
            blockedCells++;
          } else if (data.grid[i][j] === '') {
            emptyCells++;
          } else {
            filledCells++;
          }
        }
      }
      
      statsContainer.innerHTML = `
        <div class="crossword-stat-item">
          <span>Размер сетки:</span>
          <span>${data.rows}×${data.cols}</span>
        </div>
        <div class="crossword-stat-item">
          <span>Всего клеток:</span>
          <span>${totalCells}</span>
        </div>
        <div class="crossword-stat-item">
          <span>Заблокировано:</span>
          <span>${blockedCells} (${Math.round(blockedCells/totalCells*100)}%)</span>
        </div>
        <div class="crossword-stat-item">
          <span>Заполнено буквами:</span>
          <span>${filledCells} (${Math.round(filledCells/totalCells*100)}%)</span>
        </div>
        <div class="crossword-stat-item">
          <span>Пустых клеток:</span>
          <span>${emptyCells} (${Math.round(emptyCells/totalCells*100)}%)</span>
        </div>
      `;
    }

    function createSimpleStatsContainer(qid) {
      const container = document.createElement('div');
      container.id = `crosswordSimpleStats_${qid}`;
      container.className = 'crossword-stats';
      
      const builder = document.getElementById(`crosswordSimpleBuilder_${qid}`);
      const gridContainer = document.getElementById(`crosswordSimpleGridContainer_${qid}`);
      if (builder && gridContainer) {
        builder.insertBefore(container, gridContainer.nextSibling);
      }
      
      return container;
    }

    function validateSimpleCrossword(qid) {
      const data = crosswordData[qid];
      if (!data || !data.grid) {
        return { valid: false, message: '❌ Сетка не создана' };
      }
      
      const validationContainer = document.getElementById(`crosswordSimpleValidation_${qid}`) || 
        createSimpleValidationContainer(qid);
      
      // ИСПРАВЛЕНИЕ: Проверяем, есть ли заполненные клетки (не заблокированные и не пустые)
      let hasFilledCells = false;
      for (let i = 0; i < data.rows; i++) {
        for (let j = 0; j < data.cols; j++) {
          // Клетка считается заполненной, если она не заблокирована и не пустая
          if (data.grid[i][j] !== null && data.grid[i][j] !== '') {
            hasFilledCells = true;
            break;
          }
        }
        if (hasFilledCells) break;
      }
      
      if (!hasFilledCells) {
        validationContainer.className = 'validation-message warning';
        validationContainer.innerHTML = '⚠️ Кроссворд пустой. Заполните хотя бы несколько клеток.';
        return { valid: false, message: 'Кроссворд пустой' };
      }
      
      validationContainer.className = 'validation-message success';
      validationContainer.innerHTML = '✅ Кроссворд валиден! Можно сохранять.';
      return { valid: true, message: 'Кроссворд валиден' };
    }

    function createSimpleValidationContainer(qid) {
      const container = document.createElement('div');
      container.id = `crosswordSimpleValidation_${qid}`;
      container.className = 'validation-message';
      
      const builder = document.getElementById(`crosswordSimpleBuilder_${qid}`);
      const statsContainer = document.getElementById(`crosswordSimpleStats_${qid}`);
      if (builder && statsContainer) {
        builder.insertBefore(container, statsContainer.nextSibling);
      }
      
      return container;
    }

    function getSimpleCrosswordData(qid) {
      const data = crosswordData[qid];
      if (!data || !data.grid) {
        return null;
      }
      
      return {
        type: 'crossword',
        q: document.querySelector(`#questionText_${qid}`).value,
        image: document.getElementById(`crosswordSimpleImageUrl_${qid}`).value,
        grid: data.grid,
        metadata: {
          rows: data.rows,
          cols: data.cols
        }
      };
    }

    // ============ ПРИЛОЖЕНИЕ ============
    async function initApp() {
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
        showError('❌ Ошибка конфигурации. Переменные Supabase не загружены.');
        return;
      }

      try {
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
        const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        window.supabase = supabase;

        console.log('🔄 Начинаем инициализацию админ-панели...');
        
        const user = await checkAdmin(supabase);
        if (!user) {
          console.log('❌ Проверка прав администратора не пройдена');
          return;
        }

        console.log('✅ Админ-панель инициализирована для пользователя:', user.email);

        // Кнопки/вкладки/модалка
        document.getElementById('modalOk').addEventListener('click', () => {
          document.getElementById('modal').style.display = 'none';
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
          if (confirm('Выйти из аккаунта?')) {
            await supabase.auth.signOut();
            window.location.href = '/login.html';
          }
        });

        document.querySelectorAll('.admin-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.getAttribute('data-tab');
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(`${tabName}-section`).classList.add('active');

            if (tabName === 'textbooks') loadTextbooks();
            if (tabName === 'crosswords') loadCrosswords();
            if (tabName === 'assignments') { loadMaterialsForAssignments(); loadAssignments(); }
            if (tabName === 'users') loadUsers();
          });
        });

        // Инициализация зон загрузки для обложек (bucket: covers)
        initImageUpload({
          uploadAreaId: 'textbookUploadArea',
          fileInputId: 'textbookCoverInput',
          progressId: 'textbookCoverProgress',
          progressBarId: 'textbookCoverProgressBar',
          previewId: 'textbookCoverPreview',
          urlInputId: 'textbookCoverUrl',
          bucket: 'covers',
          supabase
        });
        initImageUpload({
          uploadAreaId: 'crosswordUploadArea',
          fileInputId: 'crosswordCoverInput',
          progressId: 'crosswordCoverProgress',
          progressBarId: 'crosswordCoverProgressBar',
          previewId: 'crosswordCoverPreview',
          urlInputId: 'crosswordCoverUrl',
          bucket: 'covers',
          supabase
        });

        // ===== Статистика
        async function loadStats() {
          try {
            const [{ data: t }, { data: c }, { data: a }, { data: u }] = await Promise.all([
              supabase.from('textbooks').select('id'),
              supabase.from('crosswords').select('id'),
              supabase.from('assignments').select('id'),
              supabase.from('profiles').select('id')
            ]);
            document.getElementById('totalTextbooks').textContent = t?.length || 0;
            document.getElementById('totalCrosswords').textContent = c?.length || 0;
            document.getElementById('totalAssignments').textContent = a?.length || 0;
            document.getElementById('totalUsers').textContent = u?.length || 0;
          } catch (e) {
            console.warn('Stats load error', e);
          }
        }

        // ===== Учебники
        let editingTextbookId = null;

        function showTextbookForm() {
          editingTextbookId = null;
          document.getElementById('textbookForm').classList.add('active');
          document.getElementById('textbookFormTitle').textContent = 'Создать учебник';
          document.getElementById('textbookTitle').value = '';
          document.getElementById('textbookDescription').value = '';
          document.getElementById('textbookOrder').value = '0';
          document.getElementById('textbookIsAvailable').checked = false;
          document.getElementById('textbookCoverUrl').value = '';
          document.getElementById('textbookCoverPreview').style.display = 'none';
        }
        function hideTextbookForm(){ document.getElementById('textbookForm').classList.remove('active'); }

        async function saveTextbook() {
          const title = document.getElementById('textbookTitle').value.trim();
          const description = document.getElementById('textbookDescription').value.trim();
          const orderIndex = parseInt(document.getElementById('textbookOrder').value || '0',10);
          const isAvailable = document.getElementById('textbookIsAvailable').checked;
          const coverUrl = document.getElementById('textbookCoverUrl').value;

          if (!title) return showModal('Ошибка', 'Введите название учебника');

          const payload = {
            title,
            description,
            order_index: orderIndex,
            is_available: isAvailable,
            is_active: true,
            created_by: user.id
          };
          if (coverUrl) payload.cover_image_url = coverUrl;

          let res;
          if (editingTextbookId) {
            res = await supabase.from('textbooks').update(payload).eq('id', editingTextbookId);
          } else {
            res = await supabase.from('textbooks').insert(payload);
          }
          if (res.error) return showModal('Ошибка', res.error.message);

          showModal('Готово', editingTextbookId ? 'Учебник обновлён' : 'Учебник создан');
          hideTextbookForm(); loadTextbooks(); loadStats();
        }

        async function loadTextbooks() {
          const tbody = document.querySelector('#textbooksTable tbody');
          tbody.innerHTML = '<tr><td colspan="6" style="padding:14px;">Загрузка...</td></tr>';

          const { data: textbooks, error } = await supabase.from('textbooks').select('*').order('order_index');
          if (error) { tbody.innerHTML = ''; return showModal('Ошибка', error.message); }

          const { data: ass } = await supabase.from('assignments').select('id,textbook_id');
          const counts = {};
          (ass||[]).forEach(a => { if (a.textbook_id) counts[a.textbook_id]=(counts[a.textbook_id]||0)+1; });

          tbody.innerHTML = '';
          if (!textbooks?.length) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;">Учебники не найдены</td></tr>';
            return;
          }

          textbooks.forEach(tb => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${tb.title}</td>
              <td>${tb.description || '—'}</td>
              <td>${counts[tb.id] || 0}</td>
              <td>${tb.is_available ? '🌍 Для всех' : '🔒 По доступу'}</td>
              <td>${tb.is_active ? '✅ Активен' : '❌ Неактивен'}</td>
              <td>
                <button class="btn btn-small" data-edit-textbook="${tb.id}">✏️ Редактировать</button>
                <button class="btn btn-small btn-danger" data-del-textbook="${tb.id}" data-title="${tb.title}">🗑️ Удалить</button>
              </td>
            `;
            tbody.appendChild(tr);
          });

          tbody.querySelectorAll('[data-edit-textbook]').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              const id = btn.getAttribute('data-edit-textbook');
              const { data, error } = await supabase.from('textbooks').select('*').eq('id', id).single();
              if (error) return showModal('Ошибка', error.message);
              editingTextbookId = id;
              document.getElementById('textbookForm').classList.add('active');
              document.getElementById('textbookFormTitle').textContent = 'Редактировать учебник';
              document.getElementById('textbookTitle').value = data.title || '';
              document.getElementById('textbookDescription').value = data.description || '';
              document.getElementById('textbookOrder').value = data.order_index || 0;
              document.getElementById('textbookIsAvailable').checked = !!data.is_available;
              document.getElementById('textbookCoverUrl').value = data.cover_image_url || '';
              const prev = document.getElementById('textbookCoverPreview');
              if (data.cover_image_url) { prev.src = data.cover_image_url; prev.style.display='block'; } else { prev.style.display='none'; }
            });
          });

          tbody.querySelectorAll('[data-del-textbook]').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              const id = btn.getAttribute('data-del-textbook');
              const title = btn.getAttribute('data-title') || '';
              if (!confirm(`Удалить учебник "${title}"? Связанные задания также будут удалены.`)) return;
              const { error } = await supabase.from('textbooks').delete().eq('id', id);
              if (error) return showModal('Ошибка', error.message);
              showModal('Готово', 'Учебник удалён'); loadTextbooks(); loadStats();
            });
          });
        }

        document.getElementById('createTextbookBtn').addEventListener('click', showTextbookForm);
        document.getElementById('cancelTextbookBtn').addEventListener('click', hideTextbookForm);
        document.getElementById('saveTextbookBtn').addEventListener('click', saveTextbook);

        // ===== КРОССВОРДЫ
        let editingCrosswordId = null;

        function showCrosswordForm() {
          editingCrosswordId = null;
          document.getElementById('crosswordForm').classList.add('active');
          document.getElementById('crosswordFormTitle').textContent = 'Создать кроссворд';
          document.getElementById('crosswordTitle').value = '';
          document.getElementById('crosswordDescription').value = '';
          document.getElementById('crosswordOrder').value = '0';
          document.getElementById('crosswordIsAvailable').checked = false;
          document.getElementById('crosswordCoverUrl').value = '';
          document.getElementById('crosswordCoverPreview').style.display = 'none';
        }
        function hideCrosswordForm(){ document.getElementById('crosswordForm').classList.remove('active'); }

        async function saveCrossword() {
          const title = document.getElementById('crosswordTitle').value.trim();
          const description = document.getElementById('crosswordDescription').value.trim();
          const orderIndex = parseInt(document.getElementById('crosswordOrder').value || '0',10);
          const isAvailable = document.getElementById('crosswordIsAvailable').checked;
          const coverUrl = document.getElementById('crosswordCoverUrl').value;

          if (!title) return showModal('Ошибка', 'Введите название кроссворда');

          const payload = {
            title,
            description,
            order_index: orderIndex,
            is_available: isAvailable,
            is_active: true,
            created_by: user.id
          };
          if (coverUrl) payload.cover_image_url = coverUrl;

          let res;
          if (editingCrosswordId) {
            res = await supabase.from('crosswords').update(payload).eq('id', editingCrosswordId);
          } else {
            res = await supabase.from('crosswords').insert(payload);
          }
          if (res.error) return showModal('Ошибка', res.error.message);

          showModal('Готово', editingCrosswordId ? 'Кроссворд обновлён' : 'Кроссворд создан');
          hideCrosswordForm(); loadCrosswords(); loadStats();
        }

        async function loadCrosswords() {
          const tbody = document.querySelector('#crosswordsTable tbody');
          tbody.innerHTML = '<tr><td colspan="5" style="padding:14px;">Загрузка...</td></tr>';

          const { data: crosswords, error } = await supabase.from('crosswords').select('*').order('order_index');
          if (error) { tbody.innerHTML = ''; return showModal('Ошибка', error.message); }

          const { data: ass } = await supabase.from('assignments').select('id,crossword_id');
          const counts = {};
          (ass||[]).forEach(a => { if (a.crossword_id) counts[a.crossword_id]=(counts[a.crossword_id]||0)+1; });

          tbody.innerHTML = '';
          if (!crosswords?.length) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;">Кроссворды не найдены</td></tr>';
            return;
          }

          crosswords.forEach(cw => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${cw.title}</td>
              <td>${cw.description || '—'}</td>
              <td>${counts[cw.id] || 0}</td>
              <td>${cw.is_available ? '🌍 Для всех' : '🔒 По доступу'}</td>
              <td>
                <button class="btn btn-small" data-edit-crossword="${cw.id}">✏️ Редактировать</button>
                <button class="btn btn-small btn-danger" data-del-crossword="${cw.id}" data-title="${cw.title}">🗑️ Удалить</button>
              </td>
            `;
            tbody.appendChild(tr);
          });

          tbody.querySelectorAll('[data-edit-crossword]').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              const id = btn.getAttribute('data-edit-crossword');
              const { data, error } = await supabase.from('crosswords').select('*').eq('id', id).single();
              if (error) return showModal('Ошибка', error.message);
              editingCrosswordId = id;
              document.getElementById('crosswordForm').classList.add('active');
              document.getElementById('crosswordFormTitle').textContent = 'Редактировать кроссворд';
              document.getElementById('crosswordTitle').value = data.title || '';
              document.getElementById('crosswordDescription').value = data.description || '';
              document.getElementById('crosswordOrder').value = data.order_index || 0;
              document.getElementById('crosswordIsAvailable').checked = !!data.is_available;
              document.getElementById('crosswordCoverUrl').value = data.cover_image_url || '';
              const prev = document.getElementById('crosswordCoverPreview');
              if (data.cover_image_url) { prev.src = data.cover_image_url; prev.style.display='block'; } else { prev.style.display='none'; }
            });
          });

          tbody.querySelectorAll('[data-del-crossword]').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              const id = btn.getAttribute('data-del-crossword');
              const title = btn.getAttribute('data-title') || '';
              if (!confirm(`Удалить кроссворд "${title}"? Связанные задания также будут удалены.`)) return;
              const { error } = await supabase.from('crosswords').delete().eq('id', id);
              if (error) return showModal('Ошибка', error.message);
              showModal('Готово', 'Кроссворд удалён'); loadCrosswords(); loadStats();
            });
          });
        }

        document.getElementById('createCrosswordBtn').addEventListener('click', showCrosswordForm);
        document.getElementById('cancelCrosswordBtn').addEventListener('click', hideCrosswordForm);
        document.getElementById('saveCrosswordBtn').addEventListener('click', saveCrossword);

        // ===== ЗАДАНИЯ
        let selectedMaterialId = '';
        let editingAssignmentId = null;
        let currentQuestionType = 'test';

        // переключатели типов вопросов
        document.querySelectorAll('.type-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentQuestionType = btn.getAttribute('data-type');
          });
        });

        document.getElementById('materialSelect').addEventListener('change', function () {
          selectedMaterialId = this.value;
          document.getElementById('createAssignmentBtn').disabled = !selectedMaterialId;
          loadAssignments();
        });

        document.getElementById('createAssignmentBtn').addEventListener('click', showAssignmentForm);
        document.getElementById('cancelAssignmentBtn').addEventListener('click', hideAssignmentForm);
        document.getElementById('saveAssignmentBtn').addEventListener('click', saveAssignment);
        document.getElementById('addQuestionBtn').addEventListener('click', () => addQuestion());

        async function loadMaterialsForAssignments() {
          const select = document.getElementById('materialSelect');
          select.innerHTML = '<option value="">-- Выберите учебник или кроссворд --</option>';

          const [{ data: textbooks }, { data: crosswords }] = await Promise.all([
            supabase.from('textbooks').select('id,title,is_active').order('order_index'),
            supabase.from('crosswords').select('id,title,is_active').order('order_index')
          ]);

          if (textbooks?.length) {
            const og = document.createElement('optgroup');
            og.label = '📚 Учебники';
            textbooks.filter(t=>t.is_active!==false).forEach(t=>{
              const opt = document.createElement('option');
              opt.value = `textbook_${t.id}`;
              opt.textContent = t.title;
              og.appendChild(opt);
            });
            select.appendChild(og);
          }

          if (crosswords?.length) {
            const og = document.createElement('optgroup');
            og.label = '🧩 Кроссворды';
            crosswords.filter(c=>c.is_active!==false).forEach(c=>{
              const opt = document.createElement('option');
              opt.value = `crossword_${c.id}`;
              opt.textContent = c.title;
              og.appendChild(opt);
            });
            select.appendChild(og);
          }

          // восстановим выбранный материал если есть
          if (selectedMaterialId) {
            const has = Array.from(select.options).some(o=>o.value===selectedMaterialId);
            if (has) select.value = selectedMaterialId;
          }
        }

        function showAssignmentForm() {
          editingAssignmentId = null;
          document.getElementById('assignmentForm').classList.add('active');
          document.getElementById('assignmentFormTitle').textContent = 'Создать задание';
          document.getElementById('assignmentTitle').value = '';
          document.getElementById('assignmentOrder').value = '0';
          // Сброс типа к test
          document.querySelectorAll('.type-btn').forEach(b=>b.classList.remove('active'));
          document.querySelector('.type-btn[data-type="test"]').classList.add('active');
          currentQuestionType = 'test';

          const cont = document.getElementById('questionsContainer');
          cont.innerHTML = '';
          addQuestion(); // хотя бы один вопрос
        }

        function hideAssignmentForm() {
          document.getElementById('assignmentForm').classList.remove('active');
        }

        function addQuestion(prefill) {
          const container = document.getElementById('questionsContainer');
          const qid = generateQuestionId();
          const qType = prefill?.type || currentQuestionType;

          const wrap = document.createElement('div');
          wrap.className = 'subtask-item';
          wrap.setAttribute('data-id', qid);
          wrap.setAttribute('data-type', qType);

          const imageUploadBlock = `
            <div class="form-group question-image-upload">
              <label>Изображение для вопроса (опционально):</label>
              <div class="upload-area" id="questionUploadArea_${qid}">
                <p>📁 Нажмите для загрузки изображения или перетащите файл сюда</p>
                <p class="small-muted">Поддерживаемые форматы: JPG, PNG, GIF, WebP, AVIF (макс. 5MB)</p>
                <input type="file" id="questionImageInput_${qid}" style="display:none" accept="image/*">
              </div>
              <div class="upload-progress" id="questionImageProgress_${qid}">
                <div class="upload-progress-bar" id="questionImageProgressBar_${qid}"></div>
              </div>
              <input type="hidden" id="questionImageUrl_${qid}" value="${prefill?.image || ''}">
              <img class="question-image-preview" id="questionImagePreview_${qid}" alt="Предпросмотр изображения" style="${prefill?.image ? 'display:block' : 'display:none'}" ${prefill?.image ? `src="${prefill.image}"` : ''}>
            </div>
          `;

          let inner = `
            <div class="form-group">
              <label>Текст вопроса:</label>
              <input type="text" class="input question-text" id="questionText_${qid}" placeholder="Введите вопрос" value="${prefill?.q ? String(prefill.q).replace(/"/g,'&quot;') : ''}">
            </div>
          `;

          if (qType === 'test') {
            inner += `
              ${imageUploadBlock}
              <div class="form-group">
                <label>Варианты ответов (каждый с новой строки):</label>
                <textarea class="input test-options" rows="4">${(prefill?.options || []).join('\n')}</textarea>
              </div>
              <div class="form-group">
                <label>Правильный ответ (номер варианта, начиная с 1):</label>
                <input type="number" class="input test-correct" min="1" value="${(typeof prefill?.correct === 'number' ? prefill.correct+1 : 1)}">
              </div>
            `;
          } else if (qType === 'fill') {
            inner += `
              ${imageUploadBlock}
              <div class="form-group">
                <label>Правильные ответы (каждый с новой строки):</label>
                <textarea class="input fill-answers" rows="3">${(prefill?.answers || []).join('\n')}</textarea>
                <div class="small-muted">Ответ засчитается, если совпадёт с любым вариантом</div>
              </div>
            `;
          } else if (qType === 'sentence') {
            const sentence = prefill?.sentence || '';
            const previewHtml = sentence
              ? sentence.replace(/___/g,'<span style="border-bottom:2px dashed #666; padding:0 10px; margin:0 2px;">[?]</span>')
              : 'Введите предложение ниже';
            inner += `
              ${imageUploadBlock}
              <div class="form-group">
                <label>Предложение с пропусками:</label>
                <div class="sentence-builder">
                  <div class="sentence-preview" id="sentencePreview_${qid}">${previewHtml}</div>
                  <textarea class="sentence-input" id="sentenceInput_${qid}" rows="2" placeholder="Используйте ___ для пропусков. Например: Я ___ яблоко.">${sentence}</textarea>
                  <button type="button" class="btn btn-small add-gap-btn" onclick="window.updateSentencePreview('${qid}')">Обновить предпросмотр</button>
                </div>
              </div>
              <div class="form-group">
                <label>Правильные ответы для пропусков (каждый с новой строки, по порядку пропусков):</label>
                <textarea class="input sentence-answers" rows="3">${(prefill?.answers || []).join('\n')}</textarea>
              </div>
            `;
            // live preview
            setTimeout(()=>{
              const si = document.getElementById(`sentenceInput_${qid}`);
              si?.addEventListener('input', ()=>window.updateSentencePreview(qid));
            },0);
          } else if (qType === 'crossword') {
            inner = `
              <div class="crossword-simple-builder" id="crosswordSimpleBuilder_${qid}">
                <div class="crossword-simple-help">
                  <h4>🧩 Простой конструктор кроссворда</h4>
                  <p><strong>Как создать кроссворд:</strong></p>
                  <ul>
                    <li>Выберите размер сетки и нажмите "Создать сетку"</li>
                    <li>Вписывайте буквы прямо в белые клетки</li>
                    <li>Двойной клик по клетке блокирует/разблокирует её (чёрные клетки)</li>
                    <li>Используйте стрелки для навигации между клетками</li>
                    <li>Заполните слова в сетке как должен выглядеть готовый кроссворд</li>
                  </ul>
                </div>

                <div class="crossword-simple-controls">
                  <div class="form-group">
                    <label>Количество строк:</label>
                    <input type="number" id="crosswordSimpleRows_${qid}" class="input" value="${prefill?.metadata?.rows || 15}" min="5" max="30">
                  </div>
                  <div class="form-group">
                    <label>Количество столбцов:</label>
                    <input type="number" id="crosswordSimpleCols_${qid}" class="input" value="${prefill?.metadata?.cols || 15}" min="5" max="30">
                  </div>
                  <div class="form-group">
                    <button class="btn" id="createSimpleGridBtn_${qid}">Создать сетку</button>
                  </div>
                </div>

                <div class="crossword-simple-actions">
                  <button class="btn btn-small" id="clearSimpleGridBtn_${qid}">🗑️ Очистить сетку</button>
                  <button class="btn btn-small" id="blockAllSimpleGridBtn_${qid}">⬛ Заблокировать все</button>
                  <button class="btn btn-small" id="unblockAllSimpleGridBtn_${qid}">⬜ Разблокировать все</button>
                </div>

                <div class="form-group">
                  <label>Сетка кроссворда (двойной клик блокирует/разблокирует клетку):</label>
                  <div id="crosswordSimpleGridContainer_${qid}" class="crossword-simple-grid-container"></div>
                </div>

                <div class="form-group">
                  <label>Изображение для кроссворда (опционально):</label>
                  <div class="upload-area" id="crosswordSimpleUploadArea_${qid}">
                    <p>📁 Нажмите для загрузки изображения или перетащите файл сюда</p>
                    <p class="small-muted">Поддерживаемые форматы: JPG, PNG, GIF, WebP, AVIF (макс. 5MB)</p>
                    <input type="file" id="crosswordSimpleImageInput_${qid}" style="display:none" accept="image/*">
                  </div>
                  <div class="upload-progress" id="crosswordSimpleImageProgress_${qid}">
                    <div class="upload-progress-bar" id="crosswordSimpleImageProgressBar_${qid}"></div>
                  </div>
                  <input type="hidden" id="crosswordSimpleImageUrl_${qid}" value="${prefill?.image || ''}">
                  <img class="image-preview" id="crosswordSimpleImagePreview_${qid}" alt="Предпросмотр изображения" style="${prefill?.image ? 'display:block' : 'display:none'}" ${prefill?.image ? `src="${prefill.image}"` : ''}>
                </div>

                <div class="form-group">
                  <label>Текст вопроса (будет показан ученику):</label>
                  <input type="text" class="input question-text" id="questionText_${qid}" placeholder="Введите вопрос или инструкцию для кроссворда" value="${prefill?.q ? String(prefill.q).replace(/"/g,'&quot;') : 'Решите кроссворд:'}">
                </div>
              </div>
            `;
          }

          // ДОБАВЛЕНО: кнопка удаления для кроссворда тоже
          inner += `<button class="btn btn-small btn-danger remove-question" type="button">🗑️ Удалить вопрос</button>`;
          
          wrap.innerHTML = inner;
          container.appendChild(wrap);

          // init загрузчики
          if (qType !== 'crossword') {
            initQuestionImageUpload(qid, supabase);
          } else {
            // Для простого кроссворда инициализируем конструктор
            if (prefill && prefill.grid) {
              crosswordData[qid] = {
                grid: prefill.grid,
                rows: prefill.metadata?.rows || 15,
                cols: prefill.metadata?.cols || 15
              };
            } else {
              // Если данных нет, создаем пустую сетку
              crosswordData[qid] = {
                grid: [],
                rows: 15,
                cols: 15
              };
            }
            
            // ИСПРАВЛЕНИЕ: Вызываем инициализацию после небольшой задержки, чтобы DOM успел обновиться
            setTimeout(() => {
              initSimpleCrosswordBuilder(qid);
              renderSimpleGrid(qid);
              updateSimpleCrosswordStats(qid);
            }, 100);
          }

          // удаление вопроса (для всех типов)
          wrap.querySelector('.remove-question').addEventListener('click', () => {
            const all = document.querySelectorAll('.subtask-item');
            if (all.length > 1) {
              // Удаляем данные кроссворда если это был кроссворд
              if (qType === 'crossword' && crosswordData[qid]) {
                delete crosswordData[qid];
              }
              wrap.remove();
            } else {
              alert('Должен остаться хотя бы один вопрос.');
            }
          });
        }

        async function saveAssignment() {
          const title = document.getElementById('assignmentTitle').value.trim();
          const orderIndex = parseInt(document.getElementById('assignmentOrder').value || '0', 10);
          if (!selectedMaterialId) return showModal('Ошибка', 'Выберите учебник или кроссворд');
          if (!title) return showModal('Ошибка', 'Введите название задания');

          const [kind, matId] = selectedMaterialId.split('_'); // textbook_ / crossword_
          const qs = Array.from(document.querySelectorAll('.subtask-item'));
          if (!qs.length) return showModal('Ошибка', 'Добавьте хотя бы один вопрос');

          const questions = [];
          for (let i=0;i<qs.length;i++) {
            const el = qs[i];
            const type = el.getAttribute('data-type') || 'test';
            const qid = el.getAttribute('data-id');
            let q = el.querySelector('.question-text')?.value?.trim() || '';
            
            if (type !== 'crossword' && !q) return showModal('Ошибка', `Заполните текст вопроса ${i+1}`);

            let qData = { type };

            if (type === 'test') {
              const optionsText = el.querySelector('.test-options')?.value || '';
              const options = optionsText.split('\n').map(s=>s.trim()).filter(Boolean);
              const correct = parseInt(el.querySelector('.test-correct')?.value || '1',10) - 1;
              if (!options.length) return showModal('Ошибка', `Добавьте варианты ответа в вопросе ${i+1}`);
              if (correct < 0 || correct >= options.length) return showModal('Ошибка', `Номер правильного ответа в вопросе ${i+1} должен соответствовать одному из вариантов`);
              qData.q = q;
              qData.options = options;
              qData.correct = correct;
              
              const imgUrl = el.querySelector(`#questionImageUrl_${qid}`)?.value || '';
              if (imgUrl) qData.image = imgUrl;
              
            } else if (type === 'fill') {
              const answersText = el.querySelector('.fill-answers')?.value || '';
              const answers = answersText.split('\n').map(s=>s.trim()).filter(Boolean);
              if (!answers.length) return showModal('Ошибка', `Добавьте хотя бы один правильный ответ в вопросе ${i+1}`);
              qData.q = q;
              qData.answers = answers;
              
              const imgUrl = el.querySelector(`#questionImageUrl_${qid}`)?.value || '';
              if (imgUrl) qData.image = imgUrl;
              
            } else if (type === 'sentence') {
              const sentence = el.querySelector('.sentence-input')?.value?.trim() || '';
              const answersText = el.querySelector('.sentence-answers')?.value || '';
              const answers = answersText.split('\n').map(s=>s.trim()).filter(Boolean);
              if (!sentence) return showModal('Ошибка', `Введите предложение с пропусками в вопросе ${i+1}`);
              const gaps = (sentence.match(/___/g) || []).length;
              if (!answers.length || answers.length !== gaps) {
                return showModal('Ошибка', `Количество ответов (${answers.length}) должно совпадать с количеством пропусков (${gaps}) в вопросе ${i+1}`);
              }
              qData.q = q;
              qData.sentence = sentence;
              qData.answers = answers;
              
              const imgUrl = el.querySelector(`#questionImageUrl_${qid}`)?.value || '';
              if (imgUrl) qData.image = imgUrl;
              
            } else if (type === 'crossword') {
              // Валидация кроссворда
              const validation = validateSimpleCrossword(qid);
              if (!validation.valid) {
                return showModal('❌ Ошибка', validation.message);
              }

              const crosswordData = getSimpleCrosswordData(qid);
              if (!crosswordData) {
                return showModal('❌ Ошибка', 'Не удалось получить данные кроссворда');
              }
              qData = crosswordData;
            }

            questions.push(qData);
          }

          const payload = {
            title,
            order_index: orderIndex,
            content: { questions },
            created_by: user.id
          };
          if (kind === 'textbook') payload.textbook_id = matId;
          if (kind === 'crossword') payload.crossword_id = matId;

          let res;
          if (editingAssignmentId) {
            res = await supabase.from('assignments').update(payload).eq('id', editingAssignmentId);
          } else {
            res = await supabase.from('assignments').insert(payload);
          }
          if (res.error) return showModal('Ошибка', res.error.message);

          showModal('Готово', editingAssignmentId ? 'Задание обновлено' : 'Задание создано');
          hideAssignmentForm(); loadAssignments(); loadStats();
        }

        async function loadAssignments() {
          if (!selectedMaterialId) return;
          const [kind, matId] = selectedMaterialId.split('_');

          let q = supabase.from('assignments').select('*').order('order_index');
          if (kind === 'textbook') q = q.eq('textbook_id', matId);
          if (kind === 'crossword') q = q.eq('crossword_id', matId);

          const { data: rows, error } = await q;
          const tbody = document.querySelector('#assignmentsTable tbody');
          if (error) { tbody.innerHTML = ''; return showModal('Ошибка', error.message); }

          // подтянем название материала
          let materialName = 'Материал';
          if (kind === 'textbook') {
            const { data } = await supabase.from('textbooks').select('title').eq('id', matId).single();
            materialName = data?.title || 'Учебник';
          } else {
            const { data } = await supabase.from('crosswords').select('title').eq('id', matId).single();
            materialName = data?.title || 'Кроссворд';
          }

          tbody.innerHTML = '';
          if (!rows?.length) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;">Задания не найдены</td></tr>';
            return;
          }

          rows.forEach(a=>{
            const qs = a.content?.questions || [];
            let typeText = '📝 Тест';
            const types = new Set(qs.map(q=>q.type));
            if (types.has('crossword')) typeText = '🧩 Кроссворд';
            else if (types.has('sentence')) typeText = '📝 Предложение';
            else if (types.has('fill')) typeText = '✍️ Ввод';

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${a.title}</td>
              <td>${materialName}</td>
              <td>${typeText}</td>
              <td>${qs.length}</td>
              <td>
                <button class="btn btn-small" data-edit-assignment="${a.id}">✏️ Редактировать</button>
                <button class="btn btn-small btn-danger" data-del-assignment="${a.id}" data-title="${a.title}">🗑️ Удалить</button>
              </td>
            `;
            tbody.appendChild(tr);
          });

          tbody.querySelectorAll('[data-edit-assignment]').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              const id = btn.getAttribute('data-edit-assignment');
              const { data, error } = await supabase.from('assignments').select('*').eq('id', id).single();
              if (error) return showModal('Ошибка', error.message);

              // выставить селект
              if (data.textbook_id) selectedMaterialId = `textbook_${data.textbook_id}`;
              else if (data.crossword_id) selectedMaterialId = `crossword_${data.crossword_id}`;
              document.getElementById('materialSelect').value = selectedMaterialId;
              document.getElementById('createAssignmentBtn').disabled = false;

              editingAssignmentId = id;
              document.getElementById('assignmentForm').classList.add('active');
              document.getElementById('assignmentFormTitle').textContent = 'Редактировать задание';
              document.getElementById('assignmentTitle').value = data.title || '';
              document.getElementById('assignmentOrder').value = data.order_index || 0;

              const cont = document.getElementById('questionsContainer');
              cont.innerHTML = '';
              const qs = data.content?.questions || [];
              if (!qs.length) addQuestion(); else qs.forEach(q => addQuestion(q));
            });
          });

          tbody.querySelectorAll('[data-del-assignment]').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              const id = btn.getAttribute('data-del-assignment');
              const title = btn.getAttribute('data-title') || '';
              if (!confirm(`Удалить задание "${title}"?`)) return;
              const { error } = await supabase.from('assignments').delete().eq('id', id);
              if (error) return showModal('Ошибка', error.message);
              showModal('Готово', 'Задание удалено');
              loadAssignments(); loadStats();
            });
          });
        }

        // ===== ПОЛЬЗОВАТЕЛИ / ДОСТУПЫ
        let currentEditingUserId = null;
        let searchTimeout = null;

        document.getElementById('userSearch').addEventListener('input', () => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(loadUsers, 350);
        });

        async function loadUsers() {
          const q = document.getElementById('userSearch').value.trim();
          let query = supabase.from('profiles').select('*').order('created_at',{ascending:false});
          if (q) query = query.or(`full_name.ilike.%${q}%,email.ilike.%${q}%`);

          const { data, error } = await query;
          const tbody = document.querySelector('#usersTable tbody');
          if (error) { tbody.innerHTML = ''; return showModal('Ошибка', error.message); }

          // Прогресс
          const { data: prog } = await supabase.from('user_progress').select('user_id,is_completed');
          const map = {};
          (prog||[]).forEach(p=>{
            map[p.user_id] ||= { total:0, completed:0 };
            map[p.user_id].total++;
            if (p.is_completed) map[p.user_id].completed++;
          });

          tbody.innerHTML = '';
          if (!data?.length) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;">Пользователи не найдены</td></tr>';
            return;
          }

          data.forEach(u=>{
            const pr = map[u.id] || { total:0, completed:0 };
            const pct = pr.total ? Math.round((pr.completed/pr.total)*100) : 0;
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>
                <div><strong>${u.full_name || 'Не указано'}</strong></div>
                <div class="user-stats"><span class="stat-badge">ID: ${u.id.slice(0,8)}...</span></div>
              </td>
              <td>${u.email || '—'}</td>
              <td><div class="user-stats"><span class="stat-badge">📊 ${pr.total ? `${pr.completed}/${pr.total} (${pct}%)` : 'Нет прогресса'}</span></div></td>
              <td>${u.is_admin ? '👑 Админ' : '👤 Пользователь'}</td>
              <td>
                <div class="user-actions">
                  <button class="btn btn-small ${u.is_admin ? 'secondary' : ''}" data-toggle-admin="${u.id}" data-make="${!u.is_admin}">${u.is_admin ? '❌ Убрать админку' : '👑 Сделать админом'}</button>
                  <button class="btn btn-small" data-access="${u.id}" data-name="${u.full_name || u.email}">🔐 Управление доступом</button>
                </div>
              </td>
            `;
            tbody.appendChild(tr);
          });

          // обработчики
          tbody.querySelectorAll('[data-toggle-admin]').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              const uid = btn.getAttribute('data-toggle-admin');
              const make = btn.getAttribute('data-make') === 'true';
              if (!confirm(`Вы уверены, что хотите ${make ? 'назначить' : 'снять'} права администратора?`)) return;
              const { error } = await supabase.from('profiles').update({ is_admin: make }).eq('id', uid);
              if (error) return showModal('Ошибка', error.message);
              showModal('Готово', make ? 'Права администратора выданы' : 'Права администратора сняты');
              loadUsers();
            });
          });

          tbody.querySelectorAll('[data-access]').forEach(btn=>{
            btn.addEventListener('click', ()=>openUserAccessModal(btn.getAttribute('data-access'), btn.getAttribute('data-name')));
          });
        }

        document.getElementById('closeUserAccessModal').addEventListener('click', ()=>{
          document.getElementById('userAccessModal').style.display='none';
        });
        document.getElementById('saveUserAccessBtn').addEventListener('click', saveUserAccess);

        async function openUserAccessModal(userId, userName) {
          currentEditingUserId = userId;
          document.getElementById('userAccessInfo').innerHTML = `
            <p><strong>Пользователь:</strong> ${userName}</p>
            <p class="small-muted">Отметьте учебники и кроссворды, к которым пользователь должен иметь доступ</p>
          `;

          const [t, c, ta, ca] = await Promise.all([
            supabase.from('textbooks').select('id,title').eq('is_active', true).order('order_index'),
            supabase.from('crosswords').select('id,title').eq('is_active', true).order('order_index'),
            supabase.from('textbook_access').select('textbook_id').eq('user_id', userId),
            supabase.from('crossword_access').select('crossword_id').eq('user_id', userId)
          ]);

          const tSet = new Set((ta.data||[]).map(x=>String(x.textbook_id)));
          const cSet = new Set((ca.data||[]).map(x=>String(x.crossword_id)));

          const tList = document.getElementById('textbookAccessList');
          tList.innerHTML = '';
          if (t.data?.length) {
            t.data.forEach(tb=>{
              const item = document.createElement('div');
              item.className = 'access-item';
              const id = `textbook_${tb.id}`;
              item.innerHTML = `<input type="checkbox" id="${id}" ${tSet.has(String(tb.id))?'checked':''}>
                                <label for="${id}">${tb.title}</label>`;
              tList.appendChild(item);
            });
          } else {
            tList.innerHTML = '<p class="small-muted">Нет доступных учебников</p>';
          }

          const cList = document.getElementById('crosswordAccessList');
          cList.innerHTML = '';
          if (c.data?.length) {
            c.data.forEach(cr=>{
              const item = document.createElement('div');
              item.className = 'access-item';
              const id = `crossword_${cr.id}`;
              item.innerHTML = `<input type="checkbox" id="${id}" ${cSet.has(String(cr.id))?'checked':''}>
                                <label for="${id}">${cr.title}</label>`;
              cList.appendChild(item);
            });
          } else {
            cList.innerHTML = '<p class="small-muted">Нет доступных кроссвордов</p>';
          }

          document.getElementById('userAccessModal').style.display='flex';
        }

        async function saveUserAccess() {
          if (!currentEditingUserId) return;

          // собрать выбор
          const textSelected = Array.from(document.querySelectorAll('#textbookAccessList input[type="checkbox"]:checked'))
            .map(cb => cb.id.replace('textbook_',''));
          const crossSelected = Array.from(document.querySelectorAll('#crosswordAccessList input[type="checkbox"]:checked'))
            .map(cb => cb.id.replace('crossword_',''));

          // перезаписать
          const ops = [];
          ops.push(supabase.from('textbook_access').delete().eq('user_id', currentEditingUserId));
          ops.push(supabase.from('crossword_access').delete().eq('user_id', currentEditingUserId));
          await Promise.all(ops);

          if (textSelected.length) {
            await supabase.from('textbook_access').insert(
              textSelected.map(id=>({ user_id: currentEditingUserId, textbook_id: id }))
            );
          }
          if (crossSelected.length) {
            await supabase.from('crossword_access').insert(
              crossSelected.map(id=>({ user_id: currentEditingUserId, crossword_id: id }))
            );
          }

          showModal('Готово','Доступы обновлены');
          document.getElementById('userAccessModal').style.display='none';
        }

        // ===== СТАРТОВАЯ ИНИЦИАЛИЗАЦИЯ
        await loadStats();
        await loadTextbooks();
        await loadCrosswords();
        await loadMaterialsForAssignments();
        await loadUsers();

        showContent();
      } catch (e) {
        showError('❌ Ошибка инициализации админ-панели: ' + (e?.message || e));
      }
    }

    // запуск по конфигу
    if (window.SUPABASE_URL) {
      initApp();
    } else {
      const timeout = setTimeout(()=> showError('❌ Таймаут загрузки конфигурации'), 1000);
      window.addEventListener('configLoaded', () => { clearTimeout(timeout); initApp(); });
    }
  </script>
</body>
</html>