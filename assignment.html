<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–¥–∞–Ω–∏–µ - Edu Keys</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="/load-config.js"></script>
    <style>
        .assignment-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .question-card {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 8px 26px rgba(0,0,0,0.08);
        }
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        .question-number {
            font-size: 14px;
            color: var(--accent2);
            font-weight: 700;
            margin-bottom: 8px;
        }
        .question-text {
            font-size: 18px;
            font-weight: 600;
            line-height: 1.5;
            margin-bottom: 16px;
        }
        .question-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 12px;
            margin: 16px 0;
            display: block;
        }
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }
        .option-label {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--bg1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .option-label:hover {
            background: rgba(78, 205, 196, 0.1);
        }
        .option-label.selected {
            border-color: var(--accent2);
            background: rgba(78, 205, 196, 0.15);
        }
        .option-radio {
            margin-right: 12px;
        }
        .fill-input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--bg1);
            border-radius: 12px;
            font-size: 16px;
            margin: 10px 0;
        }
        .fill-input:focus {
            border-color: var(--accent2);
            outline: none;
        }
        .sentence-container {
            background: var(--bg1);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }
        .sentence-text {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        .sentence-gap {
            display: inline-block;
            min-width: 120px;
            margin: 0 5px;
        }
        .sentence-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--bg1);
        }
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--bg1);
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--accent2);
            transition: width 0.3s ease;
        }
        .loading {
            text-align: center;
            padding: 60px 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent2);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
        }
        .completion-message {
            text-align: center;
            padding: 40px 20px;
        }
        .score-display {
            font-size: 48px;
            font-weight: 700;
            color: var(--accent2);
            margin: 20px 0;
        }
        .btn-finish {
            background: var(--accent2);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-finish:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.3);
        }
        .btn-finish:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        @media (max-width: 768px) {
            .assignment-container {
                padding: 0 15px;
                margin: 10px auto;
            }
            .question-card {
                padding: 16px;
            }
            .question-text {
                font-size: 16px;
            }
            .option-label {
                padding: 12px;
            }
            .sentence-input {
                min-width: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <button class="btn secondary" onclick="location.href='/profile.html'">‚Üê –ù–∞–∑–∞–¥</button>
            <h1 id="pageTitle">–ó–∞–¥–∞–Ω–∏–µ</h1>
            <div id="userInfo"></div>
        </header>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞–Ω–∏–µ...</p>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <div id="assignmentContent" style="display: none;">
            <div class="assignment-container">
                <div class="card">
                    <h2 id="assignmentTitle"></h2>
                    <div id="assignmentDescription"></div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 14px; color: #666;">
                        <span>–ü—Ä–æ–≥—Ä–µ—Å—Å: <span id="progressText">0</span>%</span>
                        <span>–í–æ–ø—Ä–æ—Å <span id="currentQuestion">1</span> –∏–∑ <span id="totalQuestions">0</span></span>
                    </div>

                    <div id="questionsContainer"></div>

                    <div class="navigation">
                        <button class="btn secondary" id="prevBtn" style="display: none;">‚Üê –ù–∞–∑–∞–¥</button>
                        <button class="btn" id="nextBtn">–î–∞–ª–µ–µ ‚Üí</button>
                        <button class="btn-finish" id="finishBtn" style="display: none;">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="completionScreen" class="completion-message" style="display: none;">
            <div class="card">
                <h2>üéâ –ó–∞–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</h2>
                <div class="score-display" id="finalScore">0%</div>
                <p id="completionMessage"></p>
                <div style="margin-top: 30px;">
                    <button class="btn" onclick="location.href='/profile.html'">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª—å</button>
                    <button class="btn secondary" onclick="location.reload()">–ü—Ä–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        if (!window.SUPABASE_URL) {
            await window.CONFIG_READY;
        }

        let supabase;
        try {
            const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
            supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
            console.log('‚úÖ Supabase –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase:', error);
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ' + error.message);
            return;
        }

        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const assignmentId = urlParams.get('id');
        
        if (!assignmentId) {
            showError('ID –∑–∞–¥–∞–Ω–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω –≤ URL');
            return;
        }

        console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞–Ω–∏–µ ID:', assignmentId);

        let assignment = null;
        let questions = [];
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let userProgressId = null;

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('errorMessage');
        const contentEl = document.getElementById('assignmentContent');
        const completionEl = document.getElementById('completionScreen');
        const assignmentTitleEl = document.getElementById('assignmentTitle');
        const questionsContainerEl = document.getElementById('questionsContainer');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const finishBtn = document.getElementById('finishBtn');
        const progressFillEl = document.getElementById('progressFill');
        const progressTextEl = document.getElementById('progressText');
        const currentQuestionEl = document.getElementById('currentQuestion');
        const totalQuestionsEl = document.getElementById('totalQuestions');
        const finalScoreEl = document.getElementById('finalScore');
        const completionMessageEl = document.getElementById('completionMessage');

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
        let user;
        try {
            const { data: authData, error: authError } = await supabase.auth.getUser();
            if (authError) throw authError;
            user = authData.user;
            
            if (!user) {
                console.log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ª–æ–≥–∏–Ω');
                window.location.href = '/login.html';
                return;
            }
            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', user.email);
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:', error);
            showError('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + error.message);
            return;
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞–Ω–∏–µ
        async function loadAssignment() {
            try {
                console.log('üîÑ –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∑–∞–¥–∞–Ω–∏–µ –∏–∑ –±–∞–∑—ã...');
                const { data, error } = await supabase
                    .from('assignments')
                    .select('*')
                    .eq('id', assignmentId)
                    .single();

                if (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∑–∞–¥–∞–Ω–∏—è:', error);
                    throw error;
                }

                if (!data) {
                    throw new Error('–ó–∞–¥–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                }

                assignment = data;
                questions = data.content?.questions || [];
                
                console.log('‚úÖ –ó–∞–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', assignment.title);
                console.log('üìù –í–æ–ø—Ä–æ—Å–æ–≤:', questions.length);
                
                if (questions.length === 0) {
                    throw new Error('–í –∑–∞–¥–∞–Ω–∏–∏ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤');
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await loadUserProgress();

                renderAssignment();
                showQuestion(0);

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏—è:', error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ: ' + error.message);
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserProgress() {
            try {
                console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
                const { data, error } = await supabase
                    .from('user_progress')
                    .select('*')
                    .eq('user_id', user.id)
                    .eq('assignment_id', assignmentId)
                    .maybeSingle(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º maybeSingle –≤–º–µ—Å—Ç–æ single

                if (error && error.code !== 'PGRST116') { // PGRST116 - "–Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
                    throw error;
                }

                if (data) {
                    userProgressId = data.id;
                    userAnswers = data.answers || {};
                    console.log('‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∂–µ–Ω, –æ—Ç–≤–µ—Ç–æ–≤:', Object.keys(userAnswers).length);
                } else {
                    console.log('‚ÑπÔ∏è –ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–¥–∏–º –Ω–æ–≤—ã–π');
                    userAnswers = {};
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
                // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –ø—É—Å—Ç—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏
                userAnswers = {};
            }
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        async function saveProgress(isCompleted = false) {
            try {
                const score = isCompleted ? calculateScore() : 0;
                const progressData = {
                    user_id: user.id,
                    assignment_id: assignmentId,
                    answers: userAnswers,
                    is_completed: isCompleted,
                    completed_at: isCompleted ? new Date().toISOString() : null,
                    score: score
                };

                let result;
                if (userProgressId) {
                    result = await supabase
                        .from('user_progress')
                        .update(progressData)
                        .eq('id', userProgressId);
                } else {
                    result = await supabase
                        .from('user_progress')
                        .insert(progressData)
                        .select();
                    
                    if (result.data && result.data.length > 0) {
                        userProgressId = result.data[0].id;
                    }
                }

                if (result.error) throw result.error;
                
                console.log('‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
                return true;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
                return false;
            }
        }

        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Ü–µ–Ω–∫—É
        function calculateScore() {
            if (questions.length === 0) return 0;
            
            let correctAnswers = 0;
            
            questions.forEach((question, index) => {
                if (userAnswers[index] !== undefined && userAnswers[index] !== null && userAnswers[index] !== '') {
                    if (question.type === 'test') {
                        if (parseInt(userAnswers[index]) === question.correct) {
                            correctAnswers++;
                        }
                    } else if (question.type === 'fill') {
                        const userAnswer = String(userAnswers[index]).toLowerCase().trim();
                        const correctAnswersList = question.answers.map(a => String(a).toLowerCase().trim());
                        if (correctAnswersList.includes(userAnswer)) {
                            correctAnswers++;
                        }
                    } else if (question.type === 'sentence') {
                        // –î–ª—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –ø—Ä–æ–ø—É—Å–∫
                        const userAnswerArray = Array.isArray(userAnswers[index]) ? userAnswers[index] : [userAnswers[index]];
                        let correctGaps = 0;
                        
                        userAnswerArray.forEach((answer, gapIndex) => {
                            if (answer && question.answers[gapIndex]) {
                                const userAnswer = String(answer).toLowerCase().trim();
                                const correctAnswer = String(question.answers[gapIndex]).toLowerCase().trim();
                                if (userAnswer === correctAnswer) {
                                    correctGaps++;
                                }
                            }
                        });
                        
                        // –°—á–∏—Ç–∞–µ–º –≤–æ–ø—Ä–æ—Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º, –µ—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–ø—É—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –≤–µ—Ä–Ω–æ
                        if (correctGaps === question.answers.length) {
                            correctAnswers++;
                        }
                    }
                }
            });
            
            return Math.round((correctAnswers / questions.length) * 100);
        }

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞–¥–∞–Ω–∏–µ
        function renderAssignment() {
            assignmentTitleEl.textContent = assignment.title;
            totalQuestionsEl.textContent = questions.length;
            
            loadingEl.style.display = 'none';
            contentEl.style.display = 'block';
            
            updateProgress();
            console.log('‚úÖ –ó–∞–¥–∞–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ');
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å
        function showQuestion(index) {
            if (index < 0 || index >= questions.length) return;
            
            currentQuestionIndex = index;
            const question = questions[index];
            
            questionsContainerEl.innerHTML = '';
            
            const questionCard = document.createElement('div');
            questionCard.className = 'question-card';
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤–æ–ø—Ä–æ—Å–∞
            const questionHeader = document.createElement('div');
            questionHeader.className = 'question-header';
            questionHeader.innerHTML = `
                <div>
                    <div class="question-number">–í–æ–ø—Ä–æ—Å ${index + 1} –∏–∑ ${questions.length}</div>
                    <div class="question-text">${escapeHtml(question.q || '–í–æ–ø—Ä–æ—Å –±–µ–∑ —Ç–µ–∫—Å—Ç–∞')}</div>
                </div>
            `;
            questionCard.appendChild(questionHeader);
            
            // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞
            if (question.image) {
                const img = document.createElement('img');
                img.src = question.image;
                img.alt = '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞';
                img.className = 'question-image';
                img.onerror = () => {
                    console.log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', question.image);
                    img.style.display = 'none';
                };
                img.onload = () => console.log('‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', question.image);
                questionCard.appendChild(img);
            }
            
            // –ö–æ–Ω—Ç–µ–Ω—Ç –≤–æ–ø—Ä–æ—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            if (question.type === 'test') {
                renderTestQuestion(question, index, questionCard);
            } else if (question.type === 'fill') {
                renderFillQuestion(question, index, questionCard);
            } else if (question.type === 'sentence') {
                renderSentenceQuestion(question, index, questionCard);
            } else {
                // –ï—Å–ª–∏ —Ç–∏–ø –Ω–µ —É–∫–∞–∑–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å
                renderFillQuestion(question, index, questionCard);
            }
            
            questionsContainerEl.appendChild(questionCard);
            currentQuestionEl.textContent = index + 1;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
            prevBtn.style.display = index > 0 ? 'block' : 'none';
            nextBtn.style.display = index < questions.length - 1 ? 'block' : 'none';
            finishBtn.style.display = index === questions.length - 1 ? 'block' : 'none';
            
            updateProgress();
        }

        // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–µ—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å
        function renderTestQuestion(question, index, container) {
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'options-container';
            
            if (!question.options || question.options.length === 0) {
                optionsContainer.innerHTML = '<p style="color: #999; text-align: center;">–ù–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞</p>';
                container.appendChild(optionsContainer);
                return;
            }
            
            question.options.forEach((option, optionIndex) => {
                const label = document.createElement('label');
                label.className = `option-label ${userAnswers[index] === optionIndex ? 'selected' : ''}`;
                
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = `question-${index}`;
                radio.value = optionIndex;
                radio.className = 'option-radio';
                radio.checked = userAnswers[index] === optionIndex;
                
                radio.addEventListener('change', () => {
                    userAnswers[index] = optionIndex;
                    document.querySelectorAll(`.option-label`).forEach(l => l.classList.remove('selected'));
                    label.classList.add('selected');
                    saveProgress();
                    updateProgress();
                });
                
                label.appendChild(radio);
                label.appendChild(document.createTextNode(escapeHtml(option)));
                optionsContainer.appendChild(label);
            });
            
            container.appendChild(optionsContainer);
        }

        // –†–µ–Ω–¥–µ—Ä–∏–º –≤–æ–ø—Ä–æ—Å —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º
        function renderFillQuestion(question, index, container) {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'fill-input';
            input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç...';
            input.value = userAnswers[index] || '';
            
            input.addEventListener('input', () => {
                userAnswers[index] = input.value;
                saveProgress();
                updateProgress();
            });
            
            container.appendChild(input);
        }

        // –†–µ–Ω–¥–µ—Ä–∏–º –≤–æ–ø—Ä–æ—Å —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º
        function renderSentenceQuestion(question, index, container) {
            const sentenceContainer = document.createElement('div');
            sentenceContainer.className = 'sentence-container';
            
            const sentenceText = document.createElement('div');
            sentenceText.className = 'sentence-text';
            
            if (!question.sentence) {
                sentenceText.innerHTML = '<p style="color: #999;">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ</p>';
                sentenceContainer.appendChild(sentenceText);
                container.appendChild(sentenceContainer);
                return;
            }
            
            // –†–∞–∑–±–∏–≤–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —á–∞—Å—Ç–∏ –∏ –∑–∞–º–µ–Ω—è–µ–º ___ –Ω–∞ –∏–Ω–ø—É—Ç—ã
            const parts = question.sentence.split('___');
            sentenceText.innerHTML = '';
            
            parts.forEach((part, partIndex) => {
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
                if (part) {
                    sentenceText.appendChild(document.createTextNode(part));
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–ø—É—Ç –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ (–∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π —á–∞—Å—Ç–∏)
                if (partIndex < parts.length - 1) {
                    const gapContainer = document.createElement('span');
                    gapContainer.className = 'sentence-gap';
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'sentence-input';
                    input.placeholder = `–û—Ç–≤–µ—Ç ${partIndex + 1}`;
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
                    const savedAnswers = Array.isArray(userAnswers[index]) ? userAnswers[index] : [];
                    if (savedAnswers[partIndex] !== undefined) {
                        input.value = savedAnswers[partIndex];
                    }
                    
                    input.addEventListener('input', () => {
                        if (!Array.isArray(userAnswers[index])) {
                            userAnswers[index] = [];
                        }
                        userAnswers[index][partIndex] = input.value;
                        saveProgress();
                        updateProgress();
                    });
                    
                    gapContainer.appendChild(input);
                    sentenceText.appendChild(gapContainer);
                }
            });
            
            sentenceContainer.appendChild(sentenceText);
            container.appendChild(sentenceContainer);
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        function updateProgress() {
            const answeredCount = Object.keys(userAnswers).filter(key => {
                const answer = userAnswers[key];
                return answer !== undefined && answer !== null && answer !== '' && 
                      (!Array.isArray(answer) || answer.some(item => item !== ''));
            }).length;
            
            const progress = (answeredCount / questions.length) * 100;
            
            progressFillEl.style.width = `${progress}%`;
            progressTextEl.textContent = Math.round(progress);
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
        function showError(message) {
            loadingEl.style.display = 'none';
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            console.error('üö® –û—à–∏–±–∫–∞:', message);
        }

        // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // –ó–∞–≤–µ—Ä—à–∞–µ–º –∑–∞–¥–∞–Ω–∏–µ
        async function finishAssignment() {
            const score = calculateScore();
            const success = await saveProgress(true);
            
            if (success) {
                contentEl.style.display = 'none';
                completionEl.style.display = 'block';
                
                finalScoreEl.textContent = `${score}%`;
                
                if (score >= 80) {
                    completionMessageEl.textContent = '–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! –í—ã —Ö–æ—Ä–æ—à–æ —É—Å–≤–æ–∏–ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª.';
                } else if (score >= 60) {
                    completionMessageEl.textContent = '–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! –ï—Å—Ç—å –Ω–∞–¥ —á–µ–º –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å.';
                } else {
                    completionMessageEl.textContent = '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–æ–π—Ç–∏ –∑–∞–¥–∞–Ω–∏–µ –µ—â–µ —Ä–∞–∑ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.';
                }
                
                console.log('‚úÖ –ó–∞–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —Å –æ—Ü–µ–Ω–∫–æ–π:', score + '%');
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        prevBtn.addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                showQuestion(currentQuestionIndex - 1);
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentQuestionIndex < questions.length - 1) {
                showQuestion(currentQuestionIndex + 1);
            }
        });

        finishBtn.addEventListener('click', finishAssignment);

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        console.log('üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∑–∞–¥–∞–Ω–∏—è...');
        loadAssignment();
    </script>
</body>
</html>