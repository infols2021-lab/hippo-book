<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ó–∞–¥–∞–Ω–∏–µ ‚Äî Edu Keys</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .page {
      width: 95%;
      max-width: 1000px;
      margin: 20px auto;
    }

    .header-crumbs {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
    }

    .crumbs {
      font-size: 14px;
      color: #666;
    }

    .title-card {
      background: linear-gradient(135deg, #42a5f5, #26c6da);
      color: #fff;
      padding: 18px 20px;
      border-radius: 14px;
      margin-bottom: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,.08);
    }

    .title-card h2 {
      margin: 0 0 6px 0;
      font-size: 1.6rem;
    }

    .meta {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      font-size: 13px;
      opacity: .95;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.28);
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 600;
      backdrop-filter: blur(2px);
    }

    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,.08);
      padding: 16px;
      margin-bottom: 16px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      display: none;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--accent2);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 2s linear infinite;
      margin: 0 auto 18px;
    }
    @keyframes spin { 0% { transform: rotate(0) } 100% { transform: rotate(360deg) } }

    .error {
      background: #ffebee;
      color: #c62828;
      padding: 16px;
      border-radius: 8px;
      display: none;
      margin-bottom: 12px;
      border: 1px solid #ffcdd2;
    }

    .success {
      background: #e8f5e8;
      color: #2e7d32;
      padding: 14px;
      border-radius: 8px;
      display: none;
      margin-bottom: 12px;
      border: 1px solid #c8e6c9;
    }

    .question {
      display: grid;
      gap: 12px;
    }

    .q-title {
      font-weight: 700;
      font-size: 1.05rem;
      color: #333;
    }

    .q-image {
      width: 100%;
      border-radius: 10px;
      overflow: hidden;
      background: #fafafa;
      border: 1px solid #eee;
    }
    .q-image img { width: 100%; height: auto; display: block; }

    .choices {
      display: grid;
      gap: 10px;
    }

    .choice {
      display: grid;
      grid-template-columns: 22px 1fr;
      gap: 10px;
      align-items: flex-start;
      border: 2px solid #f0f0f0;
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      transition: border-color .2s, box-shadow .2s, transform .02s;
      background: #fff;
    }

    .choice:hover { border-color: var(--accent2); box-shadow: 0 6px 16px rgba(0,0,0,.05); }
    .choice input { margin-top: 3px; }

    .choice .content { display: grid; gap: 8px; }
    .choice .content .text { color: #333; }

    .choice .thumb { border-radius: 8px; overflow: hidden; border: 1px solid #eee; }
    .choice .thumb img { width: 100%; height: auto; display: block; }

    .answer-input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #eee;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color .2s;
    }
    .answer-input:focus { outline: none; border-color: var(--accent2); }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
    }

    .btn.primary { background: var(--accent2); color: #fff; }
    .btn.secondary { background: #eceff1; color: #37474f; }
    .btn {
      border: 0;
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: transform .15s, box-shadow .15s, opacity .15s;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,0,0,.08); }
    .btn:disabled { opacity: .6; cursor: not-allowed; transform: none; box-shadow: none; }

    .result {
      margin-top: 10px;
      font-weight: 600;
    }

    .muted { color: #666; font-size: 13px; }

    @media (max-width: 768px) {
      .title-card h2 { font-size: 1.3rem; }
    }
  </style>

  <!-- –í–ê–ñ–ù–û: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ -->
  <script src="/load-config.js"></script>
</head>
<body>
  <div class="page">
    <div class="header-crumbs">
      <div class="crumbs" id="crumbs">–ó–∞–¥–∞–Ω–∏–µ</div>
      <div>
        <button class="btn secondary" id="backBtn">‚Üê –ù–∞–∑–∞–¥</button>
      </div>
    </div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞–Ω–∏–µ‚Ä¶</p>
    </div>

    <div id="errorMessage" class="error"></div>
    <div id="successMessage" class="success"></div>

    <div id="content" style="display:none">
      <div class="title-card">
        <h2 id="assignmentTitle">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</h2>
        <div class="meta">
          <span class="badge" id="typeBadge">üìù –¢–∏–ø: ‚Äî</span>
          <span class="badge" id="progressBadge">üìä –°—Ç–∞—Ç—É—Å: ‚Äî</span>
        </div>
      </div>

      <div class="card">
        <div class="question" id="questionBox">
          <!-- –í–æ–ø—Ä–æ—Å —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –∏–∑ JS -->
        </div>

        <div class="actions">
          <div class="muted" id="hint"></div>
          <div>
            <button class="btn secondary" id="skipBtn">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
            <button class="btn primary" id="submitBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>
        </div>

        <div class="result" id="resultBox"></div>
      </div>
    </div>
  </div>

  <script type="module">
    // ==================== –•–ï–õ–ü–ï–†–´ –î–õ–Ø –ö–ê–†–¢–ò–ù–û–ö (–æ–±–ª–æ–∂–∫–∏/–≤–æ–ø—Ä–æ—Å—ã/–≤–∞—Ä–∏–∞–Ω—Ç—ã) ====================
    function isHttpUrl(v) {
      return typeof v === 'string' && /^https?:\/\//i.test(v);
    }
    function resolvePublicUrl(value, bucket) {
      if (!value) return null;
      if (isHttpUrl(value)) return value;
      // –ø—Ä–∏–≤–æ–¥–∏–º –≤–æ–∑–º–æ–∂–Ω—ã–π –ø—É—Ç—å —Ñ–æ—Ä–º–∞—Ç–∞ "folder/file.png" –∫ –ø—É–±–ª–∏—á–Ω–æ–º—É URL
      const key = String(value).replace(/^\/+/, '').replace(/^storage\/v1\/object\/public\/[^/]+\//,'');
      const v = Date.now(); // –¥–ª—è –æ–±—Ö–æ–¥–∞ –∫—ç—à–∞
      return `${window.SUPABASE_URL}/storage/v1/object/public/${bucket}/${encodeURIComponent(key)}?v=${v}`;
    }
    function imgEl(url, alt='') {
      const wrap = document.createElement('div');
      wrap.className = 'thumb';
      const img = document.createElement('img');
      img.loading = 'lazy';
      img.decoding = 'async';
      img.src = url;
      img.alt = alt;
      wrap.appendChild(img);
      return wrap;
    }

    // ==================== UI –•–ï–õ–ü–ï–†–´ ====================
    function showError(message) {
      const el = document.getElementById('errorMessage');
      el.textContent = message;
      el.style.display = 'block';
      document.getElementById('successMessage').style.display = 'none';
      document.getElementById('loading').style.display = 'none';
    }
    function showSuccess(message) {
      const el = document.getElementById('successMessage');
      el.textContent = message;
      el.style.display = 'block';
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('loading').style.display = 'none';
    }
    function hideBanners() {
      document.getElementById('successMessage').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
    }
    function showContent() {
      document.getElementById('content').style.display = 'block';
      document.getElementById('loading').style.display = 'none';
      hideBanners();
    }

    document.getElementById('loading').style.display = 'block';

    // ==================== –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ====================
    async function init() {
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
        showError('‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Supabase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.');
        return;
      }

      const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
      const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        location.href = '/login.html';
        return;
      }

      const params = new URLSearchParams(location.search);
      const assignmentId = params.get('id');
      const source = params.get('source') || '';      // textbook | crossword | ''
      const sourceId = params.get('sourceId') || '';  // id —É—á–µ–±–Ω–∏–∫–∞/–∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞

      if (!assignmentId) {
        showError('‚ùå –ó–∞–¥–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ.');
        return;
      }

      // –ö–Ω–æ–ø–∫–∞ "–Ω–∞–∑–∞–¥"
      const backBtn = document.getElementById('backBtn');
      backBtn.onclick = () => {
        if (source === 'textbook' && sourceId) {
          location.href = `/textbook.html?id=${sourceId}`;
        } else if (source === 'crossword' && sourceId) {
          location.href = `/crossword.html?id=${sourceId}`;
        } else {
          location.href = '/materials.html';
        }
      };

      let assignment = null;
      let already = null; // —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å—Ç—Ä–æ–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

      try {
        // 1) –ü–æ–ª—É—á–∞–µ–º –∑–∞–¥–∞–Ω–∏–µ
        const { data: aData, error: aErr } = await supabase
          .from('assignments')
          .select('*')
          .eq('id', assignmentId)
          .single();
        if (aErr) throw aErr;
        assignment = aData;

        // 2) –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø (–µ—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –Ω–∞–ø—Ä—è–º—É—é –ø–æ —Å—Å—ã–ª–∫–µ)
        // ‚Äî –¥–æ—Å—Ç—É–ø –∫ —É—á–µ–±–Ω–∏–∫—É
        if (assignment.textbook_id) {
          // –ï—Å–ª–∏ —É—á–µ–±–Ω–∏–∫ –∑–∞–∫—Ä—ã—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä–∏–º —è–≤–Ω—ã–π –¥–æ—Å—Ç—É–ø
          const { data: tb } = await supabase.from('textbooks').select('id,is_available').eq('id', assignment.textbook_id).single();
          if (tb && !tb.is_available) {
            const { data: acc } = await supabase
              .from('textbook_access')
              .select('id')
              .eq('user_id', user.id)
              .eq('textbook_id', assignment.textbook_id)
              .maybeSingle();
            if (!acc) {
              showError('üîí –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –∑–∞–¥–∞–Ω–∏—é (—É—á–µ–±–Ω–∏–∫ –∑–∞–∫—Ä—ã—Ç). –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.');
              return;
            }
          }
        }
        // ‚Äî –¥–æ—Å—Ç—É–ø –∫ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥—É
        if (assignment.crossword_id) {
          const { data: cw } = await supabase.from('crosswords').select('id,is_available').eq('id', assignment.crossword_id).single();
          if (cw && !cw.is_available) {
            const { data: acc } = await supabase
              .from('crossword_access')
              .select('id')
              .eq('user_id', user.id)
              .eq('crossword_id', assignment.crossword_id)
              .maybeSingle();
            if (!acc) {
              showError('üîí –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –∑–∞–¥–∞–Ω–∏—é (–∫—Ä–æ—Å—Å–≤–æ—Ä–¥ –∑–∞–∫—Ä—ã—Ç). –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.');
              return;
            }
          }
        }

        // 3) –¢—è–Ω–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å (–µ—Å–ª–∏ –µ—Å—Ç—å)
        const { data: upData, error: upErr } = await supabase
          .from('user_progress')
          .select('*')
          .eq('user_id', user.id)
          .eq('assignment_id', assignmentId)
          .maybeSingle();
        if (upErr && upErr.code !== 'PGRST116') throw upErr;
        already = upData || null;
      } catch (e) {
        console.error('Load assignment error:', e);
        showError('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏—è: ' + (e.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
        return;
      }

      renderAssignment(assignment, already);

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      document.getElementById('submitBtn').onclick = () => submitAnswers(supabase, user, assignment, already);
      document.getElementById('skipBtn').onclick = () => {
        // –ü–æ–∑–≤–æ–ª–∏–º –≤–µ—Ä–Ω—É—Ç—å—Å—è, –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—è
        backBtn.click();
      };

      showContent();
    }

    // –†–ï–ù–î–ï–†
    function renderAssignment(assignment, already) {
      const content = assignment?.content || {};
      const questions = Array.isArray(content?.questions) ? content.questions : [];
      const first = questions[0] || {};

      // –¢–∏–ø
      const aType = first?.type || assignment?.type || 'test'; // test | fill | sentence

      // –ù–∞–≤–µ—Ä—Ö—É
      document.getElementById('assignmentTitle').textContent = assignment.title || '–ó–∞–¥–∞–Ω–∏–µ';
      document.getElementById('crumbs').textContent =
        (assignment.textbook_id ? '–£—á–µ–±–Ω–∏–∫ ‚Üí ' : (assignment.crossword_id ? '–ö—Ä–æ—Å—Å–≤–æ—Ä–¥ ‚Üí ' : '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã ‚Üí ')) +
        (assignment.title || '–ó–∞–¥–∞–Ω–∏–µ');

      const typeBadge = document.getElementById('typeBadge');
      typeBadge.textContent = 'üìù –¢–∏–ø: ' + (aType === 'fill' ? '–í–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞' : (aType === 'sentence' ? '–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è' : '–¢–µ—Å—Ç'));

      const progressBadge = document.getElementById('progressBadge');
      progressBadge.textContent = 'üìä –°—Ç–∞—Ç—É—Å: ' + (already?.is_completed ? '–≤—ã–ø–æ–ª–Ω–µ–Ω–æ' : '–Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ');

      const questionBox = document.getElementById('questionBox');
      questionBox.innerHTML = '';

      // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤–æ–ø—Ä–æ—Å–∞
      if (first?.text) {
        const qTitle = document.createElement('div');
        qTitle.className = 'q-title';
        qTitle.textContent = first.text;
        questionBox.appendChild(qTitle);
      }

      // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
      if (first?.image_url) {
        const url = resolvePublicUrl(first.image_url, 'assignment-images');
        if (url) {
          const wrap = document.createElement('div');
          wrap.className = 'q-image';
          wrap.appendChild(imgEl(url, '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫ –≤–æ–ø—Ä–æ—Å—É'));
          questionBox.appendChild(wrap);
        }
      }

      // –†–µ–Ω–¥–µ—Ä –ø–æ —Ç–∏–ø—É
      if (aType === 'test') {
        const choicesWrap = document.createElement('div');
        choicesWrap.className = 'choices';

        (first?.options || []).forEach((opt, idx) => {
          const label = document.createElement('label');
          label.className = 'choice';
          label.setAttribute('data-index', String(idx));

          const input = document.createElement('input');
          input.type = 'radio';
          input.name = 'answer';
          input.value = String(idx);

          const content = document.createElement('div');
          content.className = 'content';

          if (opt?.text) {
            const t = document.createElement('div');
            t.className = 'text';
            t.textContent = opt.text;
            content.appendChild(t);
          }
          if (opt?.image_url) {
            const url = resolvePublicUrl(opt.image_url, 'assignment-images');
            if (url) content.appendChild(imgEl(url, '–í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞'));
          }

          label.appendChild(input);
          label.appendChild(content);
          choicesWrap.appendChild(label);
        });

        questionBox.appendChild(choicesWrap);
        document.getElementById('hint').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª.';
      } else if (aType === 'fill') {
        const input = document.createElement('input');
        input.type = 'text';
        input.id = 'fillAnswer';
        input.className = 'answer-input';
        input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç';
        questionBox.appendChild(input);
        document.getElementById('hint').textContent = '–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª.';
      } else { // sentence –∫–∞–∫ –ø–æ–¥—Ç–∏–ø –≤–≤–æ–¥–∞
        const input = document.createElement('input');
        input.type = 'text';
        input.id = 'fillAnswer';
        input.className = 'answer-input';
        input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–µ —Å–ª–æ–≤–æ(–∞)';
        questionBox.appendChild(input);
        document.getElementById('hint').textContent = '–î–æ–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª.';
      }

      // –ï—Å–ª–∏ –∑–∞–¥–∞–Ω–∏–µ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ‚Äî –º—è–≥–∫–∏–π –ø–æ–∫–∞–∑
      if (already?.is_completed) {
        const result = document.getElementById('resultBox');
        result.style.color = '#2e7d32';
        result.textContent = '‚úÖ –ó–∞–¥–∞–Ω–∏–µ —É–∂–µ –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ.';
      }
    }

    // –ü–†–û–í–ï–†–ö–ê –ò –°–û–•–†–ê–ù–ï–ù–ò–ï
    async function submitAnswers(supabase, user, assignment, already) {
      hideBanners();

      const content = assignment?.content || {};
      const questions = Array.isArray(content?.questions) ? content.questions : [];
      const first = questions[0] || {};
      const aType = first?.type || assignment?.type || 'test';

      // –°–æ–±–∏—Ä–∞–µ–º –æ—Ç–≤–µ—Ç
      let isCorrect = true;     // –µ—Å–ª–∏ –Ω–µ—Ç –∫–ª—é—á–∞ ‚Äî —Å—á–∏—Ç–∞–µ–º –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –±–µ–∑ –æ—Ü–µ–Ω–∫–∏
      let givenAnswer = null;   // —Ç–æ, —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–º –≤ –ë–î (–¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏)
      let score = null;

      if (aType === 'test') {
        const selected = document.querySelector('input[name="answer"]:checked');
        if (!selected) {
          showError('–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞.');
          return;
        }
        const idx = Number(selected.value);
        givenAnswer = { type: 'test', selectedIndex: idx };

        const correctIndex = typeof first.correctIndex === 'number' ? first.correctIndex : null;
        if (correctIndex !== null) {
          isCorrect = (idx === correctIndex);
          score = isCorrect ? 1 : 0;
        }
      } else {
        const val = (document.getElementById('fillAnswer')?.value || '').trim();
        if (!val) {
          showError('–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç.');
          return;
        }
        givenAnswer = { type: aType, text: val };

        const correct = String(first.correct || '').trim();
        if (correct) {
          // —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞/–ø—Ä–æ–±–µ–ª–æ–≤
          isCorrect = correct.toLowerCase() === val.toLowerCase();
          score = isCorrect ? 1 : 0;
        }
      }

      // –ü–∏—à–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å.
      // –í–ê–ñ–ù–û –î–õ–Ø RLS: –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞—ë–º user_id = auth.uid()!
      const payload = {
        user_id: user.id,
        assignment_id: assignment.id,
        is_completed: true,
        score: score,
        answers: givenAnswer ? JSON.stringify(givenAnswer) : null,
        updated_at: new Date().toISOString()
      };

      // –ï—Å–ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ –µ—Å—Ç—å —Å—Ç–æ–ª–±–µ—Ü "source" / "source_id", –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–∞–≤–∏—Ç—å (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
      if (assignment.textbook_id) {
        payload.source = 'textbook';
        payload.source_id = assignment.textbook_id;
      } else if (assignment.crossword_id) {
        payload.source = 'crossword';
        payload.source_id = assignment.crossword_id;
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å onConflict –ø–æ (user_id, assignment_id)
      try {
        disableButtons(true);
        const { error } = await supabase
          .from('user_progress')
          .upsert(payload, { onConflict: 'user_id,assignment_id' });

        if (error) {
          // –ß–∞—Å—Ç–∞—è –ø—Ä–∏—á–∏–Ω–∞: RLS –∑–∞–ø—Ä–µ—â–∞–µ—Ç –≤—Å—Ç–∞–≤–∫—É, –∫–æ–≥–¥–∞ –Ω–µ —É–∫–∞–∑–∞–Ω user_id –∏–ª–∏ –ø–æ–ª–∏—Ç–∏–∫–∞ –æ–∂–∏–¥–∞–µ—Ç auth.uid()
          if (String(error.message || '').toLowerCase().includes('row-level security')) {
            showError('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏: –ø–æ–ª–∏—Ç–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–µ —Ä–∞–∑—Ä–µ—à–∏–ª–∞ –∑–∞–ø–∏—Å—å. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ —Ç–∞–±–ª–∏—Ü–µ user_progress –µ—Å—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∞ INSERT –≤–∏–¥–∞: user_id = auth.uid().');
          } else {
            showError('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: ' + error.message);
          }
          disableButtons(false);
          return;
        }

        // UI-—Ä–µ–∑—É–ª—å—Ç–∞—Ç
        const res = document.getElementById('resultBox');
        res.style.color = isCorrect ? '#2e7d32' : '#c62828';
        res.textContent = isCorrect ? '‚úÖ –û—Ç–≤–µ—Ç –ø—Ä–∏–Ω—è—Ç! –ó–∞–¥–∞–Ω–∏–µ –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ.' : '‚ÑπÔ∏è –û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω, –∑–∞–¥–∞–Ω–∏–µ –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ.';

        showSuccess('‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');

        // –û–±–Ω–æ–≤–∏–º –±–µ–π–¥–∂
        document.getElementById('progressBadge').textContent = 'üìä –°—Ç–∞—Ç—É—Å: –≤—ã–ø–æ–ª–Ω–µ–Ω–æ';

        // –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ —á–µ—Ä–µ–∑ –∫–æ—Ä–æ—Ç–∫—É—é –ø–∞—É–∑—É
        setTimeout(() => {
          const btn = document.getElementById('backBtn');
          btn.click();
        }, 1200);

      } catch (e) {
        console.error('Submit error:', e);
        showError('‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (e.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
        disableButtons(false);
      }
    }

    function disableButtons(state) {
      document.getElementById('submitBtn').disabled = state;
      document.getElementById('skipBtn').disabled = state;
      document.getElementById('backBtn').disabled = state;
    }

    if (window.SUPABASE_URL) {
      init().catch(err => showError('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + (err.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')));
    } else {
      window.addEventListener('configLoaded', () => {
        init().catch(err => showError('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + (err.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')));
      });
    }
  </script>
</body>
</html>
