<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Задание - Edu Keys</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="/load-config.js"></script>
    <style>
        /* Все существующие стили остаются без изменений */
        .assignment-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .question-card {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 8px 26px rgba(0,0,0,0.08);
        }
        .question-number {
            font-size: 14px;
            color: var(--accent2);
            font-weight: 700;
            margin-bottom: 8px;
        }
        .question-text {
            font-size: 18px;
            font-weight: 600;
            line-height: 1.5;
            margin-bottom: 16px;
            white-space: pre-line;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .question-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 12px;
            margin: 16px 0;
            display: block;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .question-image:hover {
            transform: scale(1.02);
        }
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }
        .option-label {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--bg1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .option-label:hover {
            background: rgba(78, 205, 196, 0.1);
        }
        .option-label.selected {
            border-color: var(--accent2);
            background: rgba(78, 205, 196, 0.15);
        }
        .option-radio {
            margin-right: 12px;
        }
        
        .fill-inputs-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }
        .fill-input-item {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        .fill-input-number {
            background: var(--accent2);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }
        .fill-input-item input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            font-size: 16px;
        }
        .fill-input-item input:focus {
            border-color: var(--accent2);
            outline: none;
        }
        .fill-input-count {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }
        
        .sentence-container {
            background: var(--bg1);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }
        .sentence-text {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            white-space: pre-line;
        }
        .sentence-gap {
            display: inline-block;
            min-width: 120px;
            margin: 0 5px;
        }
        .sentence-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            text-align: center;
        }
        .sentence-input:focus {
            border-color: var(--accent2);
            outline: none;
        }
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--bg1);
        }
        .question-counter {
            text-align: center;
            font-size: 16px;
            color: #666;
            margin: 15px 0;
            font-weight: 600;
        }
        .loading {
            text-align: center;
            padding: 60px 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent2);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
        }
        .completion-message {
            text-align: center;
            padding: 40px 20px;
        }
        .score-display {
            font-size: 48px;
            font-weight: 700;
            color: var(--accent2);
            margin: 20px 0;
        }
        .btn-finish {
            background: var(--accent2);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
        }
        .completion-details {
            margin: 20px 0;
            padding: 20px;
            background: var(--bg1);
            border-radius: 12px;
            text-align: left;
        }
        .completion-details h3 {
            margin-bottom: 15px;
            color: var(--accent2);
            text-align: center;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .previous-result {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
            border-left: 4px solid var(--accent2);
        }
        .question-review {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        .question-review.correct {
            border-left: 4px solid #4caf50;
        }
        .question-review.incorrect {
            border-left: 4px solid #f44336;
        }
        .question-review.skipped {
            border-left: 4px solid #ff9800;
        }
        .review-question {
            font-weight: 600;
            margin-bottom: 10px;
            white-space: pre-line;
        }
        .review-answer {
            margin: 5px 0;
        }
        .review-correct {
            color: #4caf50;
            font-weight: 600;
        }
        .review-user {
            color: #f44336;
        }
        .review-status {
            font-weight: 600;
            margin-top: 5px;
        }
        .status-correct { color: #4caf50; }
        .status-incorrect { color: #f44336; }
        .status-skipped { color: #ff9800; }

        .crossword-container {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #e9ecef;
        }

        .crossword-grid-wrapper {
            overflow: auto;
            max-width: 100%;
            margin: 10px 0;
        }

        .crossword-grid {
            display: inline-block;
            border: 3px solid #333;
            background: white;
            margin: 10px 0;
        }

        .crossword-row {
            display: flex;
        }

        .crossword-cell {
            position: relative;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            border: 1px solid #999;
        }

        /* Размеры клеток для разных размеров кроссворда */
        .crossword-cell.size-large {
            width: 25px;
            height: 25px;
            font-size: 14px;
        }

        .crossword-cell.size-medium {
            width: 30px;
            height: 30px;
            font-size: 14px;
        }

        .crossword-cell.size-normal {
            width: 35px;
            height: 35px;
            font-size: 15px;
        }

        .crossword-cell.size-small {
            width: 40px;
            height: 40px;
            font-size: 16px;
        }

        .crossword-cell.blocked {
            background: #333;
            border-color: #333;
        }

        .crossword-cell input {
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            font-weight: bold;
            text-transform: uppercase;
            background: transparent;
            outline: none;
            font-family: inherit;
            color: #2c3e50;
        }

        .crossword-cell.size-large input {
            font-size: 12px;
        }

        .crossword-cell.size-medium input {
            font-size: 13px;
        }

        .crossword-cell.size-normal input {
            font-size: 14px;
        }

        .crossword-cell.size-small input {
            font-size: 16px;
        }

        .crossword-cell input:focus {
            background: #e3f2fd;
        }

        .crossword-cell.blocked input {
            display: none;
        }

        .crossword-cell.correct {
            background: #e8f5e8;
        }

        .crossword-cell.incorrect {
            background: #ffebee;
        }

        .crossword-number {
            position: absolute;
            font-weight: bold;
            color: #333;
            z-index: 1;
            background: rgba(255,255,255,0.8);
            padding: 1px 2px;
            border-radius: 2px;
        }

        .crossword-cell.size-large .crossword-number {
            font-size: 6px;
        }

        .crossword-cell.size-medium .crossword-number {
            font-size: 7px;
        }

        .crossword-cell.size-normal .crossword-number {
            font-size: 8px;
        }

        .crossword-cell.size-small .crossword-number {
            font-size: 8px;
        }

        .crossword-number-across {
            top: 1px;
            left: 1px;
        }

        .crossword-number-down {
            top: 1px;
            right: 1px;
        }

        .crossword-instructions {
            background: #e8f5e8;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
            line-height: 1.5;
        }

        .crossword-instructions h4 {
            margin: 0 0 10px 0;
            color: #2e7d32;
        }

        .crossword-instructions ul {
            margin: 0;
            padding-left: 20px;
        }

        .crossword-instructions li {
            margin-bottom: 5px;
        }

        .crossword-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin: 10px 0;
            display: block;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .crossword-image:hover {
            transform: scale(1.02);
        }

        .crossword-words {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .crossword-words h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
        }

        .words-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .words-column h5 {
            margin: 0 0 10px 0;
            color: #34495e;
        }

        .word-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 5px 0;
        }

        .word-number {
            background: var(--accent2);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }

        .word-text {
            font-weight: 500;
        }

        .crossword-review {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .crossword-review h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }

        .crossword-words-review ul {
            margin: 0;
            padding-left: 20px;
        }

        .crossword-words-review li {
            margin-bottom: 5px;
            padding: 5px 0;
        }

        .correct-word {
            color: #4caf50;
        }

        .incorrect-word {
            color: #f44336;
        }

        .restart-container {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: #fff3e0;
            border-radius: 12px;
            border: 2px solid #ff9800;
        }

        .restart-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 0 10px;
        }

        .restart-btn:hover {
            background: #f57c00;
        }

        .view-mode-notice {
            background: #e8f5e8;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .mode-switch-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        .mode-switch-btn:hover {
            background: #5a6268;
        }

        /* Модальное окно для изображений */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            backdrop-filter: blur(5px);
        }

        .image-modal-content {
            margin: auto;
            display: block;
            max-width: 95%;
            max-height: 95%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
            background: rgba(0,0,0,0.5);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .image-modal-close:hover {
            background: rgba(0,0,0,0.8);
        }

        .image-modal-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }

        .image-modal-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .image-modal-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .image-modal-zoom-info {
            color: white;
            font-size: 16px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            background: rgba(0,0,0,0.5);
            border-radius: 20px;
        }

        @media (max-width: 768px) {
            .assignment-container {
                padding: 0 15px;
            }
            .question-card {
                padding: 16px;
            }
            .question-text {
                font-size: 16px;
            }
            .option-label {
                padding: 12px;
            }
            .crossword-cell.size-large {
                width: 22px;
                height: 22px;
                font-size: 12px;
            }
            .crossword-cell.size-medium {
                width: 26px;
                height: 26px;
                font-size: 12px;
            }
            .crossword-cell.size-normal {
                width: 30px;
                height: 30px;
                font-size: 13px;
            }
            .crossword-cell.size-small {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }
            .words-columns {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .crossword-cell.size-large .crossword-number {
                font-size: 5px;
            }
            .crossword-cell.size-medium .crossword-number {
                font-size: 6px;
            }
            .crossword-cell.size-normal .crossword-number {
                font-size: 7px;
            }
            .crossword-cell.size-small .crossword-number {
                font-size: 7px;
            }
            .fill-input-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .fill-input-item input {
                width: 100%;
            }
            .header-buttons {
                flex-direction: column;
                gap: 5px;
            }
            .mode-switch-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            .image-modal-content {
                max-width: 98%;
                max-height: 85%;
            }
            .image-modal-close {
                top: 10px;
                right: 15px;
                font-size: 30px;
                width: 40px;
                height: 40px;
            }
            .image-modal-controls {
                bottom: 15px;
                padding: 10px;
            }
            .image-modal-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .crossword-cell.size-large {
                width: 18px;
                height: 18px;
                font-size: 10px;
            }
            .crossword-cell.size-medium {
                width: 22px;
                height: 22px;
                font-size: 10px;
            }
            .crossword-cell.size-normal {
                width: 25px;
                height: 25px;
                font-size: 11px;
            }
            .crossword-cell.size-small {
                width: 30px;
                height: 30px;
                font-size: 12px;
            }
            .fill-input-number {
                width: 24px;
                height: 24px;
                font-size: 12px;
            }
            .crossword-cell.size-large .crossword-number {
                font-size: 4px;
            }
            .crossword-cell.size-medium .crossword-number {
                font-size: 5px;
            }
            .crossword-cell.size-normal .crossword-number {
                font-size: 6px;
            }
            .crossword-cell.size-small .crossword-number {
                font-size: 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-buttons">
                <button class="btn secondary" id="backToMaterialsBtn">← К материалам</button>
                <button class="mode-switch-btn" id="modeSwitchBtn" style="display: none;">↶ Сменить режим</button>
            </div>
            <h1>Задание</h1>
        </header>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Загружаем задание...</p>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <div id="assignmentContent" style="display: none;">
            <div class="assignment-container">
                <div class="restart-container" id="restartContainer" style="display: none;">
                    <h3>📊 У вас есть предыдущий результат</h3>
                    <p>Вы можете просмотреть свои прошлые ответы или начать заново с чистыми полями</p>
                    <div>
                        <button class="restart-btn" id="startFreshBtn">Начать заново</button>
                        <button class="btn secondary" id="viewPreviousBtn">Просмотреть прошлые ответы</button>
                    </div>
                </div>

                <div class="card" id="questionsCard" style="display: none;">
                    <h2 id="assignmentTitle">Название задания</h2>
                    
                    <div id="viewModeNotice" class="view-mode-notice" style="display: none;">
                        <strong>👀 Режим просмотра</strong>
                        <br><small>Вы просматриваете свои предыдущие ответы</small>
                    </div>
                    
                    <div class="question-counter">
                        Вопрос <span id="currentQuestion">1</span> из <span id="totalQuestions">0</span>
                    </div>

                    <div id="questionsContainer"></div>

                    <div class="navigation">
                        <button class="btn secondary" id="prevBtn" style="display: none;">← Назад</button>
                        <button class="btn" id="nextBtn">Далее →</button>
                        <button class="btn-finish" id="finishBtn" style="display: none;">Завершить задание</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="completionScreen" class="completion-message" style="display: none;">
            <div class="card">
                <h2>🎉 Задание завершено!</h2>
                <div class="score-display" id="finalScore">0%</div>
                <p id="completionMessage"></p>
                
                <div class="completion-details">
                    <h3>📊 Детали результатов</h3>
                    <div class="result-item">
                        <span>Всего вопросов:</span>
                        <span id="totalQuestionsResult">0</span>
                    </div>
                    <div class="result-item">
                        <span>Правильных ответов:</span>
                        <span id="correctAnswersResult">0</span>
                    </div>
                    <div class="result-item">
                        <span>Неправильных ответов:</span>
                        <span id="incorrectAnswersResult">0</span>
                    </div>
                    <div class="result-item">
                        <span>Пропущено вопросов:</span>
                        <span id="skippedQuestionsResult">0</span>
                    </div>
                </div>

                <div id="questionsReview" style="display: none;">
                    <h3>🔍 Разбор ответов</h3>
                    <div id="reviewContainer"></div>
                </div>
                
                <div style="margin-top: 30px;">
                    <button class="btn" onclick="location.href='/materials.html'">Вернуться к материалам</button>
                    <button class="btn secondary" onclick="location.reload()" style="margin-left: 10px;">Пройти заново</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для изображений -->
    <div id="imageModal" class="image-modal">
        <span class="image-modal-close">&times;</span>
        <img class="image-modal-content" id="modalImage">
        <div class="image-modal-controls">
            <button class="image-modal-btn" id="zoomOutBtn">−</button>
            <div class="image-modal-zoom-info" id="zoomInfo">100%</div>
            <button class="image-modal-btn" id="zoomInBtn">+</button>
            <button class="image-modal-btn" id="resetZoomBtn">⟲</button>
        </div>
    </div>

    <script type="module">
        // Глобальные переменные для управления состоянием
        let currentState = {
            assignment: null,
            questions: [],
            userAnswers: {},
            supabase: null,
            user: null,
            previousProgress: null,
            isViewMode: false,
            currentQuestionIndex: 0,
            hasCompleted: false
        };

        // Переменные для управления модальным окном изображений
        let currentZoom = 1;
        const ZOOM_STEP = 0.25;
        const MIN_ZOOM = 0.5;
        const MAX_ZOOM = 3;

        // ============ ФУНКЦИИ ДЛЯ МОДАЛЬНОГО ОКНА ИЗОБРАЖЕНИЙ ============
        function initImageModal() {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const closeBtn = document.querySelector('.image-modal-close');
            const zoomInBtn = document.getElementById('zoomInBtn');
            const zoomOutBtn = document.getElementById('zoomOutBtn');
            const resetZoomBtn = document.getElementById('resetZoomBtn');
            const zoomInfo = document.getElementById('zoomInfo');

            // Закрытие модального окна
            closeBtn.onclick = function() {
                modal.style.display = 'none';
                resetZoom();
            }

            // Закрытие при клике вне изображения
            modal.onclick = function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                    resetZoom();
                }
            }

            // Закрытие по ESC
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && modal.style.display === 'block') {
                    modal.style.display = 'none';
                    resetZoom();
                }
            });

            // Управление масштабом
            zoomInBtn.onclick = function() {
                if (currentZoom < MAX_ZOOM) {
                    currentZoom += ZOOM_STEP;
                    updateZoom();
                }
            }

            zoomOutBtn.onclick = function() {
                if (currentZoom > MIN_ZOOM) {
                    currentZoom -= ZOOM_STEP;
                    updateZoom();
                }
            }

            resetZoomBtn.onclick = resetZoom;

            // Масштабирование колесиком мыши
            modalImg.onwheel = function(event) {
                event.preventDefault();
                if (event.deltaY < 0) {
                    // Zoom in
                    if (currentZoom < MAX_ZOOM) {
                        currentZoom += ZOOM_STEP;
                    }
                } else {
                    // Zoom out
                    if (currentZoom > MIN_ZOOM) {
                        currentZoom -= ZOOM_STEP;
                    }
                }
                updateZoom();
            }

            function updateZoom() {
                modalImg.style.transform = `translate(-50%, -50%) scale(${currentZoom})`;
                zoomInfo.textContent = Math.round(currentZoom * 100) + '%';
            }

            function resetZoom() {
                currentZoom = 1;
                updateZoom();
            }
        }

        // Функция открытия изображения в модальном окне
        function openImageModal(src) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            
            modalImg.src = src;
            modal.style.display = 'block';
            currentZoom = 1;
            modalImg.style.transform = 'translate(-50%, -50%) scale(1)';
            document.getElementById('zoomInfo').textContent = '100%';
        }

        // ============ НОВАЯ ФУНКЦИЯ: Нормализация текста для сравнения ============
        function normalizeText(text) {
            if (!text) return '';
            
            // Приводим к нижнему регистру и обрезаем пробелы
            let normalized = String(text).toLowerCase().trim();
            
            // Заменяем все виды апострофов на стандартный '
            normalized = normalized.replace(/[’‘ʼ`´]/g, "'");
            
            // Убираем пробелы непосредственно перед и после апострофа
            normalized = normalized.replace(/\s*'\s*/g, "'");
            
            // Заменяем множественные пробелы на один
            normalized = normalized.replace(/\s+/g, ' ');
            
            return normalized;
        }

        // ============ НОВАЯ ФУНКЦИЯ: Сравнение ответов с учетом нормализации ============
        function compareAnswers(userAnswer, correctAnswer) {
            if (!userAnswer && !correctAnswer) return true;
            if (!userAnswer || !correctAnswer) return false;
            
            const normalizedUser = normalizeText(userAnswer);
            const normalizedCorrect = normalizeText(correctAnswer);
            
            return normalizedUser === normalizedCorrect;
        }

        // ============ НОВАЯ ФУНКЦИЯ: Проверка ответа на соответствие любому из вариантов ============
        function checkAnswerAgainstVariants(userAnswer, correctVariants) {
            if (!userAnswer) return false;
            
            const normalizedUser = normalizeText(userAnswer);
            
            for (const variant of correctVariants) {
                if (normalizeText(variant) === normalizedUser) {
                    return true;
                }
            }
            
            return false;
        }

        // Простая функция для показа ошибок
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            console.error('Ошибка:', message);
        }

        // Функция показа временной ошибки
        function showTempError(message) {
            const errorEl = document.getElementById('errorMessage');
            if (!errorEl) return;
            
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }

        // Функция скрытия всех основных экранов
        function hideAllScreens() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('assignmentContent').style.display = 'none';
            document.getElementById('completionScreen').style.display = 'none';
            document.getElementById('restartContainer').style.display = 'none';
            document.getElementById('questionsCard').style.display = 'none';
        }

        // Настройка кнопок навигации
        function setupNavigationButtons() {
            // Кнопка "К материалам" - всегда ведет на materials.html
            document.getElementById('backToMaterialsBtn').addEventListener('click', () => {
                location.href = '/materials.html';
            });

            // Кнопка смены режима - показывает выбор режима
            document.getElementById('modeSwitchBtn').addEventListener('click', () => {
                showRestartChoice();
            });
        }

        // Обновление видимости кнопки смены режима
        function updateModeSwitchButton() {
            const modeSwitchBtn = document.getElementById('modeSwitchBtn');
            // Показываем кнопку только когда есть выбор режима (есть предыдущий прогресс)
            if (currentState.previousProgress && !currentState.hasCompleted) {
                modeSwitchBtn.style.display = 'block';
            } else {
                modeSwitchBtn.style.display = 'none';
            }
        }

        // Основная функция инициализации
        async function initAssignment() {
            try {
                console.log('🚀 Начинаем загрузку задания...');

                // Инициализируем модальное окно для изображений
                initImageModal();

                // Настраиваем кнопки навигации
                setupNavigationButtons();

                // Ждем конфигурацию если нужно
                if (!window.SUPABASE_URL) {
                    console.log('⏳ Ожидаем конфигурацию...');
                    await window.CONFIG_READY;
                }

                // Импортируем Supabase
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
                currentState.supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
                console.log('✅ Supabase подключен');

                // Проверяем авторизацию
                const { data: { user }, error: authError } = await currentState.supabase.auth.getUser();
                if (authError || !user) {
                    window.location.href = '/login.html';
                    return;
                }
                currentState.user = user;
                console.log('✅ Пользователь авторизован:', user.email);

                // Получаем ID задания из URL
                const urlParams = new URLSearchParams(window.location.search);
                const assignmentId = urlParams.get('id');
                
                if (!assignmentId) {
                    showError('ID задания не указан в URL');
                    return;
                }

                console.log('📝 Загружаем задание ID:', assignmentId);

                // Загружаем задание
                const { data: assignment, error: assignmentError } = await currentState.supabase
                    .from('assignments')
                    .select('*')
                    .eq('id', assignmentId)
                    .single();

                if (assignmentError) {
                    throw new Error('Не удалось загрузить задание: ' + assignmentError.message);
                }

                if (!assignment) {
                    throw new Error('Задание не найдено');
                }

                currentState.assignment = assignment;
                currentState.questions = assignment.content?.questions || [];
                console.log('✅ Задание загружено:', assignment.title, 'Вопросов:', currentState.questions.length);

                if (currentState.questions.length === 0) {
                    throw new Error('В задании нет вопросов');
                }

                // Загружаем прогресс пользователя
                const { data: progress } = await currentState.supabase
                    .from('user_progress')
                    .select('*')
                    .eq('user_id', currentState.user.id)
                    .eq('assignment_id', assignmentId)
                    .maybeSingle();

                if (progress) {
                    currentState.previousProgress = progress;
                    currentState.hasCompleted = progress.is_completed || false;
                    console.log('✅ Прогресс загружен, предыдущий результат:', currentState.previousProgress.score + '%');
                    
                    // Показываем выбор: начать заново или просмотреть предыдущие ответы
                    showRestartChoice();
                } else {
                    // Нет предыдущего прогресса - сразу показываем задание
                    currentState.isViewMode = false;
                    currentState.userAnswers = {};
                    currentState.hasCompleted = false;
                    showAssignment();
                }

            } catch (error) {
                console.error('❌ Критическая ошибка:', error);
                showError(error.message);
            }
        }

        // Функция показа выбора режима (начать заново или просмотреть)
        function showRestartChoice() {
            hideAllScreens();
            document.getElementById('assignmentContent').style.display = 'block';
            document.getElementById('restartContainer').style.display = 'block';

            // Обновляем кнопку смены режима
            updateModeSwitchButton();

            // Устанавливаем заголовок
            document.getElementById('assignmentTitle').textContent = currentState.assignment.title;
            document.getElementById('totalQuestions').textContent = currentState.questions.length;

            // Очищаем предыдущие обработчики
            const startFreshBtn = document.getElementById('startFreshBtn');
            const viewPreviousBtn = document.getElementById('viewPreviousBtn');
            
            startFreshBtn.replaceWith(startFreshBtn.cloneNode(true));
            viewPreviousBtn.replaceWith(viewPreviousBtn.cloneNode(true));

            // Кнопка "Начать заново"
            document.getElementById('startFreshBtn').addEventListener('click', () => {
                // Начинаем с чистыми ответами
                currentState.isViewMode = false;
                currentState.userAnswers = {};
                currentState.hasCompleted = false;
                showAssignment();
            });

            // Кнопка "Просмотреть прошлые ответы"
            document.getElementById('viewPreviousBtn').addEventListener('click', () => {
                // Показываем с предыдущими ответами
                currentState.isViewMode = true;
                currentState.userAnswers = JSON.parse(JSON.stringify(currentState.previousProgress.answers || {}));
                currentState.hasCompleted = false;
                showAssignment();
            });
        }

        // Функция показа задания
        function showAssignment() {
            hideAllScreens();
            document.getElementById('assignmentContent').style.display = 'block';
            document.getElementById('questionsCard').style.display = 'block';
            
            // Обновляем кнопку смены режима
            updateModeSwitchButton();

            // Устанавливаем заголовок
            document.getElementById('assignmentTitle').textContent = currentState.assignment.title;
            document.getElementById('totalQuestions').textContent = currentState.questions.length;

            // Показываем/скрываем уведомление о режиме просмотра
            if (currentState.isViewMode) {
                document.getElementById('viewModeNotice').style.display = 'block';
            } else {
                document.getElementById('viewModeNotice').style.display = 'none';
            }

            // Показываем предыдущий результат, если есть и мы в режиме нового прохождения
            if (currentState.previousProgress && !currentState.isViewMode && !currentState.hasCompleted) {
                const previousResult = document.createElement('div');
                previousResult.className = 'previous-result';
                previousResult.innerHTML = `
                    <strong>📊 Предыдущий результат:</strong> ${currentState.previousProgress.score}%
                    <br><small>Новое прохождение обновит этот результат</small>
                `;
                document.getElementById('questionsCard').insertBefore(
                    previousResult, 
                    document.querySelector('.question-counter')
                );
            }

            // Показываем первый вопрос
            showQuestion(0);
        }

        // Функция показа вопроса
        function showQuestion(index) {
            if (index < 0 || index >= currentState.questions.length) return;
            currentState.currentQuestionIndex = index;
            
            const question = currentState.questions[index];
            const container = document.getElementById('questionsContainer');
            
            // Очищаем контейнер
            container.innerHTML = '';
            
            // Создаем карточку вопроса
            const questionCard = document.createElement('div');
            questionCard.className = 'question-card';
            
            // Заголовок вопроса с сохранением переносов строк
            questionCard.innerHTML = `
                <div class="question-number">Вопрос ${index + 1} из ${currentState.questions.length}</div>
                <div class="question-text">${question.q || 'Вопрос без текста'}</div>
            `;
            
            // Изображение вопроса
            if (question.image) {
                const img = document.createElement('img');
                img.src = question.image;
                img.alt = 'Изображение вопроса';
                img.className = 'question-image';
                img.onerror = () => img.style.display = 'none';
                // Добавляем обработчик для открытия в модальном окне
                img.addEventListener('click', () => openImageModal(question.image));
                questionCard.appendChild(img);
            }
            
            // Обработка разных типов вопросов
            if (question.type === 'test' && question.options) {
                renderTestQuestion(question, index, questionCard);
            } else if (question.type === 'fill') {
                renderFillQuestion(question, index, questionCard);
            } else if (question.type === 'sentence') {
                renderSentenceQuestion(question, index, questionCard);
            } else if (question.type === 'crossword') {
                renderCrosswordQuestion(question, index, questionCard);
            } else {
                // Если тип не указан, показываем как текстовый вопрос
                renderFillQuestion(question, index, questionCard);
            }
            
            container.appendChild(questionCard);
            
            // Обновляем навигацию
            updateNavigation();
        }

        // Функция обновления навигации
        function updateNavigation() {
            const index = currentState.currentQuestionIndex;
            
            document.getElementById('currentQuestion').textContent = index + 1;
            document.getElementById('prevBtn').style.display = index > 0 ? 'block' : 'none';
            
            if (currentState.isViewMode) {
                // В режиме просмотра показываем только навигацию
                document.getElementById('nextBtn').style.display = index < currentState.questions.length - 1 ? 'block' : 'none';
                document.getElementById('finishBtn').style.display = 'none';
            } else {
                // В режиме выполнения показываем обычную навигации
                document.getElementById('nextBtn').style.display = index < currentState.questions.length - 1 ? 'block' : 'none';
                document.getElementById('finishBtn').style.display = index === currentState.questions.length - 1 ? 'block' : 'none';
            }
        }

        // Рендерим тестовый вопрос
        function renderTestQuestion(question, index, container) {
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'options-container';
            
            question.options.forEach((option, optionIndex) => {
                const label = document.createElement('label');
                label.className = `option-label ${currentState.userAnswers[index] === optionIndex ? 'selected' : ''}`;
                
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = `question-${index}`;
                radio.value = optionIndex;
                radio.className = 'option-radio';
                radio.checked = currentState.userAnswers[index] === optionIndex;
                radio.disabled = currentState.isViewMode;
                
                if (!currentState.isViewMode) {
                    radio.addEventListener('change', async () => {
                        currentState.userAnswers[index] = optionIndex;
                        document.querySelectorAll('.option-label').forEach(l => l.classList.remove('selected'));
                        label.classList.add('selected');
                        await saveProgress(false);
                    });
                }
                
                label.appendChild(radio);
                label.appendChild(document.createTextNode(option));
                optionsContainer.appendChild(label);
            });
            
            container.appendChild(optionsContainer);
        }

        // Рендерим вопрос с заполнением
        function renderFillQuestion(question, index, container) {
            const inputsContainer = document.createElement('div');
            inputsContainer.className = 'fill-inputs-container';
            
            // Получаем ответы пользователя для этого вопроса
            let userAnswerArray = currentState.userAnswers[index];
            if (!userAnswerArray || !Array.isArray(userAnswerArray)) {
                userAnswerArray = [];
                currentState.userAnswers[index] = userAnswerArray;
            }
            
            // Получаем правильные ответы из вопроса
            const correctAnswers = question.answers || [];
            
            // Создаем поля ввода для каждого ответа
            correctAnswers.forEach((answerGroup, answerIndex) => {
                const inputItem = document.createElement('div');
                inputItem.className = 'fill-input-item';
                
                const numberDiv = document.createElement('div');
                numberDiv.className = 'fill-input-number';
                numberDiv.textContent = answerIndex + 1;
                
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = `Введите ответ ${answerIndex + 1}...`;
                input.value = userAnswerArray[answerIndex] || '';
                input.disabled = currentState.isViewMode;
                
                if (!currentState.isViewMode) {
                    input.addEventListener('input', async () => {
                        userAnswerArray[answerIndex] = input.value;
                        await saveProgress(false);
                    });
                }
                
                inputItem.appendChild(numberDiv);
                inputItem.appendChild(input);
                inputsContainer.appendChild(inputItem);
            });
            
            // Добавляем счетчик ответов
            const countDiv = document.createElement('div');
            countDiv.className = 'fill-input-count';
            countDiv.textContent = `Количество ответов: ${correctAnswers.length}`;
            
            container.appendChild(inputsContainer);
            container.appendChild(countDiv);
        }

        // Рендерим вопрос с предложением с сохранением переносов строк
        function renderSentenceQuestion(question, index, container) {
            const sentenceContainer = document.createElement('div');
            sentenceContainer.className = 'sentence-container';
            
            // Создаем предпросмотр предложения с сохранением переносов
            const sentencePreview = document.createElement('div');
            sentencePreview.className = 'sentence-text';
            
            if (!question.sentence) {
                sentencePreview.textContent = 'Предложение не указано';
                sentenceContainer.appendChild(sentencePreview);
                container.appendChild(sentenceContainer);
                return;
            }
            
            // Разбиваем предложение на части по пропускам с сохранением переносов
            const parts = question.sentence.split('___');
            sentencePreview.innerHTML = '';
            
            parts.forEach((part, partIndex) => {
                // Добавляем текст (сохраняем переносы строк)
                if (part) {
                    const textSpan = document.createElement('span');
                    textSpan.style.whiteSpace = 'pre-line';
                    textSpan.textContent = part;
                    sentencePreview.appendChild(textSpan);
                }
                
                // Добавляем инпут для пропуска (кроме последней части)
                if (partIndex < parts.length - 1) {
                    const gapContainer = document.createElement('span');
                    gapContainer.className = 'sentence-gap';
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'sentence-input';
                    input.placeholder = `Ответ ${partIndex + 1}`;
                    input.disabled = currentState.isViewMode;
                    
                    // Восстанавливаем сохраненный ответ
                    if (!Array.isArray(currentState.userAnswers[index])) {
                        currentState.userAnswers[index] = [];
                    }
                    if (currentState.userAnswers[index][partIndex] !== undefined) {
                        input.value = currentState.userAnswers[index][partIndex];
                    }
                    
                    if (!currentState.isViewMode) {
                        input.addEventListener('input', async () => {
                            if (!Array.isArray(currentState.userAnswers[index])) {
                                currentState.userAnswers[index] = [];
                            }
                            currentState.userAnswers[index][partIndex] = input.value;
                            await saveProgress(false);
                        });
                    }
                    
                    gapContainer.appendChild(input);
                    sentencePreview.appendChild(gapContainer);
                }
            });
            
            sentenceContainer.appendChild(sentencePreview);
            container.appendChild(sentenceContainer);
        }

        // Рендерим вопрос с кроссвордом
        function renderCrosswordQuestion(question, index, container) {
            const crosswordContainer = document.createElement('div');
            crosswordContainer.className = 'crossword-container';
            
            // Инструкции для кроссворда
            const instructions = document.createElement('div');
            instructions.className = 'crossword-instructions';
            instructions.innerHTML = `
                <h4>🧩 Инструкция по решению кроссворда</h4>
                <ul>
                    <li>Заполните все белые клетки буквами</li>
                    <li>Черные клетки заблокированы и не заполняются</li>
                    <li>Используйте стрелки для навигации между клетками</li>
                    <li>Tab/Shift+Tab для перехода между клетками</li>
                    <li>Каждое слово считается отдельным вопросом</li>
                    <li>Номера слов отображаются в углах клеток</li>
                </ul>
            `;
            crosswordContainer.appendChild(instructions);

            // Изображение кроссворда, если есть
            if (question.image) {
                const img = document.createElement('img');
                img.src = question.image;
                img.alt = 'Изображение кроссворда';
                img.className = 'crossword-image';
                img.onerror = () => img.style.display = 'none';
                // Добавляем обработчик для открытия в модальном окне
                img.addEventListener('click', () => openImageModal(question.image));
                crosswordContainer.appendChild(img);
            }

            // Список подсказок для кроссворда (только номера и количество букв)
            if (question.words && question.words.length > 0) {
                const wordsContainer = document.createElement('div');
                wordsContainer.className = 'crossword-words';
                
                const wordsColumns = document.createElement('div');
                wordsColumns.className = 'words-columns';
                
                // Разделяем слова по направлениям
                const acrossWords = question.words.filter(word => word.direction === 'across');
                const downWords = question.words.filter(word => word.direction === 'down');
                
                if (acrossWords.length > 0) {
                    const acrossColumn = document.createElement('div');
                    acrossColumn.className = 'words-column';
                    acrossColumn.innerHTML = '<h5>→ По горизонтали:</h5>';
                    
                    acrossWords.forEach(word => {
                        const wordItem = document.createElement('div');
                        wordItem.className = 'word-item';
                        wordItem.innerHTML = `
                            <div class="word-number">${word.number}</div>
                            <div class="word-text">букв: ${word.length}</div>
                        `;
                        acrossColumn.appendChild(wordItem);
                    });
                    
                    wordsColumns.appendChild(acrossColumn);
                }
                
                if (downWords.length > 0) {
                    const downColumn = document.createElement('div');
                    downColumn.className = 'words-column';
                    downColumn.innerHTML = '<h5>↓ По вертикали:</h5>';
                    
                    downWords.forEach(word => {
                        const wordItem = document.createElement('div');
                        wordItem.className = 'word-item';
                        wordItem.innerHTML = `
                            <div class="word-number">${word.number}</div>
                            <div class="word-text">букв: ${word.length}</div>
                        `;
                        downColumn.appendChild(wordItem);
                    });
                    
                    wordsColumns.appendChild(downColumn);
                }
                
                wordsContainer.innerHTML = '<h4>Подсказки:</h4>';
                wordsContainer.appendChild(wordsColumns);
                crosswordContainer.appendChild(wordsContainer);
            }

            // Создаем сетку кроссворда
            const gridWrapper = document.createElement('div');
            gridWrapper.className = 'crossword-grid-wrapper';
            
            const gridContainer = document.createElement('div');
            gridContainer.className = 'crossword-grid';
            
            const grid = question.grid || [];
            const blocks = question.blocks || [];
            const words = question.words || [];
            const rows = question.metadata?.rows || grid.length;
            const cols = question.metadata?.cols || (grid[0] ? grid[0].length : 0);
            
            // Определяем размер клеток в зависимости от размера кроссворда
            let cellSizeClass = 'size-small';
            if (rows > 15 || cols > 15) {
                cellSizeClass = 'size-large';
            } else if (rows > 12 || cols > 12) {
                cellSizeClass = 'size-medium';
            } else if (rows > 8 || cols > 8) {
                cellSizeClass = 'size-normal';
            }
            
            // Инициализируем userAnswers для кроссворда, если нужно
            if (!currentState.userAnswers[index] || !Array.isArray(currentState.userAnswers[index])) {
                currentState.userAnswers[index] = Array(rows).fill().map(() => Array(cols).fill(''));
            }

            // Создаем массив для хранения ссылок на инпуты для быстрого доступа
            const inputRefs = Array(rows).fill().map(() => Array(cols).fill(null));

            // Определяем, какие клетки должны быть активными (входят в слова)
            const activeCells = new Set();
            words.forEach(word => {
                for (let i = 0; i < word.length; i++) {
                    const row = word.direction === 'across' ? word.start.row : word.start.row + i;
                    const col = word.direction === 'across' ? word.start.col + i : word.start.col;
                    activeCells.add(`${row},${col}`);
                }
            });

            // Создаем объект для хранения номеров слов в клетках
            const cellNumbers = {};
            words.forEach(word => {
                const key = `${word.start.row}-${word.start.col}`;
                if (!cellNumbers[key]) {
                    cellNumbers[key] = [];
                }
                cellNumbers[key].push({ number: word.number, direction: word.direction });
            });

            for (let i = 0; i < rows; i++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'crossword-row';
                
                for (let j = 0; j < cols; j++) {
                    const cell = document.createElement('div');
                    cell.className = `crossword-cell ${cellSizeClass}`;
                    
                    // Проверяем, должна ли клетка быть заблокирована
                    const isExplicitlyBlocked = blocks.some(block => block.row === i && block.col === j);
                    const isInActiveCell = activeCells.has(`${i},${j}`);
                    const isEmptyCell = !grid[i] || !grid[i][j];
                    
                    // Клетка блокируется если:
                    // 1. Она явно заблокирована администратором ИЛИ
                    // 2. Она не входит в активные клетки (слова) И она пустая
                    const isBlocked = isExplicitlyBlocked || (!isInActiveCell && isEmptyCell);
                    
                    if (isBlocked) {
                        cell.classList.add('blocked');
                    } else {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.maxLength = 1;
                        input.value = currentState.userAnswers[index][i][j] || '';
                        input.placeholder = '';
                        input.disabled = currentState.isViewMode;
                        
                        // Сохраняем ссылку на инпут
                        inputRefs[i][j] = input;
                        
                        if (!currentState.isViewMode) {
                            input.addEventListener('input', async (e) => {
                                // Сохраняем введенную букву
                                if (!currentState.userAnswers[index][i]) currentState.userAnswers[index][i] = [];
                                currentState.userAnswers[index][i][j] = e.target.value.toUpperCase();
                                
                                // Автопереход к следующей клетке
                                if (e.target.value && j < cols - 1) {
                                    const nextCell = inputRefs[i][j + 1];
                                    if (nextCell && !nextCell.parentElement.classList.contains('blocked')) {
                                        nextCell.focus();
                                    }
                                }
                                
                                await saveProgress(false);
                            });
                            
                            input.addEventListener('keydown', (e) => {
                                // Навигация стрелками и Tab
                                switch(e.key) {
                                    case 'ArrowLeft':
                                        e.preventDefault();
                                        if (j > 0) {
                                            const prevCell = inputRefs[i][j - 1];
                                            if (prevCell) prevCell.focus();
                                        }
                                        break;
                                    case 'ArrowRight':
                                        e.preventDefault();
                                        if (j < cols - 1) {
                                            const nextCell = inputRefs[i][j + 1];
                                            if (nextCell) nextCell.focus();
                                        }
                                        break;
                                    case 'ArrowUp':
                                        e.preventDefault();
                                        if (i > 0) {
                                            const upCell = inputRefs[i - 1][j];
                                            if (upCell) upCell.focus();
                                        }
                                        break;
                                    case 'ArrowDown':
                                        e.preventDefault();
                                        if (i < rows - 1) {
                                            const downCell = inputRefs[i + 1][j];
                                            if (downCell) downCell.focus();
                                        }
                                        break;
                                    case 'Tab':
                                        e.preventDefault();
                                        if (e.shiftKey) {
                                            // Shift+Tab - предыдущая клетка
                                            if (j > 0) {
                                                const prevCell = inputRefs[i][j - 1];
                                                if (prevCell) prevCell.focus();
                                            } else if (i > 0) {
                                                const prevCell = inputRefs[i - 1][cols - 1];
                                                if (prevCell) prevCell.focus();
                                            }
                                        } else {
                                            // Tab - следующая клетка
                                            if (j < cols - 1) {
                                                const nextCell = inputRefs[i][j + 1];
                                                if (nextCell) nextCell.focus();
                                            } else if (i < rows - 1) {
                                                const nextCell = inputRefs[i + 1][0];
                                                if (nextCell) nextCell.focus();
                                            }
                                        }
                                        break;
                                    case 'Backspace':
                                        if (!e.target.value && j > 0) {
                                            e.preventDefault();
                                            const prevCell = inputRefs[i][j - 1];
                                            if (prevCell) {
                                                prevCell.focus();
                                                prevCell.value = '';
                                                if (!currentState.userAnswers[index][i]) currentState.userAnswers[index][i] = [];
                                                currentState.userAnswers[index][i][j-1] = '';
                                                saveProgress(false);
                                            }
                                        }
                                        break;
                                }
                            });
                        }
                        
                        cell.appendChild(input);
                    }
                    
                    // Добавляем номера слов, если клетка является началом слова
                    const numbers = cellNumbers[`${i}-${j}`] || [];
                    numbers.forEach(num => {
                        const numberEl = document.createElement('div');
                        numberEl.className = `crossword-number crossword-number-${num.direction}`;
                        numberEl.textContent = num.number;
                        cell.appendChild(numberEl);
                    });
                    
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    rowDiv.appendChild(cell);
                }
                gridContainer.appendChild(rowDiv);
            }
            
            gridWrapper.appendChild(gridContainer);
            crosswordContainer.appendChild(gridWrapper);
            container.appendChild(crosswordContainer);
        }

        // Функция сохранения прогресса
        async function saveProgress(isCompleted = false) {
            try {
                const score = isCompleted ? calculateScore().score : 0;
                const progressData = {
                    user_id: currentState.user.id,
                    assignment_id: currentState.assignment.id,
                    answers: currentState.userAnswers,
                    is_completed: isCompleted,
                    completed_at: isCompleted ? new Date().toISOString() : null,
                    score: score
                };

                // Проверяем существующий прогресс
                const { data: existing } = await currentState.supabase
                    .from('user_progress')
                    .select('id')
                    .eq('user_id', currentState.user.id)
                    .eq('assignment_id', currentState.assignment.id)
                    .maybeSingle();

                let result;
                if (existing) {
                    result = await currentState.supabase
                        .from('user_progress')
                        .update(progressData)
                        .eq('id', existing.id);
                } else {
                    result = await currentState.supabase
                        .from('user_progress')
                        .insert(progressData);
                }

                if (result.error) {
                    console.error('Ошибка сохранения прогресса:', result.error);
                    throw new Error('Не удалось сохранить прогресс');
                }

                console.log('✅ Прогресс сохранен');
                return true;
            } catch (error) {
                console.error('❌ Ошибка сохранения:', error);
                return false;
            }
        }

        // Функция проверки, что все вопросы заполнены
        function validateAllQuestionsAnswered() {
            for (let i = 0; i < currentState.questions.length; i++) {
                const question = currentState.questions[i];
                const userAnswer = currentState.userAnswers[i];
                
                let hasAnswer = false;
                
                if (question.type === 'test') {
                    // Для теста - выбран любой вариант
                    hasAnswer = userAnswer !== undefined && userAnswer !== null && userAnswer !== '';
                } 
                else if (question.type === 'fill') {
                    // Для ввода текста - все поля заполнены
                    if (Array.isArray(userAnswer)) {
                        const correctAnswersCount = question.answers?.length || 0;
                        hasAnswer = userAnswer.length >= correctAnswersCount && 
                                   userAnswer.every(answer => 
                                       answer !== undefined && answer !== null && answer !== '' && answer.trim() !== ''
                                   );
                    } else {
                        hasAnswer = false;
                    }
                }
                else if (question.type === 'sentence') {
                    // Для предложения - все пропуски заполнены
                    if (Array.isArray(userAnswer)) {
                        const gapsCount = (question.sentence?.match(/___/g) || []).length;
                        hasAnswer = userAnswer.length >= gapsCount && 
                                   userAnswer.every(answer => 
                                       answer !== undefined && answer !== null && answer !== '' && answer.trim() !== ''
                                   );
                    } else {
                        hasAnswer = false;
                    }
                }
                else if (question.type === 'crossword') {
                    // Для кроссворда - проверяем, что все активные клетки заполнены
                    if (userAnswer && typeof userAnswer === 'object') {
                        const activeCells = new Set();
                        question.words.forEach(word => {
                            for (let k = 0; k < word.length; k++) {
                                const row = word.direction === 'across' ? word.start.row : word.start.row + k;
                                const col = word.direction === 'across' ? word.start.col + k : word.start.col;
                                activeCells.add(`${row},${col}`);
                            }
                        });
                        
                        let allFilled = true;
                        activeCells.forEach(cellKey => {
                            const [row, col] = cellKey.split(',').map(Number);
                            const cellAnswer = userAnswer[row] && userAnswer[row][col];
                            if (!cellAnswer || cellAnswer.trim() === '') {
                                allFilled = false;
                            }
                        });
                        
                        hasAnswer = allFilled;
                    } else {
                        hasAnswer = false;
                    }
                }
                
                if (!hasAnswer) {
                    return {
                        allAnswered: false,
                        firstUnanswered: i
                    };
                }
            }
            
            return {
                allAnswered: true,
                firstUnanswered: -1
            };
        }

        // Функция расчета оценки с поддержкой множественных ответов и нормализацией апострофов
        function calculateScore() {
            let correctAnswers = 0;
            let incorrectAnswers = 0;
            let skippedAnswers = 0;
            const questionResults = [];
            
            currentState.questions.forEach((question, index) => {
                const userAnswer = currentState.userAnswers[index];
                const result = {
                    question: question.q,
                    type: question.type,
                    userAnswer: userAnswer,
                    correctAnswer: null,
                    isCorrect: false,
                    isSkipped: false
                };
                
                // Проверяем, есть ли ответ
                let hasAnswer = false;
                
                if (question.type === 'crossword') {
                    // Для кроссворда считаем слова, а не клетки
                    let correctWords = 0;
                    const wordResults = [];
                    
                    question.words.forEach(word => {
                        let isWordCorrect = true;
                        
                        // Проверяем каждую клетку слова
                        for (let k = 0; k < word.length; k++) {
                            const row = word.direction === 'across' ? word.start.row : word.start.row + k;
                            const col = word.direction === 'across' ? word.start.col + k : word.start.col;

                            const userLetter = (userAnswer[row] && userAnswer[row][col]) ? userAnswer[row][col].toUpperCase().trim() : '';
                            const correctLetter = (question.grid[row] && question.grid[row][col]) ? question.grid[row][col].toUpperCase().trim() : '';

                            if (userLetter !== correctLetter) {
                                isWordCorrect = false;
                                break;
                            }
                        }
                        
                        if (isWordCorrect) {
                            correctWords++;
                        }
                        
                        wordResults.push({
                            word: word,
                            isCorrect: isWordCorrect
                        });
                    });
                    
                    // Считаем, что ответ есть, если заполнена хотя бы одна активная клетка
                    const hasAnyAnswer = Object.keys(userAnswer).some(row => 
                        Array.isArray(userAnswer[row]) && userAnswer[row].some(cell => cell && cell.trim() !== '')
                    );
                    
                    hasAnswer = hasAnyAnswer;
                    
                    result.crosswordStats = {
                        correctWords: correctWords,
                        totalWords: question.words.length,
                        wordResults: wordResults
                    };
                    
                    // Для кроссворда правильные ответы = количество правильных слов
                    // Неправильные ответы = количество неправильных слов
                    if (hasAnswer) {
                        correctAnswers += correctWords;
                        incorrectAnswers += (question.words.length - correctWords);
                        result.isCorrect = correctWords === question.words.length;
                    } else {
                        skippedAnswers += question.words.length;
                        result.isSkipped = true;
                    }
                    
                } else {
                    // Проверка заполнения для разных типов вопросов
                    if (question.type === 'test') {
                        hasAnswer = userAnswer !== undefined && userAnswer !== null && userAnswer !== '';
                    } 
                    else if (question.type === 'fill') {
                        // Для ввода текста - проверяем, что все поля заполнены
                        if (Array.isArray(userAnswer)) {
                            const correctAnswersCount = question.answers?.length || 0;
                            hasAnswer = userAnswer.length >= correctAnswersCount && 
                                       userAnswer.every(answer => 
                                           answer !== undefined && answer !== null && answer !== '' && answer.trim() !== ''
                                       );
                        } else {
                            hasAnswer = false;
                        }
                    }
                    else if (question.type === 'sentence') {
                        // Для предложения - проверяем, что все пропуски заполнены
                        if (Array.isArray(userAnswer)) {
                            const gapsCount = (question.sentence?.match(/___/g) || []).length;
                            hasAnswer = userAnswer.length >= gapsCount && 
                                       userAnswer.every(answer => 
                                           answer !== undefined && answer !== null && answer !== '' && answer.trim() !== ''
                                       );
                        } else {
                            hasAnswer = false;
                        }
                    }
                
                    if (!hasAnswer) {
                        skippedAnswers++;
                        result.isSkipped = true;
                        questionResults.push(result);
                        return;
                    }
                    
                    let isCorrect = false;
                    
                    if (question.type === 'test') {
                        // Для тестовых вопросов сравниваем номер правильного ответа
                        result.correctAnswer = question.correct;
                        result.correctOptions = question.options;
                        isCorrect = parseInt(userAnswer) === question.correct;
                    } 
                    else if (question.type === 'fill') {
                        // Для вписывания ответа - проверяем каждый ответ отдельно с нормализацией
                        result.correctAnswer = question.answers;
                        if (Array.isArray(userAnswer) && Array.isArray(question.answers)) {
                            // Проверяем, что все ответы совпадают и количество ответов правильное
                            if (userAnswer.length === question.answers.length) {
                                isCorrect = userAnswer.every((answer, answerIndex) => {
                                    if (!answer || !question.answers[answerIndex]) return false;
                                    
                                    // ИСПРАВЛЕНИЕ: Используем нормализацию для сравнения
                                    const userAnswerNormalized = normalizeText(String(answer));
                                    const correctVariants = question.answers[answerIndex].map(a => normalizeText(String(a)));
                                    
                                    return correctVariants.some(correctVariant => 
                                        userAnswerNormalized === correctVariant
                                    );
                                });
                            }
                        }
                    } 
                    else if (question.type === 'sentence') {
                        // Для предложений - проверяем каждый пропуск на соответствие ЛЮБОМУ из вариантов с нормализацией
                        result.correctAnswer = question.answers;
                        if (Array.isArray(userAnswer) && Array.isArray(question.answers)) {
                            // Проверяем, что все ответы совпадают и количество ответов правильное
                            if (userAnswer.length === question.answers.length) {
                                isCorrect = userAnswer.every((answer, gapIndex) => {
                                    if (!answer || !question.answers[gapIndex]) return false;
                                    
                                    // ИСПРАВЛЕНИЕ: Используем нормализацию для сравнения
                                    const userGapAnswer = normalizeText(String(answer));
                                    let correctGapVariants = [];
                                    
                                    // Поддержка старого и нового форматов
                                    if (Array.isArray(question.answers[gapIndex])) {
                                        // Новый формат: массив вариантов для пропуска
                                        correctGapVariants = question.answers[gapIndex].map(a => normalizeText(String(a)));
                                    } else {
                                        // Старый формат: один вариант для пропуска
                                        correctGapVariants = [normalizeText(String(question.answers[gapIndex]))];
                                    }
                                    
                                    return correctGapVariants.some(correctVariant => 
                                        userGapAnswer === correctVariant
                                    );
                                });
                            }
                        }
                    }
                    
                    result.isCorrect = isCorrect;
                    
                    if (isCorrect) {
                        correctAnswers++;
                    } else {
                        incorrectAnswers++;
                    }
                }
                
                questionResults.push(result);
            });
            
            const totalAnswered = correctAnswers + incorrectAnswers + skippedAnswers;
            const score = totalAnswered > 0 ? Math.round((correctAnswers / totalAnswered) * 100) : 0;
            
            return {
                score: score,
                correctAnswers: correctAnswers,
                incorrectAnswers: incorrectAnswers,
                skippedAnswers: skippedAnswers,
                totalQuestions: currentState.questions.length,
                questionResults: questionResults
            };
        }

        // Функция завершения задания с проверкой заполнения
        async function finishAssignment() {
            try {
                // Проверяем, что все вопросы заполнены
                const validation = validateAllQuestionsAnswered();
                if (!validation.allAnswered) {
                    showTempError(`❌ Не все вопросы заполнены! Пожалуйста, ответьте на вопрос ${validation.firstUnanswered + 1}`);
                    showQuestion(validation.firstUnanswered); // Переходим к незаполненному вопросу
                    return;
                }

                const scoreResult = calculateScore();
                const success = await saveProgress(true);
                
                if (!success) {
                    throw new Error('Не удалось сохранить результат');
                }

                // Обновляем состояние
                currentState.hasCompleted = true;
                currentState.previousProgress = {
                    ...currentState.previousProgress,
                    answers: currentState.userAnswers,
                    score: scoreResult.score,
                    is_completed: true
                };

                // Показываем экран завершения с деталями
                showCompletionScreen(scoreResult);

            } catch (error) {
                console.error('❌ Ошибка завершения:', error);
                alert('Ошибка при сохранении результата: ' + error.message);
            }
        }

        // Функция показа экрана завершения
        function showCompletionScreen(scoreResult) {
            hideAllScreens();
            document.getElementById('completionScreen').style.display = 'block';
            
            // Скрываем кнопку смены режима после завершения
            document.getElementById('modeSwitchBtn').style.display = 'none';
            
            // Устанавливаем результаты
            document.getElementById('finalScore').textContent = `${scoreResult.score}%`;
            document.getElementById('totalQuestionsResult').textContent = scoreResult.correctAnswers + scoreResult.incorrectAnswers + scoreResult.skippedAnswers;
            document.getElementById('correctAnswersResult').textContent = scoreResult.correctAnswers;
            document.getElementById('incorrectAnswersResult').textContent = scoreResult.incorrectAnswers;
            document.getElementById('skippedQuestionsResult').textContent = scoreResult.skippedAnswers;
            
            // Устанавливаем сообщение в зависимости от результата
            if (scoreResult.score >= 90) {
                document.getElementById('completionMessage').textContent = 'Отличный результат! Вы прекрасно справились с заданием!';
            } else if (scoreResult.score >= 70) {
                document.getElementById('completionMessage').textContent = 'Хороший результат! Вы хорошо усвоили материал.';
            } else if (scoreResult.score >= 50) {
                document.getElementById('completionMessage').textContent = 'Неплохой результат! Есть над чем поработать.';
            } else {
                document.getElementById('completionMessage').textContent = 'Попробуйте пройти задание еще раз для лучшего результата.';
            }
            
            // Показываем разбор ответов, если есть неправильные или пропущенные вопросы
            if (scoreResult.incorrectAnswers > 0 || scoreResult.skippedAnswers > 0) {
                showQuestionsReview(scoreResult.questionResults);
            }
        }

        // Функция показа разбора ответов с сохранением переносов строк
        function showQuestionsReview(questionResults) {
            const reviewContainer = document.getElementById('reviewContainer');
            const questionsReview = document.getElementById('questionsReview');
            
            reviewContainer.innerHTML = '';
            questionsReview.style.display = 'block';
            
            questionResults.forEach((result, index) => {
                const reviewItem = document.createElement('div');
                
                let statusClass = '';
                let statusText = '';
                let statusColor = '';
                
                if (result.isSkipped) {
                    statusClass = 'skipped';
                    statusText = 'Пропущен';
                    statusColor = 'status-skipped';
                } else if (result.isCorrect) {
                    statusClass = 'correct';
                    statusText = 'Правильно';
                    statusColor = 'status-correct';
                } else {
                    statusClass = 'incorrect';
                    statusText = 'Неправильно';
                    statusColor = 'status-incorrect';
                }
                
                reviewItem.className = `question-review ${statusClass}`;
                
                let answerDetails = '';
                
                if (result.type === 'test') {
                    const userOption = result.userAnswer !== undefined ? result.correctOptions[result.userAnswer] : 'Не отвечено';
                    const correctOption = result.correctOptions[result.correctAnswer];
                    
                    answerDetails = `
                        <div class="review-answer"><strong>Ваш ответ:</strong> ${userOption}</div>
                        <div class="review-answer review-correct"><strong>Правильный ответ:</strong> ${correctOption}</div>
                    `;
                } else if (result.type === 'fill') {
                    // Для ввода текста показываем все ответы
                    let userAnswerText = 'Не отвечено';
                    if (Array.isArray(result.userAnswer)) {
                        userAnswerText = result.userAnswer.map((ans, i) => 
                            ans ? `[${i+1}: ${ans}]` : `[${i+1}: не отвечено]`
                        ).join(' ');
                    }
                    
                    let correctAnswerText = '';
                    if (Array.isArray(result.correctAnswer)) {
                        correctAnswerText = result.correctAnswer.map((ans, i) => {
                            if (Array.isArray(ans)) {
                                return `[${i+1}: ${ans.join(' или ')}]`;
                            } else {
                                return `[${i+1}: ${ans}]`;
                            }
                        }).join(' ');
                    }
                    
                    answerDetails = `
                        <div class="review-answer"><strong>Ваши ответы:</strong> ${userAnswerText}</div>
                        <div class="review-answer review-correct"><strong>Правильные ответы:</strong> ${correctAnswerText}</div>
                    `;
                } else if (result.type === 'sentence') {
                    let userAnswerText = 'Не отвечено';
                    if (Array.isArray(result.userAnswer)) {
                        userAnswerText = result.userAnswer.map((ans, i) => 
                            ans ? `[${i+1}: ${ans}]` : `[${i+1}: не отвечено]`
                        ).join(' ');
                    }
                    
                    let correctAnswerText = '';
                    if (Array.isArray(result.correctAnswer)) {
                        correctAnswerText = result.correctAnswer.map((ans, i) => {
                            if (Array.isArray(ans)) {
                                return `[${i+1}: ${ans.join(' или ')}]`;
                            } else {
                                return `[${i+1}: ${ans}]`;
                            }
                        }).join(' ');
                    }
                    
                    answerDetails = `
                        <div class="review-answer"><strong>Ваши ответы:</strong> ${userAnswerText}</div>
                        <div class="review-answer review-correct"><strong>Правильные ответы:</strong> ${correctAnswerText}</div>
                    `;
                } else if (result.type === 'crossword') {
                    const stats = result.crosswordStats || { correctWords: 0, totalWords: 0, wordResults: [] };
                    
                    // Группируем слова по направлениям
                    const acrossWords = stats.wordResults.filter(wr => wr.word.direction === 'across');
                    const downWords = stats.wordResults.filter(wr => wr.word.direction === 'down');
                    
                    answerDetails = `
                        <div class="crossword-review">
                            <h4>Разбор кроссворда</h4>
                            <p>Правильно угадано слов: ${stats.correctWords} из ${stats.totalWords}</p>
                            <div class="crossword-words-review">
                    `;
                    
                    if (acrossWords.length > 0) {
                        answerDetails += `<h5>По горизонтали:</h5><ul>`;
                        acrossWords.forEach(wr => {
                            answerDetails += `<li class="${wr.isCorrect ? 'correct-word' : 'incorrect-word'}">
                                <strong>${wr.word.number}.</strong> ${wr.word.text} ${wr.isCorrect ? '✅' : '❌'}
                                ${!wr.isCorrect ? `<br><small>Правильный ответ: ${wr.word.text}</small>` : ''}
                            </li>`;
                        });
                        answerDetails += `</ul>`;
                    }
                    
                    if (downWords.length > 0) {
                        answerDetails += `<h5>По вертикали:</h5><ul>`;
                        downWords.forEach(wr => {
                            answerDetails += `<li class="${wr.isCorrect ? 'correct-word' : 'incorrect-word'}">
                                <strong>${wr.word.number}.</strong> ${wr.word.text} ${wr.isCorrect ? '✅' : '❌'}
                                ${!wr.isCorrect ? `<br><small>Правильный ответ: ${wr.word.text}</small>` : ''}
                            </li>`;
                        });
                        answerDetails += `</ul>`;
                    }
                    
                    answerDetails += `</div></div>`;
                }
                
                reviewItem.innerHTML = `
                    <div class="review-question">Вопрос ${index + 1}: ${result.question}</div>
                    ${answerDetails}
                    <div class="review-status ${statusColor}">${statusText}</div>
                `;
                
                reviewContainer.appendChild(reviewItem);
            });
        }

        // Настройка обработчиков навигации
        function setupNavigation() {
            document.getElementById('prevBtn').addEventListener('click', () => {
                if (currentState.currentQuestionIndex > 0) {
                    showQuestion(currentState.currentQuestionIndex - 1);
                }
            });

            document.getElementById('nextBtn').addEventListener('click', () => {
                if (currentState.currentQuestionIndex < currentState.questions.length - 1) {
                    showQuestion(currentState.currentQuestionIndex + 1);
                }
            });

            if (!currentState.isViewMode) {
                document.getElementById('finishBtn').addEventListener('click', finishAssignment);
            }
        }

        // Инициализация навигации
        setupNavigation();

        // Запускаем инициализацию
        initAssignment();
    </script>
</body>
</html>