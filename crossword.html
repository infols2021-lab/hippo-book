<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ö—Ä–æ—Å—Å–≤–æ—Ä–¥ ‚Äî Edu Keys</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .crossword-container {
      width: 95%;
      max-width: 1000px;
      margin: 20px auto;
    }
    
    .crossword-header {
      background: linear-gradient(135deg, #ff6b6b, #ffa726);
      color: white;
      padding: 30px;
      border-radius: 16px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .crossword-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .crossword-description {
      font-size: 1.1rem;
      opacity: 0.9;
      margin-bottom: 20px;
    }
    
    .progress-stats {
      display: flex;
      justify-content: center;
      gap: 30px;
      flex-wrap: wrap;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-number {
      font-size: 2rem;
      font-weight: 700;
    }
    
    .stat-label {
      font-size: 0.9rem;
      opacity: 0.8;
    }
    
    .assignments-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .assignment-item {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      cursor: pointer;
      border-left: 4px solid #f0f0f0;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .assignment-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .assignment-item.completed {
      border-left-color: var(--accent);
      background: #fff5f5;
    }
    
    .assignment-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: bold;
      background: #ffeaa7;
      color: #e17055;
    }
    
    .assignment-content {
      flex: 1;
    }
    
    .assignment-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 5px;
      color: #333;
    }
    
    .assignment-type {
      font-size: 12px;
      color: #666;
    }
    
    .assignment-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-completed {
      background: #e8f5e8;
      color: #2e7d32;
    }
    
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .back-button {
      margin-bottom: 20px;
    }

    .locked-message {
      background: #fff3cd;
      border: 2px solid #ffeaa7;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
    }

    .loading { 
      text-align: center; 
      padding: 40px; 
      display: none;
    }
    .spinner { 
      border: 4px solid #f3f3f3; 
      border-top: 4px solid var(--accent); 
      border-radius: 50%; 
      width: 40px; 
      height: 40px; 
      animation: spin 2s linear infinite; 
      margin: 0 auto 20px; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    .error { 
      background: #ffebee; 
      color: #c62828; 
      padding: 20px; 
      border-radius: 8px; 
      margin: 20px; 
      text-align: center; 
      display: none; 
    }

    @media (max-width: 768px) {
      .crossword-header {
        padding: 20px;
      }
      
      .crossword-title {
        font-size: 1.5rem;
      }
      
      .progress-stats {
        gap: 15px;
      }
      
      .stat-number {
        font-size: 1.5rem;
      }
      
      .assignment-item {
        padding: 15px;
      }
    }
  </style>
  
  <script src="/load-config.js"></script>
</head>
<body>
  <div class="crossword-container">
    <div class="back-button">
      <button class="btn secondary" onclick="location.href='/materials.html'">‚Üê –ù–∞–∑–∞–¥ –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º</button>
    </div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –∫—Ä–æ—Å—Å–≤–æ—Ä–¥...</p>
    </div>
    
    <div id="errorMessage" class="error"></div>

    <div id="crosswordContent" style="display: none;">
      <div id="lockedMessage" class="locked-message" style="display: none;">
        <h3>üîí –ö—Ä–æ—Å—Å–≤–æ—Ä–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</h3>
        <p>–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –∫—Ä–æ—Å—Å–≤–æ—Ä–¥—É –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.</p>
      </div>

      <div class="crossword-header" id="crosswordHeader" style="display: none;">
        <div class="crossword-title" id="crosswordTitle">–ù–∞–∑–≤–∞–Ω–∏–µ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞</div>
        <div class="crossword-description" id="crosswordDescription">–û–ø–∏—Å–∞–Ω–∏–µ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞</div>
        <div class="progress-stats">
          <div class="stat-item">
            <div class="stat-number" id="completedCount">0</div>
            <div class="stat-label">–†–∞–∑–≥–∞–¥–∞–Ω–æ</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="totalCount">0</div>
            <div class="stat-label">–í—Å–µ–≥–æ —Å–ª–æ–≤</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="progressPercent">0%</div>
            <div class="stat-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
          </div>
        </div>
      </div>

      <div class="card" id="assignmentsCard" style="display: none;">
        <h3>–°–ª–æ–≤–∞ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞</h3>
        <p class="small-muted">–†–∞–∑–≥–∞–¥—ã–≤–∞–π—Ç–µ —Å–ª–æ–≤–∞ –≤ –ª—é–±–æ–º –ø–æ—Ä—è–¥–∫–µ. –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
        
        <div class="assignments-list" id="assignmentsList"></div>
      </div>
    </div>
  </div>

  <script type="module">
    document.getElementById('loading').style.display = 'block';
    
    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorMessage').style.display = 'block';
      document.getElementById('loading').style.display = 'none';
    }
    
    function showContent() {
      document.getElementById('crosswordContent').style.display = 'block';
      document.getElementById('loading').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
    }
    
    async function initApp() {
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
        showError('‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Supabase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.');
        return false;
      }
      
      try {
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
        const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          window.location.href = '/login.html';
          return;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const crosswordId = urlParams.get('id');

        if (!crosswordId) {
          showError('‚ùå –ö—Ä–æ—Å—Å–≤–æ—Ä–¥ –Ω–µ —É–∫–∞–∑–∞–Ω');
          return;
        }

        let crossword = null;
        let assignments = [];
        let userProgress = [];
        let crosswordAccess = [];

        async function loadCrossword() {
          try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫—Ä–æ—Å—Å–≤–æ—Ä–¥
            const { data: crosswordData, error: crosswordError } = await supabase
              .from('crosswords')
              .select('*')
              .eq('id', crosswordId)
              .single();

            if (crosswordError) throw crosswordError;
            crossword = crosswordData;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
            const { data: accessData, error: accessError } = await supabase
              .from('crossword_access')
              .select('*')
              .eq('user_id', user.id)
              .eq('crossword_id', crosswordId)
              .single();

            crosswordAccess = accessData;

            // –ï—Å–ª–∏ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞
            if (!crossword.is_available && !crosswordAccess) {
              document.getElementById('lockedMessage').style.display = 'block';
              showContent();
              return;
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞–Ω–∏—è –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞
            const { data: assignmentsData, error: assignmentsError } = await supabase
              .from('assignments')
              .select('*')
              .eq('crossword_id', crosswordId)
              .order('order_index');

            if (assignmentsError) throw assignmentsError;
            assignments = assignmentsData || [];

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const { data: progressData, error: progressError } = await supabase
              .from('user_progress')
              .select('*')
              .eq('user_id', user.id)
              .in('assignment_id', assignments.map(a => a.id));

            if (progressError) throw progressError;
            userProgress = progressData || [];

            renderCrossword();
            renderAssignments();
            showContent();

          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞:', error);
            showError('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞: ' + error.message);
          }
        }

        function renderCrossword() {
          document.getElementById('crosswordTitle').textContent = crossword.title;
          document.getElementById('crosswordDescription').textContent = crossword.description || '–†–∞–∑–≥–∞–¥–∞–π—Ç–µ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥';

          const completedCount = userProgress.filter(up => up.is_completed).length;
          const totalCount = assignments.length;
          const progressPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

          document.getElementById('completedCount').textContent = completedCount;
          document.getElementById('totalCount').textContent = totalCount;
          document.getElementById('progressPercent').textContent = progressPercent + '%';

          document.getElementById('crosswordHeader').style.display = 'block';
          document.getElementById('assignmentsCard').style.display = 'block';
        }

        function renderAssignments() {
          const list = document.getElementById('assignmentsList');
          list.innerHTML = '';

          if (assignments.length === 0) {
            list.innerHTML = `
              <div style="text-align: center; padding: 40px; color: #666;">
                <p>üß© –°–ª–æ–≤–∞ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
                <p class="small-muted">–°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —Å–ª–æ–≤–∞ –¥–ª—è —Ä–∞–∑–≥–∞–¥—ã–≤–∞–Ω–∏—è</p>
              </div>
            `;
            return;
          }

          assignments.forEach(assignment => {
            const progress = userProgress.find(up => up.assignment_id === assignment.id);
            const isCompleted = progress ? progress.is_completed : false;

            const item = document.createElement('div');
            item.className = `assignment-item ${isCompleted ? 'completed' : ''}`;
            item.onclick = () => {
              window.location.href = `/assignment.html?id=${assignment.id}&source=crossword&sourceId=${crosswordId}`;
            };

            item.innerHTML = `
              <div class="assignment-icon">üß©</div>
              <div class="assignment-content">
                <div class="assignment-title">${assignment.title}</div>
                <div class="assignment-type">–°–ª–æ–≤–æ –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–∞</div>
              </div>
              <div class="assignment-status ${isCompleted ? 'status-completed' : 'status-pending'}">
                ${isCompleted ? '‚úÖ –†–∞–∑–≥–∞–¥–∞–Ω–æ' : '‚è≥ –û–∂–∏–¥–∞–µ—Ç'}
              </div>
            `;

            list.appendChild(item);
          });
        }

        await loadCrossword();
        return true;
        
      } catch (error) {
        showError('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message);
        return false;
      }
    }
    
    if (window.SUPABASE_URL) {
      initApp();
    } else {
      window.addEventListener('configLoaded', initApp);
    }
  </script>
</body>
</html>