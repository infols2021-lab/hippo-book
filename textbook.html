<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–£—á–µ–±–Ω–∏–∫ ‚Äî Edu Keys</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .textbook-container {
      width: 95%;
      max-width: 1000px;
      margin: 20px auto;
    }
    
    .textbook-header {
      color: white;
      padding: 0;
      border-radius: 16px;
      margin-bottom: 20px;
      text-align: center;
      overflow: hidden;
      position: relative;
      background: linear-gradient(135deg, #667eea, #764ba2);
    }

    .textbook-cover {
      width: 100%;
      height: 220px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      user-select: none;
    }
    .textbook-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .textbook-info {
      padding: 20px 24px 26px;
      background: linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.15));
    }
    
    .textbook-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.25);
    }
    
    .textbook-description {
      font-size: 1.05rem;
      opacity: 0.95;
      margin-bottom: 18px;
      text-shadow: 0 1px 6px rgba(0,0,0,0.2);
    }
    
    .progress-stats {
      display: flex;
      justify-content: center;
      gap: 30px;
      flex-wrap: wrap;
    }
    
    .stat-item {
      text-align: center;
      background: rgba(255,255,255,0.12);
      padding: 10px 16px;
      border-radius: 12px;
      backdrop-filter: blur(2px);
    }
    
    .stat-number {
      font-size: 1.6rem;
      font-weight: 800;
    }
    
    .stat-label {
      font-size: 0.85rem;
      opacity: 0.95;
    }
    
    .assignments-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .assignment-item {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      cursor: pointer;
      border-left: 4px solid #f0f0f0;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .assignment-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .assignment-item.completed {
      border-left-color: var(--accent2);
      background: #f8fffe;
    }
    
    .assignment-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: bold;
    }
    
    .assignment-icon.test {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .assignment-icon.fill {
      background: #f3e5f5;
      color: #7b1fa2;
    }
    
    .assignment-icon.sentence {
      background: #e8f5e8;
      color: #2e7d32;
    }
    
    .assignment-content {
      flex: 1;
    }
    
    .assignment-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 5px;
      color: #333;
    }
    
    .assignment-type {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .assignment-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .status-completed {
      background: #e8f5e8;
      color: #2e7d32;
    }
    
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .back-button {
      margin-bottom: 20px;
    }

    .locked-message {
      background: #fff3cd;
      border: 2px solid #ffeaa7;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
    }

    .loading { 
      text-align: center; 
      padding: 40px; 
      display: none;
    }
    .spinner { 
      border: 4px solid #f3f3f3; 
      border-top: 4px solid var(--accent2); 
      border-radius: 50%; 
      width: 40px; 
      height: 40px; 
      animation: spin 2s linear infinite; 
      margin: 0 auto 20px; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    .error { 
      background: #ffebee; 
      color: #c62828; 
      padding: 20px; 
      border-radius: 8px; 
      margin: 20px; 
      text-align: center; 
      display: none; 
    }

    @media (max-width: 768px) {
      .textbook-cover { height: 160px; }
      .textbook-title { font-size: 1.5rem; }
      .progress-stats { gap: 12px; }
      .stat-number { font-size: 1.3rem; }
      .assignment-item { padding: 15px; }
    }
  </style>
  
  <!-- –í–ê–ñ–ù–û: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ -->
  <script src="/load-config.js"></script>
</head>
<body>
  <div class="textbook-container">
    <div class="back-button">
      <button class="btn secondary" onclick="location.href='/materials.html'">‚Üê –ù–∞–∑–∞–¥ –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º</button>
    </div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>–ó–∞–≥—Ä—É–∂–∞–µ–º —É—á–µ–±–Ω–∏–∫...</p>
    </div>
    
    <div id="errorMessage" class="error"></div>

    <div id="textbookContent" style="display: none;">
      <div id="lockedMessage" class="locked-message" style="display: none;">
        <h3>üîí –£—á–µ–±–Ω–∏–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</h3>
        <p>–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É —É—á–µ–±–Ω–∏–∫—É –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.</p>
      </div>

      <div class="textbook-header" id="textbookHeader" style="display: none;">
        <div class="textbook-cover" id="textbookCover">üìö</div>
        <div class="textbook-info">
          <div class="textbook-title" id="textbookTitle">–ù–∞–∑–≤–∞–Ω–∏–µ —É—á–µ–±–Ω–∏–∫–∞</div>
          <div class="textbook-description" id="textbookDescription">–û–ø–∏—Å–∞–Ω–∏–µ —É—á–µ–±–Ω–∏–∫–∞</div>
          <div class="progress-stats">
            <div class="stat-item">
              <div class="stat-number" id="completedCount">0</div>
              <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="totalCount">0</div>
              <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞–Ω–∏–π</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="progressPercent">0%</</div>
              <div class="stat-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card" id="assignmentsCard" style="display: none;">
        <h3>–ó–∞–¥–∞–Ω–∏—è —É—á–µ–±–Ω–∏–∫–∞</h3>
        <p class="small-muted">–í—ã–ø–æ–ª–Ω—è–π—Ç–µ –∑–∞–¥–∞–Ω–∏—è –≤ –ª—é–±–æ–º –ø–æ—Ä—è–¥–∫–µ. –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
        
        <div class="assignments-list" id="assignmentsList"></div>
      </div>
    </div>
  </div>

  <script type="module">
    // ===== –•–µ–ª–ø–µ—Ä—ã –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ Supabase Storage =====
    function isHttpUrl(v) {
      return typeof v === 'string' && /^https?:\/\//i.test(v);
    }

    function resolvePublicUrl(value, bucket) {
      if (!value) return null;
      if (isHttpUrl(value)) return value;
      const key = String(value).replace(/^\/+/, '').replace(/^storage\/v1\/object\/public\/[^/]+\//,'');
      const v = Date.now();
      return `${window.SUPABASE_URL}/storage/v1/object/public/${bucket}/${encodeURIComponent(key)}?v=${v}`;
    }

    function mountCover(containerEl, rawValue, bucket, fallbackEmoji) {
      containerEl.textContent = fallbackEmoji;
      const url = resolvePublicUrl(rawValue, bucket);
      if (!url) return;

      const img = document.createElement('img');
      img.loading = 'lazy';
      img.decoding = 'async';
      img.alt = '–û–±–ª–æ–∂–∫–∞ —É—á–µ–±–Ω–∏–∫–∞';
      img.src = url;

      img.onload = () => {
        containerEl.textContent = '';
        containerEl.appendChild(img);
      };
      img.onerror = () => {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–ª–æ–∂–∫—É —É—á–µ–±–Ω–∏–∫–∞:', url);
      };
    }

    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorMessage').style.display = 'block';
      document.getElementById('loading').style.display = 'none';
    }
    
    function showContent() {
      document.getElementById('textbookContent').style.display = 'block';
      document.getElementById('loading').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
    }

    document.getElementById('loading').style.display = 'block';
    
    async function initApp() {
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
        showError('‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Supabase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.');
        return false;
      }
      
      try {
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
        const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          window.location.href = '/login.html';
          return;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const textbookId = urlParams.get('id');

        if (!textbookId) {
          showError('‚ùå –£—á–µ–±–Ω–∏–∫ –Ω–µ —É–∫–∞–∑–∞–Ω');
          return;
        }

        let textbook = null;
        let assignments = [];
        let userProgress = [];
        let textbookAccess = null;

        async function loadTextbook() {
          try {
            // 1) –£—á–µ–±–Ω–∏–∫
            const { data: textbookData, error: textbookError } = await supabase
              .from('textbooks')
              .select('*')
              .eq('id', textbookId)
              .single();

            if (textbookError) throw textbookError;
            textbook = textbookData;

            // 2) –î–æ—Å—Ç—É–ø
            const { data: accessData } = await supabase
              .from('textbook_access')
              .select('*')
              .eq('user_id', user.id)
              .eq('textbook_id', textbookId)
              .maybeSingle(); // –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ, —á–µ–º single() –µ—Å–ª–∏ –Ω–µ—Ç —Å—Ç—Ä–æ–∫–∏

            textbookAccess = accessData;

            // –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –Ω–µ—Ç –ø—É–±–ª–∏—á–Ω–æ–≥–æ —Ñ–ª–∞–≥–∞ –∏ –Ω–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
            if (!textbook.is_available && !textbookAccess) {
              document.getElementById('lockedMessage').style.display = 'block';
              showContent();
              return;
            }

            // 3) –ó–∞–¥–∞–Ω–∏—è
            const { data: assignmentsData, error: assignmentsError } = await supabase
              .from('assignments')
              .select('*')
              .eq('textbook_id', textbookId)
              .order('order_index');

            if (assignmentsError) throw assignmentsError;
            assignments = assignmentsData || [];

            // 4) –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const { data: progressData, error: progressError } = await supabase
              .from('user_progress')
              .select('assignment_id,is_completed')
              .eq('user_id', user.id)
              .in('assignment_id', assignments.map(a => a.id));

            if (progressError) throw progressError;
            userProgress = progressData || [];

            renderTextbook();
            renderAssignments();
            showContent();

          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–µ–±–Ω–∏–∫–∞:', error);
            showError('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–µ–±–Ω–∏–∫–∞: ' + error.message);
          }
        }

        function renderTextbook() {
          // –û–±–ª–æ–∂–∫–∞
          const coverEl = document.getElementById('textbookCover');
          mountCover(coverEl, textbook.cover_image_url, 'covers', 'üìö');

          // –¢–µ–∫—Å—Ç—ã
          document.getElementById('textbookTitle').textContent = textbook.title;
          document.getElementById('textbookDescription').textContent = textbook.description || '–£—á–µ–±–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ –∑–∞–¥–∞–Ω–∏—è';

          // –°—Ç–∞—Ç—ã
          const completedCount = userProgress.filter(up => up.is_completed).length;
          const totalCount = assignments.length;
          const progressPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

          document.getElementById('completedCount').textContent = completedCount;
          document.getElementById('totalCount').textContent = totalCount;
          document.getElementById('progressPercent').textContent = progressPercent + '%';

          document.getElementById('textbookHeader').style.display = 'block';
          document.getElementById('assignmentsCard').style.display = 'block';
        }

        function renderAssignments() {
          const list = document.getElementById('assignmentsList');
          list.innerHTML = '';

          if (assignments.length === 0) {
            list.innerHTML = `
              <div style="text-align: center; padding: 40px; color: #666;">
                <p>üìù –ó–∞–¥–∞–Ω–∏—è –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
                <p class="small-muted">–°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –∑–∞–¥–∞–Ω–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</p>
              </div>
            `;
            return;
          }

          assignments.forEach(assignment => {
            const progress = userProgress.find(up => up.assignment_id === assignment.id);
            const isCompleted = progress ? progress.is_completed : false;
            
            // –¢–∏–ø—ã: test / fill / sentence (–ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ–º—Å—è –ø–æ–¥ —Ç–≤–æ—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É)
            const assignmentData = assignment.content || {};
            const aType = assignmentData?.questions?.[0]?.type || assignment.type || 'test';
            
            let typeIcon = 'üìù';
            let typeLabel = '–¢–µ—Å—Ç';
            let typeClass = 'test';
            
            if (aType === 'fill') {
              typeIcon = '‚úçÔ∏è';
              typeLabel = '–í–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞';
              typeClass = 'fill';
            } else if (aType === 'sentence') {
              typeIcon = 'üìù';
              typeLabel = '–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è';
              typeClass = 'sentence';
            }

            const item = document.createElement('div');
            item.className = `assignment-item ${isCompleted ? 'completed' : ''}`;
            item.onclick = () => {
              // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –∑–∞–¥–∞–Ω–∏—è
              window.location.href = `/assignment.html?id=${assignment.id}&source=textbook&sourceId=${textbookId}`;
            };

            item.innerHTML = `
              <div class="assignment-icon ${typeClass}">${typeIcon}</div>
              <div class="assignment-content">
                <div class="assignment-title">${assignment.title}</div>
                <div class="assignment-type">${typeLabel}</div>
              </div>
              <div class="assignment-status ${isCompleted ? 'status-completed' : 'status-pending'}">
                ${isCompleted ? '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ' : '‚è≥ –û–∂–∏–¥–∞–µ—Ç'}
              </div>
            `;

            list.appendChild(item);
          });
        }

        await loadTextbook();
        return true;
        
      } catch (error) {
        showError('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message);
        return false;
      }
    }
    
    if (window.SUPABASE_URL) {
      initApp();
    } else {
      window.addEventListener('configLoaded', initApp);
    }
  </script>
</body>
</html>
